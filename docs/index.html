<!DOCTYPE html>
<html class="init-no-js">
<head>
<meta charset="UTF-8" />
<title>understanding-ar</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!--

OldFashioned superset of SugarCube (v2.7.2): A free (gratis and libre) story format, based on TiddlyWiki.

Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>.
All rights reserved.

Parts copyright © 2016 Blair MacIntyre <blair@cc.gatech.edu>.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<script src='http://bmaci.com/a4/twine/vendor/aframe.js'></script>
<script	src='http://bmaci.com/a4/twine/vendor/argon.js'></script>
<script	src='http://bmaci.com/a4/twine/vendor/ArgonSunMoon.js'></script>
<script	src='http://bmaci.com/a4/twine/vendor/CSS3DArgonRenderer.js'></script>
<script	src='http://bmaci.com/a4/twine/vendor/CSS3DArgonHUD.js'></script>
<script	src='http://bmaci.com/a4/twine/vendor/aframe-look-at-billboard-component.min.js'></script>
<script	src='http://bmaci.com/a4/twine/vendor/argon-aframe.js'></script>

<script id="script-libraries" type="text/javascript">
if(document.head&&document.addEventListener&&document.querySelector&&Object.create&&Object.freeze&&JSON){document.documentElement.className="init-loading";
/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js */
if("document" in self){if(!("classList" in document.createElement("_"))){(function(j){"use strict";if(!("Element" in j)){return}var a="classList",f="prototype",m=j.Element[f],b=Object,k=String[f].trim||function(){return this.replace(/^\s+|\s+$/g,"")},c=Array[f].indexOf||function(q){var p=0,o=this.length;for(;p<o;p++){if(p in this&&this[p]===q){return p}}return -1},n=function(o,p){this.name=o;this.code=DOMException[o];this.message=p},g=function(p,o){if(o===""){throw new n("SYNTAX_ERR","An invalid or illegal string was specified")}if(/\s/.test(o)){throw new n("INVALID_CHARACTER_ERR","String contains an invalid character")}return c.call(p,o)},d=function(s){var r=k.call(s.getAttribute("class")||""),q=r?r.split(/\s+/):[],p=0,o=q.length;for(;p<o;p++){this.push(q[p])}this._updateClassName=function(){s.setAttribute("class",this.toString())}},e=d[f]=[],i=function(){return new d(this)};n[f]=Error[f];e.item=function(o){return this[o]||null};e.contains=function(o){o+="";return g(this,o)!==-1};e.add=function(){var s=arguments,r=0,p=s.length,q,o=false;do{q=s[r]+"";if(g(this,q)===-1){this.push(q);o=true}}while(++r<p);if(o){this._updateClassName()}};e.remove=function(){var t=arguments,s=0,p=t.length,r,o=false,q;do{r=t[s]+"";q=g(this,r);while(q!==-1){this.splice(q,1);o=true;q=g(this,r)}}while(++s<p);if(o){this._updateClassName()}};e.toggle=function(p,q){p+="";var o=this.contains(p),r=o?q!==true&&"remove":q!==false&&"add";if(r){this[r](p)}if(q===true||q===false){return q}else{return !o}};e.toString=function(){return this.join(" ")};if(b.defineProperty){var l={get:i,enumerable:true,configurable:true};try{b.defineProperty(m,a,l)}catch(h){if(h.number===-2146823252){l.enumerable=false;b.defineProperty(m,a,l)}}}else{if(b[f].__defineGetter__){m.__defineGetter__(a,i)}}}(self))}else{(function(){var b=document.createElement("_");b.classList.add("c1","c2");if(!b.classList.contains("c2")){var c=function(e){var d=DOMTokenList.prototype[e];DOMTokenList.prototype[e]=function(h){var g,f=arguments.length;for(g=0;g<f;g++){h=arguments[g];d.call(this,h)}}};c("add");c("remove")}b.classList.toggle("c3",false);if(b.classList.contains("c3")){var a=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(d,e){if(1 in arguments&&!this.contains(d)===!e){return e}else{return a.call(this,d)}}}b=null}())}};
/*!
 * https://github.com/es-shims/es5-shim
 * @license es5-shim Copyright 2009-2015 by contributors, MIT License
 * see https://github.com/es-shims/es5-shim/blob/v4.5.6/LICENSE
 */
(function(t,r){"use strict";if(typeof define==="function"&&define.amd){define(r)}else if(typeof exports==="object"){module.exports=r()}else{t.returnExports=r()}})(this,function(){var t=Array;var r=t.prototype;var e=Object;var n=e.prototype;var i=Function;var a=i.prototype;var o=String;var f=o.prototype;var u=Number;var l=u.prototype;var s=r.slice;var c=r.splice;var v=r.push;var h=r.unshift;var p=r.concat;var y=r.join;var d=a.call;var g=a.apply;var w=Math.max;var b=Math.min;var T=n.toString;var m=typeof Symbol==="function"&&typeof Symbol.toStringTag==="symbol";var D;var x=Function.prototype.toString,S=/\s*class /,O=function isES6ClassFn(t){try{var r=x.call(t);var e=r.replace(/\/\/.*\n/g,"");var n=e.replace(/\/\*[.\s\S]*\*\//g,"");var i=n.replace(/\n/gm," ").replace(/ {2}/g," ");return S.test(i)}catch(a){return false}},E=function tryFunctionObject(t){try{if(O(t)){return false}x.call(t);return true}catch(r){return false}},j="[object Function]",I="[object GeneratorFunction]",D=function isCallable(t){if(!t){return false}if(typeof t!=="function"&&typeof t!=="object"){return false}if(m){return E(t)}if(O(t)){return false}var r=T.call(t);return r===j||r===I};var M;var U=RegExp.prototype.exec,F=function tryRegexExec(t){try{U.call(t);return true}catch(r){return false}},N="[object RegExp]";M=function isRegex(t){if(typeof t!=="object"){return false}return m?F(t):T.call(t)===N};var C;var k=String.prototype.valueOf,R=function tryStringObject(t){try{k.call(t);return true}catch(r){return false}},A="[object String]";C=function isString(t){if(typeof t==="string"){return true}if(typeof t!=="object"){return false}return m?R(t):T.call(t)===A};var P=e.defineProperty&&function(){try{var t={};e.defineProperty(t,"x",{enumerable:false,value:t});for(var r in t){return false}return t.x===t}catch(n){return false}}();var $=function(t){var r;if(P){r=function(t,r,n,i){if(!i&&r in t){return}e.defineProperty(t,r,{configurable:true,enumerable:false,writable:true,value:n})}}else{r=function(t,r,e,n){if(!n&&r in t){return}t[r]=e}}return function defineProperties(e,n,i){for(var a in n){if(t.call(n,a)){r(e,a,n[a],i)}}}}(n.hasOwnProperty);var J=function isPrimitive(t){var r=typeof t;return t===null||r!=="object"&&r!=="function"};var Y=u.isNaN||function(t){return t!==t};var Z={ToInteger:function ToInteger(t){var r=+t;if(Y(r)){r=0}else if(r!==0&&r!==1/0&&r!==-(1/0)){r=(r>0||-1)*Math.floor(Math.abs(r))}return r},ToPrimitive:function ToPrimitive(t){var r,e,n;if(J(t)){return t}e=t.valueOf;if(D(e)){r=e.call(t);if(J(r)){return r}}n=t.toString;if(D(n)){r=n.call(t);if(J(r)){return r}}throw new TypeError},ToObject:function(t){if(t==null){throw new TypeError("can't convert "+t+" to object")}return e(t)},ToUint32:function ToUint32(t){return t>>>0}};var z=function Empty(){};$(a,{bind:function bind(t){var r=this;if(!D(r)){throw new TypeError("Function.prototype.bind called on incompatible "+r)}var n=s.call(arguments,1);var a;var o=function(){if(this instanceof a){var i=g.call(r,this,p.call(n,s.call(arguments)));if(e(i)===i){return i}return this}else{return g.call(r,t,p.call(n,s.call(arguments)))}};var f=w(0,r.length-n.length);var u=[];for(var l=0;l<f;l++){v.call(u,"$"+l)}a=i("binder","return function ("+y.call(u,",")+"){ return binder.apply(this, arguments); }")(o);if(r.prototype){z.prototype=r.prototype;a.prototype=new z;z.prototype=null}return a}});var G=d.bind(n.hasOwnProperty);var B=d.bind(n.toString);var H=d.bind(s);var W=g.bind(s);var L=d.bind(f.slice);var X=d.bind(f.split);var q=d.bind(f.indexOf);var K=d.bind(v);var Q=d.bind(n.propertyIsEnumerable);var V=d.bind(r.sort);var _=t.isArray||function isArray(t){return B(t)==="[object Array]"};var tt=[].unshift(0)!==1;$(r,{unshift:function(){h.apply(this,arguments);return this.length}},tt);$(t,{isArray:_});var rt=e("a");var et=rt[0]!=="a"||!(0 in rt);var nt=function properlyBoxed(t){var r=true;var e=true;var n=false;if(t){try{t.call("foo",function(t,e,n){if(typeof n!=="object"){r=false}});t.call([1],function(){"use strict";e=typeof this==="string"},"x")}catch(i){n=true}}return!!t&&!n&&r&&e};$(r,{forEach:function forEach(t){var r=Z.ToObject(this);var e=et&&C(this)?X(this,""):r;var n=-1;var i=Z.ToUint32(e.length);var a;if(arguments.length>1){a=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.forEach callback must be a function")}while(++n<i){if(n in e){if(typeof a==="undefined"){t(e[n],n,r)}else{t.call(a,e[n],n,r)}}}}},!nt(r.forEach));$(r,{map:function map(r){var e=Z.ToObject(this);var n=et&&C(this)?X(this,""):e;var i=Z.ToUint32(n.length);var a=t(i);var o;if(arguments.length>1){o=arguments[1]}if(!D(r)){throw new TypeError("Array.prototype.map callback must be a function")}for(var f=0;f<i;f++){if(f in n){if(typeof o==="undefined"){a[f]=r(n[f],f,e)}else{a[f]=r.call(o,n[f],f,e)}}}return a}},!nt(r.map));$(r,{filter:function filter(t){var r=Z.ToObject(this);var e=et&&C(this)?X(this,""):r;var n=Z.ToUint32(e.length);var i=[];var a;var o;if(arguments.length>1){o=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.filter callback must be a function")}for(var f=0;f<n;f++){if(f in e){a=e[f];if(typeof o==="undefined"?t(a,f,r):t.call(o,a,f,r)){K(i,a)}}}return i}},!nt(r.filter));$(r,{every:function every(t){var r=Z.ToObject(this);var e=et&&C(this)?X(this,""):r;var n=Z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.every callback must be a function")}for(var a=0;a<n;a++){if(a in e&&!(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return false}}return true}},!nt(r.every));$(r,{some:function some(t){var r=Z.ToObject(this);var e=et&&C(this)?X(this,""):r;var n=Z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.some callback must be a function")}for(var a=0;a<n;a++){if(a in e&&(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return true}}return false}},!nt(r.some));var it=false;if(r.reduce){it=typeof r.reduce.call("es5",function(t,r,e,n){return n})==="object"}$(r,{reduce:function reduce(t){var r=Z.ToObject(this);var e=et&&C(this)?X(this,""):r;var n=Z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduce callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduce of empty array with no initial value")}var i=0;var a;if(arguments.length>=2){a=arguments[1]}else{do{if(i in e){a=e[i++];break}if(++i>=n){throw new TypeError("reduce of empty array with no initial value")}}while(true)}for(;i<n;i++){if(i in e){a=t(a,e[i],i,r)}}return a}},!it);var at=false;if(r.reduceRight){at=typeof r.reduceRight.call("es5",function(t,r,e,n){return n})==="object"}$(r,{reduceRight:function reduceRight(t){var r=Z.ToObject(this);var e=et&&C(this)?X(this,""):r;var n=Z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduceRight callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduceRight of empty array with no initial value")}var i;var a=n-1;if(arguments.length>=2){i=arguments[1]}else{do{if(a in e){i=e[a--];break}if(--a<0){throw new TypeError("reduceRight of empty array with no initial value")}}while(true)}if(a<0){return i}do{if(a in e){i=t(i,e[a],a,r)}}while(a--);return i}},!at);var ot=r.indexOf&&[0,1].indexOf(1,2)!==-1;$(r,{indexOf:function indexOf(t){var r=et&&C(this)?X(this,""):Z.ToObject(this);var e=Z.ToUint32(r.length);if(e===0){return-1}var n=0;if(arguments.length>1){n=Z.ToInteger(arguments[1])}n=n>=0?n:w(0,e+n);for(;n<e;n++){if(n in r&&r[n]===t){return n}}return-1}},ot);var ft=r.lastIndexOf&&[0,1].lastIndexOf(0,-3)!==-1;$(r,{lastIndexOf:function lastIndexOf(t){var r=et&&C(this)?X(this,""):Z.ToObject(this);var e=Z.ToUint32(r.length);if(e===0){return-1}var n=e-1;if(arguments.length>1){n=b(n,Z.ToInteger(arguments[1]))}n=n>=0?n:e-Math.abs(n);for(;n>=0;n--){if(n in r&&t===r[n]){return n}}return-1}},ft);var ut=function(){var t=[1,2];var r=t.splice();return t.length===2&&_(r)&&r.length===0}();$(r,{splice:function splice(t,r){if(arguments.length===0){return[]}else{return c.apply(this,arguments)}}},!ut);var lt=function(){var t={};r.splice.call(t,0,0,1);return t.length===1}();$(r,{splice:function splice(t,r){if(arguments.length===0){return[]}var e=arguments;this.length=w(Z.ToInteger(this.length),0);if(arguments.length>0&&typeof r!=="number"){e=H(arguments);if(e.length<2){K(e,this.length-t)}else{e[1]=Z.ToInteger(r)}}return c.apply(this,e)}},!lt);var st=function(){var r=new t(1e5);r[8]="x";r.splice(1,1);return r.indexOf("x")===7}();var ct=function(){var t=256;var r=[];r[t]="a";r.splice(t+1,0,"b");return r[t]==="a"}();$(r,{splice:function splice(t,r){var e=Z.ToObject(this);var n=[];var i=Z.ToUint32(e.length);var a=Z.ToInteger(t);var f=a<0?w(i+a,0):b(a,i);var u=b(w(Z.ToInteger(r),0),i-f);var l=0;var s;while(l<u){s=o(f+l);if(G(e,s)){n[l]=e[s]}l+=1}var c=H(arguments,2);var v=c.length;var h;if(v<u){l=f;var p=i-u;while(l<p){s=o(l+u);h=o(l+v);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l+=1}l=i;var y=i-u+v;while(l>y){delete e[l-1];l-=1}}else if(v>u){l=i-u;while(l>f){s=o(l+u-1);h=o(l+v-1);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l-=1}}l=f;for(var d=0;d<c.length;++d){e[l]=c[d];l+=1}e.length=i-u+v;return n}},!st||!ct);var vt=r.join;var ht;try{ht=Array.prototype.join.call("123",",")!=="1,2,3"}catch(pt){ht=true}if(ht){$(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return vt.call(C(this)?X(this,""):this,r)}},ht)}var yt=[1,2].join(undefined)!=="1,2";if(yt){$(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return vt.call(this,r)}},yt)}var dt=function push(t){var r=Z.ToObject(this);var e=Z.ToUint32(r.length);var n=0;while(n<arguments.length){r[e+n]=arguments[n];n+=1}r.length=e+n;return e+n};var gt=function(){var t={};var r=Array.prototype.push.call(t,undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();$(r,{push:function push(t){if(_(this)){return v.apply(this,arguments)}return dt.apply(this,arguments)}},gt);var wt=function(){var t=[];var r=t.push(undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();$(r,{push:dt},wt);$(r,{slice:function(t,r){var e=C(this)?X(this,""):this;return W(e,arguments)}},et);var bt=function(){try{[1,2].sort(null);[1,2].sort({});return true}catch(t){}return false}();var Tt=function(){try{[1,2].sort(/a/);return false}catch(t){}return true}();var mt=function(){try{[1,2].sort(undefined);return true}catch(t){}return false}();$(r,{sort:function sort(t){if(typeof t==="undefined"){return V(this)}if(!D(t)){throw new TypeError("Array.prototype.sort callback must be a function")}return V(this,t)}},bt||!mt||!Tt);var Dt=!{toString:null}.propertyIsEnumerable("toString");var xt=function(){}.propertyIsEnumerable("prototype");var St=!G("x","0");var Ot=function(t){var r=t.constructor;return r&&r.prototype===t};var Et={$window:true,$console:true,$parent:true,$self:true,$frame:true,$frames:true,$frameElement:true,$webkitIndexedDB:true,$webkitStorageInfo:true,$external:true};var jt=function(){if(typeof window==="undefined"){return false}for(var t in window){try{if(!Et["$"+t]&&G(window,t)&&window[t]!==null&&typeof window[t]==="object"){Ot(window[t])}}catch(r){return true}}return false}();var It=function(t){if(typeof window==="undefined"||!jt){return Ot(t)}try{return Ot(t)}catch(r){return false}};var Mt=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var Ut=Mt.length;var Ft=function isArguments(t){return B(t)==="[object Arguments]"};var Nt=function isArguments(t){return t!==null&&typeof t==="object"&&typeof t.length==="number"&&t.length>=0&&!_(t)&&D(t.callee)};var Ct=Ft(arguments)?Ft:Nt;$(e,{keys:function keys(t){var r=D(t);var e=Ct(t);var n=t!==null&&typeof t==="object";var i=n&&C(t);if(!n&&!r&&!e){throw new TypeError("Object.keys called on a non-object")}var a=[];var f=xt&&r;if(i&&St||e){for(var u=0;u<t.length;++u){K(a,o(u))}}if(!e){for(var l in t){if(!(f&&l==="prototype")&&G(t,l)){K(a,o(l))}}}if(Dt){var s=It(t);for(var c=0;c<Ut;c++){var v=Mt[c];if(!(s&&v==="constructor")&&G(t,v)){K(a,v)}}}return a}});var kt=e.keys&&function(){return e.keys(arguments).length===2}(1,2);var Rt=e.keys&&function(){var t=e.keys(arguments);return arguments.length!==1||t.length!==1||t[0]!==1}(1);var At=e.keys;$(e,{keys:function keys(t){if(Ct(t)){return At(H(t))}else{return At(t)}}},!kt||Rt);var Pt=new Date(-0xc782b5b342b24).getUTCMonth()!==0;var $t=new Date(-0x55d318d56a724);var Jt=new Date(14496624e5);var Yt=$t.toUTCString()!=="Mon, 01 Jan -45875 11:59:59 GMT";var Zt;var zt;var Gt=$t.getTimezoneOffset();if(Gt<-720){Zt=$t.toDateString()!=="Tue Jan 02 -45875";zt=!/^Thu Dec 10 2015 \d\d:\d\d:\d\d GMT[-\+]\d\d\d\d(?: |$)/.test(Jt.toString())}else{Zt=$t.toDateString()!=="Mon Jan 01 -45875";zt=!/^Wed Dec 09 2015 \d\d:\d\d:\d\d GMT[-\+]\d\d\d\d(?: |$)/.test(Jt.toString())}var Bt=d.bind(Date.prototype.getFullYear);var Ht=d.bind(Date.prototype.getMonth);var Wt=d.bind(Date.prototype.getDate);var Lt=d.bind(Date.prototype.getUTCFullYear);var Xt=d.bind(Date.prototype.getUTCMonth);var qt=d.bind(Date.prototype.getUTCDate);var Kt=d.bind(Date.prototype.getUTCDay);var Qt=d.bind(Date.prototype.getUTCHours);var Vt=d.bind(Date.prototype.getUTCMinutes);var _t=d.bind(Date.prototype.getUTCSeconds);var tr=d.bind(Date.prototype.getUTCMilliseconds);var rr=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var er=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var nr=function daysInMonth(t,r){return Wt(new Date(r,t,0))};$(Date.prototype,{getFullYear:function getFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);if(t<0&&Ht(this)>11){return t+1}return t},getMonth:function getMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Ht(this);if(t<0&&r>11){return 0}return r},getDate:function getDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Ht(this);var e=Wt(this);if(t<0&&r>11){if(r===12){return e}var n=nr(0,t+1);return n-e+1}return e},getUTCFullYear:function getUTCFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Lt(this);if(t<0&&Xt(this)>11){return t+1}return t},getUTCMonth:function getUTCMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Lt(this);var r=Xt(this);if(t<0&&r>11){return 0}return r},getUTCDate:function getUTCDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Lt(this);var r=Xt(this);var e=qt(this);if(t<0&&r>11){if(r===12){return e}var n=nr(0,t+1);return n-e+1}return e}},Pt);$(Date.prototype,{toUTCString:function toUTCString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Kt(this);var r=qt(this);var e=Xt(this);var n=Lt(this);var i=Qt(this);var a=Vt(this);var o=_t(this);return rr[t]+", "+(r<10?"0"+r:r)+" "+er[e]+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"}},Pt||Yt);$(Date.prototype,{toDateString:function toDateString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();return rr[t]+" "+er[e]+" "+(r<10?"0"+r:r)+" "+n}},Pt||Zt);if(Pt||zt){Date.prototype.toString=function toString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();var i=this.getHours();var a=this.getMinutes();var o=this.getSeconds();var f=this.getTimezoneOffset();var u=Math.floor(Math.abs(f)/60);var l=Math.floor(Math.abs(f)%60);return rr[t]+" "+er[e]+" "+(r<10?"0"+r:r)+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"+(f>0?"-":"+")+(u<10?"0"+u:u)+(l<10?"0"+l:l)};if(P){e.defineProperty(Date.prototype,"toString",{configurable:true,enumerable:false,writable:true})}}var ir=-621987552e5;var ar="-000001";var or=Date.prototype.toISOString&&new Date(ir).toISOString().indexOf(ar)===-1;var fr=Date.prototype.toISOString&&new Date(-1).toISOString()!=="1969-12-31T23:59:59.999Z";var ur=d.bind(Date.prototype.getTime);$(Date.prototype,{toISOString:function toISOString(){if(!isFinite(this)||!isFinite(ur(this))){throw new RangeError("Date.prototype.toISOString called on non-finite value.")}var t=Lt(this);var r=Xt(this);t+=Math.floor(r/12);r=(r%12+12)%12;var e=[r+1,qt(this),Qt(this),Vt(this),_t(this)];t=(t<0?"-":t>9999?"+":"")+L("00000"+Math.abs(t),0<=t&&t<=9999?-4:-6);for(var n=0;n<e.length;++n){e[n]=L("00"+e[n],-2)}return t+"-"+H(e,0,2).join("-")+"T"+H(e,2).join(":")+"."+L("000"+tr(this),-3)+"Z"}},or||fr);var lr=function(){try{return Date.prototype.toJSON&&new Date(NaN).toJSON()===null&&new Date(ir).toJSON().indexOf(ar)!==-1&&Date.prototype.toJSON.call({toISOString:function(){return true}})}catch(t){return false}}();if(!lr){Date.prototype.toJSON=function toJSON(t){var r=e(this);var n=Z.ToPrimitive(r);if(typeof n==="number"&&!isFinite(n)){return null}var i=r.toISOString;if(!D(i)){throw new TypeError("toISOString property is not callable")}return i.call(r)}}var sr=Date.parse("+033658-09-27T01:46:40.000Z")===1e15;var cr=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z"));var vr=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));if(vr||cr||!sr){var hr=Math.pow(2,31)-1;var pr=Y(new Date(1970,0,1,0,0,0,hr+1).getTime());Date=function(t){var r=function Date(e,n,i,a,f,u,l){var s=arguments.length;var c;if(this instanceof t){var v=u;var h=l;if(pr&&s>=7&&l>hr){var p=Math.floor(l/hr)*hr;var y=Math.floor(p/1e3);v+=y;h-=y*1e3}c=s===1&&o(e)===e?new t(r.parse(e)):s>=7?new t(e,n,i,a,f,v,h):s>=6?new t(e,n,i,a,f,v):s>=5?new t(e,n,i,a,f):s>=4?new t(e,n,i,a):s>=3?new t(e,n,i):s>=2?new t(e,n):s>=1?new t(e instanceof t?+e:e):new t}else{c=t.apply(this,arguments)}if(!J(c)){$(c,{constructor:r},true)}return c};var e=new RegExp("^"+"(\\d{4}|[+-]\\d{6})"+"(?:-(\\d{2})"+"(?:-(\\d{2})"+"(?:"+"T(\\d{2})"+":(\\d{2})"+"(?:"+":(\\d{2})"+"(?:(\\.\\d{1,}))?"+")?"+"("+"Z|"+"(?:"+"([-+])"+"(\\d{2})"+":(\\d{2})"+")"+")?)?)?)?"+"$");var n=[0,31,59,90,120,151,181,212,243,273,304,334,365];var i=function dayFromMonth(t,r){var e=r>1?1:0;return n[r]+Math.floor((t-1969+e)/4)-Math.floor((t-1901+e)/100)+Math.floor((t-1601+e)/400)+365*(t-1970)};var a=function toUTC(r){var e=0;var n=r;if(pr&&n>hr){var i=Math.floor(n/hr)*hr;var a=Math.floor(i/1e3);e+=a;n-=a*1e3}return u(new t(1970,0,1,0,0,e,n))};for(var f in t){if(G(t,f)){r[f]=t[f]}}$(r,{now:t.now,UTC:t.UTC},true);r.prototype=t.prototype;$(r.prototype,{constructor:r},true);var l=function parse(r){var n=e.exec(r);if(n){var o=u(n[1]),f=u(n[2]||1)-1,l=u(n[3]||1)-1,s=u(n[4]||0),c=u(n[5]||0),v=u(n[6]||0),h=Math.floor(u(n[7]||0)*1e3),p=Boolean(n[4]&&!n[8]),y=n[9]==="-"?1:-1,d=u(n[10]||0),g=u(n[11]||0),w;var b=c>0||v>0||h>0;if(s<(b?24:25)&&c<60&&v<60&&h<1e3&&f>-1&&f<12&&d<24&&g<60&&l>-1&&l<i(o,f+1)-i(o,f)){w=((i(o,f)+l)*24+s+d*y)*60;w=((w+c+g*y)*60+v)*1e3+h;if(p){w=a(w)}if(-864e13<=w&&w<=864e13){return w}}return NaN}return t.parse.apply(this,arguments)};$(r,{parse:l});return r}(Date)}if(!Date.now){Date.now=function now(){return(new Date).getTime()}}var yr=l.toFixed&&(8e-5.toFixed(3)!=="0.000"||.9.toFixed(0)!=="1"||1.255.toFixed(2)!=="1.25"||0xde0b6b3a7640080.toFixed(0)!=="1000000000000000128");var dr={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function multiply(t,r){var e=-1;var n=r;while(++e<dr.size){n+=t*dr.data[e];dr.data[e]=n%dr.base;n=Math.floor(n/dr.base)}},divide:function divide(t){var r=dr.size;var e=0;while(--r>=0){e+=dr.data[r];dr.data[r]=Math.floor(e/t);e=e%t*dr.base}},numToString:function numToString(){var t=dr.size;var r="";while(--t>=0){if(r!==""||t===0||dr.data[t]!==0){var e=o(dr.data[t]);if(r===""){r=e}else{r+=L("0000000",0,7-e.length)+e}}}return r},pow:function pow(t,r,e){return r===0?e:r%2===1?pow(t,r-1,e*t):pow(t*t,r/2,e)},log:function log(t){var r=0;var e=t;while(e>=4096){r+=12;e/=4096}while(e>=2){r+=1;e/=2}return r}};var gr=function toFixed(t){var r,e,n,i,a,f,l,s;r=u(t);r=Y(r)?0:Math.floor(r);if(r<0||r>20){throw new RangeError("Number.toFixed called with invalid number of decimals")}e=u(this);if(Y(e)){return"NaN"}if(e<=-1e21||e>=1e21){return o(e)}n="";if(e<0){n="-";e=-e}i="0";if(e>1e-21){a=dr.log(e*dr.pow(2,69,1))-69;f=a<0?e*dr.pow(2,-a,1):e/dr.pow(2,a,1);f*=4503599627370496;a=52-a;if(a>0){dr.multiply(0,f);l=r;while(l>=7){dr.multiply(1e7,0);l-=7}dr.multiply(dr.pow(10,l,1),0);l=a-1;while(l>=23){dr.divide(1<<23);l-=23}dr.divide(1<<l);dr.multiply(1,1);dr.divide(2);i=dr.numToString()}else{dr.multiply(0,f);dr.multiply(1<<-a,0);i=dr.numToString()+L("0.00000000000000000000",2,2+r)}}if(r>0){s=i.length;if(s<=r){i=n+L("0.0000000000000000000",0,r-s+2)+i}else{i=n+L(i,0,s-r)+"."+L(i,s-r)}}else{i=n+i}return i};$(l,{toFixed:gr},yr);var wr=function(){try{return 1..toPrecision(undefined)==="1"}catch(t){return true}}();var br=l.toPrecision;$(l,{toPrecision:function toPrecision(t){return typeof t==="undefined"?br.call(this):br.call(this,t)}},wr);if("ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1){(function(){var t=typeof/()??/.exec("")[1]==="undefined";var r=Math.pow(2,32)-1;f.split=function(e,n){var i=String(this);if(typeof e==="undefined"&&n===0){return[]}if(!M(e)){return X(this,e,n)}var a=[];var o=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),f=0,u,l,s,c;var h=new RegExp(e.source,o+"g");if(!t){u=new RegExp("^"+h.source+"$(?!\\s)",o)}var p=typeof n==="undefined"?r:Z.ToUint32(n);l=h.exec(i);while(l){s=l.index+l[0].length;if(s>f){K(a,L(i,f,l.index));if(!t&&l.length>1){l[0].replace(u,function(){for(var t=1;t<arguments.length-2;t++){if(typeof arguments[t]==="undefined"){l[t]=void 0}}})}if(l.length>1&&l.index<i.length){v.apply(a,H(l,1))}c=l[0].length;f=s;if(a.length>=p){break}}if(h.lastIndex===l.index){h.lastIndex++}l=h.exec(i)}if(f===i.length){if(c||!h.test("")){K(a,"")}}else{K(a,L(i,f))}return a.length>p?H(a,0,p):a}})()}else if("0".split(void 0,0).length){f.split=function split(t,r){if(typeof t==="undefined"&&r===0){return[]}return X(this,t,r)}}var Tr=f.replace;var mr=function(){var t=[];"x".replace(/x(.)?/g,function(r,e){K(t,e)});return t.length===1&&typeof t[0]==="undefined"}();if(!mr){f.replace=function replace(t,r){var e=D(r);var n=M(t)&&/\)[*?]/.test(t.source);if(!e||!n){return Tr.call(this,t,r)}else{var i=function(e){var n=arguments.length;var i=t.lastIndex;t.lastIndex=0;var a=t.exec(e)||[];t.lastIndex=i;K(a,arguments[n-2],arguments[n-1]);return r.apply(this,a)};return Tr.call(this,t,i)}}}var Dr=f.substr;var xr="".substr&&"0b".substr(-1)!=="b";$(f,{substr:function substr(t,r){var e=t;if(t<0){e=w(this.length+t,0)}return Dr.call(this,e,r)}},xr);var Sr="	\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003"+"\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028"+"\u2029\ufeff";var Or="\u200b";var Er="["+Sr+"]";var jr=new RegExp("^"+Er+Er+"*");var Ir=new RegExp(Er+Er+"*$");var Mr=f.trim&&(Sr.trim()||!Or.trim());$(f,{trim:function trim(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}return o(this).replace(jr,"").replace(Ir,"")}},Mr);var Ur=d.bind(String.prototype.trim);var Fr=f.lastIndexOf&&"abc\u3042\u3044".lastIndexOf("\u3042\u3044",2)!==-1;$(f,{lastIndexOf:function lastIndexOf(t){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var r=o(this);var e=o(t);var n=arguments.length>1?u(arguments[1]):NaN;var i=Y(n)?Infinity:Z.ToInteger(n);var a=b(w(i,0),r.length);var f=e.length;var l=a+f;while(l>0){l=w(0,l-f);var s=q(L(r,l,a+f),e);if(s!==-1){return l+s}}return-1}},Fr);var Nr=f.lastIndexOf;$(f,{lastIndexOf:function lastIndexOf(t){return Nr.apply(this,arguments)}},f.lastIndexOf.length!==1);if(parseInt(Sr+"08")!==8||parseInt(Sr+"0x16")!==22){parseInt=function(t){var r=/^[\-+]?0[xX]/;return function parseInt(e,n){var i=Ur(e);var a=u(n)||(r.test(i)?16:10);return t(i,a)}}(parseInt)}if(1/parseFloat("-0")!==-Infinity){parseFloat=function(t){return function parseFloat(r){var e=Ur(r);var n=t(e);return n===0&&L(e,0,1)==="-"?-0:n}}(parseFloat)}if(String(new RangeError("test"))!=="RangeError: test"){var Cr=function toString(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var t=this.name;if(typeof t==="undefined"){t="Error"}else if(typeof t!=="string"){t=o(t)}var r=this.message;if(typeof r==="undefined"){r=""}else if(typeof r!=="string"){r=o(r)}if(!t){return r}if(!r){return t}return t+": "+r};Error.prototype.toString=Cr}if(P){var kr=function(t,r){if(Q(t,r)){var e=Object.getOwnPropertyDescriptor(t,r);e.enumerable=false;Object.defineProperty(t,r,e)}};kr(Error.prototype,"message");if(Error.prototype.message!==""){Error.prototype.message=""}kr(Error.prototype,"name")}if(String(/a/gim)!=="/a/gim"){var Rr=function toString(){var t="/"+this.source+"/";if(this.global){t+="g"}if(this.ignoreCase){t+="i"}if(this.multiline){t+="m"}return t};RegExp.prototype.toString=Rr}});
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.0
 * see https://github.com/paulmillr/es6-shim/blob/0.35.0/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var O={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var m=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){O.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=m(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var M=Function.call.bind(Array.prototype.sort);var C=Function.call.bind(String.prototype.slice);var x=Function.call.bind(Array.prototype.push);var N=Function.apply.bind(Array.prototype.push);var A=Function.call.bind(Array.prototype.shift);var R=Math.max;var _=Math.min;var k=Math.floor;var F=Math.abs;var L=Math.log;var D=Math.sqrt;var z=Function.call.bind(Object.prototype.hasOwnProperty);var q;var G=function(){};var W=S.Symbol||{};var H=W.species||"@@species";var V=Number.isNaN||function isNaN(e){return e!==e};var B=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var $=function isArguments(e){return g(e)==="[object Arguments]"};var U=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var J=$(arguments)?$:U;var K={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},object:function(e){return e!==null&&typeof e==="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var X=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);O.preserveToString(e[t],n)};var Z=typeof W==="function"&&typeof W["for"]==="function"&&K.symbol(W());var Y=K.symbol(W.iterator)?W.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){Y="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var Q=S.Reflect;var ee=String;var te={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!te.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(e==null){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"},ToObject:function(e,t){return Object(te.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return te.IsCallable(e)},ToInt32:function(e){return te.ToNumber(e)>>0},ToUint32:function(e){return te.ToNumber(e)>>>0},ToNumber:function(e){if(g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=te.ToNumber(e);if(V(t)){return 0}if(t===0||!B(t)){return t}return(t>0?1:-1)*k(F(t))},ToLength:function(e){var t=te.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return V(e)&&V(t)},SameValueZero:function(e,t){return e===t||V(e)&&V(t)},IsIterable:function(e){return te.TypeIsObject(e)&&(typeof e[Y]!=="undefined"||J(e))},GetIterator:function(e){if(J(e)){return new q(e,"value")}var t=te.GetMethod(e,Y);if(!te.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=te.Call(t,e);if(!te.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=te.ToObject(e)[t];if(r===void 0||r===null){return void 0}if(!te.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=te.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=te.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!te.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!te.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=te.IteratorNext(e);var r=te.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&Q.construct){return Q.construct(e,t,o)}var i=o.prototype;if(!te.TypeIsObject(i)){i=Object.prototype}var a=m(i);var u=te.Call(e,a,t);return te.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!te.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[H];if(n===void 0||n===null){return t}if(!te.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=te.ToString(e);var i="<"+t;if(r!==""){var a=te.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!te.TypeIsObject(e)){return false}var t=e[W.match];if(typeof t!=="undefined"){return!!t}return K.regex(e)},ToString:function ToString(e){return ee(e)}};if(s&&Z){var re=function defineWellKnownSymbol(e){if(K.symbol(W[e])){return W[e]}var t=W["for"]("Symbol."+e);Object.defineProperty(W,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!K.symbol(W.search)){var ne=re("search");var oe=String.prototype.search;h(RegExp.prototype,ne,function search(e){return te.Call(oe,e,[this])});var ie=function search(e){var t=te.RequireObjectCoercible(this);if(e!==null&&typeof e!=="undefined"){var r=te.GetMethod(e,ne);if(typeof r!=="undefined"){return te.Call(r,e,[t])}}return te.Call(oe,t,[te.ToString(e)])};X(String.prototype,"search",ie)}if(!K.symbol(W.replace)){var ae=re("replace");var ue=String.prototype.replace;h(RegExp.prototype,ae,function replace(e,t){return te.Call(ue,e,[this,t])});var fe=function replace(e,t){var r=te.RequireObjectCoercible(this);if(e!==null&&typeof e!=="undefined"){var n=te.GetMethod(e,ae);if(typeof n!=="undefined"){return te.Call(n,e,[r,t])}}return te.Call(ue,r,[te.ToString(e),t])};X(String.prototype,"replace",fe)}if(!K.symbol(W.split)){var se=re("split");var ce=String.prototype.split;h(RegExp.prototype,se,function split(e,t){return te.Call(ce,e,[this,t])});var le=function split(e,t){var r=te.RequireObjectCoercible(this);if(e!==null&&typeof e!=="undefined"){var n=te.GetMethod(e,se);if(typeof n!=="undefined"){return te.Call(n,e,[r,t])}}return te.Call(ce,r,[te.ToString(e),t])};X(String.prototype,"split",le)}var pe=K.symbol(W.match);var ve=pe&&function(){var e={};e[W.match]=function(){return 42};return"a".match(e)!==42}();if(!pe||ve){var ye=re("match");var he=String.prototype.match;h(RegExp.prototype,ye,function match(e){return te.Call(he,e,[this])});var be=function match(e){var t=te.RequireObjectCoercible(this);if(e!==null&&typeof e!=="undefined"){var r=te.GetMethod(e,ye);if(typeof r!=="undefined"){return te.Call(r,e,[t])}}return te.Call(he,t,[te.ToString(e)])};X(String.prototype,"match",be)}}var ge=function wrapConstructor(e,t,r){O.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in G||r[n]){return}O.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in G||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;O.redefine(e.prototype,"constructor",t)};var de=function(){return this};var Oe=function(e){if(s&&!z(e,H)){O.getter(e,H,de)}};var me=function(e,t){var r=t||function iterator(){return this};h(e,Y,r);if(!e[Y]&&K.symbol(Y)){e[Y]=r}};var we=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var je=function createDataPropertyOrThrow(e,t,r){we(e,t,r);if(!te.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var Se=function(e,t,r,n){if(!te.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!te.TypeIsObject(o)){o=r}var i=m(o);for(var a in n){if(z(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Te=String.fromCodePoint;X(String,"fromCodePoint",function fromCodePoint(e){return te.Call(Te,this,arguments)})}var Ie={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!te.SameValue(r,te.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){x(t,String.fromCharCode(r))}else{r-=65536;x(t,String.fromCharCode((r>>10)+55296));x(t,String.fromCharCode(r%1024+56320))}}return t.join("")},raw:function raw(e){var t=te.ToObject(e,"bad callSite");var r=te.ToObject(t.raw,"bad raw value");var n=r.length;var o=te.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=te.ToString(a);s=te.ToString(r[u]);x(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=te.ToString(f);x(i,c);a+=1}return i.join("")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){X(String,"raw",Ie.raw)}b(String,Ie);var Ee=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Pe=Infinity;var Me={repeat:function repeat(e){var t=te.ToString(te.RequireObjectCoercible(this));var r=te.ToInteger(e);if(r<0||r>=Pe){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return Ee(t,r)},startsWith:function startsWith(e){var t=te.ToString(te.RequireObjectCoercible(this));if(te.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=te.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=R(te.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=te.ToString(te.RequireObjectCoercible(this));if(te.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=te.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:te.ToInteger(o);var a=_(R(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(te.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=te.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=te.ToString(te.RequireObjectCoercible(this));var r=te.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){X(String.prototype,"includes",Me.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var Ce=i(function(){"/a/".startsWith(/a/)});var xe=a(function(){return"abc".startsWith("a",Infinity)===false});if(!Ce||!xe){X(String.prototype,"startsWith",Me.startsWith);X(String.prototype,"endsWith",Me.endsWith)}}if(Z){var Ne=a(function(){var e=/a/;e[W.match]=false;return"/a/".startsWith(e)});if(!Ne){X(String.prototype,"startsWith",Me.startsWith)}var Ae=a(function(){var e=/a/;e[W.match]=false;return"/a/".endsWith(e)});if(!Ae){X(String.prototype,"endsWith",Me.endsWith)}var Re=a(function(){var e=/a/;e[W.match]=false;return"/a/".includes(e)});if(!Re){X(String.prototype,"includes",Me.includes)}}b(String.prototype,Me);var _e=["	\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var ke=new RegExp("(^["+_e+"]+)|(["+_e+"]+$)","g");var Fe=function trim(){return te.ToString(te.RequireObjectCoercible(this)).replace(ke,"")};var Le=["\x85","\u200b","\ufffe"].join("");var De=new RegExp("["+Le+"]","g");var ze=/^[\-+]0x[0-9a-f]+$/i;var qe=Le.trim().length!==Le.length;h(String.prototype,"trim",Fe,qe);var Ge=function(e){te.RequireObjectCoercible(e);this._s=te.ToString(e);this._i=0};Ge.prototype.next=function(){var e=this._s,t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return{value:void 0,done:true}}var r=e.charCodeAt(t),n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return{value:e.substr(t,o),done:false}};me(Ge.prototype);me(String.prototype,function(){return new Ge(this)});var We={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!te.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(J(e)||te.GetMethod(e,Y))!=="undefined";var u,f,s;if(a){f=te.IsConstructor(r)?Object(new r):[];var c=te.GetIterator(e);var l,p;s=0;while(true){l=te.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){te.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=te.ToObject(e);u=te.ToLength(y.length);f=te.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}f[s]=h}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!te.IsCallable(t)?new Array(e):te.Construct(t,[e]);for(var o=0;o<e;++o){je(n,o,arguments[o])}n.length=e;return n}};b(Array,We);Oe(Array);var He=function(e){return{value:e,done:arguments.length===0}};q=function(e,t){this.i=0;this.array=e;this.kind=t};b(q.prototype,{next:function(){var e=this.i,t=this.array;if(!(this instanceof q)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=te.ToLength(t.length);for(;e<r;e++){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return{value:o,done:false}}}this.array=void 0;return{value:void 0,done:true}}});me(q.prototype);var Ve=function orderKeys(e,t){var r=String(te.ToInteger(e))===e;var n=String(te.ToInteger(t))===t;if(r&&n){return t-e}else if(r&&!n){return-1}else if(!r&&n){return 1}else{return e.localeCompare(t)}};var Be=function getAllKeys(e){var t=[];var r=[];for(var n in e){x(z(e,n)?t:r,n)}M(t,Ve);M(r,Ve);return P(t,r)};var $e=Array.of===We.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!$e){X(Array,"of",We.of)}var Ue={copyWithin:function copyWithin(e,t){var r=te.ToObject(this);var n=te.ToLength(r.length);var o=te.ToInteger(e);var i=te.ToInteger(t);var a=o<0?R(n+o,0):_(o,n);var u=i<0?R(n+i,0):_(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:te.ToInteger(f);var c=s<0?R(n+s,0):_(s,n);var l=_(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=te.ToObject(this);var o=te.ToLength(n.length);t=te.ToInteger(typeof t==="undefined"?0:t);r=te.ToInteger(typeof r==="undefined"?o:r);var i=t<0?R(o+t,0):_(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=te.ToObject(this);var n=te.ToLength(r.length);if(!te.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=te.ToObject(this);var n=te.ToLength(r.length);if(!te.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new q(this,"key")},values:function values(){return new q(this,"value")},entries:function entries(){return new q(this,"entry")}};if(Array.prototype.keys&&!te.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!te.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[Y]){b(Array.prototype,{values:Array.prototype[Y]});if(K.symbol(W.unscopables)){Array.prototype[W.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var Je=Array.prototype.values;X(Array.prototype,"values",function values(){return te.Call(Je,this,arguments)});h(Array.prototype,Y,Array.prototype.values,true)}b(Array.prototype,Ue);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}me(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){me(Object.getPrototypeOf([].values()))}var Ke=function(){return a(function(){return Array.from({length:-1}).length===0})}();var Xe=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!Ke||!Xe){X(Array,"from",We.from)}var Ze=function(){return a(function(){return Array.from([0],void 0)})}();if(!Ze){var Ye=Array.from;X(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return te.Call(Ye,this,arguments)}else{return t(Ye,this,e)}})}var Qe=-(Math.pow(2,32)-1);var et=function(e,r){var n={length:Qe};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!et(Array.prototype.forEach)){var tt=Array.prototype.forEach;X(Array.prototype,"forEach",function forEach(e){return te.Call(tt,this.length>=0?this:[],arguments)},true)}if(!et(Array.prototype.map)){var rt=Array.prototype.map;X(Array.prototype,"map",function map(e){return te.Call(rt,this.length>=0?this:[],arguments)},true)}if(!et(Array.prototype.filter)){var nt=Array.prototype.filter;X(Array.prototype,"filter",function filter(e){return te.Call(nt,this.length>=0?this:[],arguments)},true)}if(!et(Array.prototype.some)){var ot=Array.prototype.some;X(Array.prototype,"some",function some(e){return te.Call(ot,this.length>=0?this:[],arguments)},true)}if(!et(Array.prototype.every)){var it=Array.prototype.every;X(Array.prototype,"every",function every(e){return te.Call(it,this.length>=0?this:[],arguments)},true)}if(!et(Array.prototype.reduce)){var at=Array.prototype.reduce;X(Array.prototype,"reduce",function reduce(e){return te.Call(at,this.length>=0?this:[],arguments)},true)}if(!et(Array.prototype.reduceRight,true)){var ut=Array.prototype.reduceRight;X(Array.prototype,"reduceRight",function reduceRight(e){return te.Call(ut,this.length>=0?this:[],arguments)},true)}var ft=Number("0o10")!==8;var st=Number("0b10")!==2;var ct=y(Le,function(e){return Number(e+0+e)===0});if(ft||st||ct){var lt=Number;var pt=/^0b[01]+$/i;var vt=/^0o[0-7]+$/i;var yt=pt.test.bind(pt);var ht=vt.test.bind(vt);var bt=function(e){var t;if(typeof e.valueOf==="function"){t=e.valueOf();if(K.primitive(t)){return t}}if(typeof e.toString==="function"){t=e.toString();if(K.primitive(t)){return t}}throw new TypeError("No default value")};var gt=De.test.bind(De);var dt=ze.test.bind(ze);var Ot=function(){var e=function Number(t){var r;if(arguments.length>0){r=K.primitive(t)?t:bt(t,"number")}else{r=0}if(typeof r==="string"){r=te.Call(Fe,r);if(yt(r)){r=parseInt(C(r,2),2)}else if(ht(r)){r=parseInt(C(r,2),8)}else if(gt(r)||dt(r)){r=NaN}}var n=this;var o=a(function(){lt.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new lt(r)}return lt(r)};return e}();ge(lt,Ot,{});b(Ot,{NaN:lt.NaN,MAX_VALUE:lt.MAX_VALUE,MIN_VALUE:lt.MIN_VALUE,NEGATIVE_INFINITY:lt.NEGATIVE_INFINITY,POSITIVE_INFINITY:lt.POSITIVE_INFINITY});Number=Ot;O.redefine(S,"Number",Ot)}var mt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:mt,MIN_SAFE_INTEGER:-mt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:B,isInteger:function isInteger(e){return B(e)&&te.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&F(e)<=Number.MAX_SAFE_INTEGER},isNaN:V});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if(![,1].find(function(e,t){return t===0})){X(Array.prototype,"find",Ue.find)}if([,1].findIndex(function(e,t){return t===0})!==0){X(Array.prototype,"findIndex",Ue.findIndex)}var wt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var jt=function ensureEnumerable(e,t){if(s&&wt(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var St=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var Tt=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var It=function(e,t){var r=n(Object(t));var o;if(te.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),wt(t))}return p(P(r,o||[]),Tt(t),e)};var Et={assign:function(e,t){var r=te.ToObject(e,"Cannot convert undefined or null to object");return p(te.Call(St,1,arguments),It,r)},is:function is(e,t){return te.SameValue(e,t)}};var Pt=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(Pt){X(Object,"assign",Et.assign)}b(Object,Et);if(s){var Mt={setPrototypeOf:function(e,r){var n;var o=function(e,t){if(!te.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||te.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var i=function(e,r){o(e,r);t(n,e,r);return e};try{n=e.getOwnPropertyDescriptor(e.prototype,r).set;t(n,{},null)}catch(a){if(e.prototype!=={}[r]){return}n=function(e){this[r]=e};i.polyfill=i(i({},null),e.prototype)instanceof e}return i}(Object,"__proto__")};b(Object,Mt)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf,r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Ct=!i(function(){Object.keys("foo")});if(!Ct){var xt=Object.keys;X(Object,"keys",function keys(e){return xt(te.ToObject(e))});n=Object.keys}var Nt=i(function(){Object.keys(/a/g)});if(Nt){var At=Object.keys;X(Object,"keys",function keys(e){if(K.regex(e)){var t=[];for(var r in e){if(z(e,r)){x(t,r)}}return t}return At(e)});n=Object.keys}if(Object.getOwnPropertyNames){var Rt=!i(function(){Object.getOwnPropertyNames("foo")});if(!Rt){var _t=typeof window==="object"?Object.getOwnPropertyNames(window):[];var kt=Object.getOwnPropertyNames;X(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=te.ToObject(e);if(g(t)==="[object Window]"){try{return kt(t)}catch(r){return P([],_t)}}return kt(t)})}}if(Object.getOwnPropertyDescriptor){var Ft=!i(function(){Object.getOwnPropertyDescriptor("foo","bar")});if(!Ft){var Lt=Object.getOwnPropertyDescriptor;X(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Lt(te.ToObject(e),t)})}}if(Object.seal){var Dt=!i(function(){Object.seal("foo")});if(!Dt){var zt=Object.seal;X(Object,"seal",function seal(e){if(!K.object(e)){return e}return zt(e)})}}if(Object.isSealed){var qt=!i(function(){Object.isSealed("foo")});if(!qt){var Gt=Object.isSealed;X(Object,"isSealed",function isSealed(e){if(!K.object(e)){return true}return Gt(e)})}}if(Object.freeze){var Wt=!i(function(){Object.freeze("foo")});if(!Wt){var Ht=Object.freeze;X(Object,"freeze",function freeze(e){if(!K.object(e)){return e}return Ht(e)})}}if(Object.isFrozen){var Vt=!i(function(){Object.isFrozen("foo")});if(!Vt){var Bt=Object.isFrozen;X(Object,"isFrozen",function isFrozen(e){if(!K.object(e)){return true}return Bt(e)})}}if(Object.preventExtensions){var $t=!i(function(){Object.preventExtensions("foo")});if(!$t){var Ut=Object.preventExtensions;X(Object,"preventExtensions",function preventExtensions(e){if(!K.object(e)){return e}return Ut(e)})}}if(Object.isExtensible){var Jt=!i(function(){Object.isExtensible("foo")});if(!Jt){var Kt=Object.isExtensible;X(Object,"isExtensible",function isExtensible(e){if(!K.object(e)){return false}return Kt(e)})}}if(Object.getPrototypeOf){var Xt=!i(function(){Object.getPrototypeOf("foo")});if(!Xt){var Zt=Object.getPrototypeOf;X(Object,"getPrototypeOf",function getPrototypeOf(e){return Zt(te.ToObject(e))})}}var Yt=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&te.IsCallable(e.get)}();if(s&&!Yt){var Qt=function flags(){if(!te.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};O.getter(RegExp.prototype,"flags",Qt)}var er=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var tr=Z&&s&&function(){var e=/./;e[W.match]=false;return RegExp(e)===e}();var rr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var nr=rr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!rr||!nr){var or=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=te.RequireObjectCoercible(this);if(K.regex(e)){return t(or,e)}var r=ee(e.source);var n=ee(e.flags);return"/"+r+"/"+n},true);O.preserveToString(RegExp.prototype.toString,or)}if(s&&(!er||tr)){var ir=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var ar=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var ur=function(){return this.source};var fr=te.IsCallable(ar.get)?ar.get:ur;var sr=RegExp;var cr=function(){return function RegExp(e,t){var r=te.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(K.regex(e)){o=te.Call(fr,e);i=typeof t==="undefined"?te.Call(ir,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new sr(e,t)}}();ge(sr,cr,{$input:true});RegExp=cr;O.redefine(S,"RegExp",cr)}if(s){var lr={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(lr),function(e){if(e in RegExp&&!(lr[e]in RegExp)){O.getter(RegExp,lr[e],function get(){return RegExp[e]})}})}Oe(RegExp);var pr=1/Number.EPSILON;var vr=function roundTiesToEven(e){return e+pr-pr};var yr=Math.pow(2,-23);var hr=Math.pow(2,127)*(2-yr);var br=Math.pow(2,-126);var gr=Number.prototype.clz;delete Number.prototype.clz;var dr={acosh:function acosh(e){var t=Number(e);if(Number.isNaN(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}return L(t/Math.E+D(t+1)*D(t-1)/Math.E)+1},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}return t<0?-Math.asinh(-t):L(t+D(t*t+1))},atanh:function atanh(e){var t=Number(e);if(Number.isNaN(t)||t<-1||t>1){return NaN}if(t===-1){return-Infinity}if(t===1){return Infinity}if(t===0){return t}return.5*L((1+t)/(1-t))},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0,n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=Math.exp(L(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=te.ToUint32(t);if(r===0){return 32}return gr?te.Call(gr,r):31-k(L(r+.5)*Math.LOG2E)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(Number.isNaN(t)){return NaN}if(!T(t)){return Infinity}if(t<0){t=-t}if(t>21){return Math.exp(t)/2}return(Math.exp(t)+Math.exp(-t))/2},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(F(t)>.5){return Math.exp(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=F(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*D(r)},log2:function log2(e){return L(e)*Math.LOG2E},log10:function log10(e){return L(e)*Math.LOG10E},log1p:function log1p(e){var t=Number(e);if(t<-1||Number.isNaN(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(L(1+t)/(1+t-1))},sign:function sign(e){var t=Number(e);if(t===0){return t}if(Number.isNaN(t)){return t}return t<0?-1:1},sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}if(F(t)<1){return(Math.expm1(t)-Math.expm1(-t))/2}return(Math.exp(t-1)-Math.exp(-t-1))*Math.E/2},tanh:function tanh(e){var t=Number(e);if(Number.isNaN(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}var r=Math.expm1(t);var n=Math.expm1(-t);if(r===Infinity){return 1}if(n===Infinity){return-1}return(r-n)/(Math.exp(t)+Math.exp(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-k(-t):k(t)},imul:function imul(e,t){var r=te.ToUint32(e);var n=te.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||V(t)){return t}var r=Math.sign(t);var n=F(t);if(n<br){return r*vr(n/br/yr)*br*yr}var o=(1+yr/Number.EPSILON)*n;var i=o-(o-n);if(i>hr||V(i)){return r*Infinity}return r*i}};b(Math,dr);h(Math,"log1p",dr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",dr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));h(Math,"tanh",dr.tanh,Math.tanh(-2e-17)!==-2e-17);h(Math,"acosh",dr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"cbrt",dr.cbrt,Math.abs(1-Math.cbrt(1e-300)/1e-100)/Number.EPSILON>8);h(Math,"sinh",dr.sinh,Math.sinh(-2e-17)!==-2e-17);var Or=Math.expm1(10);h(Math,"expm1",dr.expm1,Or>22025.465794806718||Or<22025.465794806718);
var mr=Math.round;var wr=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var jr=pr+1;var Sr=2*pr-1;var Tr=[jr,Sr].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=k(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!wr||!Tr);O.preserveToString(Math.round,mr);var Ir=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=dr.imul;O.preserveToString(Math.imul,Ir)}if(Math.imul.length!==2){X(Math,"imul",function imul(e,t){return te.Call(Ir,Math,arguments)})}var Er=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}te.IsPromise=function(e){if(!te.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!te.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(te.IsCallable(t.resolve)&&te.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&te.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){x(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=A(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=te.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(te.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var O=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var m=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return O(e,new TypeError("Self resolution"))}if(!te.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return O(e,o)}if(!te.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return O(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=m(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!te.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=Se(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=m(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var M=function(e,t,r){var n=e.iterator;var o=[],i={count:1},a,u;var f=0;while(true){try{a=te.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var C=function(e,t,r){var n=e.iterator,o,i,a;while(true){try{o=te.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!te.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=te.GetIterator(e);i={iterator:o,done:false};return M(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{te.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!te.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=te.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{te.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!te.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!te.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(te.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!te.IsPromise(n)){throw new TypeError("not a promise")}var o=te.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=te.IsCallable(e)?e:a;var d=te.IsCallable(t)?t:u;var O=n._promise;var m;if(O.state===f){if(O.reactionLength===0){O.fulfillReactionHandler0=g;O.rejectReactionHandler0=d;O.reactionCapability0=i}else{var w=3*(O.reactionLength-1);O[w+l]=g;O[w+p]=d;O[w+v]=i}O.reactionLength+=1}else if(O.state===s){m=O.result;h(g,i,m)}else if(O.state===c){m=O.result;h(d,i,m)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof Er==="function"){b(S,{Promise:Er});var Pr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var Mr=!i(function(){S.Promise.reject(42).then(null,5).then(null,G)});var Cr=i(function(){S.Promise.call(3,G)});var xr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,G).then(null,G)}catch(n){return true}return t===r}(S.Promise);var Nr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Ar=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Ar.prototype=Promise.prototype;Ar.all=Promise.all;var Rr=a(function(){return!!Ar.all([1,2])});if(!Pr||!Mr||!Cr||xr||!Nr||Rr){Promise=Er;X(S,"Promise",Er)}if(Promise.all.length!==1){var _r=Promise.all;X(Promise,"all",function all(e){return te.Call(_r,this,arguments)})}if(Promise.race.length!==1){var kr=Promise.race;X(Promise,"race",function race(e){return te.Call(kr,this,arguments)})}if(Promise.resolve.length!==1){var Fr=Promise.resolve;X(Promise,"resolve",function resolve(e){return te.Call(Fr,this,arguments)})}if(Promise.reject.length!==1){var Lr=Promise.reject;X(Promise,"reject",function reject(e){return te.Call(Lr,this,arguments)})}jt(Promise,"all");jt(Promise,"race");jt(Promise,"resolve");jt(Promise,"reject");Oe(Promise)}var Dr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var zr=Dr(["z","a","bb"]);var qr=Dr(["z",1,"a","3",2]);if(s){var Gr=function fastkey(e){if(!zr){return null}if(typeof e==="undefined"||e===null){return"^"+te.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!qr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var Wr=function emptyObject(){return Object.create?Object.create(null):{}};var Hr=function addIterableToMap(e,n,o){if(r(o)||K.string(o)){l(o,function(e){if(!te.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(o!==null&&typeof o!=="undefined"){a=n.set;if(!te.IsCallable(a)){throw new TypeError("bad map")}i=te.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=te.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!te.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){te.IteratorClose(i,true);throw s}}}}};var Vr=function addIterableToSet(e,n,o){if(r(o)||K.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(o!==null&&typeof o!=="undefined"){a=n.add;if(!te.IsCallable(a)){throw new TypeError("bad set")}i=te.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=te.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){te.IteratorClose(i,true);throw s}}}}};var Br={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!te.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+te.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");this.head=e._head;this.i=this.head;this.kind=t};i.prototype={next:function next(){var e=this.i,t=this.kind,r=this.head,n;if(typeof this.i==="undefined"){return{value:void 0,done:true}}while(e.isRemoved()&&e!==r){e=e.prev}while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return{value:n,done:false}}}this.i=void 0;return{value:void 0,done:true}}};me(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=Se(this,Map,a,{_es6map:true,_head:null,_storage:Wr(),_size:0});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){Hr(Map,e,arguments[0])}return e};a=u.prototype;O.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t=Gr(e);if(t!==null){var r=this._storage[t];if(r){return r.value}else{return}}var n=this._head,i=n;while((i=i.next)!==n){if(te.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=Gr(e);if(t!==null){return typeof this._storage[t]!=="undefined"}var r=this._head,n=r;while((n=n.next)!==r){if(te.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head,i=n,a;var u=Gr(e);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}else{a=this._storage[u]=new r(e,t);i=n.prev}}while((i=i.next)!==n){if(te.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(te.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head,n=r;var i=Gr(t);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}while((n=n.next)!==r){if(te.SameValueZero(n.key,t)){n.key=n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._size=0;this._storage=Wr();var t=this._head,r=t,n=r.next;while((r=n)!==t){r.key=r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});me(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!te.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+te.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=Se(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:Wr()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){Vr(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}else{var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=e["[[SetData]]"]=new Br.Map;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};O.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=Gr(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=Gr(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=Gr(e))!==null){var n=z(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=Wr()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return this["[[SetData]]"].values()},entries:function entries(){r(this,"entries");u(this);return this["[[SetData]]"].entries()},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);me(i.prototype,i.prototype.values);return i}()};if(S.Map||S.Set){var $r=a(function(){return new Map([[1,2]]).get(1)===2});if(!$r){var Ur=S.Map;S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new Ur;if(arguments.length>0){Hr(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=m(Ur.prototype);h(S.Map.prototype,"constructor",S.Map,true);O.preserveToString(S.Map,Ur)}var Jr=new Map;var Kr=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var Xr=Jr.set(1,2)===Jr;if(!Kr||!Xr){var Zr=Map.prototype.set;X(Map.prototype,"set",function set(e,r){t(Zr,this,e===0?0:e,r);return this})}if(!Kr){var Yr=Map.prototype.get;var Qr=Map.prototype.has;b(Map.prototype,{get:function get(e){return t(Yr,this,e===0?0:e)},has:function has(e){return t(Qr,this,e===0?0:e)}},true);O.preserveToString(Map.prototype.get,Yr);O.preserveToString(Map.prototype.has,Qr)}var en=new Set;var tn=function(e){e["delete"](0);e.add(-0);return!e.has(0)}(en);var rn=en.add(1)===en;if(!tn||!rn){var nn=Set.prototype.add;Set.prototype.add=function add(e){t(nn,this,e===0?0:e);return this};O.preserveToString(Set.prototype.add,nn)}if(!tn){var on=Set.prototype.has;Set.prototype.has=function has(e){return t(on,this,e===0?0:e)};O.preserveToString(Set.prototype.has,on);var an=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(an,this,e===0?0:e)};O.preserveToString(Set.prototype["delete"],an)}var un=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var fn=Object.setPrototypeOf&&!un;var sn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||fn||!sn){var cn=S.Map;S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new cn;if(arguments.length>0){Hr(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=cn.prototype;h(S.Map.prototype,"constructor",S.Map,true);O.preserveToString(S.Map,cn)}var ln=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var pn=Object.setPrototypeOf&&!ln;var vn=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||pn||!vn){var yn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new yn;if(arguments.length>0){Vr(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=yn.prototype;h(S.Set.prototype,"constructor",S.Set,true);O.preserveToString(S.Set,yn)}var hn=!a(function(){return(new Map).keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||(new S.Map).size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof(new S.Map).keys().next!=="function"||hn||!un){b(S,{Map:Br.Map,Set:Br.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}me(Object.getPrototypeOf((new S.Map).keys()));me(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var bn=S.Set.prototype.has;X(S.Set.prototype,"has",function has(e){return t(bn,this,e)})}}b(S,Br);Oe(S.Map);Oe(S.Set)}var gn=function throwUnlessTargetIsObject(e){if(!te.TypeIsObject(e)){throw new TypeError("target must be an object")}};var dn={apply:function apply(){return te.Call(te.Call,null,arguments)},construct:function construct(e,t){if(!te.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!te.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return te.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){gn(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){gn(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(dn,{ownKeys:function ownKeys(e){gn(e);var t=Object.getOwnPropertyNames(e);if(te.IsCallable(Object.getOwnPropertySymbols)){N(t,Object.getOwnPropertySymbols(e))}return t}})}var On=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(dn,{isExtensible:function isExtensible(e){gn(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){gn(e);return On(function(){Object.preventExtensions(e)})}})}if(s){var mn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return mn(o,t,r)}if("value"in n){return n.value}if(n.get){return te.Call(n.get,r)}return void 0};var wn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return wn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!te.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return Q.defineProperty(o,r,{value:n})}else{return Q.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}}if(i.set){t(i.set,o,n);return true}return false};Object.assign(dn,{defineProperty:function defineProperty(e,t,r){gn(e);return On(function(){Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){gn(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){gn(e);var r=arguments.length>2?arguments[2]:e;return mn(e,t,r)},set:function set(e,t,r){gn(e);var n=arguments.length>3?arguments[3]:e;return wn(e,t,r,n)}})}if(Object.getPrototypeOf){var jn=Object.getPrototypeOf;dn.getPrototypeOf=function getPrototypeOf(e){gn(e);return jn(e)}}if(Object.setPrototypeOf&&dn.getPrototypeOf){var Sn=function(e,t){var r=t;while(r){if(e===r){return true}r=dn.getPrototypeOf(r)}return false};Object.assign(dn,{setPrototypeOf:function setPrototypeOf(e,t){gn(e);if(t!==null&&!te.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===Q.getPrototypeOf(e)){return true}if(Q.isExtensible&&!Q.isExtensible(e)){return false}if(Sn(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var Tn=function(e,t){if(!te.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){X(S.Reflect,e,t)}}};Object.keys(dn).forEach(function(e){Tn(e,dn[e])});var In=S.Reflect.getPrototypeOf;if(c&&In&&In.name!=="getPrototypeOf"){X(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(In,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){X(S.Reflect,"setPrototypeOf",dn.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){X(S.Reflect,"defineProperty",dn.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){X(S.Reflect,"construct",dn.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var En=Date.prototype.toString;var Pn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return te.Call(En,this)};X(Date.prototype,"toString",Pn)}var Mn={anchor:function anchor(e){return te.CreateHTML(this,"a","name",e)},big:function big(){return te.CreateHTML(this,"big","","")},blink:function blink(){return te.CreateHTML(this,"blink","","")},bold:function bold(){return te.CreateHTML(this,"b","","")},fixed:function fixed(){return te.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return te.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return te.CreateHTML(this,"font","size",e)},italics:function italics(){return te.CreateHTML(this,"i","","")},link:function link(e){return te.CreateHTML(this,"a","href",e)},small:function small(){return te.CreateHTML(this,"small","","")},strike:function strike(){return te.CreateHTML(this,"strike","","")},sub:function sub(){return te.CreateHTML(this,"sub","","")},sup:function sub(){return te.CreateHTML(this,"sup","","")}};l(Object.keys(Mn),function(e){var r=String.prototype[e];var n=false;if(te.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){X(String.prototype,e,Mn[e])}});var Cn=function(){if(!Z){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e(W())!=="undefined"){return true}if(e([W()])!=="[null]"){return true}var t={a:W()};t[W()]=true;if(e(t)!=="{}"){return true}return false}();var xn=a(function(){if(!Z){return true}return JSON.stringify(Object(W()))==="{}"&&JSON.stringify([Object(W())])==="[{}]"});if(Cn||!xn){var Nn=JSON.stringify;X(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=te.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(K.symbol(n)){return Tt({})(n)}else{return n}}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return Nn.apply(this,o)})}return S});
/*! jQuery v2.2.1 | (c) jQuery Foundation | jquery.org/license */
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=a.document,e=c.slice,f=c.concat,g=c.push,h=c.indexOf,i={},j=i.toString,k=i.hasOwnProperty,l={},m="2.2.1",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return e.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:e.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a){return n.each(this,a)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(e.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:g,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=n.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){var b=a&&a.toString();return!n.isArray(a)&&b-parseFloat(b)+1>=0},isPlainObject:function(a){return"object"!==n.type(a)||a.nodeType||n.isWindow(a)?!1:a.constructor&&!k.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?i[j.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=n.trim(a),a&&(1===a.indexOf("use strict")?(b=d.createElement("script"),b.text=a,d.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(s(a)){for(c=a.length;c>d;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):g.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:h.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,g=0,h=[];if(s(a))for(d=a.length;d>g;g++)e=b(a[g],g,c),null!=e&&h.push(e);else for(g in a)e=b(a[g],g,c),null!=e&&h.push(e);return f.apply([],h)},guid:1,proxy:function(a,b){var c,d,f;return"string"==typeof b&&(c=a[b],b=a,a=c),n.isFunction(a)?(d=e.call(arguments,2),f=function(){return a.apply(b||this,d.concat(e.call(arguments)))},f.guid=a.guid=a.guid||n.guid++,f):void 0},now:Date.now,support:l}),"function"==typeof Symbol&&(n.fn[Symbol.iterator]=c[Symbol.iterator]),n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(a,b){i["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=!!a&&"length"in a&&a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=ga(),z=ga(),A=ga(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+L+"*\\]",O=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+N+")*)|.*)\\)|)",P=new RegExp(L+"+","g"),Q=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),R=new RegExp("^"+L+"*,"+L+"*"),S=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),T=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),U=new RegExp(O),V=new RegExp("^"+M+"$"),W={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},X=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,$=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,_=/[+~]/,aa=/'|\\/g,ba=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),ca=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},da=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(ea){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function fa(a,b,d,e){var f,h,j,k,l,o,r,s,w=b&&b.ownerDocument,x=b?b.nodeType:9;if(d=d||[],"string"!=typeof a||!a||1!==x&&9!==x&&11!==x)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==x&&(o=$.exec(a)))if(f=o[1]){if(9===x){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(w&&(j=w.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(o[2])return H.apply(d,b.getElementsByTagName(a)),d;if((f=o[3])&&c.getElementsByClassName&&b.getElementsByClassName)return H.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+" "]&&(!q||!q.test(a))){if(1!==x)w=b,s=a;else if("object"!==b.nodeName.toLowerCase()){(k=b.getAttribute("id"))?k=k.replace(aa,"\\$&"):b.setAttribute("id",k=u),r=g(a),h=r.length,l=V.test(k)?"#"+k:"[id='"+k+"']";while(h--)r[h]=l+" "+qa(r[h]);s=r.join(","),w=_.test(a)&&oa(b.parentNode)||b}if(s)try{return H.apply(d,w.querySelectorAll(s)),d}catch(y){}finally{k===u&&b.removeAttribute("id")}}}return i(a.replace(Q,"$1"),b,d,e)}function ga(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ha(a){return a[u]=!0,a}function ia(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ja(a,b){var c=a.split("|"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function ka(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function la(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function na(a){return ha(function(b){return b=+b,ha(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function oa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=fa.support={},f=fa.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fa.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener("unload",da,!1):e.attachEvent&&e.attachEvent("onunload",da)),c.attributes=ia(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ia(function(a){return a.appendChild(n.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Z.test(n.getElementsByClassName),c.getById=ia(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return"undefined"!=typeof b.getElementsByClassName&&p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=Z.test(n.querySelectorAll))&&(ia(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\r\\' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),ia(function(a){var b=n.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=Z.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ia(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",O)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=Z.test(o.compareDocumentPosition),t=b||Z.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return ka(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?ka(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},fa.matches=function(a,b){return fa(a,null,null,b)},fa.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(T,"='$1']"),c.matchesSelector&&p&&!A[b+" "]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fa(b,n,null,[a]).length>0},fa.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fa.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fa.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fa.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=fa.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=fa.selectors={cacheLength:50,createPseudo:ha,match:W,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ba,ca),a[3]=(a[3]||a[4]||a[5]||"").replace(ba,ca),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||fa.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&fa.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return W.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&U.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ba,ca).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fa.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(P," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||fa.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ha(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ha(function(a){var b=[],c=[],d=h(a.replace(Q,"$1"));return d[u]?ha(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ha(function(a){return function(b){return fa(a,b).length>0}}),contains:ha(function(a){return a=a.replace(ba,ca),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ha(function(a){return V.test(a||"")||fa.error("unsupported lang: "+a),a=a.replace(ba,ca).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Y.test(a.nodeName)},input:function(a){return X.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:na(function(){return[0]}),last:na(function(a,b){return[b-1]}),eq:na(function(a,b,c){return[0>c?c+b:c]}),even:na(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:na(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:na(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:na(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=la(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=ma(b);function pa(){}pa.prototype=d.filters=d.pseudos,d.setFilters=new pa,g=fa.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=R.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=S.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(Q," ")}),h=h.slice(c.length));for(g in d.filter)!(e=W[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fa.error(a):z(a,i).slice(0)};function qa(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function ra(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j,k=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(j=b[u]||(b[u]={}),i=j[b.uniqueID]||(j[b.uniqueID]={}),(h=i[d])&&h[0]===w&&h[1]===f)return k[2]=h[2];if(i[d]=k,k[2]=a(b,c,g))return!0}}}function sa(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ta(a,b,c){for(var d=0,e=b.length;e>d;d++)fa(a,b[d],c);return c}function ua(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function va(a,b,c,d,e,f){return d&&!d[u]&&(d=va(d)),e&&!e[u]&&(e=va(e,f)),ha(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ta(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:ua(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=ua(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=ua(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function wa(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=ra(function(a){return a===b},h,!0),l=ra(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[ra(sa(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return va(i>1&&sa(m),i>1&&qa(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(Q,"$1"),c,e>i&&wa(a.slice(i,e)),f>e&&wa(a=a.slice(e)),f>e&&qa(a))}m.push(c)}return sa(m)}function xa(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s="0",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG("*",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=F.call(i));u=ua(u)}H.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&fa.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ha(f):f}return h=fa.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wa(b[c]),f[u]?d.push(f):e.push(f);f=A(a,xa(e,d)),f.selector=a}return f},i=fa.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(ba,ca),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=W.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(ba,ca),_.test(j[0].type)&&oa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qa(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||_.test(a)&&oa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ia(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ia(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ja("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ia(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ja("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ia(function(a){return null==a.getAttribute("disabled")})||ja(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fa}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.uniqueSort=n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},v=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},w=n.expr.match.needsContext,x=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,y=/^.[^:#\[\.,]*$/;function z(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(y.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return h.call(b,a)>-1!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;c>b;b++)if(n.contains(e[b],this))return!0}));for(b=0;c>b;b++)n.find(a,e[b],d);return d=this.pushStack(c>1?n.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(z(this,a||[],!1))},not:function(a){return this.pushStack(z(this,a||[],!0))},is:function(a){return!!z(this,"string"==typeof a&&w.test(a)?n(a):a||[],!1).length}});var A,B=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=n.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||A,"string"==typeof a){if(e="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:B.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),x.test(e[1])&&n.isPlainObject(b))for(e in b)n.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}return f=d.getElementById(e[2]),f&&f.parentNode&&(this.length=1,this[0]=f),this.context=d,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?void 0!==c.ready?c.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};C.prototype=n.fn,A=n(d);var D=/^(?:parents|prev(?:Until|All))/,E={children:!0,contents:!0,next:!0,prev:!0};n.fn.extend({has:function(a){var b=n(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(n.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=w.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.uniqueSort(f):f)},index:function(a){return a?"string"==typeof a?h.call(n(a),this[0]):h.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.uniqueSort(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function F(a,b){while((a=a[b])&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return u(a,"parentNode")},parentsUntil:function(a,b,c){return u(a,"parentNode",c)},next:function(a){return F(a,"nextSibling")},prev:function(a){return F(a,"previousSibling")},nextAll:function(a){return u(a,"nextSibling")},prevAll:function(a){return u(a,"previousSibling")},nextUntil:function(a,b,c){return u(a,"nextSibling",c)},prevUntil:function(a,b,c){return u(a,"previousSibling",c)},siblings:function(a){return v((a.parentNode||{}).firstChild,a)},children:function(a){return v(a.firstChild)},contents:function(a){return a.contentDocument||n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(E[a]||n.uniqueSort(e),D.test(a)&&e.reverse()),this.pushStack(e)}});var G=/\S+/g;function H(a){var b={};return n.each(a.match(G)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?H(a):n.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:"")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){n.each(b,function(b,c){n.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&"string"!==n.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return n.each(arguments,function(a,b){var c;while((c=n.inArray(b,f,c))>-1)f.splice(c,1),h>=c&&h--}),this},has:function(a){return a?n.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c="",this},disabled:function(){return!f},lock:function(){return e=g=[],c||(f=c=""),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().progress(c.notify).done(c.resolve).fail(c.reject):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=e.call(arguments),d=c.length,f=1!==d||a&&n.isFunction(a.promise)?d:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?e.call(arguments):d,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(d>1)for(i=new Array(d),j=new Array(d),k=new Array(d);d>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().progress(h(b,j,i)).done(h(b,k,c)).fail(g.reject):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(d,[n]),n.fn.triggerHandler&&(n(d).triggerHandler("ready"),n(d).off("ready"))))}});function J(){d.removeEventListener("DOMContentLoaded",J),a.removeEventListener("load",J),n.ready()}n.ready.promise=function(b){return I||(I=n.Deferred(),"complete"===d.readyState||"loading"!==d.readyState&&!d.documentElement.doScroll?a.setTimeout(n.ready):(d.addEventListener("DOMContentLoaded",J),a.addEventListener("load",J))),I.promise(b)},n.ready.promise();var K=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)K(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},L=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function M(){this.expando=n.expando+M.uid++}M.uid=1,M.prototype={register:function(a,b){var c=b||{};return a.nodeType?a[this.expando]=c:Object.defineProperty(a,this.expando,{value:c,writable:!0,configurable:!0}),a[this.expando]},cache:function(a){if(!L(a))return{};var b=a[this.expando];return b||(b={},L(a)&&(a.nodeType?a[this.expando]=b:Object.defineProperty(a,this.expando,{value:b,configurable:!0}))),b},set:function(a,b,c){var d,e=this.cache(a);if("string"==typeof b)e[b]=c;else for(d in b)e[d]=b[d];return e},get:function(a,b){return void 0===b?this.cache(a):a[this.expando]&&a[this.expando][b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,n.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=a[this.expando];if(void 0!==f){if(void 0===b)this.register(a);else{n.isArray(b)?d=b.concat(b.map(n.camelCase)):(e=n.camelCase(b),b in f?d=[b,e]:(d=e,d=d in f?[d]:d.match(G)||[])),c=d.length;while(c--)delete f[d[c]]}(void 0===b||n.isEmptyObject(f))&&(a.nodeType?a[this.expando]=void 0:delete a[this.expando])}},hasData:function(a){var b=a[this.expando];return void 0!==b&&!n.isEmptyObject(b)}};var N=new M,O=new M,P=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Q=/[A-Z]/g;function R(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(Q,"-$&").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:P.test(c)?n.parseJSON(c):c}catch(e){}O.set(a,b,c);
}else c=void 0;return c}n.extend({hasData:function(a){return O.hasData(a)||N.hasData(a)},data:function(a,b,c){return O.access(a,b,c)},removeData:function(a,b){O.remove(a,b)},_data:function(a,b,c){return N.access(a,b,c)},_removeData:function(a,b){N.remove(a,b)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=O.get(f),1===f.nodeType&&!N.get(f,"hasDataAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),R(f,d,e[d])));N.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){O.set(this,a)}):K(this,function(b){var c,d;if(f&&void 0===b){if(c=O.get(f,a)||O.get(f,a.replace(Q,"-$&").toLowerCase()),void 0!==c)return c;if(d=n.camelCase(a),c=O.get(f,d),void 0!==c)return c;if(c=R(f,d,void 0),void 0!==c)return c}else d=n.camelCase(a),this.each(function(){var c=O.get(this,d);O.set(this,d,b),a.indexOf("-")>-1&&void 0!==c&&O.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){O.remove(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=N.get(a,b),c&&(!d||n.isArray(c)?d=N.access(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return N.get(a,c)||N.access(a,c,{empty:n.Callbacks("once memory").add(function(){N.remove(a,[b+"queue",c])})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=N.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var S=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,T=new RegExp("^(?:([+-])=|)("+S+")([a-z%]*)$","i"),U=["Top","Right","Bottom","Left"],V=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)};function W(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return n.css(a,b,"")},i=h(),j=c&&c[3]||(n.cssNumber[b]?"":"px"),k=(n.cssNumber[b]||"px"!==j&&+i)&&T.exec(n.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||".5",k/=f,n.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var X=/^(?:checkbox|radio)$/i,Y=/<([\w:-]+)/,Z=/^$|\/(?:java|ecma)script/i,$={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};$.optgroup=$.option,$.tbody=$.tfoot=$.colgroup=$.caption=$.thead,$.th=$.td;function _(a,b){var c="undefined"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||"*"):"undefined"!=typeof a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&n.nodeName(a,b)?n.merge([a],c):c}function aa(a,b){for(var c=0,d=a.length;d>c;c++)N.set(a[c],"globalEval",!b||N.get(b[c],"globalEval"))}var ba=/<|&#?\w+;/;function ca(a,b,c,d,e){for(var f,g,h,i,j,k,l=b.createDocumentFragment(),m=[],o=0,p=a.length;p>o;o++)if(f=a[o],f||0===f)if("object"===n.type(f))n.merge(m,f.nodeType?[f]:f);else if(ba.test(f)){g=g||l.appendChild(b.createElement("div")),h=(Y.exec(f)||["",""])[1].toLowerCase(),i=$[h]||$._default,g.innerHTML=i[1]+n.htmlPrefilter(f)+i[2],k=i[0];while(k--)g=g.lastChild;n.merge(m,g.childNodes),g=l.firstChild,g.textContent=""}else m.push(b.createTextNode(f));l.textContent="",o=0;while(f=m[o++])if(d&&n.inArray(f,d)>-1)e&&e.push(f);else if(j=n.contains(f.ownerDocument,f),g=_(l.appendChild(f),"script"),j&&aa(g),c){k=0;while(f=g[k++])Z.test(f.type||"")&&c.push(f)}return l}!function(){var a=d.createDocumentFragment(),b=a.appendChild(d.createElement("div")),c=d.createElement("input");c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),b.appendChild(c),l.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var da=/^key/,ea=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,fa=/^([^.]*)(?:\.(.+)|)/;function ga(){return!0}function ha(){return!1}function ia(){try{return d.activeElement}catch(a){}}function ja(a,b,c,d,e,f){var g,h;if("object"==typeof b){"string"!=typeof c&&(d=d||c,c=void 0);for(h in b)ja(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&("string"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=ha;else if(!e)return a;return 1===f&&(g=e,e=function(a){return n().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=n.guid++)),a.each(function(){n.event.add(this,b,e,d,c)})}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=N.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=n.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return"undefined"!=typeof n&&n.event.triggered!==b.type?n.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(G)||[""],j=b.length;while(j--)h=fa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o&&(l=n.event.special[o]||{},o=(e?l.delegateType:l.bindType)||o,l=n.event.special[o]||{},k=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[o])||(m=i[o]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(o,g)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),n.event.global[o]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=N.hasData(a)&&N.get(a);if(r&&(i=r.events)){b=(b||"").match(G)||[""],j=b.length;while(j--)if(h=fa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=i[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete i[o])}else for(o in i)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(i)&&N.remove(a,"handle events")}},dispatch:function(a){a=n.event.fix(a);var b,c,d,f,g,h=[],i=e.call(arguments),j=(N.get(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.rnamespace||a.rnamespace.test(g.namespace))&&(a.handleObj=g,a.data=g.data,d=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&("click"!==a.type||isNaN(a.button)||a.button<1))for(;i!==this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>-1:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,e,f,g=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||d,e=c.documentElement,f=c.body,a.pageX=b.clientX+(e&&e.scrollLeft||f&&f.scrollLeft||0)-(e&&e.clientLeft||f&&f.clientLeft||0),a.pageY=b.clientY+(e&&e.scrollTop||f&&f.scrollTop||0)-(e&&e.clientTop||f&&f.clientTop||0)),a.which||void 0===g||(a.which=1&g?1:2&g?3:4&g?2:0),a}},fix:function(a){if(a[n.expando])return a;var b,c,e,f=a.type,g=a,h=this.fixHooks[f];h||(this.fixHooks[f]=h=ea.test(f)?this.mouseHooks:da.test(f)?this.keyHooks:{}),e=h.props?this.props.concat(h.props):this.props,a=new n.Event(g),b=e.length;while(b--)c=e[b],a[c]=g[c];return a.target||(a.target=d),3===a.target.nodeType&&(a.target=a.target.parentNode),h.filter?h.filter(a,g):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==ia()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===ia()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&n.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}}},n.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?ga:ha):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={constructor:n.Event,isDefaultPrevented:ha,isPropagationStopped:ha,isImmediatePropagationStopped:ha,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=ga,a&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=ga,a&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=ga,a&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),n.fn.extend({on:function(a,b,c,d){return ja(this,a,b,c,d)},one:function(a,b,c,d){return ja(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=ha),this.each(function(){n.event.remove(this,a,c,b)})}});var ka=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,la=/<script|<style|<link/i,ma=/checked\s*(?:[^=]|=\s*.checked.)/i,na=/^true\/(.*)/,oa=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function pa(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function qa(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function ra(a){var b=na.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function sa(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(N.hasData(a)&&(f=N.access(a),g=N.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)n.event.add(b,e,j[e][c])}O.hasData(a)&&(h=O.access(a),i=n.extend({},h),O.set(b,i))}}function ta(a,b){var c=b.nodeName.toLowerCase();"input"===c&&X.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}function ua(a,b,c,d){b=f.apply([],b);var e,g,h,i,j,k,m=0,o=a.length,p=o-1,q=b[0],r=n.isFunction(q);if(r||o>1&&"string"==typeof q&&!l.checkClone&&ma.test(q))return a.each(function(e){var f=a.eq(e);r&&(b[0]=q.call(this,e,f.html())),ua(f,b,c,d)});if(o&&(e=ca(b,a[0].ownerDocument,!1,a,d),g=e.firstChild,1===e.childNodes.length&&(e=g),g||d)){for(h=n.map(_(e,"script"),qa),i=h.length;o>m;m++)j=e,m!==p&&(j=n.clone(j,!0,!0),i&&n.merge(h,_(j,"script"))),c.call(a[m],j,m);if(i)for(k=h[h.length-1].ownerDocument,n.map(h,ra),m=0;i>m;m++)j=h[m],Z.test(j.type||"")&&!N.access(j,"globalEval")&&n.contains(k,j)&&(j.src?n._evalUrl&&n._evalUrl(j.src):n.globalEval(j.textContent.replace(oa,"")))}return a}function va(a,b,c){for(var d,e=b?n.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||n.cleanData(_(d)),d.parentNode&&(c&&n.contains(d.ownerDocument,d)&&aa(_(d,"script")),d.parentNode.removeChild(d));return a}n.extend({htmlPrefilter:function(a){return a.replace(ka,"<$1></$2>")},clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=n.contains(a.ownerDocument,a);if(!(l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(g=_(h),f=_(a),d=0,e=f.length;e>d;d++)ta(f[d],g[d]);if(b)if(c)for(f=f||_(a),g=g||_(h),d=0,e=f.length;e>d;d++)sa(f[d],g[d]);else sa(a,h);return g=_(h,"script"),g.length>0&&aa(g,!i&&_(a,"script")),h},cleanData:function(a){for(var b,c,d,e=n.event.special,f=0;void 0!==(c=a[f]);f++)if(L(c)){if(b=c[N.expando]){if(b.events)for(d in b.events)e[d]?n.event.remove(c,d):n.removeEvent(c,d,b.handle);c[N.expando]=void 0}c[O.expando]&&(c[O.expando]=void 0)}}}),n.fn.extend({domManip:ua,detach:function(a){return va(this,a,!0)},remove:function(a){return va(this,a)},text:function(a){return K(this,function(a){return void 0===a?n.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return ua(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=pa(this,a);b.appendChild(a)}})},prepend:function(){return ua(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=pa(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return ua(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return ua(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(n.cleanData(_(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return K(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!la.test(a)&&!$[(Y.exec(a)||["",""])[1].toLowerCase()]){a=n.htmlPrefilter(a);try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(_(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return ua(this,arguments,function(b){var c=this.parentNode;n.inArray(this,a)<0&&(n.cleanData(_(this)),c&&c.replaceChild(b,this))},a)}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=[],e=n(a),f=e.length-1,h=0;f>=h;h++)c=h===f?this:this.clone(!0),n(e[h])[b](c),g.apply(d,c.get());return this.pushStack(d)}});var wa,xa={HTML:"block",BODY:"block"};function ya(a,b){var c=n(b.createElement(a)).appendTo(b.body),d=n.css(c[0],"display");return c.detach(),d}function za(a){var b=d,c=xa[a];return c||(c=ya(a,b),"none"!==c&&c||(wa=(wa||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=wa[0].contentDocument,b.write(),b.close(),c=ya(a,b),wa.detach()),xa[a]=c),c}var Aa=/^margin/,Ba=new RegExp("^("+S+")(?!px)[a-z%]+$","i"),Ca=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)},Da=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e},Ea=d.documentElement;!function(){var b,c,e,f,g=d.createElement("div"),h=d.createElement("div");if(h.style){h.style.backgroundClip="content-box",h.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===h.style.backgroundClip,g.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",g.appendChild(h);function i(){h.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",h.innerHTML="",Ea.appendChild(g);var d=a.getComputedStyle(h);b="1%"!==d.top,f="2px"===d.marginLeft,c="4px"===d.width,h.style.marginRight="50%",e="4px"===d.marginRight,Ea.removeChild(g)}n.extend(l,{pixelPosition:function(){return i(),b},boxSizingReliable:function(){return null==c&&i(),c},pixelMarginRight:function(){return null==c&&i(),e},reliableMarginLeft:function(){return null==c&&i(),f},reliableMarginRight:function(){var b,c=h.appendChild(d.createElement("div"));return c.style.cssText=h.style.cssText="-webkit-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",h.style.width="1px",Ea.appendChild(g),b=!parseFloat(a.getComputedStyle(c).marginRight),Ea.removeChild(g),h.removeChild(c),b}})}}();function Fa(a,b,c){var d,e,f,g,h=a.style;return c=c||Ca(a),g=c?c.getPropertyValue(b)||c[b]:void 0,""!==g&&void 0!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),c&&!l.pixelMarginRight()&&Ba.test(g)&&Aa.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f),void 0!==g?g+"":g}function Ga(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Ha=/^(none|table(?!-c[ea]).+)/,Ia={position:"absolute",visibility:"hidden",display:"block"},Ja={letterSpacing:"0",fontWeight:"400"},Ka=["Webkit","O","Moz","ms"],La=d.createElement("div").style;function Ma(a){if(a in La)return a;var b=a[0].toUpperCase()+a.slice(1),c=Ka.length;while(c--)if(a=Ka[c]+b,a in La)return a}function Na(a,b,c){var d=T.exec(b);return d?Math.max(0,d[2]-(c||0))+(d[3]||"px"):b}function Oa(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+U[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+U[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+U[f]+"Width",!0,e))):(g+=n.css(a,"padding"+U[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+U[f]+"Width",!0,e)));return g}function Pa(b,c,e){var f=!0,g="width"===c?b.offsetWidth:b.offsetHeight,h=Ca(b),i="border-box"===n.css(b,"boxSizing",!1,h);if(d.msFullscreenElement&&a.top!==a&&b.getClientRects().length&&(g=Math.round(100*b.getBoundingClientRect()[c])),0>=g||null==g){if(g=Fa(b,c,h),(0>g||null==g)&&(g=b.style[c]),Ba.test(g))return g;f=i&&(l.boxSizingReliable()||g===b.style[c]),g=parseFloat(g)||0}return g+Oa(b,c,e||(i?"border":"content"),f,h)+"px"}function Qa(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=N.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&V(d)&&(f[g]=N.access(d,"olddisplay",za(d.nodeName)))):(e=V(d),"none"===c&&e||N.set(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Fa(a,"opacity");return""===c?"1":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;return b=n.cssProps[h]||(n.cssProps[h]=Ma(h)||h),g=n.cssHooks[b]||n.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=T.exec(c))&&e[1]&&(c=W(a,b,e),f="number"),null!=c&&c===c&&("number"===f&&(c+=e&&e[3]||(n.cssNumber[h]?"":"px")),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Ma(h)||h),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=Fa(a,b,d)),"normal"===e&&b in Ja&&(e=Ja[b]),""===c||c?(f=parseFloat(e),c===!0||isFinite(f)?f||0:e):e}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?Ha.test(n.css(a,"display"))&&0===a.offsetWidth?Da(a,Ia,function(){return Pa(a,b,d)}):Pa(a,b,d):void 0},set:function(a,c,d){var e,f=d&&Ca(a),g=d&&Oa(a,b,d,"border-box"===n.css(a,"boxSizing",!1,f),f);return g&&(e=T.exec(c))&&"px"!==(e[3]||"px")&&(a.style[b]=c,c=n.css(a,b)),Na(a,c,g)}}}),n.cssHooks.marginLeft=Ga(l.reliableMarginLeft,function(a,b){return b?(parseFloat(Fa(a,"marginLeft"))||a.getBoundingClientRect().left-Da(a,{marginLeft:0},function(){return a.getBoundingClientRect().left}))+"px":void 0}),n.cssHooks.marginRight=Ga(l.reliableMarginRight,function(a,b){return b?Da(a,{display:"inline-block"},Fa,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+U[d]+b]=f[d]||f[d-2]||f[0];return e}},Aa.test(a)||(n.cssHooks[a+b].set=Na)}),n.fn.extend({css:function(a,b){return K(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Ca(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return Qa(this,!0)},hide:function(){return Qa(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){V(this)?n(this).show():n(this).hide()})}});function Ra(a,b,c,d,e){return new Ra.prototype.init(a,b,c,d,e)}n.Tween=Ra,Ra.prototype={constructor:Ra,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||n.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=Ra.propHooks[this.prop];return a&&a.get?a.get(this):Ra.propHooks._default.get(this)},run:function(a){var b,c=Ra.propHooks[this.prop];return this.options.duration?this.pos=b=n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Ra.propHooks._default.set(this),this}},Ra.prototype.init.prototype=Ra.prototype,Ra.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0)},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[n.cssProps[a.prop]]&&!n.cssHooks[a.prop]?a.elem[a.prop]=a.now:n.style(a.elem,a.prop,a.now+a.unit)}}},Ra.propHooks.scrollTop=Ra.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:"swing"},n.fx=Ra.prototype.init,n.fx.step={};var Sa,Ta,Ua=/^(?:toggle|show|hide)$/,Va=/queueHooks$/;function Wa(){return a.setTimeout(function(){Sa=void 0}),Sa=n.now()}function Xa(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=U[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ya(a,b,c){for(var d,e=(_a.tweeners[b]||[]).concat(_a.tweeners["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Za(a,b,c){var d,e,f,g,h,i,j,k,l=this,m={},o=a.style,p=a.nodeType&&V(a),q=N.get(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,l.always(function(){l.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=n.css(a,"display"),k="none"===j?N.get(a,"olddisplay")||za(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(o.display="inline-block")),c.overflow&&(o.overflow="hidden",l.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Ua.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(p?"hide":"show")){if("show"!==e||!q||void 0===q[d])continue;p=!0}m[d]=q&&q[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(m))"inline"===("none"===j?za(a.nodeName):j)&&(o.display=j);else{q?"hidden"in q&&(p=q.hidden):q=N.access(a,"fxshow",{}),f&&(q.hidden=!p),p?n(a).show():l.done(function(){n(a).hide()}),l.done(function(){var b;N.remove(a,"fxshow");for(b in m)n.style(a,b,m[b])});for(d in m)g=Ya(p?q[d]:0,d,l),d in q||(q[d]=g.start,p&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function $a(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function _a(a,b,c){var d,e,f=0,g=_a.prefilters.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Sa||Wa(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{},easing:n.easing._default},c),originalProperties:b,originalOptions:c,startTime:Sa||Wa(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for($a(k,j.opts.specialEasing);g>f;f++)if(d=_a.prefilters[f].call(j,a,k,j.opts))return n.isFunction(d.stop)&&(n._queueHooks(j.elem,j.opts.queue).stop=n.proxy(d.stop,d)),d;return n.map(k,Ya,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(_a,{tweeners:{"*":[function(a,b){var c=this.createTween(a,b);return W(c.elem,a,T.exec(b),c),c}]},tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.match(G);for(var c,d=0,e=a.length;e>d;d++)c=a[d],_a.tweeners[c]=_a.tweeners[c]||[],_a.tweeners[c].unshift(b)},prefilters:[Za],prefilter:function(a,b){b?_a.prefilters.unshift(a):_a.prefilters.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(V).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=_a(this,n.extend({},a),f);(e||N.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=N.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Va.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=N.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Xa(b,!0),a,d,e)}}),n.each({slideDown:Xa("show"),slideUp:Xa("hide"),slideToggle:Xa("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=0,c=n.timers;for(Sa=n.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||n.fx.stop(),Sa=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){Ta||(Ta=a.setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){a.clearInterval(Ta),Ta=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(b,c){return b=n.fx?n.fx.speeds[b]||b:b,c=c||"fx",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a=d.createElement("input"),b=d.createElement("select"),c=b.appendChild(d.createElement("option"));a.type="checkbox",l.checkOn=""!==a.value,l.optSelected=c.selected,b.disabled=!0,l.optDisabled=!c.disabled,a=d.createElement("input"),a.value="t",a.type="radio",l.radioValue="t"===a.value}();var ab,bb=n.expr.attrHandle;n.fn.extend({attr:function(a,b){return K(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return"undefined"==typeof a.getAttribute?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),e=n.attrHooks[b]||(n.expr.match.bool.test(b)?ab:void 0)),void 0!==c?null===c?void n.removeAttr(a,b):e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+""),c):e&&"get"in e&&null!==(d=e.get(a,b))?d:(d=n.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(G);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)}}),ab={set:function(a,b,c){return b===!1?n.removeAttr(a,c):a.setAttribute(c,c),c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=bb[b]||n.find.attr;bb[b]=function(a,b,d){var e,f;return d||(f=bb[b],bb[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,bb[b]=f),e}});var cb=/^(?:input|select|textarea|button)$/i,db=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return K(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[n.propFix[a]||a]})}}),n.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&n.isXMLDoc(a)||(b=n.propFix[b]||b,
e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):cb.test(a.nodeName)||db.test(a.nodeName)&&a.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this});var eb=/[\t\r\n\f]/g;function fb(a){return a.getAttribute&&a.getAttribute("class")||""}n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,fb(this)))});if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=fb(c),d=1===c.nodeType&&(" "+e+" ").replace(eb," ")){g=0;while(f=b[g++])d.indexOf(" "+f+" ")<0&&(d+=f+" ");h=n.trim(d),e!==h&&c.setAttribute("class",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,fb(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=fb(c),d=1===c.nodeType&&(" "+e+" ").replace(eb," ")){g=0;while(f=b[g++])while(d.indexOf(" "+f+" ")>-1)d=d.replace(" "+f+" "," ");h=n.trim(d),e!==h&&c.setAttribute("class",h)}}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):n.isFunction(a)?this.each(function(c){n(this).toggleClass(a.call(this,c,fb(this),b),b)}):this.each(function(){var b,d,e,f;if("string"===c){d=0,e=n(this),f=a.match(G)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(void 0===a||"boolean"===c)&&(b=fb(this),b&&N.set(this,"__className__",b),this.setAttribute&&this.setAttribute("class",b||a===!1?"":N.get(this,"__className__")||""))})},hasClass:function(a){var b,c,d=0;b=" "+a+" ";while(c=this[d++])if(1===c.nodeType&&(" "+fb(c)+" ").replace(eb," ").indexOf(b)>-1)return!0;return!1}});var gb=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(gb,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){return n.trim(a.value)}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],(c.selected||i===e)&&(l.optDisabled?!c.disabled:null===c.getAttribute("disabled"))&&(!c.parentNode.disabled||!n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=n.inArray(n.valHooks.option.get(d),f)>-1)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>-1:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var hb=/^(?:focusinfocus|focusoutblur)$/;n.extend(n.event,{trigger:function(b,c,e,f){var g,h,i,j,l,m,o,p=[e||d],q=k.call(b,"type")?b.type:b,r=k.call(b,"namespace")?b.namespace.split("."):[];if(h=i=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!hb.test(q+n.event.triggered)&&(q.indexOf(".")>-1&&(r=q.split("."),q=r.shift(),r.sort()),l=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=r.join("."),b.rnamespace=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:n.makeArray(c,[b]),o=n.event.special[q]||{},f||!o.trigger||o.trigger.apply(e,c)!==!1)){if(!f&&!o.noBubble&&!n.isWindow(e)){for(j=o.delegateType||q,hb.test(j+q)||(h=h.parentNode);h;h=h.parentNode)p.push(h),i=h;i===(e.ownerDocument||d)&&p.push(i.defaultView||i.parentWindow||a)}g=0;while((h=p[g++])&&!b.isPropagationStopped())b.type=g>1?j:o.bindType||q,m=(N.get(h,"events")||{})[b.type]&&N.get(h,"handle"),m&&m.apply(h,c),m=l&&h[l],m&&m.apply&&L(h)&&(b.result=m.apply(h,c),b.result===!1&&b.preventDefault());return b.type=q,f||b.isDefaultPrevented()||o._default&&o._default.apply(p.pop(),c)!==!1||!L(e)||l&&n.isFunction(e[q])&&!n.isWindow(e)&&(i=e[l],i&&(e[l]=null),n.event.triggered=q,e[q](),n.event.triggered=void 0,i&&(e[l]=i)),b.result}},simulate:function(a,b,c){var d=n.extend(new n.Event,c,{type:a,isSimulated:!0});n.event.trigger(d,null,b),d.isDefaultPrevented()&&c.preventDefault()}}),n.fn.extend({trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),l.focusin="onfocusin"in a,l.focusin||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a))};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=N.access(d,b);e||d.addEventListener(a,c,!0),N.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=N.access(d,b)-1;e?N.access(d,b,e):(d.removeEventListener(a,c,!0),N.remove(d,b))}}});var ib=a.location,jb=n.now(),kb=/\?/;n.parseJSON=function(a){return JSON.parse(a+"")},n.parseXML=function(b){var c;if(!b||"string"!=typeof b)return null;try{c=(new a.DOMParser).parseFromString(b,"text/xml")}catch(d){c=void 0}return(!c||c.getElementsByTagName("parsererror").length)&&n.error("Invalid XML: "+b),c};var lb=/#.*$/,mb=/([?&])_=[^&]*/,nb=/^(.*?):[ \t]*([^\r\n]*)$/gm,ob=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,pb=/^(?:GET|HEAD)$/,qb=/^\/\//,rb={},sb={},tb="*/".concat("*"),ub=d.createElement("a");ub.href=ib.href;function vb(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(G)||[];if(n.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function wb(a,b,c,d){var e={},f=a===sb;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function xb(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&n.extend(!0,a,d),a}function yb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function zb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ib.href,type:"GET",isLocal:ob.test(ib.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":tb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?xb(xb(a,n.ajaxSettings),b):xb(n.ajaxSettings,a)},ajaxPrefilter:vb(rb),ajaxTransport:vb(sb),ajax:function(b,c){"object"==typeof b&&(c=b,b=void 0),c=c||{};var e,f,g,h,i,j,k,l,m=n.ajaxSetup({},c),o=m.context||m,p=m.context&&(o.nodeType||o.jquery)?n(o):n.event,q=n.Deferred(),r=n.Callbacks("once memory"),s=m.statusCode||{},t={},u={},v=0,w="canceled",x={readyState:0,getResponseHeader:function(a){var b;if(2===v){if(!h){h={};while(b=nb.exec(g))h[b[1].toLowerCase()]=b[2]}b=h[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===v?g:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return v||(a=u[c]=u[c]||a,t[a]=b),this},overrideMimeType:function(a){return v||(m.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>v)for(b in a)s[b]=[s[b],a[b]];else x.always(a[x.status]);return this},abort:function(a){var b=a||w;return e&&e.abort(b),z(0,b),this}};if(q.promise(x).complete=r.add,x.success=x.done,x.error=x.fail,m.url=((b||m.url||ib.href)+"").replace(lb,"").replace(qb,ib.protocol+"//"),m.type=c.method||c.type||m.method||m.type,m.dataTypes=n.trim(m.dataType||"*").toLowerCase().match(G)||[""],null==m.crossDomain){j=d.createElement("a");try{j.href=m.url,j.href=j.href,m.crossDomain=ub.protocol+"//"+ub.host!=j.protocol+"//"+j.host}catch(y){m.crossDomain=!0}}if(m.data&&m.processData&&"string"!=typeof m.data&&(m.data=n.param(m.data,m.traditional)),wb(rb,m,c,x),2===v)return x;k=n.event&&m.global,k&&0===n.active++&&n.event.trigger("ajaxStart"),m.type=m.type.toUpperCase(),m.hasContent=!pb.test(m.type),f=m.url,m.hasContent||(m.data&&(f=m.url+=(kb.test(f)?"&":"?")+m.data,delete m.data),m.cache===!1&&(m.url=mb.test(f)?f.replace(mb,"$1_="+jb++):f+(kb.test(f)?"&":"?")+"_="+jb++)),m.ifModified&&(n.lastModified[f]&&x.setRequestHeader("If-Modified-Since",n.lastModified[f]),n.etag[f]&&x.setRequestHeader("If-None-Match",n.etag[f])),(m.data&&m.hasContent&&m.contentType!==!1||c.contentType)&&x.setRequestHeader("Content-Type",m.contentType),x.setRequestHeader("Accept",m.dataTypes[0]&&m.accepts[m.dataTypes[0]]?m.accepts[m.dataTypes[0]]+("*"!==m.dataTypes[0]?", "+tb+"; q=0.01":""):m.accepts["*"]);for(l in m.headers)x.setRequestHeader(l,m.headers[l]);if(m.beforeSend&&(m.beforeSend.call(o,x,m)===!1||2===v))return x.abort();w="abort";for(l in{success:1,error:1,complete:1})x[l](m[l]);if(e=wb(sb,m,c,x)){if(x.readyState=1,k&&p.trigger("ajaxSend",[x,m]),2===v)return x;m.async&&m.timeout>0&&(i=a.setTimeout(function(){x.abort("timeout")},m.timeout));try{v=1,e.send(t,z)}catch(y){if(!(2>v))throw y;z(-1,y)}}else z(-1,"No Transport");function z(b,c,d,h){var j,l,t,u,w,y=c;2!==v&&(v=2,i&&a.clearTimeout(i),e=void 0,g=h||"",x.readyState=b>0?4:0,j=b>=200&&300>b||304===b,d&&(u=yb(m,x,d)),u=zb(m,u,x,j),j?(m.ifModified&&(w=x.getResponseHeader("Last-Modified"),w&&(n.lastModified[f]=w),w=x.getResponseHeader("etag"),w&&(n.etag[f]=w)),204===b||"HEAD"===m.type?y="nocontent":304===b?y="notmodified":(y=u.state,l=u.data,t=u.error,j=!t)):(t=y,(b||!y)&&(y="error",0>b&&(b=0))),x.status=b,x.statusText=(c||y)+"",j?q.resolveWith(o,[l,y,x]):q.rejectWith(o,[x,y,t]),x.statusCode(s),s=void 0,k&&p.trigger(j?"ajaxSuccess":"ajaxError",[x,m,j?l:t]),r.fireWith(o,[x,y]),k&&(p.trigger("ajaxComplete",[x,m]),--n.active||n.event.trigger("ajaxStop")))}return x},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax(n.extend({url:a,type:b,dataType:e,data:c,success:d},n.isPlainObject(a)&&a))}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){var b;return n.isFunction(a)?this.each(function(b){n(this).wrapAll(a.call(this,b))}):(this[0]&&(b=n(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return n.isFunction(a)?this.each(function(b){n(this).wrapInner(a.call(this,b))}):this.each(function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return!n.expr.filters.visible(a)},n.expr.filters.visible=function(a){return a.offsetWidth>0||a.offsetHeight>0||a.getClientRects().length>0};var Ab=/%20/g,Bb=/\[\]$/,Cb=/\r?\n/g,Db=/^(?:submit|button|image|reset|file)$/i,Eb=/^(?:input|select|textarea|keygen)/i;function Fb(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||Bb.test(a)?d(a,e):Fb(a+"["+("object"==typeof e&&null!=e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Fb(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Fb(c,a[c],b,e);return d.join("&").replace(Ab,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&Eb.test(this.nodeName)&&!Db.test(a)&&(this.checked||!X.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(Cb,"\r\n")}}):{name:b.name,value:c.replace(Cb,"\r\n")}}).get()}}),n.ajaxSettings.xhr=function(){try{return new a.XMLHttpRequest}catch(b){}};var Gb={0:200,1223:204},Hb=n.ajaxSettings.xhr();l.cors=!!Hb&&"withCredentials"in Hb,l.ajax=Hb=!!Hb,n.ajaxTransport(function(b){var c,d;return l.cors||Hb&&!b.crossDomain?{send:function(e,f){var g,h=b.xhr();if(h.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(g in b.xhrFields)h[g]=b.xhrFields[g];b.mimeType&&h.overrideMimeType&&h.overrideMimeType(b.mimeType),b.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest");for(g in e)h.setRequestHeader(g,e[g]);c=function(a){return function(){c&&(c=d=h.onload=h.onerror=h.onabort=h.onreadystatechange=null,"abort"===a?h.abort():"error"===a?"number"!=typeof h.status?f(0,"error"):f(h.status,h.statusText):f(Gb[h.status]||h.status,h.statusText,"text"!==(h.responseType||"text")||"string"!=typeof h.responseText?{binary:h.response}:{text:h.responseText},h.getAllResponseHeaders()))}},h.onload=c(),d=h.onerror=c("error"),void 0!==h.onabort?h.onabort=d:h.onreadystatechange=function(){4===h.readyState&&a.setTimeout(function(){c&&d()})},c=c("abort");try{h.send(b.hasContent&&b.data||null)}catch(i){if(c)throw i}},abort:function(){c&&c()}}:void 0}),n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(e,f){b=n("<script>").prop({charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&f("error"===a.type?404:200,a.type)}),d.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Ib=[],Jb=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Ib.pop()||n.expando+"_"+jb++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Jb.test(b.url)?"url":"string"==typeof b.data&&0===(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Jb.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Jb,"$1"+e):b.jsonp!==!1&&(b.url+=(kb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?n(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Ib.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),l.createHTMLDocument=function(){var a=d.implementation.createHTMLDocument("").body;return a.innerHTML="<form></form><form></form>",2===a.childNodes.length}(),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||(l.createHTMLDocument?d.implementation.createHTMLDocument(""):d);var e=x.exec(a),f=!c&&[];return e?[b.createElement(e[1])]:(e=ca([a],b,f),f&&f.length&&n(f).remove(),n.merge([],e.childNodes))};var Kb=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&Kb)return Kb.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>-1&&(d=n.trim(a.slice(h)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e||"GET",dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(g,f||[a.responseText,b,a])})}),this},n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};function Lb(a){return n.isWindow(a)?a:9===a.nodeType&&a.defaultView}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,n.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,n.contains(b,d)?(e=d.getBoundingClientRect(),c=Lb(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===n.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(d=a.offset()),d.top+=n.css(a[0],"borderTopWidth",!0),d.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-n.css(c,"marginTop",!0),left:b.left-d.left-n.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Ea})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c="pageYOffset"===b;n.fn[a]=function(d){return K(this,function(a,d,e){var f=Lb(a);return void 0===e?f?f[b]:a[d]:void(f?f.scrollTo(c?f.pageXOffset:e,c?e:f.pageYOffset):a[d]=e)},a,d,arguments.length)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=Ga(l.pixelPosition,function(a,c){return c?(c=Fa(a,b),Ba.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return K(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)},size:function(){return this.length}}),n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var Mb=a.jQuery,Nb=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=Nb),b&&a.jQuery===n&&(a.jQuery=Mb),n},b||(a.jQuery=a.$=n),n});
/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);
/*!
 * imagesLoaded PACKAGED v4.1.0
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
!function(t,e){"function"==typeof define&&define.amd?define("ev-emitter/ev-emitter",e):"object"==typeof module&&module.exports?module.exports=e():t.EvEmitter=e()}(this,function(){function t(){}var e=t.prototype;return e.on=function(t,e){if(t&&e){var i=this._events=this._events||{},n=i[t]=i[t]||[];return-1==n.indexOf(e)&&n.push(e),this}},e.once=function(t,e){if(t&&e){this.on(t,e);var i=this._onceEvents=this._onceEvents||{},n=i[t]=i[t]||[];return n[e]=!0,this}},e.off=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=i.indexOf(e);return-1!=n&&i.splice(n,1),this}},e.emitEvent=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=0,o=i[n];e=e||[];for(var r=this._onceEvents&&this._onceEvents[t];o;){var s=r&&r[o];s&&(this.off(t,o),delete r[o]),o.apply(this,e),n+=s?0:1,o=i[n]}return this}},t}),function(t,e){"use strict";"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(i){return e(t,i)}):"object"==typeof module&&module.exports?module.exports=e(t,require("ev-emitter")):t.imagesLoaded=e(t,t.EvEmitter)}(window,function(t,e){function i(t,e){for(var i in e)t[i]=e[i];return t}function n(t){var e=[];if(Array.isArray(t))e=t;else if("number"==typeof t.length)for(var i=0;i<t.length;i++)e.push(t[i]);else e.push(t);return e}function o(t,e,r){return this instanceof o?("string"==typeof t&&(t=document.querySelectorAll(t)),this.elements=n(t),this.options=i({},this.options),"function"==typeof e?r=e:i(this.options,e),r&&this.on("always",r),this.getImages(),h&&(this.jqDeferred=new h.Deferred),void setTimeout(function(){this.check()}.bind(this))):new o(t,e,r)}function r(t){this.img=t}function s(t,e){this.url=t,this.element=e,this.img=new Image}var h=t.jQuery,a=t.console;o.prototype=Object.create(e.prototype),o.prototype.options={},o.prototype.getImages=function(){this.images=[],this.elements.forEach(this.addElementImages,this)},o.prototype.addElementImages=function(t){"IMG"==t.nodeName&&this.addImage(t),this.options.background===!0&&this.addElementBackgroundImages(t);var e=t.nodeType;if(e&&d[e]){for(var i=t.querySelectorAll("img"),n=0;n<i.length;n++){var o=i[n];this.addImage(o)}if("string"==typeof this.options.background){var r=t.querySelectorAll(this.options.background);for(n=0;n<r.length;n++){var s=r[n];this.addElementBackgroundImages(s)}}}};var d={1:!0,9:!0,11:!0};return o.prototype.addElementBackgroundImages=function(t){var e=getComputedStyle(t);if(e)for(var i=/url\((['"])?(.*?)\1\)/gi,n=i.exec(e.backgroundImage);null!==n;){var o=n&&n[2];o&&this.addBackground(o,t),n=i.exec(e.backgroundImage)}},o.prototype.addImage=function(t){var e=new r(t);this.images.push(e)},o.prototype.addBackground=function(t,e){var i=new s(t,e);this.images.push(i)},o.prototype.check=function(){function t(t,i,n){setTimeout(function(){e.progress(t,i,n)})}var e=this;return this.progressedCount=0,this.hasAnyBroken=!1,this.images.length?void this.images.forEach(function(e){e.once("progress",t),e.check()}):void this.complete()},o.prototype.progress=function(t,e,i){this.progressedCount++,this.hasAnyBroken=this.hasAnyBroken||!t.isLoaded,this.emitEvent("progress",[this,t,e]),this.jqDeferred&&this.jqDeferred.notify&&this.jqDeferred.notify(this,t),this.progressedCount==this.images.length&&this.complete(),this.options.debug&&a&&a.log("progress: "+i,t,e)},o.prototype.complete=function(){var t=this.hasAnyBroken?"fail":"done";if(this.isComplete=!0,this.emitEvent(t,[this]),this.emitEvent("always",[this]),this.jqDeferred){var e=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[e](this)}},r.prototype=Object.create(e.prototype),r.prototype.check=function(){var t=this.getIsImageComplete();return t?void this.confirm(0!==this.img.naturalWidth,"naturalWidth"):(this.proxyImage=new Image,this.proxyImage.addEventListener("load",this),this.proxyImage.addEventListener("error",this),this.img.addEventListener("load",this),this.img.addEventListener("error",this),void(this.proxyImage.src=this.img.src))},r.prototype.getIsImageComplete=function(){return this.img.complete&&void 0!==this.img.naturalWidth},r.prototype.confirm=function(t,e){this.isLoaded=t,this.emitEvent("progress",[this,this.img,e])},r.prototype.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},r.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindEvents()},r.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindEvents()},r.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this),this.proxyImage.removeEventListener("error",this),this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype=Object.create(r.prototype),s.prototype.check=function(){this.img.addEventListener("load",this),this.img.addEventListener("error",this),this.img.src=this.url;var t=this.getIsImageComplete();t&&(this.confirm(0!==this.img.naturalWidth,"naturalWidth"),this.unbindEvents())},s.prototype.unbindEvents=function(){this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype.confirm=function(t,e){this.isLoaded=t,this.emitEvent("progress",[this,this.element,e])},o.makeJQueryPlugin=function(e){e=e||t.jQuery,e&&(h=e,h.fn.imagesLoaded=function(t,e){var i=new o(this,t,e);return i.jqDeferred.promise(h(this))})},o.makeJQueryPlugin(),o});
/*! lz-string-1.3.3-min.js | (c) 2013 Pieroxy | Licensed under a WTFPL license */
var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(e){if(e==null)return"";var t="";var n,r,i,s,o,u,a;var f=0;e=LZString.compress(e);while(f<e.length*2){if(f%2==0){n=e.charCodeAt(f/2)>>8;r=e.charCodeAt(f/2)&255;if(f/2+1<e.length)i=e.charCodeAt(f/2+1)>>8;else i=NaN}else{n=e.charCodeAt((f-1)/2)&255;if((f+1)/2<e.length){r=e.charCodeAt((f+1)/2)>>8;i=e.charCodeAt((f+1)/2)&255}else r=i=NaN}f+=3;s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+LZString._keyStr.charAt(s)+LZString._keyStr.charAt(o)+LZString._keyStr.charAt(u)+LZString._keyStr.charAt(a)}return t},decompressFromBase64:function(e){if(e==null)return"";var t="",n=0,r,i,s,o,u,a,f,l,c=0,h=LZString._f;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){u=LZString._keyStr.indexOf(e.charAt(c++));a=LZString._keyStr.indexOf(e.charAt(c++));f=LZString._keyStr.indexOf(e.charAt(c++));l=LZString._keyStr.indexOf(e.charAt(c++));i=u<<2|a>>4;s=(a&15)<<4|f>>2;o=(f&3)<<6|l;if(n%2==0){r=i<<8;if(f!=64){t+=h(r|s)}if(l!=64){r=o<<8}}else{t=t+h(r|i);if(f!=64){r=s<<8}if(l!=64){t+=h(r|o)}}n+=3}return LZString.decompress(t)},compressToUTF16:function(e){if(e==null)return"";var t="",n,r,i,s=0,o=LZString._f;e=LZString.compress(e);for(n=0;n<e.length;n++){r=e.charCodeAt(n);switch(s++){case 0:t+=o((r>>1)+32);i=(r&1)<<14;break;case 1:t+=o(i+(r>>2)+32);i=(r&3)<<13;break;case 2:t+=o(i+(r>>3)+32);i=(r&7)<<12;break;case 3:t+=o(i+(r>>4)+32);i=(r&15)<<11;break;case 4:t+=o(i+(r>>5)+32);i=(r&31)<<10;break;case 5:t+=o(i+(r>>6)+32);i=(r&63)<<9;break;case 6:t+=o(i+(r>>7)+32);i=(r&127)<<8;break;case 7:t+=o(i+(r>>8)+32);i=(r&255)<<7;break;case 8:t+=o(i+(r>>9)+32);i=(r&511)<<6;break;case 9:t+=o(i+(r>>10)+32);i=(r&1023)<<5;break;case 10:t+=o(i+(r>>11)+32);i=(r&2047)<<4;break;case 11:t+=o(i+(r>>12)+32);i=(r&4095)<<3;break;case 12:t+=o(i+(r>>13)+32);i=(r&8191)<<2;break;case 13:t+=o(i+(r>>14)+32);i=(r&16383)<<1;break;case 14:t+=o(i+(r>>15)+32,(r&32767)+32);s=0;break}}return t+o(i+32)},decompressFromUTF16:function(e){if(e==null)return"";var t="",n,r,i=0,s=0,o=LZString._f;while(s<e.length){r=e.charCodeAt(s)-32;switch(i++){case 0:n=r<<1;break;case 1:t+=o(n|r>>14);n=(r&16383)<<2;break;case 2:t+=o(n|r>>13);n=(r&8191)<<3;break;case 3:t+=o(n|r>>12);n=(r&4095)<<4;break;case 4:t+=o(n|r>>11);n=(r&2047)<<5;break;case 5:t+=o(n|r>>10);n=(r&1023)<<6;break;case 6:t+=o(n|r>>9);n=(r&511)<<7;break;case 7:t+=o(n|r>>8);n=(r&255)<<8;break;case 8:t+=o(n|r>>7);n=(r&127)<<9;break;case 9:t+=o(n|r>>6);n=(r&63)<<10;break;case 10:t+=o(n|r>>5);n=(r&31)<<11;break;case 11:t+=o(n|r>>4);n=(r&15)<<12;break;case 12:t+=o(n|r>>3);n=(r&7)<<13;break;case 13:t+=o(n|r>>2);n=(r&3)<<14;break;case 14:t+=o(n|r>>1);n=(r&1)<<15;break;case 15:t+=o(n|r);i=0;break}s++}return LZString.decompress(t)},compress:function(e){if(e==null)return"";var t,n,r={},i={},s="",o="",u="",a=2,f=3,l=2,c="",h=0,p=0,d,v=LZString._f;for(d=0;d<e.length;d+=1){s=e.charAt(d);if(!Object.prototype.hasOwnProperty.call(r,s)){r[s]=f++;i[s]=true}o=u+s;if(Object.prototype.hasOwnProperty.call(r,o)){u=o}else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}r[o]=f++;u=String(s)}}if(u!==""){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}}n=2;for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}while(true){h=h<<1;if(p==15){c+=v(h);break}else p++}return c},decompress:function(e){if(e==null)return"";if(e=="")return null;var t=[],n,r=4,i=4,s=3,o="",u="",a,f,l,c,h,p,d,v=LZString._f,m={string:e,val:e.charCodeAt(0),position:32768,index:1};for(a=0;a<3;a+=1){t[a]=a}l=0;h=Math.pow(2,2);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(n=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 2:return""}t[3]=d;f=u=d;while(true){if(m.index>m.string.length){return""}l=0;h=Math.pow(2,s);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(d=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 2:return u}if(r==0){r=Math.pow(2,s);s++}if(t[d]){o=t[d]}else{if(d===i){o=f+f.charAt(0)}else{return null}}u+=o;t[i++]=f+o.charAt(0);r--;f=o;if(r==0){r=Math.pow(2,s);s++}}}};if(typeof module!=="undefined"&&module!=null){module.exports=LZString}
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(e){"use strict";var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s="download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",true,false,e,0,0,0,0,0,false,false,false,false,0,null);n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];if(typeof t==="string"){r.revokeObjectURL(t)}else{t.remove()}}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i==="function"){try{i.call(e,n||e)}catch(s){f(s)}}}},v=function(t,r){var f=this,p=t.type,v=false,m,g,y=function(){var e=n().createObjectURL(t);h.push(e);return e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m){m=y(t)}if(g){g.location.href=m}else{window.open(m,"_blank")}f.readyState=f.DONE;b()},E=function(e){return function(){if(f.readyState!==f.DONE){return e.apply(this,arguments)}}},S={create:true,exclusive:false},x;f.readyState=f.INIT;if(!r){r="download"}if(s){m=y(t);i.href=m;i.download=r;o(i);f.readyState=f.DONE;b();return}if(e.chrome&&p&&p!==l){x=t.slice||t.webkitSlice;t=x.call(t,0,t.size,l);v=true}if(u&&r!=="download"){r+=".download"}if(p===l||u){g=e}if(!a){w();return}c+=t.size;a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var n=function(){e.getFile(r,S,E(function(e){e.createWriter(E(function(n){n.onwriteend=function(t){g.location.href=e.toURL();h.push(e);f.readyState=f.DONE;d(f,"writeend",t)};n.onerror=function(){var e=n.error;if(e.code!==e.ABORT_ERR){w()}};"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=f["on"+e]});n.write(t);f.abort=function(){n.abort();f.readyState=f.DONE};f.readyState=f.WRITING}),w)}),w)};e.getFile(r,{create:false},E(function(e){e.remove();n()}),E(function(e){if(e.code===e.NOT_FOUND_ERR){n()}else{w()}}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};m.abort=function(){var e=this;e.readyState=e.DONE;d(e,"abort")};m.readyState=m.INIT=0;m.WRITING=1;m.DONE=2;m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null;e.addEventListener("unload",p,false);return g}(self)
/*! seedrandom.js v2.3.3 | (c) 2013 David Bau, all rights reserved. | Licensed under a BSD-style license */
!function(a,b,c,d,e,f,g,h,i){function j(a){var b,c=a.length,e=this,f=0,g=e.i=e.j=0,h=e.S=[];for(c||(a=[c++]);d>f;)h[f]=f++;for(f=0;d>f;f++)h[f]=h[g=r&g+a[f%c]+(b=h[f])],h[g]=b;(e.g=function(a){for(var b,c=0,f=e.i,g=e.j,h=e.S;a--;)b=h[f=r&f+1],c=c*d+h[r&(h[f]=h[g=r&g+b])+(h[g]=b)];return e.i=f,e.j=g,c})(d)}function k(a,b){var c,d=[],e=typeof a;if(b&&"object"==e)for(c in a)try{d.push(k(a[c],b-1))}catch(f){}return d.length?d:"string"==e?a:a+"\0"}function l(a,b){for(var c,d=a+"",e=0;e<d.length;)b[r&e]=r&(c^=19*b[r&e])+d.charCodeAt(e++);return n(b)}function m(c){try{return a.crypto.getRandomValues(c=new Uint8Array(d)),n(c)}catch(e){return[+new Date,a,(c=a.navigator)&&c.plugins,a.screen,n(b)]}}function n(a){return String.fromCharCode.apply(0,a)}var o=c.pow(d,e),p=c.pow(2,f),q=2*p,r=d-1,s=c["seed"+i]=function(a,f,g){var h=[],r=l(k(f?[a,n(b)]:null==a?m():a,3),h),s=new j(h);return l(n(s.S),b),(g||function(a,b,d){return d?(c[i]=a,b):a})(function(){for(var a=s.g(e),b=o,c=0;p>a;)a=(a+c)*d,b*=d,c=s.g(1);for(;a>=q;)a/=2,b/=2,c>>>=1;return(a+c)/b},r,this==c)};l(c[i](),b),g&&g.exports?g.exports=s:h&&h.amd&&h(function(){return s})}(this,[],Math,256,6,52,"object"==typeof module&&module,"function"==typeof define&&define,"random");
/*! console_hack.js | (c) 2015 Thomas Michael Edwards | Licensed under SugarCube's Simple BSD license */
!function(){for(var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],length=methods.length,noop=function(){},console=window.console=window.console||{};length--;){var method=methods[length];console[method]||(console[method]=noop)}}();
}else{document.documentElement.className="init-lacking"}
</script>
<script src="https://use.fontawesome.com/46b4065509.js"></script>
<style id="style-normalize" type="text/css">/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */

/**
 * 1. Set default font family to sans-serif.
 * 2. Prevent iOS and IE text size adjust after device orientation change,
 *    without disabling user zoom.
 */

html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}

/**
 * Remove default margin.
 */

body {
  margin: 0;
}

/* HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined for any HTML5 element in IE 8/9.
 * Correct `block` display not defined for `details` or `summary` in IE 10/11
 * and Firefox.
 * Correct `block` display not defined for `main` in IE 11.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}

/**
 * 1. Correct `inline-block` display not defined in IE 8/9.
 * 2. Normalize vertical alignment of `progress` in Chrome, Firefox, and Opera.
 */

audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
  display: none;
  height: 0;
}

/**
 * Address `[hidden]` styling not present in IE 8/9/10.
 * Hide the `template` element in IE 8/9/10/11, Safari, and Firefox < 22.
 */

[hidden],
template {
  display: none;
}

/* Links
   ========================================================================== */

/**
 * Remove the gray background color from active links in IE 10.
 */

a {
  background-color: transparent;
}

/**
 * Improve readability of focused elements when they are also in an
 * active/hover state.
 */

a:active,
a:hover {
  outline: 0;
}

/* Text-level semantics
   ========================================================================== */

/**
 * Address styling not present in IE 8/9/10/11, Safari, and Chrome.
 */

abbr[title] {
  border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 4+, Safari, and Chrome.
 */

b,
strong {
  font-weight: bold;
}

/**
 * Address styling not present in Safari and Chrome.
 */

dfn {
  font-style: italic;
}

/**
 * Address variable `h1` font-size and margin within `section` and `article`
 * contexts in Firefox 4+, Safari, and Chrome.
 */

h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

/**
 * Address styling not present in IE 8/9.
 */

mark {
  background: #ff0;
  color: #000;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
  font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sup {
  top: -0.5em;
}

sub {
  bottom: -0.25em;
}

/* Embedded content
   ========================================================================== */

/**
 * Remove border when inside `a` element in IE 8/9/10.
 */

img {
  border: 0;
}

/**
 * Correct overflow not hidden in IE 9/10/11.
 */

svg:not(:root) {
  overflow: hidden;
}

/* Grouping content
   ========================================================================== */

/**
 * Address margin not present in IE 8/9 and Safari.
 */

figure {
  margin: 1em 40px;
}

/**
 * Address differences between Firefox and other browsers.
 */

hr {
  box-sizing: content-box;
  height: 0;
}

/**
 * Contain overflow in all browsers.
 */

pre {
  overflow: auto;
}

/**
 * Address odd `em`-unit font size rendering in all browsers.
 */

code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

/* Forms
   ========================================================================== */

/**
 * Known limitation: by default, Chrome and Safari on OS X allow very limited
 * styling of `select`, unless a `border` property is set.
 */

/**
 * 1. Correct color not being inherited.
 *    Known issue: affects color of disabled elements.
 * 2. Correct font properties not being inherited.
 * 3. Address margins set differently in Firefox 4+, Safari, and Chrome.
 */

button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}

/**
 * Address `overflow` set to `hidden` in IE 8/9/10/11.
 */

button {
  overflow: visible;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Firefox, IE 8/9/10/11, and Opera.
 * Correct `select` style inheritance in Firefox.
 */

button,
select {
  text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
  cursor: default;
}

/**
 * Remove inner padding and border in Firefox 4+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}

/**
 * Address Firefox 4+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

input {
  line-height: normal;
}

/**
 * It's recommended that you don't attempt to style these elements.
 * Firefox's implementation doesn't respect box-sizing, padding, or width.
 *
 * 1. Address box sizing set to `content-box` in IE 8/9/10.
 * 2. Remove excess padding in IE 8/9/10.
 */

input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}

/**
 * Fix the cursor style for Chrome's increment/decrement buttons. For certain
 * `font-size` values of the `input`, it causes the cursor style of the
 * decrement button to change from `default` to `text`.
 */

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari and Chrome.
 */

input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  box-sizing: content-box; /* 2 */
}

/**
 * Remove inner padding and search cancel button in Safari and Chrome on OS X.
 * Safari (but not Chrome) clips the cancel button when the search input has
 * padding (and `textfield` appearance).
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct `color` not being inherited in IE 8/9/10/11.
 * 2. Remove padding so people aren't caught out if they zero out fieldsets.
 */

legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}

/**
 * Remove default vertical scrollbar in IE 8/9/10/11.
 */

textarea {
  overflow: auto;
}

/**
 * Don't inherit the `font-weight` (applied by a rule above).
 * NOTE: the default cannot safely be changed in Chrome and Safari on OS X.
 */

optgroup {
  font-weight: bold;
}

/* Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
  border-collapse: collapse;
  border-spacing: 0;
}

td,
th {
  padding: 0;
}
</style>
<style id="style-init-screen" type="text/css">/***********************************************************************************************************************
 *
 * init-screen.css
 *
 * Copyright © 2014–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

#init-screen { display: none; z-index: 100000; position: fixed; top: 0px; left: 0px; height: 100%; width: 100%; font-size: 28px; text-align: center; }
#init-screen p { display: none; width: 75%; margin: 2em auto; font-weight: bold; font-style: italic; }
#init-loading progress { height: 20px; } /* fixes a rendering bug in Chrome on certain platforms */
html.init-no-js #init-screen, html.init-lacking #init-screen, html.init-loading #init-screen { display: block; }
html.init-no-js #init-no-js { display: block; }
html.init-lacking #init-lacking { display: block; }
html.init-loading #init-loading { display: block; }
html.init-loading #ui-bar, html.init-loading #passages { display: none; }
html.init-no-js #init-no-js, noscript { color: red; font-weight: bold; }
</style>
<style id="style-fonts" type="text/css">/***********************************************************************************************************************
 *
 * fonts.css
 *
 * Copyright © 2014–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

@font-face {
	font-family: "tme-fa-icons";
	src: url('data:application/octet-stream;base64,d09GRgABAAAAACWoAA4AAAAAQhQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABRAAAAEQAAABWPihI/2NtYXAAAAGIAAAAOgAAAUrQXRm3Y3Z0IAAAAcQAAAAKAAAACgAAAABmcGdtAAAB0AAABZQAAAtwiJCQWWdhc3AAAAdkAAAACAAAAAgAAAAQZ2x5ZgAAB2wAABjCAAAq+uJ4WNtoZWFkAAAgMAAAADQAAAA2BZlJs2hoZWEAACBkAAAAIAAAACQIJwQZaG10eAAAIIQAAABuAAABOPTeAABsb2NhAAAg9AAAAJ4AAACeojKW6m1heHAAACGUAAAAIAAAACAA6gvwbmFtZQAAIbQAAAGPAAAC/eLsyKlwb3N0AAAjRAAAAfwAAAM0412SIHByZXAAACVAAAAAZQAAAHvdawOFeJxjYGRWYZzAwMrAwVTFtIeBgaEHQjM+YDBkZGJgYGJgZWbACgLSXFMYHF4wvPBhDvqfxRDFHMQwDSjMCJIDANLeC6V4nGNgYGBmgGAZBkYGEHAB8hjBfBYGDSDNBqQZGZgYGF74/P8PUvCCAURLMELVAwEjG8OIBwC4Ywb6AAAAAAAAAAAAAAAAAAB4nK1WaXMTRxCd1WHLNj6CDxI2gVnGcox2VpjLCBDG7EoW4BzylexCjl1Ldu6LT/wG/ZpekVSRb/y0vB4d2GAnVVQoSv2m9+1M9+ueXpPQksReWI+k3HwpprY2aWTnSUg3bFqO4kPZ2QspU0z+LoiCaLXUvu04JCISgap1hSWC2PfI0iTjQ48yWrYlvWpSbulJd9kaD+qt+vbT0FGO3QklNZuhQ+uRLanCqBJFMu2RkjYtw9VfSVrh5yvMfNUMJYLoJJLGm2EMj+Rn44xWGa3GdhxFkU2WG0WKRDM8iCKPslpin1wxQUD5oBlSXvk0onyEH5EVe5TTCnHJdprf9yU/6R3OvyTieouyJQf+QHZkB3unK/ki0toK46adbEehivB0fSfEI5uT6p/sUV7TaOB2RaYnzQiWyleQWPkJZfYPyWrhfMqXPBrVkoOcCFovc2Jf8g60HkdMiWsmyILujk6IoO6XnKHYY/q4+OO9XSwXIQTIOJb1jkq4EEYpYbOaJG0EOYiSskWV1HpHTJzyOi3iLWG/Tu3oS2e0Sag7MZ6th46tnKjkeDSp00ymTu2k5tGUBlFKOhM85tcBlB/RJK+2sZrEyqNpbDNjJJFQoIVzaSqIZSeWNAXRPJrRm7thmmvXokWaPFDPPXpPb26Fmzs9p+3AP2v8Z3UqpoO9MJ2eDshKfJp2uUnRun56hn8m8UPWAiqRLTbDlMVDtn4H5eVjS47CawNs957zK+h99kTIpIH4G/AeL9UpBUyFmFVQC9201rUsy9RqVotUZOq7IU0rX9ZpAk05Dn1jX8Y4/q+ZGUtMCd/vxOnZEZeeufYlyDSH3GZdj+Z1arFdgM5sz+k0y/Z9nebYfqDTPNvzOh1ha+t0lO2HOi2w/UinY2wvaEGT7jsEchGBXMAGEoGwdRAI20sIhK1CIGwXEQjbIgJhu4RA2H6MQNguIxC2l7Wsmn4qaRw7E8sARYgDoznuyGVuKldTyaUSrotGpzbkKXKrpKJ4Vv0rA/3ikTesgbVAukTW/IpJrnxUleOPrmh508S5Ao5Vf3tzXJ8TD2W/WPhT8L/amqqkV6x5ZHIVeSPQk+NE1yYVj67p8rmqR9f/i4oOa4F+A6UQC0VZlg2+mZDwUafTUA1c5RAzGzMP1/W6Zc3P4fybGCEL6H78NxQaC9yDTllJWe1gr9XXj2W5twflsCdYkmK+zOtb4YuMzEr7RWYpez7yecAVMCqVYasNXK3gzXsS85DpTfJMELcVZYOkjceZILGBYx4wb76TICRMXbWB2imcsIG8YMwp2O+EQ1RvlOVwe6F9Ho2Uf2tX7MgZFU0Q+G32Rtjrs1DyW6yBhCe/1NdAVSFNxbipgEsj5YZq8GFcrdtGMk6gr6jYDcuyig8fR9x3So5lIPlIEatHRz+tvUKd1Ln9yihu3zv9CIJBaWL+9r6Z4qCUd7WSZVZtA1O3GpVT15rDxasO3c2j7nvH2Sdy1jTddE/c9L6mVbeDg7lZEO3bHJSlTC6o68MOG6jLzaXQ6mVckt52DzAsMKDfoRUb/1f3cfg8V6oKo+NIvZ2oH6PPYgzyDzh/R/UF6OcxTLmGlOd7lxOfbtzD2TJdxV2sn+LfwKy15mbpGnBD0w2Yh6xaHbrKDXynBjo90tyO9BDwse4K8QBgE8Bi8InuWsbzKYDxfMYcH+Bz5jBoMofBFnMYbDNnDWCHOQx2mcNgjzkMvmDOOsCXzGEQModBxBwGT5gTADxlDoOvmMPga+Yw+IY59wG+ZQ6DmDkMEuYw2Nd0ayhzixd0F6htUBXowPQTFvewONRUGbK/44Vhf28Qs38wiKk/aro9pP7EC0P92SCm/mIQU3/VdGdI/Y0Xhvq7QUz9wyCmPtMvxnKZwV9GvkuFA8ouNp/z98T7B8IaQLYAAQAB//8AD3icrToNcBzVefe9/b3dvd29u909/dyd7ke6k86yLEunOyHJsrCxJWyJGmEcLMDYxBhHNsZQBzOAkjQmFDrGIq5gHEIcCILOAGZq3IQO04RkIGkgaUMKMbQznSlJW0wgJtOQHxRr1e+93TvJwq7JTD3y2/f//bzvfX/vAhAIzL3KPcYNBFIB8UR9EJYuAcuAqGNbOiwDSczkuorlaJ6WTeVSRwMIDveY8aN20GztjzMhW4P2H+kNUPM5NaVNQE0K3tWM77vv8rJqgnT33VJE4WWIfd/QbKHZjcXcZiFAqjCDgUJA/mZTWOIIwi0vAwNiUjkW9THIZs6DAbnj6ffGP/P+0y2vv+5SXGLKuXHJPJH92c+yT7x3883wnI9W/DxI4T9+bm7uOL+MUwNywAg0BJYFQgNKa2NDzFBEjqeM0SFXLHU4YKe7yjFoSmdEKWw5nemOUj5czMXCliilM7lyuFgqp3HaDf1j/fhH+s6cfm4MEpA8c0BSQBO5CUkD5fJi05kDjSUoNnETTUUSXtpPVm0aGHDdmV0nNkPiMUWeHZMVRSZPSlp0dqypCKVG8iT9IK5AEeamyZGAjecW5tm5SSBm8ojiSqBsYoXDTRtuymw13V8axjB+p2EPlsMGcRzTTRkGOLRpmk/AzSZ+A97ecx+QN8g9gUbc26F7N+GJiN5pLGMA8hUo7EQcHI455A0PwrS3I37N+bZhTE8bex1aeeIJ4+MTjTY6gcH+iIvgGWQRdh2TR9sS81kspCzytguLfBcyuBOLXuhwYnZnh8NFUs6plLPLScGpWBKwkYztwsop7Hie9r7rYK/9brWXTg9U+RiBX+GJiyc0rgIv7UNJe3vPjrFdyZOV/byNUkyW/0AuIi/h+h6U5a64SmW5ieGcya2AYimG+EUtnZN08ImgveV+KOYykiiJVMrbkI+dHUkC9+nyPUFdD94j639r1uTq7FiSNrR1hXS8uLbGapYUSbpaJvzmp5aODbU9iJNBU1gJa5LFTCqihNpDigmWWtc2GjUy7Y2m3hHk14qmPJXp2cTInZudO85dhzw2AuXAJQHl+Yt7l0RVjkO8u4q5JZARE2A5yNxStNgGWcQSj7izA1HucCgJOsRsb7xYWgn9XAwvRqaN4HAS4ENF3kXFFovJ/muW3zsYDK3jxaCQbOouOPXZPmBDNZG4krS0N2/9wakf7hHv+IcPX/jcaGWZAp9fvrFtv66UeSlXn4zYdZo5kLNwIJJRTbEu3jz62Zf37Xv5l7RAeugZfAQ7kJ5koA3PoJB1eP8MpHRVWqpygyITpiKz4DCoHMENlun+wrDA0bNZ9jmJZdZwhhx9UnewMKztg2yAlie9j6O7Lzrks7tYdRdOO4u/FJ9e5G93RyFTJ1f5G17IZDs7z25uEfuFBYwlvYpUUuTnKJO6umg5IymD88yGGxbycjN2JOkIVk6wUoEzm/0O5T/Owb92Jg8NyL/6qFrl30IZ5nSgMp3nch7DkvOMCaMeoQ1U4JZxQncenmAMmcAei/S7V9CvAccW8mczwtMCceSQ8nwhXWuKAeQPJbRCc9RnhoSyhvBL+WgxTzsk0Y567IFj+35wa4Xq7ykS5YIm7UIdq4iCfKcsiIoSvFFWONUnFovZoXHKhXE69R9hTOIEgZPcJ0VZRrx+i3j9hhtFPqQDnYjX8uaEpS2+F4twiVkOylSJAwfvBZO3XBnoTaEHtltSWAGKIEl3SJIQ1CRESIRnLFtJRc88GckEbQuOBTO5zBXziL0JIPKiyMtzggwiMc+czmbDEbDMbJaLhC3LPzPuFOKaD6zEM+tt15gNxTPLIg5dvglCfGmbmakYmqmKsEfRVOWWAXjqvEzVeamT6botq9321Vu2rIb7KOrufmZ24LWmoiI3yspJJ65e704JprBSFGH3pxXLhAQe9fBzbM1rq7YAm1dsctvZSiqu8G94rxwS/LQ7JYorRR0XXq/GmSh4dJADKAsSk70ajQ8gHdE0MhzVjOCbVDSvKINd1PhKVN+fgMTG2zYCvIaq+V2mmsNTP36IRLD6xO7ejWTDisfc7zCVD6tQW+/eMTW1Y3fSt20foe+hBZpQ3zfGfH3vyzmCZNvHFoJFVPrRjj7m6I26M3r7KHQxgD5c2H/4tQdIeJLJ+yQDvTsZOwv4jYfJQxVaxxmtKtNTTVaQnRmS6kkWvfBoNvCeIT55jt41PJZwpg3YYeJYGK+dppgK/sF+R/8ggZIOBlnyNoK/qpwokLZ6uCFRKCTKV8HeGaYksPg2Xj/3fyQZb6dhGWv2QLLQU4DW7lZwf77Hw+vb3AjzexKIVywkEXoGlB1JUqr4FW3A7BZlDzgzhZ5W0tyfI1da7mmn13JvsZOFxLuJIRsmLXJVskByA41iu/uvSds9bWOnPZQ4lSgANm+xqQ6gMPlGH2YR79rSDIXLXQBujHZSxkCpSIeynwCdNxEFJ2HVmSDaFPxQYoIN2BfCM8E6zTCu66VDSQ97KkPfIa8i7nGUITNAZagDhYFJjeg5rXh+bcBuYamT/JWmRVE8Iopeb/3ud1ZdSIs4TkQLcaogJ63Z5dGUxEfefz8qSKko+Qm2PB/ZgyEEMngmjkjovYB0GBog+n9COzD7MiQ73pfOA5S8NLseIst+QWbPC9y/J8dRv7QFliCNWcnzAYlI3fE8hdNVbBPY1WEeZxm8m5mKOdypQRG1qhiRgQBnZbr7N20qT1ipoPsLVYWEGq8hE3BoLPn2tV8PhWVe0WTB4nIN3WMD7cmIiDZEhaSSROulWMbk2+sX4LIs0Iq4NNdUfV3mDeqCbaEOligmbYSFCaU0VRVULrhTKoKlIMubNvV3ZyyOByWMilXkBpNjcIjihTjBrwzF/bmKF1iMJNsHxrobcnxElDVF0C3u69fevP5txIsEcUrVZyR96DPqiI/C+zGTp0uZGkXVP6PG1RncET7Ey/eKjnX885QeWw83krsCIVyvMp8TD9P3rEvMFUkFZxS6Rw25ytWQJ/52/tqLyQSDrc7Dpiq/H2XDgYsVBgjnK7BF95EwLKLNKLh0bg5x74VXPNwJO1fq7raB588j7pbhat78pDKjPE1td1Jl6Hhn8Q73LdISsCrrgwuijljQ28Tinnavx+Xu9ap6jYqn2QzNaly7RoVJ99MoBl/DvmtU1X0Lu3FCnO37XXKEW832Nai8BYnDKKvIF92W3F9dotK94ahCNyJPuW+5b2L1WrQ2X6fSc1TBejLg77uvsm8FX2b1ghWk6cbjuB1FUIVm9y0f6aMKfMbdhjshNGihFKgIgE7044ZvkbXz+zbh3chXN/f35Z6mOyF2b/m7H6V7HVV3XYOYtiDOig/J25bh+xPuAPMdxRPRc8V1YU8Z2mEv9OIO2O6DTg8Wtt2C3+lCcjBRmEaNVbDhi0nLnUK1ttvqdVpsexruQ93WGnf3T9s47N+te7nN5FeohRGeChUfIvZx5htAPYTNjQl/ea/tTlkW7LZ7nIK3dyNsGUwWpq0+a4k/ALvozB5nurkCqwthUdrq5mnzBD/tu5rpfPVYuC6L0VZwnMfd/YnGxgTc97jjFNjGFvRQ6iyrYPfZjyPVyQJM233YRF5YVb1xgLzjwVMX3NOwZ/K7wtJZx4W8pGRNNzf4ZOBeCKgPCxuKcUYmxQNycbjP5wGlEJGk8OZc369tR3gtaZ+X6CbmVkIONRVJcugpluk1TQL1Fqmfy1ELVi4hYy1zJhYNj4zu7RkfbuebN17fv+q2Fj4sDgtE7Hv2uk89uneIH7j9yNWjR1YMmUvJSzO6s9QcGWkbHt83PtzW0yWCMMLr4roNcMm+o88e3XdJ/0VDkWiFDxSv5YhXq8d3nVAryjjtoDXp7Ojn2gg6ijGHIUxDpQZ0Y2lQym2+5NZHN219to8XhsUw33Lb6p6dG9DVGN598/bmkXA0NoPeR2t4qO/h0U8d3bcKtmB5yeilos6PCCB29fgINjeNmEsdfaYmGhm6qB9RrPhEx7mrEbfGwCDauZXNJo09wLJ1oAhSe1NxWkUDKKJofMqeE+szt8S4K9JYmjbLXRRtylOU1vWN//mVy4/0DVGNqM9QJT7SvL287ot5MSZoGC/oyHTWO7p3vdd5s6RB439/5fKH6aIaEDh46AVkpMqWo1YdaWpe1690hzT4e79jxGuLvD+R0iUwuiJ+TLUM4+yrA8aAdsVAsX1JFgMsTkCF4ceBdtgLZ8oXaENnPpfPipLA6A57nn4+XI1hUbCoYmig1KP5pH44Kybnq4cUyatKivvTmXpeOC7y8J4il3yHncWVz+SDrc5zTqucPyYro3Af7XP30/I8ddJxsQAgXIFbz37QdsmqNhJl0K6145C0rkWzExAX8aM3sDpwYyA8oF83PNBXWu7xRPQMIT1E6syw7M4F2tFwOmyhVKQ7+uH/lz9DribLBF4jsuze94lYBc+7LzLOXMw4c+66u52EZz/QLEWxyA0XZFuA9+OVUfSTwyzWCw0o3a0Jx9BYTrKp2AZiEi9qGSs6OFhZkPboRDXesZKpbcd3UOjV8dMgNNQhr1pJh0Qy5petVIQ48Zq1KefMj7zIhluf3pQeBs5JfUuJMGcgHFRik16gP1mzHX2EmroaYhmVysETLOo54aSGU/gHzbEwdRvCMXuGhUczHj3HkZ42Rk9LYIDS07c8YRuqSBg91Pmnwo8VghFR2Y9oKTmxziSwi0HTN2I1cMvT3E7Fezk/Pae1UnYyUwqdRnqCNZPoXSJSk6hxGWmRBKqBSMqyTP97/wmaJcQCGpqbG5Iw6vhEtHpEVWihepULpFG3rqG0rOha2qTxJIC0YOSYFjrxEtP8nlSlIxvu7PLcRKmS76mk04Sq0HoTqJ04CcfcK+DDIU34mhCX/dByaAiDy58ibicVeRdNJrNyezI2G/ESlUKsZDxiOtLJk/ChXCc9Imp+1nO2xL6QZIkkWiizM7SHIF9q9K8ZpQDx8zOjgWaMzORvdrSGPJ2sEzRYZer9O2gmWD4zSTr6sSuH8Uc/IGjmyLIMOHUV0G48840967ixy2v6zIhcU+pr3bDj9u0bc1xfqUbO9sUuH3O/iqEbFPqaPbOBZuFTO57rx7mxvnDL7avRFLah/ei55LZCpKddjqz4OxhyH6YRLuzA0rcfY5yC8rQTcb08JdLYleZW8TZ0lGgSCyVfQoQtRDiPV6BqKLryzL7kqRmkuoGdE5UzlKWy39mJQlU1OChf1KrEHOYcsdMhvaO3j5JN+zZBXJZ2Kmq0WRSMDSFJGqmtC0q8eZesmfWxPxNNca3DC3KzYsg7MBBXhJ2yHmvy5sojNXVBmQvfhUdoxJ0NgiENWTzfqwd3SOjC927ceNvGjbfTUTNp13eIumhvAKEvJA/HTUW6Maj1CeJAUtBFrcOI1xugSWxubV1qqaRJ1gZvqiHLbKqwOo5TR9hELw7/iBsjL/t6WXl+SWN9VOO5RfnTtJcwreTFY35bWthGB+bMB+yOcGEDg4bztxbkUR0wh1h2kJWgV0awMR+Hjvn5mlrmu9BMCMpYsZynmQC8KR2xco4maZIg5jN5CU86ViJ/s27nzqlxgFc6167fuXP92s5XYOdDO8j4pYNYw16IjR8eH79U0ra3Y6V9uyat20l2P7AbsKpjJ81Tzs39nt9PXgqYeL9LNB+Yi9uMN1BEZ0knnvijDiZLEDg6dJ30NuA9oQEVh9U0uk/kgO8A+R94pvWy8YveWn0ZWbfmLepJXdqz5Z5B94qhu7d2k75r7l0Lx2gVtvTMr6FXgDY7p56d6qSNS+/e0ke6r//CQ1/YXiTdW++u+FK/529HfC3klvzNhK3Te4txIUFlkuQ8tIjguXrUG6WAPWgMsIcDF664d3v3DHXwhQ07YMul2I9QDvtQXz+bokoej3uUo5mt1Qi7f/m58pGoIAyavsnnFiUl8cbhKTpRmI+CKw9Y1oKc5GvZZJCT6kWJcCHNzzDS3KTQKEocr/6Fe1GoUf+1rq/QG/W/hs9goz8E649Xc5M6HxXjAnDV9OT9spBFuwOC26Prv2bzQ3RhCHfwaYpW8+LxqOzlYOZR7/Kf/RbmXMktCzAr3jWP/Kqt5KUqZDq4uTqyBbYGfL17HcuL19KcjykyePSoAP2bNgILH1qOXXFwA9l471P3bOIvOwRXL8j+k0OjB6cPjrLCfe2sXP/824QcsAMZlOmGWiMo0rwb4K1qo+mH/LkBVlXdA+cFXFFWvz0//AXvbZ6+ac3GoyzHHvXfzCqvNILfLi9qV7KBJ/03OPbql/A+XlcDa3g9C1/rnPPU/XzkR4E3q/4p6kHES6V3vVx1M7x3EG4RnpwfhuT9B8mTF4BG6w/vZp7SbtoL4oJBkCuYe2+LL3GT6CtdzGKjNas6FGaHETyqOIeljCSdy4azYTwkLxFIL08OHSKaM+7sonl9vERpGguhHaS5bUgz24xu3ETTPsVKqntkIZfpqR1MdBfQKd6hmiFHviU1QZ260MQ2FSOcbfDmVoyFeHkb9rq/db9KFWsP6uutqz6LgZW6R+JrIjp86Gp6jSXL+7RoUv38yjEracH0NiVpKdu2ISBl27QDRdTKAT9WHoc/IL/p7w4sptcdmtpFR6IcZRnNXDnaT909x7Ykjj6PwmlFdP9FMuWgQvb8nAiKpHB7iS4/r+pk678LRCWOGpq9QwfOlOGlbpDkEPwThngKL7puibAY5LvMl+ZQQ8Yx4mxF/wZjkGJ7a3NjKl5jyjiJ/hAhLzVVExN+9qMpZsAyWImhu/eF2NlfcmS6bxq6lNlO9CZvxpjon/G7R5k1SqVwuFwOv3HTTZn0TTelSQs2wtjpPkNH8D/RH++b3mkosx0KLkzSlfi92qSrzPKX2arMTe692ChjJ7T5I75t3I487EIe5jXKQ6pg6Q83qs/lEn3noSFynmb4aOrBF9sEoBuHhKFYcL11up41emofLCQGE60wVdeDClSvn5qqM41Go7t+iuWUHqzrNrOGWTsFst5TtwLXXPk0Syc9fSX2rsBFmzadY6C/Fge8d+e5uXHkfyiQRc6vwTu2Ylkhz95Fq2/8+YVv/CxSqb7xxyqhDjDBRxFBxcQnSYzeBfrYNqGJjej4TLDfWEywII42hqZ+/BB/6I2DkCn0WS9uv3PD4Z0DpG/3oemDe7u5NS/aMOWtol60t2qCusYTSi19uHn1iHiQOpz2i2v6xx/4xqE9PfyqHQ+N3Ln9RftsmoxADcYAyvMt9Y73lr7wdwTUmb8g/u53GOaw6pPizJC9MJrEj7noG9sG1CNhmWN2BcF2dpRzGBfz5XrojEWZRxuj6aCYY0tiLJOTMmK2uJJQjxj/8hjKEB1iGHCj4JTpxczQzEtehAevG+5pUO12twtCjfG4I979yJB4a7RlZbDdVGV1OMgDQPZQY+ERm1wqiVyYJwJHMrGaP+o9YKbUlE2ApL6YEiyylNT9ESff74qtvCgqNSZcBVOa+2Hr9q9E70rVikGTcxRJ4BSQa6ImzpQIEXk+OFbqhvQRQ4souDWotqAiL2Xqm+AZ/Yz0kXcCOnvfqg1779vzOXtqtvPMii9Ig5+dwj87Kf4bQ6EJfdRt4PyQZYFY0/NXERbE5vPzi+As2njhToFqfp7h6ufXYTFiZ6MCryyG/xQX5qIBFddLfr6b+SYsHc3P1ocikRD5rxCMuNslxeBKuiZjzQpUY6kFvwNgPtyioHRxkEr9fv+HE5AwHFc9q0neOXOa/kiAi9ByQX3et1fZb2+q7yCL914QN5y1GVt/DOVaR29JPCECXV9iGaI84A7sQ9W3Y4dLZe4vVR1Mxd3Hc7rq7lNVOKjqHM9xqmiceVWXNTgoiO6fswpN0R/EfnefyHtnMvcsdw1nzMOJiSzGpQ+SPmclxmVRqlVM0HG5wNFSQYAIRhjE3ZDTsobwJbifVegTxj7sx7mCRwvp5XSWh6/QYs/TwjyMahKsVCYZVaeECMTR56MplPyzCfrSPO/dL0m8RwvpQ1oS56aF7i/58Mpn0eOHaKxcTNGd84cLd4oCvXPu3B+4a8kPUA7rmSzJ7E3Zy7OzuJEm/Mt+7Eh/pyDPMx7xF7luuh/CY9hDe4WZYLqvW+YhFlJiWX1PO0aOB6L0t3AVOUK7V/XSqP8Dx/CavHCY8erwC3jhyKHZR2nu9wXvpz4vKN4dwOIA22sZ/S1RTbhyBxbvF/XeXzEQpfEUTa0hLTTE+RigN9vzQhBp0RzT5OUaKazwlhEU8u0fx8D9XmGdwVmmZmpavDGuichhJJUz1nn5pp9yj5H3GG7DgZtovmnn5YNFiiT/JyIZqw6Uvd+i0TRIFwumFw7SVEg/TYvQDM/8hE9O4uTWEVlECuyU2tLW1oKK3jIk+bItDxy6TZKw36mttdZgKDxo1fIRzrFMSbrt0J/Cl8KVh1OcozuqGUyO7RxLBk3UrA6XfmDTF97qwAErpOl655GnjnTqOidyIQsHO08G/hcLt/j/AAB4nGNgZGBgAOLaW41M8fw2Xxm4mV8ARRguss1QhNC5H/9//Z/FUsEcBORyMDCBRAFTFwxveJxjYGRgYA76n8UQxVLGwPD/FUsFA1AEBfgBAHyYBUh4nGN+wcDAvACCWfSBNIgviMBM1kA6koGBMRWVBqsDYqYmiF4wHQkxg+kUBMPVWEP0gTDYvBdoahZAzYxEY0ciuWUBFjkoZimDYLC8IKpehmsQccYvSGYgYZB7YBhFL5o8cxTQjDUI/wIArpclrwAAAAAAAAA6AIYA3AEKAUgBgAGgAfoCYgKqAwIDOgOGA9wEQAR4BLYFAgU8BZoFzAYMBlIGmga6BtgG+AcYB0QHcAecB8gIAAg2CG4IpgjyCUAJrAo0CtALOAueDAoMYA0ADVANjg3mDiQOjg7GDvgPOA+ED84QPBB2EN4RNhGgEfISchKoEsgS6BMGEz4TXhOSE8QT+BQsFGIUiBTWFX0AAAABAAAATgBuAAYAAAAAAAIAAAAQAHMAAAAiC3AAAAAAeJx1kctOGzEUhn9DoIKgLloJdcdZIRDK5CKhSqyoogJrhLJDwgyeSzpjRx4HlGfgLcoz8Dp9j+76Z2KhqFJmZM93Ph/bxx4AX/AHCqvnnG3FCgeMVryFT/gReZv+JnKHfBd5B108RN6l/xV5H2d4idzFV/zmCqqzx2iK98gK39RR5C18Vt8jb9P/jNwh30fewaGaR96lf428j4l6i9zFsfo7drOFL/MiyMn4VEaD4bk8LsRRlVZXouehcL6RS8mcDaaqXJK6OtSml+lemTrb3Jp8Xmm/rtZ5YnxTOivDZLCur401XgfztNytec5HIWSSeVfLVdxHZt5NTRqSIoTZRb+/vj/GcJhhAY8SOQoECE5oT/kdYYAhf4zgkRnCzFVWCQuNikZjzhlFO9IwvmTLGFlaw4yKnCBlX9PUdD2Oa/Zlay1n3dLmXKei9xuzNvkJ7XLvso2F9SaselP2Na1tZ+i2wqePszV4ZhUj2sBZy1P4tmrB1X/nEd7XcmxKk9In7a0F2gv0+W44/z/KQo7lAHicbZLnlpswEIW5Bgy4bLLpvfeE9N57z76DLARWEJKOEEucpw8CO/kTncOdT6PhnlHxRt4wJt7/x47nYQQfAUKMESFGggmmmGGOLezBXmxjH/bjAA7iEA7jCI7iGI7jBE7iFE7jDM7iHM7jAi7iEi7jCq7iGq7jBlLcxC3cxh3cxT3cxwM8xCM8xhM8xTM8xwu8xCu8xhu8xTu8xwd8xCd8xhd8xTd8xw/sBLUlZuIkZZW2q0hzahvDRqocUyIpE4EWTR1WXDZ1sGRCz5yklBsqWBZwmauZk01mTqxl0nIlUyLs9r/Zej35m4kFl2XKftlAKFomTlKlmfQ1l74lRdB9dbxQqqyIKbc2MPQZGqbFKsqVaYnJ4ky1Ms24iQXLrYPE8GLZ07jRfaIvcf5JX+NoMhQ5jLoqFwenBS8Gpw7WTh05py6MaOtT2ibEGNXWKW1Da0i9nPY6dNe7CEWy7pc+5EJpvfJVnvtUFUHFZBPWS2LYxKqiECztVpINypAuGS2nvQ6Gs+H0hsk0U3ZznDETguua1/MNpLvMWH/RFGEuuobCihScxqS2zPC6jH4rVaVcxn1UjQ1yJW1QK2MTJ6nrPOqp0d3Vk1WoSVOz7p0oHeWdTbpoh5i3sVWpezp23AGTWch+Mmonu0o0Vb+l6RqdabLmRnveH9ru7j54nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjIwaEFoDhR6JwMDAycyi5nBZaMKY0dgxAaHjoiNzCkuG9VAvF0cDQyMLA4dySERICWRQLCRgUdrB+P/1g0svRuZGFwAB9MiuAAAAA==') format('woff');
}
</style>
<style id="style-core" type="text/css">/***********************************************************************************************************************
 *
 * core.css
 *
 * Copyright © 2014–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

/*
	Default structural styles.
*/
html {
	/*
		We define the base font size and line height here as they affect the layout
		of the base page elements (i.e. `#ui-bar`, `#ui-dialog`, and `#story`).
	*/
	font: 16px/1 Helmet, Freesans, sans-serif;
}

/* Story data styling. */
#store-area, tw-storydata {
	display: none !important;
	z-index: 0;
}

/* Story display area styling. */
#story {
	z-index: 10;
	-webkit-transition: margin-left 200ms ease-in;
	-o-transition: margin-left 200ms ease-in;
	transition: margin-left 200ms ease-in;
}

#story-ar {
	/* added for OLDFASHIONED */
	/* margin: 2.5em; */
	border: 2.5em;
	position: fixed;
    box-sizing: border-box;
	height: 100%;
}

@media screen and (max-width: 1136px) {
	#story {
		margin-right: 1.5em;
	}
}
#passages {
	max-width: 54em;
	margin: 0 auto;
}

#passages-ar {
	/* added for OLDFASHIONED */
	border: 0 auto;
    pointer-events: auto;
	/* overflow-y: auto; */ 
	height: 100%;
}

/* Special no transition styling. */
.no-transition {
	-webkit-transition: none !important;
	-o-transition: none !important;
	transition: none !important;
}

/*
	Default appearance styles.
*/
*:focus {
	outline: thin dotted;
}

/* added for OLDFASHIONED */
html {
	background-color: transparent;
}

body {
	/* changed color and background-color for OLDFASHIONED */
	color: #111;
	background-color: transparent;
}

a {
	cursor: pointer;
	color: #68d;
	text-decoration: none;
	-webkit-transition-duration: 200ms;
	     -o-transition-duration: 200ms;
	        transition-duration: 200ms;
}
a:hover {
	color: #8af;
	text-decoration: underline;
}
a.link-broken {
	color: #c22;
}
a.link-broken:hover {
	color: #e44;
}
span.link-disabled {
	color: #aaa;
}
area {
	cursor: pointer;
}
button {
	cursor: pointer;
	color: #eee;
	background-color: #35a;
	border: 1px solid #57c;
	line-height: normal;
	padding: 0.4em;
	-webkit-transition-duration: 200ms;
	     -o-transition-duration: 200ms;
	        transition-duration: 200ms;
	-webkit-user-select: none;
	   -moz-user-select: none;
	    -ms-user-select: none;
	        user-select: none;
}
button:hover {
	background-color: #57c;
	border-color: #79e;
}
button:disabled {
	cursor: not-allowed;
	background-color: #444;
	border: 1px solid #666;
}
input, select, textarea {
	color: #eee;
	background-color: transparent;
	border: 1px solid #444;
	padding: 0.4em;
}
select {
	padding: 0.34em 0.4em;
}
input[type="text"] {
	min-width: 18em;
}
textarea {
	min-width: 30em;
}
input[type="checkbox"], input[type="file"], input[type="radio"], select {
	cursor: pointer;
}
input:focus, select:focus, textarea:focus,
input:hover, select:hover, textarea:hover {
	background-color: #333;
	border-color: #eee;
}
hr {
	display: block;
	height: 1px;
	border: none;
	border-top: 1px solid #eee;
	margin: 1em 0;
	padding: 0;
}
textarea {
	resize: vertical;
}
audio, canvas, progress, video {
	max-width: 100%;
}

.error {
	padding: 0.25em;
	background-color: #511;
	border-left: 0.5em solid #c22;
}
.error[title] {
	cursor: help;
}
.highlight, .marked {
	color: yellow;
	font-weight: bold;
	font-style: italic;
}
.nobr {
	white-space: nowrap;
}

[data-icon]:before,
[data-icon-before]:before,
[data-icon-after]:after,
.error:before,
#story a.link-external:after {
	font-family: "tme-fa-icons";
	font-style: normal;
	font-weight: normal;
	font-variant: normal;
	text-transform: none;
	line-height: 1;
	speak: none;
}
[data-icon]:before {
	content: attr(data-icon);
}
[data-icon-before]:before {
	content: attr(data-icon-before) "\00a0";
}
[data-icon-after]:after {
	content: "\00a0" attr(data-icon-after);
}
.error:before {
	content: "\00a0\e80d\00a0\00a0";
}
#story a.link-external:after {
	content: "\00a0\e80e";
}

/* Passage styling. */
.passage {
	line-height: 1.75;
	text-align: left;
	-webkit-transition: opacity 400ms ease-in;
	-o-transition: opacity 400ms ease-in;
	transition: opacity 400ms ease-in;

	/* added for OLDFASHIONED */
    pointer-events: auto;
}
.passage-in {
	opacity: 0;
}
.passage ul, .passage ol {
	margin-left: 0.5em;
	padding-left: 1.5em;
}
.passage table {
	margin: 1em 0;
	border-collapse: collapse;
	font-size: 100%;
}
.passage tr, .passage th, .passage td, .passage caption {
	padding: 3px;
}
.passage .error {
	white-space: nowrap;
}

/* Macro styling. */
.macro-repeat-insert,
.macro-timed-insert {
	-webkit-transition: opacity 400ms ease-in;
	-o-transition: opacity 400ms ease-in;
	transition: opacity 400ms ease-in;
}
.macro-repeat-in,
.macro-timed-in {
	opacity: 0;
}
</style>
<style id="style-ui-bar" type="text/css">/***********************************************************************************************************************
 *
 * ui-bar.css
 *
 * Copyright © 2015–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

/*
	Patches to the core styles.
*/
#story {
	margin-left: 20em;
}
#ui-bar.stowed ~ #story {
	margin-left: 1.5em;
}
@media screen and (max-width: 1136px) {
	#story {
		margin-left: 19em;
	}
	#ui-bar.stowed ~ #story {
		margin-left: 1.5em;
	}
}
/*
	At very narrow viewport widths, set `#story{margin-left}` equal to the value
	of `#ui-bar.stowed~#story{margin-left}`, so that `#ui-bar` will side over top
	of `#story` when unstowed, rather than shoving it over.
*/
@media screen and (max-width: 768px) {
	#story {
		margin-left: 3.5em;
	}
}


/*
	Default structural styles.
*/
#ui-bar {
    pointer-events: auto;
	position: fixed;
	z-index: 50;
	top: 0;
	left: 0;
	width: 17.5em;
	height: 100%;
	margin: 0;
	padding: 0;
	color: #eee;
	-webkit-transition: left 200ms ease-in;
	-o-transition: left 200ms ease-in;
	transition: left 200ms ease-in;
}
#ui-bar.stowed {
	left: -17.75em;
}
#ui-bar-body {
	height: 90%; /* fallback for browsers without support for calc() */
	height: calc(100% - 2.5em);
	margin: 2.5em 0;
	padding: 0 1.5em;
}
#ui-bar.stowed #ui-bar-history,
#ui-bar.stowed #ui-bar-body {
	visibility: hidden;
	-webkit-transition: visibility 200ms step-end;
	-o-transition: visibility 200ms step-end;
	transition: visibility 200ms step-end;
}


/*
	Default appearance styles.
*/
#ui-bar {
	background-color: #222;
	border-right: 1px solid #444;
	text-align: center;
}
#ui-bar-tray {
	position: absolute;
	top: 0.2em;
	left: 0;
	right: 0;
}
#ui-bar a {
	text-decoration: none;
}
#ui-bar hr {
	border-color: #444;
}
#ui-bar-toggle,
#ui-bar-history [id|="history"] {
	font-size: 1.2em;
	line-height: inherit;
	color: #eee;
	background-color: transparent;
	border: 1px solid #444;
}
#ui-bar-toggle {
	display: block;
	background-color: #333;
	border-color: #eee;
	color: #eee;
	position: absolute;
	top: 0;
	right: -2em;
/*	border-right: none; */
	padding: 0.3em 0.45em 0.25em;
}
#ui-bar.stowed #ui-bar-toggle {
	padding: 0.3em 0.35em 0.25em 0.55em;
}
#ui-bar-toggle:hover {
	background-color: #eee;
	color: #333;
	border-color: #333;
}
#ui-bar-history {
	margin: 0 auto;
}
#ui-bar-history [id|="history"] {
	padding: 0.2em 0.45em 0.35em;
}
#ui-bar-history #history-jumpto {
	padding: 0.2em 0.665em 0.35em;
}
#ui-bar-history [id|="history"]:not(:first-child) {
	margin-left: 1.2em;
}
#ui-bar-history [id|="history"]:hover {
	background-color: #444;
	border-color: #eee;
}
#ui-bar-history [id|="history"]:disabled {
	color: #444;
	background-color: transparent;
	border-color: #444;
}
#ui-bar-body {
	line-height: 1.5;
	overflow: auto;
}
#ui-bar-body > :not(:first-child) {
	margin-top: 2em;
}
#story-title {
	margin: 0;
	font-size: 162.5%;
}
#story-author {
	margin-top: 2em;
	font-weight: bold;
}
#menu ul {
	margin: 1em 0 0;
	padding: 0;
	list-style: none;
	border: 1px solid #444;
}
#menu ul:empty {
	display: none;
}
#menu li {
	margin: 0;
}
#menu li:not(:first-child) {
	border-top: 1px solid #444;
}
#menu li a {
	display: block;
	padding: 0.25em 0.75em;
	border: 1px solid transparent;
	color: #eee;
	text-transform: uppercase;
}
#menu li a:hover {
	background-color: #444;
	border-color: #eee;
}

/* Stop text selection on certain UI elements. */
#ui-bar-history [id|="history"],
#ui-bar-toggle,
#menu a {
	-webkit-user-select: none;
	   -moz-user-select: none;
	    -ms-user-select: none;
	        user-select: none;
}


/*
	Default font icon styles.
*/
#ui-bar-toggle:before,
#ui-bar-history [id|="history"],
#menu-item-saves a:before,
#menu-item-settings a:before,
#menu-item-restart a:before,
#menu-item-share a:before {
	font-family: "tme-fa-icons";
	font-style: normal;
	font-weight: normal;
	font-variant: normal;
	text-transform: none;
	line-height: 1;
	speak: none;
}
#ui-bar-toggle:before {
	content: "\e81d";
}
#ui-bar.stowed #ui-bar-toggle:before {
	content: "\e81e";
}
#menu-item-saves a:before {
	content: "\e82b\00a0";
}
#menu-item-settings a:before {
	content: "\e82d\00a0";
}
#menu-item-restart a:before {
	content: "\e82c\00a0";
}
#menu-item-share a:before {
	content: "\e82f\00a0";
}
</style>
<style id="style-ui-dialog" type="text/css">/***********************************************************************************************************************
 *
 * ui-dialog.css
 *
 * Copyright © 2015–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

/*
	Patches to the core styles.
*/
html.ui-dialog-open body {
	overflow: hidden;
}


/*
	Default structural styles.
*/
#ui-overlay.open {
	visibility: visible;
    pointer-events: auto;
	-webkit-transition: opacity 200ms ease-in;
	-o-transition: opacity 200ms ease-in;
	transition: opacity 200ms ease-in;
}
#ui-overlay:not(.open) {
	-webkit-transition: visibility 200ms step-end, opacity 200ms ease-in;
	-o-transition: visibility 200ms step-end, opacity 200ms ease-in;
	transition: visibility 200ms step-end, opacity 200ms ease-in;
}
#ui-overlay {
    pointer-events: none;
	visibility: hidden;
	opacity: 0;
	z-index: 1000;
	position: fixed;
	top: 0px;
	left: 0px;
	height: 100%;
	width: 100%;
}
#ui-dialog.open {
	display: block;
    pointer-events: auto;
	-webkit-transition: opacity 200ms ease-in;
	-o-transition: opacity 200ms ease-in;
	transition: opacity 200ms ease-in;
}
/*
	We do not animate `#ui-dialog:not(.open)` for various reasons.  Chief among
	them, however, is so that the dialog isn't in the middle of its animation
	when other page updates happen.

	e.g. The restoration of `overflow` on `body` would cause the still animating
	     dialog to jump around a little if a scrollbar were to pop in.

	     Any dialog action which performs a task which has its own animations
	     (e.g. passage display) or causes the page to reload in addition to
	     closing the dialog could cause display shenanigans.
*/
#ui-dialog {
	display: none;
    pointer-events: none;
	opacity: 0;
	z-index: 1100;
	position: fixed;
	top: 50px;
	color: #eee;
	margin: 0;
	padding: 0;
}
#ui-dialog-titlebar {
	position: relative;
}
#ui-dialog-close {
	display: block;
	position: absolute;
	right: 0;
	top: 0;
	white-space: nowrap;
}
#ui-dialog-body {
	overflow: auto;
	min-width: 280px;
	height: 90%; /* fallback for browsers without support for calc() */
	height: calc(100% - 2.1em - 34px); /* title(2.1em) - top/bottom borders(2px) - top/bottom gutters(32px) */
}

/* Settings dialog styling. */
#ui-dialog-body.settings [id|="setting-body"] {
	display: table;
	width: 100%;
}
#ui-dialog-body.settings [id|="setting-label"] {
	display: table-cell;
	padding: 0.4em 2em 0.4em 0;
}
#ui-dialog-body.settings [id|="setting-label"] + div {
	display: table-cell;
	min-width: 8em;
	text-align: right;
	vertical-align: middle;
	white-space: nowrap;
}


/*
	Default appearance styles.
*/
#ui-overlay {
	background-color: #000;
}
#ui-overlay.open {
	opacity: 0.8;
}
#ui-dialog {
	max-width: 66em;
}
#ui-dialog.open {
	opacity: 1;
}
#ui-dialog-titlebar {
	background-color: #444;
	min-height: 24px;
}
#ui-dialog-title {
	margin: 0;
	padding: 0.2em 3.5em 0.2em 0.5em;
	font-size: 1.5em;
	text-align: center;
	text-transform: uppercase;
}
#ui-dialog-close {
	cursor: pointer;
	font-size: 120%;
	margin: 0;
	padding: 0;
	width: 3.6em;
	height: 92%;
	background-color: transparent;
	border: 1px solid transparent;
	-webkit-transition-duration: 200ms;
	     -o-transition-duration: 200ms;
	        transition-duration: 200ms;
}
#ui-dialog-close:hover {
	background-color: #b44;
	border-color: #d66;
}
#ui-dialog-body {
	background-color: #111;
	border: 1px solid #444;
	text-align: left;
	line-height: 1.5;
	padding: 1em;
}
#ui-dialog-body > *:first-child {
	margin-top: 0;
}
#ui-dialog-body hr {
	background-color: #444;
}

/* Default dialog button bar styling. */
#ui-dialog-body ul.buttons {
	margin: 0;
	padding: 0;
	list-style: none;
}
#ui-dialog-body ul.buttons li {
	display: inline-block;
	margin: 0;
	padding: 0.4em 0.4em 0 0;
}
#ui-dialog-body ul.buttons > li + li > button {
	margin-left: 1em;
}

/* List-based dialog styling (primarily for the Rewind & Share dialogs). */
#ui-dialog-body.list {
	padding: 0;
	min-width: 140px;
}
#ui-dialog-body.list ul {
	margin: 0;
	padding: 0;
	list-style: none;
	border: 1px solid transparent;
}
#ui-dialog-body.list li {
	margin: 0;
}
#ui-dialog-body.list li:not(:first-child) {
	border-top: 1px solid #444;
}
#ui-dialog-body.list li a {
	display: block;
	padding: 0.25em 0.75em;
	border: 1px solid transparent;
	color: #eee;
	text-decoration: none;
}
#ui-dialog-body.list li a:hover {
	background-color: #333;
	border-color: #eee;
}

/* Saves dialog styling. */
#ui-dialog-body.saves {
	padding: 0 0 1px; /* Webkit/Blink need 1px bottom padding or they'll trigger the scroll bar */
}
#ui-dialog-body.saves > *:not(:first-child) {
	border-top: 1px solid #444;
}
#ui-dialog-body.saves table {
	border-spacing: 0;
	min-width: 340px;
	width: 100%;
}
#ui-dialog-body.saves tr:not(:first-child) {
	border-top: 1px solid #444;
}
#ui-dialog-body.saves td {
	padding: 0.33em 0.33em;
}
#ui-dialog-body.saves td:first-child {
	min-width: 1.5em;
	text-align: center;
}
#ui-dialog-body.saves td:nth-child(3) {
	line-height: 1.2;
}
#ui-dialog-body.saves td:last-child {
	text-align: right;
}
#ui-dialog-body.saves .empty {
	color: #999;
}
#ui-dialog-body.saves .datestamp {
	font-size: 75%;
}
#ui-dialog-body.saves ul.buttons li {
	padding: 0.4em;
}
#ui-dialog-body.saves ul.buttons li:last-child {
	/*
		Using `position:absolute;right:0;` here can produce poor results,
		so we use `float:right` instead.
	*/
	float: right;
}

/* Settings dialog styling. */
#ui-dialog-body.settings div[id|="header-body"] {
	margin: 1em 0;
}
#ui-dialog-body.settings div[id|="header-body"]:first-child {
	margin-top: 0;
}
#ui-dialog-body.settings div[id|="header-body"]:not(:first-child) {
	border-top: 1px solid #444;
	padding-top: 1em;
}
#ui-dialog-body.settings div[id|="header-body"] > * {
	margin: 0;
}
#ui-dialog-body.settings h2[id|="header-heading"] {
	font-size: 1.375em;
}
#ui-dialog-body.settings p[id|="header-label"] {
	font-size: 87.5%;
}
#ui-dialog-body.settings div[id|="setting-body"] + div[id|="setting-body"] {
	margin: 0.5em 0;
}
#ui-dialog-body.settings [id|="setting-control"] {
	white-space: nowrap;
}
#ui-dialog-body.settings button[id|="setting-control"] {
	color: #eee;
	background-color: transparent;
	border: 1px solid #444;
	padding: 0.4em;
}
#ui-dialog-body.settings button[id|="setting-control"]:hover {
	background-color: #333;
	border-color: #eee;
}
#ui-dialog-body.settings button[id|="setting-control"].enabled {
	background-color: #282;
	border-color: #4a4;
}
#ui-dialog-body.settings button[id|="setting-control"].enabled:hover {
	background-color: #4a4;
	border-color: #6c6;
}

/* Share dialog styling. */
#ui-dialog-body.share {
	min-width: 140px;
}

/* Stop text selection on certain UI elements. */
#ui-dialog-close,
#ui-dialog-body.list a,
#ui-dialog-body.settings span[id|="setting-input"] {
	-webkit-user-select: none;
	   -moz-user-select: none;
	    -ms-user-select: none;
	        user-select: none;
}


/*
	Default font icon styles.
*/
#ui-dialog-close,
#ui-dialog-body.saves button[id="saves-export"]:before,
#ui-dialog-body.saves button[id="saves-import"]:before,
#ui-dialog-body.saves button[id="saves-clear"]:before,
#ui-dialog-body.settings button[id|="setting-control"]:after,
#ui-dialog-body.settings button[id|="setting-control"].enabled:after {
	font-family: "tme-fa-icons";
	font-style: normal;
	font-weight: normal;
	font-variant: normal;
	text-transform: none;
	line-height: 1;
	speak: none;
}
#ui-dialog-body.saves button[id="saves-export"]:before {
	content: "\e829\00a0";
}
#ui-dialog-body.saves button[id="saves-import"]:before {
	content: "\e82a\00a0";
}
#ui-dialog-body.saves button[id="saves-clear"]:before {
	content: "\e827\00a0";
}
#ui-dialog-body.settings button[id|="setting-control"]:after {
	content: "\00a0\00a0\e830";
}
#ui-dialog-body.settings button[id|="setting-control"].enabled:after {
	content: "\00a0\00a0\e831";
}
</style>
<style id="style-debugview" type="text/css">/***********************************************************************************************************************
 *
 * debugview.css
 *
 * Copyright © 2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

/*
	Patches to the UI bar styles.
*/
#ui-bar-body > #debug-view-toggle:first-child {
	margin-top: 1em;
}
#ui-bar-body > #debug-view-toggle:first-child + * {
	margin-top: 1em;
}


/*
	UI bar debug view toggle button styles.
*/
#debug-view-toggle {
	text-transform: uppercase;
}
#debug-view-toggle:before,
#debug-view-toggle:after {
	font-family: "tme-fa-icons";
	font-style: normal;
	font-weight: normal;
	font-variant: normal;
	text-transform: none;
	line-height: 1;
	speak: none;
}
#debug-view-toggle:before {
	content: "\e838\00a0";
}
html:not(.debug-view) #debug-view-toggle {
	color: #eee;
	background-color: transparent;
	border: 1px solid #444;
	padding: 0.4em;
}
html:not(.debug-view) #debug-view-toggle:hover {
	background-color: #333;
	border-color: #eee;
}
html:not(.debug-view) #debug-view-toggle:after {
	content: "\00a0\00a0\e830";
}
html.debug-view #debug-view-toggle {
	background-color: #282;
	border-color: #4a4;
}
html.debug-view #debug-view-toggle:hover {
	background-color: #4a4;
	border-color: #6c6;
}
html.debug-view #debug-view-toggle:after {
	content: "\00a0\00a0\e831";
}


/*
	Default debug view styles.
*/
html.debug-view .debug {
	padding: 0.25em;
	background-color: #234; /* #541, #151 */
}
html.debug-view .debug[title] {
	cursor: help;
}
html.debug-view .debug.block {
	display: inline-block;
	vertical-align: middle;
}
html.debug-view .debug.invalid {
	text-decoration: line-through;
}
html.debug-view .debug.hidden,
html.debug-view .debug.hidden .debug {
	background-color: #555;
}
html:not(.debug-view) .debug.hidden {
	display: none;
}

html.debug-view .debug[data-name][data-type]:before,
html.debug-view .debug[data-name][data-type].nonvoid:after {
	background-color: rgba(0,0,0,0.25);
	font-family: monospace, monospace;
	white-space: pre;
}
html.debug-view .debug[data-name][data-type]:before {
	content: attr(data-name);
}
html.debug-view .debug[data-name][data-type|="macro"]:before {
	content: "<<" attr(data-name) ">>";
}
html.debug-view .debug[data-name][data-type|="macro"].nonvoid:after {
	content: "<</" attr(data-name) ">>";
}
html.debug-view .debug[data-name][data-type|="html"]:before {
	content: "<" attr(data-name) ">";
}
html.debug-view .debug[data-name][data-type|="html"].nonvoid:after {
	content: "</" attr(data-name) ">";
}
html.debug-view .debug[data-name][data-type]:not(:empty):before {
	margin-right: 0.25em;
}
html.debug-view .debug[data-name][data-type].nonvoid:not(:empty):after {
	margin-left: 0.25em;
}
html.debug-view .debug[data-name][data-type|="special"],
html.debug-view .debug[data-name][data-type|="special"]:before {
	display: block;
}
</style>
</head>
<body>
	<div id="init-screen">
		<p id="init-no-js"><noscript>Apologies! JavaScript is required. Please enable it to continue.</noscript></p>
		<p id="init-lacking">Apologies! You are using an <strong>outdated</strong> browser which lacks required capabilities. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
		<p id="init-loading">Initializing. Please wait&hellip;<br /><progress></progress></p>
	</div>
	<div id="hud"></div>
	<ar-scene id="argon-aframe">
	</ar-scene>
	<div id="store-area" hidden><tw-storydata name="understanding-ar" startnode="1" creator="Twine" creator-version="2.0.11" ifid="65CD69EF-27B2-4D0A-9464-A2006DEAE27C" format="OldFashioned" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">#story {
}

#learn {
	text-align: center;
}


.blurb
{
	margin: 0 !important;
	position: absolute;
	bottom: 0px;
	left: 0px;
	width: 100%
	text-align: center;
	color: rgb(0,0,0);
	background: rgb(255,255,255);
	outline: 3px solid rgba(127,255,255,0.5);
	border: 0px;
  font-size: 14px;
	padding: 10px;
}

.blurb b {
	display: block;
	text-align: center;
	margin: 0;
	padding: 0;
}







</style><script role="script" id="twine-user-script" type="text/twine-javascript">Config.ui.stowBarInitially = true; 
Config.saves.autoload = false;
Config.saves.autosave = false;

var storyEvents = [];
var passageEvents = [];

predisplay['#argon-passage-cleanup'] = function (task) {
		for (var i=0; i<passageEvents.length; i++) { 
			var e = passageEvents[i];
			e.target.removeEventListener(e.eventName, e.callback);
		}
		passageEvents = [];
		$('#passage-entities').empty();
};

function getComponentAttrFromArg(arg) {
	var eq = arg.indexOf("=");
	if (eq == -1) {
		return(arg);
	} else if (eq == 0 || eq == arg.length-1) {
		return "";
	} else {
		return arg.slice(0,eq) + ":" + arg.slice(eq+1) + ";";
	}
}

function setAttrFromArg(target, arg) {
	var eq = arg.indexOf("=");
	if (eq == -1) {
		target.attr(arg);
	} else if (eq == 0 || eq == arg.length-1) {
		return false;
	} else {
		target.attr(arg.slice(0,eq), arg.slice(eq+1));
	}
}

// <<deleteEntity name >>
// <<showEntity name >>
// <<hideEntity name >>
Macro.add(['removeEntity','showEntity','hideEntity'], {
		handler() {
			if (this.args.length < 1) {
				return this.error('must specify entity name');
			}

			var targetId = this.args[0];

			// want to search both story and passage entities for the entity to manipulate
			var $container = $("#story-entities").add("#passage-entities");

			var $targets = $container.find("#" + targetId);
			
			if ($targets.length > 0) {
				switch (this.name) {
				case "removeEntity":
					$container.remove($targets);
					break;
					
				case "showEntity":
					$targets.attr("visible", "true");
					break;
				
				case "hideEntity":
					$targets.attr("visible", "false");
					break;
				}
			} else {
				return this.error('passage "' + targetId + '" does not exist.');
			}
		}
});		

// <<createReferenceEntity name story|passage "parent frame" * >>
Macro.add(['createReferenceFrameEntity'], {
		handler() {
			if (this.args.length < 3) {
				return this.error('need selector, name and parent frame name');
			}

			var targetId = this.args[0];

			var $container;
			if (this.args[1] === "story") {
				$container = $("#story-entities");
			} else if (this.args[1] === "passage") {
				$container = $("#passage-entities");
			} else {
				return this.error('3D content type must be "story" or "passage": "' + this.args[1] + '" invalid');
			}

			var $targets = $container.find("#" + targetId);

			if ($targets.length > 0) {
				return this.error('passage "' + targetId + '" already exists.');
			} 

			$targets = jQuery(document.createElement('ar-frame'));
			$targets.attr({
				"id": targetId,
				"parent": this.args[2]
			});

			for (var i = 3; i<this.args.length; i++) {
				setAttrFromArg($targets, this.args[i]);
			}

			$container.append($targets);	
		}
});


// <<append3d name>> content <</append3d>>
Macro.add(['append3d', 'replace3d'], {
		tags : null,

		handler() {
			if (this.args.length < 1) {
				return this.error('must specify entity name');
			}
			
			var targetId = this.args[0];

			// want to search both story and passage entities for the entity to manipulate
			var $container = $("#story-entities").add("#passage-entities");
			
			var $targets = $container.find("#" + targetId);
			if ($targets.length === 0) {
				return this.error('passage "' + targetId + '" does not exist.');
			} 
			
			if (this.name === 'replace3d') {
				$targets.empty();
			}

			if (this.payload[0].contents !== '') {
				var frag = document.createDocumentFragment();
				new Wikifier(frag, this.payload[0].contents);
			    var div = document.createElement('div');
			    div.appendChild(frag);
				var text = div.innerText;

				console.log("storing content in 3D element: " + text);
  	            $targets.append(text);
			}
		}
});

// <<addAsset>> content <</addAsset>>
Macro.add(['addAsset'], {
		tags: null,

		handler () {
			var $assets = $("a-assets");
			if ($assets.length === 0) {
				$assets = jQuery(document.createElement('a-assets'));
				$("#argon-aframe").prepend($assets);
			}
			if (this.payload[0].contents !== '') {
				var frag = document.createDocumentFragment();
				new Wikifier(frag, this.payload[0].contents);
			    var div = document.createElement('div');
			    div.appendChild(frag);
				var text = div.innerText;

  	            $assets.append(text);
			}			
		}
});

// <<onEvent name story|passage target event [eventVar]>> twine code to run <</onEvent>>
Macro.add(['onEvent'], {
	tags: null,

	handler () {
			if (this.args.length < 4) {
				return this.error('must specify a name for the event, story or passage, a jquery selector, event name (optional variable name for event data)');
			}

			var thisName = this.args[0];
			var targetId = this.args[2];
			var eventList;

			// want to search the entire 3D scene for possible targets
			var $container = $("#argon-aframe");
			var $targets = targetId === "#argon-aframe" ? $container :  $container.find(targetId);
			if ($targets.length === 0) {
				return this.error('passage "' + targetId + '" does not exist.');
			} 


			if (this.args[1] === "story") {
				eventList = storyEvents;
			} else if (this.args[1] === "passage") {
				eventList = passageEvents;
			} else {
				return this.error('3D content type must be "story" or "passage": "' + this.args[1] + '" invalid');
			}
			
			var tempVar = false;
			var varName = undefined;
			if (this.args.length > 4) {
				//	return this.error('variable name must start with $ or _: ' + this.args[1] + " " + this.args[2] + " " + this.args[3]);
				
				varName = this.args[4];
				if (varName[0] === '_') {
					tempVar = true;
					varName = varName.slice(1);
				} else if (varName[0] === '$') {
					varName = varName.slice(1);
				} else {
					return this.error('variable name must start with $ or _');
				}
			}
			var contents = this.payload[0].contents;
			if (contents === '') {
				return; /// do nothing
			}

			var eventName = this.args[3];
			var name = this.payload[0].name;
			var source = this.payload[0].source;

			// if the target matched multiple targets, attach the event to each one
			for (var i = 0; i < $targets.length; i++) {
				// create somewhere to store the output if an error
				var eventOutput = jQuery(document.createElement('span'))
					.addClass(`macro-${this.name}`)
					.appendTo(this.output);

				// if (Config.debug && curItem.name === 'next') {
				// 	eventOutput = jQuery((new DebugView( // eslint-disable-line no-param-reassign
				// 		eventOutput[0],
				// 		'macro',			
				// 		name,
				// 		source
				// 	)).output);
				// }

				var cbFunc = function (evt) {
					if (varName) {
						if (tempVar) {
							TempVariables[varName] = evt;
						} else {
							State.variables[varName] = evt;
						}
					}
					// empty the contents, so we can update them
					eventOutput.empty();
					var frag = document.createDocumentFragment();
					new Wikifier(frag, contents);
					eventOutput.append(frag);
				}
				$targets[i].addEventListener(eventName, cbFunc);
				var newEvent = {
					name: thisName,
					targetId: targetId,
					target: $targets[i],
					eventName: eventName,
					callback: cbFunc
				}
				eventList.push(newEvent);
			}
		
	}
});

// <<removeEvent name>>
Macro.add(["removeEvent"], {
		handler () {
			if (this.args.length < 1) {
				return this.error('must specify onEvent name');
			}

			var eventName = this.args[0];

			var filterFunc = function(e) {
				if (e.name == eventName) {
					e.target.removeEventListener(e.eventName, e.callback);
					return false;
				} 
				return true;
			};
			storyEvents = storyEvents.filter(filterFunc);
			passageEvents = passageEvents.filter(filterFunc);
		}
});

//
Macro.add(["initVuforia"], {
	handler () {
		if (this.args.length < 1) {
				return this.error('parameter missing: key file url');
		}

		var keyElem = document.createElement('a-asset-item');
		var $keyElem = jQuery(keyElem);
		$keyElem.attr({
		   "id" : "vuforiakey",
  		   "src" : this.args[0]
		});

		keyElem.addEventListener('loaded', function(evt) {
			$('#argon-aframe').attr("vuforiakey", "#vuforiakey");
		});
  	$('#argon-aframe').prepend($keyElem);
	}
});

Macro.add(["vuforiaDataset"], {	
	handler () {
		if (this.args.length < 2) {
				return this.error('parameters are {id, dataset url}');
		}
		console.log("dataset: " + this.args[1]);
		$('#argon-aframe').attr("vuforiadataset__" + this.args[0], "src:url(" + this.args[1] + ");");
	}
});

// <<createHUD name [name-2]>>
Macro.add(["createHUD"], {	
	handler () {
		if (this.args.length < 1) {
				return this.error('parameters is one or two names for left (and right) hud elements');
		}

		var hudElem1 = document.createElement('div');
		var $hudElem1 = jQuery(hudElem1).attr("id", this.args[0]);

		var hudElem2 = document.createElement('div');
		var $hudElem2 = jQuery(hudElem2).attr("id", this.args.length < 2 ? this.args[0] + "-2": this.args[1]);

		var arScene = document.querySelector('ar-scene');
		arScene.hud.appendChild(hudElem1, hudElem2);
	}
});

// <<deleteHUD name [name-2]>>
// <<showHUD name [name-2]>>
// <<hideHUD name [name-2]>>
Macro.add(['removeHUD','showHUD','hideHUD'], {
		handler() {
			if (this.args.length < 1) {
				return this.error('must specify HUD element name');
			}

			var targetId1 = this.args[0];
			var targetId2 = this.args.length < 2 ? this.args[0] + "-2": this.args[1];

			// want to search both story and passage entities for the entity to manipulate
			var $container = $("#hud");
			var $targets = $container.find("#" + targetId1).add($container.find("#" + targetId2));
			
			if ($targets.length > 0) {
				switch (this.name) {
				case "removeHUD":
					$targets.remove();
					break;
					
				case "showHUD":
					targets.attr("visible", "true");
					break;
				
				case "hideHUD":
					targets.attr("visible", "false");
					break;
				}
			} else {
				return this.error('passage "' + targetId + '" does not exist.');
			}
		}
});








</script><tw-passagedata pid="1" name="Start" tags="" position="567,254">&lt;&lt;set $onPages = [&quot;&quot;]&gt;&gt;
&lt;center&gt;
&lt;h2 id=&quot;title&quot;&gt;Understanding AR&lt;/h2&gt;
&lt;/center&gt;

&lt;p id=&quot;learn&quot;&gt;Let&#39;s learn about the history of AR!&lt;/p&gt;

&lt;p id=&quot;message&quot;&gt;&lt;em&gt;Loading ...&lt;/em&gt;&lt;/p&gt;

&lt;&lt;nobr&gt;&gt;

/* create a spinner to show while loading */
&lt;&lt;createReferenceFrameEntity spinningbox passage ar.user&gt;&gt;
&lt;&lt;createHUD &quot;hudElem&quot; &quot;hudElem2&quot;&gt;&gt;

/* if vuforia isn&#39;t available, tell the user we can&#39;t do
   anything on this platform */
&lt;&lt;onEvent vuforiaNotAvailable passage &quot;#argon-aframe&quot; argon-vuforia-not-available &quot;_evt&quot;&gt;&gt; 
	&lt;&lt;replace &quot;#message&quot;&gt;&gt;&lt;b&gt;Your browser does not support Vuforia AR tracking software, please consider using Argon4.&lt;/b&gt;&lt;&lt;/replace&gt;&gt;
    &lt;&lt;addclass &quot;#hudElem&quot; hide&gt;&gt;
    &lt;&lt;addclass &quot;#hudElem2&quot; hide&gt;&gt;
	&lt;&lt;hideEntity spinningbox&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;

/* follow the initialization steps, providing feedback 
   to the user along the way.  Many of these won&#39;t happen
   if the web app is set up correctly, but we pay attention
   anyway to help with debugging */
&lt;&lt;onEvent argonInit passage &quot;#argon-aframe&quot; argon-initialized&gt;&gt;
	&lt;&lt;replace &quot;#message&quot;&gt;&gt;Argon initialized, start vision tracker...&lt;&lt;/replace&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;

&lt;&lt;onEvent vuforiaInit passage &quot;#argon-aframe&quot; argon-vuforia-initialized&gt;&gt; 
	&lt;&lt;replace &quot;#message&quot;&gt;&gt;Vision tracker initialized, downloading tracking data...&lt;&lt;/replace&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;

&lt;&lt;onEvent vuforiaInitFailed passage &quot;#argon-aframe&quot; argon-vuforia-initialization-failed &quot;_evt&quot;&gt;&gt; 
	&lt;&lt;replace &quot;#message&quot;&gt;&gt;Vision tracker failed to initialize: _evt.detail.error.message&lt;&lt;/replace&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;

&lt;&lt;onEvent vuforiaLoadFailed passage &quot;#argon-aframe&quot; argon-vuforia-dataset-load-failed &quot;_evt&quot;&gt;&gt; 
	&lt;&lt;replace &quot;#message&quot;&gt;&gt;Failed to load tracking dataset: _evt.detail.error.message&lt;&lt;/replace&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;

/* change the style of the small hud element used to 
   say &quot;look at the brochure&quot; in viewer mode */ 
&lt;&lt;onEvent enterVR story &quot;#argon-aframe&quot; enter-vr &quot;_evt&quot; &gt;&gt;
    &lt;&lt;addclass &quot;#hudElem&quot; viewerMode&gt;&gt;
    &lt;&lt;addclass &quot;#hudElem2&quot; viewerMode&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;
&lt;&lt;onEvent exitVR story &quot;#argon-aframe&quot; exit-vr &quot;_evt&quot; &gt;&gt;
    &lt;&lt;removeclass &quot;#hudElem&quot; viewerMode&gt;&gt;
    &lt;&lt;removeclass &quot;#hudElem2&quot; viewerMode&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;

&lt;&lt;onEvent vuforiaLoaded passage &quot;#argon-aframe&quot; argon-vuforia-dataset-loaded &quot;_evt&quot;&gt;&gt;
&lt;&lt;replace &quot;#message&quot;&gt;&gt;&lt;&lt;/replace&gt;&gt;
&lt;&lt;append &quot;#hudElem&quot;&gt;&gt;Look at a symbol to begin&lt;&lt;/append&gt;&gt;
&lt;&lt;append &quot;#hudElem2&quot;&gt;&gt;Look at a symbol to begin&lt;&lt;/append&gt;&gt;
&lt;&lt;addclass &quot;#hudElem&quot; topScreen&gt;&gt;
&lt;&lt;addclass &quot;#hudElem2&quot; topScreen&gt;&gt;

&lt;&lt;set $trackables to _evt.detail.trackables&gt;&gt; 
&lt;&lt;set $trackableKeys to Object.keys(_evt.detail.trackables)&gt;&gt;
&lt;&lt;set $trackablesFound to 0&gt;&gt;
&lt;&lt;set $onPages = []&gt;&gt;

&lt;&lt;for _i to 0; _i lt $trackableKeys.length; _i++&gt;&gt;
	&lt;&lt;set _t to $trackableKeys[_i]&gt;&gt;
	&lt;&lt;set _tObject to $trackables[_t]&gt;&gt;
	&lt;&lt;set _tEntity to _t+&quot;-entity&quot;&gt;&gt;
	&lt;&lt;set _tTrigger to _t+&quot;-trigger&quot;&gt;&gt;
	&lt;&lt;set _tTarget to &quot;vuforia.storybook.&quot;+_t&gt;&gt;
	&lt;&lt;set _tSelector to &quot;#&quot;+_tEntity&gt;&gt;
	&lt;&lt;set _tName to &quot;targetStatus-&quot;+_t&gt;&gt;
	
	&lt;&lt;set _tPassage to _t&gt;&gt; 

	&lt;&lt;set _tObject.entityName to _tEntity&gt;&gt;
	&lt;&lt;set _tObject.triggerName to _tTrigger&gt;&gt;
	&lt;&lt;set _tObject.selector to _tSelector&gt;&gt;
	&lt;&lt;set _tObject.found to false&gt;&gt;
	&lt;&lt;set _tObject.eventName to _tName&gt;&gt;
	&lt;&lt;set _tObject.referenceName to _tTarget&gt;&gt;
	&lt;&lt;set _tObject.passageName to _tPassage&gt;&gt;
	&lt;&lt;set _tObject.initPassage to false&gt;&gt;
	
	&lt;&lt;set _tTriggerString to &quot;trigger=radius:0.25;event:&quot;+_tTrigger+&quot;;&quot;&gt;&gt;
	
	&lt;&lt;createReferenceFrameEntity _tEntity story _tTarget  trackvisibility=true visible=false _tTriggerString&gt;&gt;

&lt;&lt;set _ttt to &quot;gvulink-&quot; + _t&gt;&gt;


&lt;&lt;script&gt;&gt;
$(&quot;#ttttttt&quot;).attr(&quot;id&quot;, TempVariables.ttt);



&lt;&lt;/script&gt;&gt;

&lt;&lt;set _tempStr to &quot;css-object=&#39;div:#gvulink-&quot; + _t + &quot;&#39;&quot;&gt;&gt;
&lt;&lt;append3d _tEntity&gt;&gt;
&lt;a-entity&gt;
  &lt;a-entity _tempStr scale=&quot;0.0003 0.0003 0.0003&quot; rotation=&quot;0 0 0&quot; position=&quot;0 -0.1600 0&quot;&gt;&lt;/a-entity&gt;
&lt;/a-entity&gt;
&lt;&lt;/append3d&gt;&gt;

&lt;&lt;onEvent _tName story _tSelector referenceframe-statuschanged &quot;_evt&quot;&gt;&gt; 
&lt;&lt;set _rfc_name to _evt.detail.target.id&gt;&gt;
&lt;&lt;if _rfc_name.endsWith(&quot;-entity&quot;)&gt;&gt;
  &lt;&lt;set _rfc_name to _rfc_name.slice(0,-7)&gt;&gt;
  &lt;&lt;set _rfcObject to $trackables[_rfc_name]&gt;&gt;
  &lt;&lt;set _rfcGoto to null&gt;&gt;
  &lt;&lt;set _rfcObject.found to _evt.detail.found&gt;&gt;
  &lt;&lt;set $trackablesFound to 0&gt;&gt;
  &lt;&lt;set _rfc_stay to false&gt;&gt;
  &lt;&lt;for _rfc_i to 0; _rfc_i lt $trackableKeys.length; _rfc_i++&gt;&gt;
	 &lt;&lt;set _rfc_o to $trackables[$trackableKeys[_rfc_i]]&gt;&gt;
	 &lt;&lt;set _rfc_t to _rfc_o.found&gt;&gt;
	 &lt;&lt;if _rfc_t&gt;&gt;
	 	&lt;&lt;set $trackablesFound = $trackablesFound + 1&gt;&gt;  
		&lt;&lt;set _rfcGoto to _rfc_o&gt;&gt;
		&lt;&lt;if $onPages.includes($trackableKeys[_rfc_i])&gt;&gt;
			&lt;&lt;set _rfc_stay to true&gt;&gt;
		&lt;&lt;/if&gt;&gt;
     &lt;&lt;/if&gt;&gt;
  &lt;&lt;/for&gt;&gt;
  &lt;&lt;if $trackablesFound eq 0&gt;&gt;
    &lt;&lt;removeclass &quot;#hudElem&quot; hide&gt;&gt;
    &lt;&lt;removeclass &quot;#hudElem2&quot; hide&gt;&gt;
  &lt;&lt;else&gt;&gt;
    &lt;&lt;addclass &quot;#hudElem&quot; hide&gt;&gt;
    &lt;&lt;addclass &quot;#hudElem2&quot; hide&gt;&gt;
	&lt;&lt;if not _rfc_stay&gt;&gt;
		&lt;&lt;if _rfcGoto isnot null&gt;&gt;
		   &lt;&lt;replace &quot;#hudElem&quot;&gt;&gt;&lt;&lt;/replace&gt;&gt;
		   &lt;&lt;replace &quot;#hudElem2&quot;&gt;&gt;&lt;&lt;/replace&gt;&gt;
		  
			&lt;&lt;goto _rfcGoto.passageName&gt;&gt;
		&lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
  &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/onEvent&gt;&gt;
&lt;&lt;/for&gt;&gt;	
&lt;&lt;/onEvent&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata>
<tw-passagedata pid="2" name="StoryInit" tags="" position="91,256">/* we want to use vuforia for this story */
&lt;&lt;initVuforia &quot;http://philkt.me/understanding-ar-twine/key.txt&quot;&gt;&gt;
&lt;&lt;vuforiaDataset storybook &quot;http://philkt.me/understanding-ar-twine/datasets/storybook.xml&quot;&gt;&gt;

&lt;&lt;set $trackables to {}&gt;&gt; 
&lt;&lt;set $trackableKeys to []&gt;&gt;
&lt;&lt;set $trackablesFound to 0&gt;&gt;
&lt;&lt;set $onPages = []&gt;&gt;

Config.saves.autoload = false;

&lt;&lt;addAsset&gt;&gt;

        &lt;a-asset-item id=&quot;damocles-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/damocles/damocles.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;damocles-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/damocles/damocles.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
        &lt;a-asset-item id=&quot;artoolkit-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/artoolkit/artoolkit.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;artoolkit-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/artoolkit/artoolkit.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
        &lt;a-asset-item id=&quot;googleglass-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/google-glass/google-glass.obj&quot;&gt;&lt;/a-asset-item&gt;
		&lt;a-asset-item id=&quot;googleglass-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/google-glass/google-glass.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
		&lt;a-asset-item id=&quot;hololens-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/hololens/hololens.obj&quot;&gt;&lt;/a-asset-item&gt;
		&lt;a-asset-item id=&quot;hololens-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/hololens/hololens.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
        &lt;a-asset-item id=&quot;pokemongo-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/pokemon-go/pokemon-go.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;pokemongo-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/pokemon-go/pokemon-go.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
        &lt;a-asset-item id=&quot;videoplace-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/videoplace/videplace.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;videoplace-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/videoplace/videplace.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
		&lt;a-asset-item id=&quot;eyetap-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/eyetap/eyetap.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;eyetap-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/eyetap/eyetap.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
		&lt;a-asset-item id=&quot;argon-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/argon/argon.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;argon-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/argon/argon.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
		&lt;a-asset-item id=&quot;fixtures-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/fixture/fixture.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;fixtures-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/fixture/fixture.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
		&lt;a-asset-item id=&quot;quake-obj&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/quake/quake.obj&quot;&gt;&lt;/a-asset-item&gt;
        &lt;a-asset-item id=&quot;quake-mtl&quot; src=&quot;http://philkt.me/understanding-ar-twine/models/quake/quake.mtl&quot;&gt;&lt;/a-asset-item&gt;
		
&lt;&lt;/addAsset&gt;&gt;</tw-passagedata>
<tw-passagedata pid="3" name="damocles" tags="" position="375,0">&lt;&lt;set $onPages = [&quot;damocles&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Sword of Damocles&lt;/b&gt;
[[The Sword of Damocles was created in 1968 by Ivan Sutherland. It was considered the world’s first augmented virtual reality headset. The design and UI was considered primitive as it was not a fully immersive AR experience. |damocles-2]]
&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;damocles&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #damocles-obj; mtl: #damocles-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;


&lt;&lt;/append3d&gt;&gt;



&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="4" name="artoolkit" tags="" position="250.0001,121">&lt;&lt;set $onPages = [&quot;artoolkit&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Ar Toolkit&lt;/b&gt;
[[ARToolKit was developed by Hirokazu Kato in 2000. It is an open-source library that overlays computer graphics onto the camera. Developers were able to overcome the problem of calculating the user’s viewpoint in real time.|artoolkit-2]]
&lt;/div&gt;
&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;artoolkit&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #artoolkit-obj; mtl: #artoolkit-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="5" name="googleglass" tags="" position="281,257">&lt;&lt;set $onPages = [&quot;googleglass&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Google Glass&lt;/b&gt;
[[Google Glass was developed by Google X. Released to the public in 2013, the device resembles eyeglasses and includes a touchpad, a camera, and display. It is activated either by the touchpad or by voice activation, allowing convenience to the user as they go through their day to day.|googleglass-2]]
&lt;/div&gt;
&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;googleglass&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #googleglass-obj; mtl: #googleglass-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;

&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="6" name="pokemongo" tags="" position="871.0001,260">&lt;&lt;set $onPages = [&quot;pokemongo&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Pokemon GO&lt;/b&gt;
[[Released in summer of 2016 to immense popularity, Pokemon GO is an AR smartphone app inspired by the Pokemon video game franchise and developed by Niantic Inc, who previously developed an AR game called Ingress. Players can walk around the real world and encounter virtual Pokemon to catch to use in battle.|pokemongo-2]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;pokemongo&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #pokemongo-obj; mtl: #pokemongo-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="7" name="videoplace" tags="" position="880,0">&lt;&lt;set $onPages = [&quot;videoplace&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Videoplace&lt;/b&gt;
[[Established by Myron Krueger in the mid-1970&#39;s, Videoplace was an AR lab created with the vision of an artificual reality that surrounded its users, and responded to their movements and actions without requiring them to wear any peripheral gear like goggles or gloves.|videoplace-2]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;videoplace&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #videoplace-obj; mtl: #videoplace-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="8" name="videoplace-2" tags="" position="710,0">&lt;&lt;set $onPages = [&quot;videoplace&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Videoplace&lt;/b&gt;
[[The Videoplace used projectors, video camers, some special hardware, and onscreen silhouetttes to place people in an interactive environment on a screen, which allowed users in separate rooms to interact with one another. People could interact with objects on the screen which gave them a sense of precense even though they received no direct physical feedback. The Videoplace is permanently displayed at the University of Connecticut.|Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;videoplace&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #videoplace-obj; mtl: #videoplace-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="9" name="pokemongo-2" tags="" position="700,261">&lt;&lt;set $onPages = [&quot;pokemongo&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Pokemon GO&lt;/b&gt;
[[Trainers can also visit landmark locations in their local neighborhood to collect items in-game, as well as battle other players with their Pokemon for control of Gyms. Pokemon GO is the most visible and popular AR app to have ever launded and may lead to greater development and players of future AR games to come.|Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;pokemongo&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #pokemongo-obj; mtl: #pokemongo-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="10" name="damocles-2" tags="" position="575,40">&lt;&lt;set $onPages = [&quot;damocles&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Sword of Damocles&lt;/b&gt;
[[It was so heavy when placed on the user’s head that it had to be suspended by a pole connected to the ceiling so that it wouldn’t hurt the user. While early in development, the Sword of Damocles inspired future creations, such as the Oculus Rift.|Start]]
&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;damocles&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #damocles-obj; mtl: #damocles-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;


&lt;&lt;/append3d&gt;&gt;



&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="11" name="artoolkit-2" tags="" position="449,128">&lt;&lt;set $onPages = [&quot;artoolkit&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;AR Toolkit&lt;/b&gt;
[[This library allowed them to software to calculate the camera position and orientation so as to overlay a virtual object onto the real world camera. To this day, it is still used to compliment other AR libraries.|Start]]
&lt;/div&gt;
&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;artoolkit&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #artoolkit-obj; mtl: #artoolkit-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="12" name="googleglass-2" tags="" position="433,261">&lt;&lt;set $onPages = [&quot;googleglass&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Google Glass&lt;/b&gt;
[[However, due to privacy concerns, the headset has been subject to massive criticism and legislation action. Despite these setbacks, Google Glass has set the trend for wearable devices and Google has filed a new application with the FCC for a new version of the product.|Start]]
&lt;/div&gt;
&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;googleglass&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #googleglass-obj; mtl: #googleglass-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;

&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="13" name="eyetap" tags="" position="446,476">&lt;&lt;set $onPages = [&quot;eyetap&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Eyetap&lt;/b&gt;
[[Developed by Steve Mann, the original eyetap was a computer in a backpack that was attached to a camera and screwed into a helmet. After many iterations, the device became lighter and smaller. |Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;eyetap&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #eyetap-obj; mtl: #eyetap-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;


&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="14" name="argon" tags="" position="276,450">&lt;&lt;set $onPages = [&quot;argon&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Argon&lt;/b&gt;
[[Argonjs is a javascript framework developed at Georgia Tech (and also what&#39;s powering this storybook ;)). Argon was created in the Augmented Environments lab at Georgia Tech. |Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;argon&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;

&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #argon-obj; mtl: #argon-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;



&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="15" name="virtualfixtures" tags="" position="1012,155">&lt;&lt;set $onPages = [&quot;virtualfixtures&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Virtual Fixtures&lt;/b&gt;
[[Developed by Louis Rosenberg in 1992, Virtual Fixtures was considered the first fully immersive Augmented Reality system. The system used two physical robots that were worn by the user. |virtualfixtures-2]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;virtualfixtures&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #fixtures-obj; mtl: #fixtures-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="16" name="virtualfixtures-2" tags="" position="777,135">&lt;&lt;set $onPages = [&quot;virtualfixtures&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Virtual Fixtures&lt;/b&gt;
[[The system also incorporated a binocular magnifier aligned to the user’s view that would display the location of the user’s arms. Virtual Fixtures had physical constraints as the user was using it within its virtual environment. While created in the early 1990s, it still gave the user a fully immersive experience in a virtual world.|Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;virtualfixtures&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #fixtures-obj; mtl: #fixtures-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="17" name="arquake" tags="" position="966,464">&lt;&lt;set $onPages = [&quot;arquake&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;AR Quake&lt;/b&gt;
[[Developed in the Wearable Computing Lab at the University of South Australia, AR Quake is an augmented reality version of the game Quake. It was designed to immerse players in the game by overlaying virtual images onto the real world. |arquake-2]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;arquake&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #quake-obj; mtl: #quake-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="18" name="arquake-2" tags="" position="772,452">&lt;&lt;set $onPages = [&quot;arquake&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;AR Quake&lt;/b&gt;
[[Users could then play the game in the real world! Albeit with a giant backpack on themselves, and no BFG. |Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;arquake&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #quake-obj; mtl: #quake-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="19" name="hololens" tags="" position="631,565">&lt;&lt;set $onPages = [&quot;hololens&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Hololens&lt;/b&gt;
[[A &quot;mixed reality&quot; headset developed by Microsoft and revealed to the world in 2015. The Hololens allows users to see holograpahic prjections on top of the real world, using custom cameras, sensors, and CPUs to make the magic happen. |hololens-2]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;hololens&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #hololens-obj; mtl: #hololens-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;


&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
<tw-passagedata pid="20" name="hololens-2" tags="" position="631,415">&lt;&lt;set $onPages = [&quot;hololens&quot;]&gt;&gt;
&lt;div class=&quot;blurb&quot;&gt;
&lt;b&gt;Hololens&lt;/b&gt;
[[The developer edition of Hololens starts at $3000 and was released March 30, 2016. A consumer version has yet to be announced.|Start]]&lt;/div&gt;&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _tObject to $trackables[&quot;hololens&quot;]&gt;&gt;
&lt;&lt;set _tn to _tObject.entityName&gt;&gt;
&lt;&lt;set _ts to _tObject.selector&gt;&gt;


&lt;&lt;if _tObject.initPassage&gt;&gt;
&lt;&lt;else&gt;&gt;
  &lt;&lt;set _tObject.initPassage to true&gt;&gt;


&lt;&lt;append3d _tn&gt;&gt;
	

       &lt;a-entity scale=&quot;0.03 0.03 0.03&quot;&gt;


        &lt;a-entity obj-model=&quot;obj: #hololens-obj; mtl: #hololens-mtl&quot;&gt;&lt;/a-entity&gt;

       &lt;/a-entity&gt;
	  
&lt;&lt;/append3d&gt;&gt;


&lt;&lt;/if&gt;&gt;
&lt;&lt;/nobr&gt;&gt;
</tw-passagedata>
</tw-storydata>
</div>
	<script id="script-sugarcube" type="text/javascript">
	/*! OldFashioned JS

	OldFashioned is based on SugarCube.  It includes code from argon.js (argonjs.io) 
	and AFrame (aframe.io), both of which have licenses on their respective sites.  
	
	argon.js is licences under an Apache2.0 license, and AFrame is licensed under an
	MIT license.
 		
	OldFashioned icon created by Oliviu Stoian, downloaded from the Noun Project
	at https://thenounproject.com/term/whiskey-glass/58605/

	SugarCube includes code from TiddlyWiki 1.2.39, which has the following license:
	--------------------------------------------------------------------------------
	TiddlyWiki 1.2.39 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

	Published under a BSD open source license

	Copyright (c) Osmosoft Limited 2005

	Redistribution and use in source and binary forms, with or without modification,
	are permitted provided that the following conditions are met:

	Redistributions of source code must retain the above copyright notice, this list
	of conditions and the following disclaimer.

	Redistributions in binary form must reproduce the above copyright notice, this
	list of conditions and the following disclaimer in the documentation and/or
	other materials provided with the distribution.

	Neither the name of the Osmosoft Limited nor the names of its contributors may
	be used to endorse or promote products derived from this software without
	specific prior written permission.

	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
	ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
	WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
	DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
	ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
	(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
	LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
	ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
	(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
	SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	--------------------------------------------------------------------------------
	*/
	if(document.documentElement.classList.contains('init-loading')){window.TWINE1=false;
window.DEBUG=false;
(function (window, document, jQuery, undefined) {
"use strict";

'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

/***********************************************************************************************************************
 *
 * lib/alert.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var Alert = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * Error Functions.
  ******************************************************************************************************************/

	function _alertMesg(type, where, mesg, error) {
		var isFatal = type === 'fatal';
		var errMesg = 'Apologies! ' + (isFatal ? 'A fatal' : 'An') + ' error has occurred.';

		if (isFatal) {
			errMesg += ' Aborting.';
		} else {
			errMesg += ' You may be able to continue, but some parts may not work properly.';
		}

		if (where != null || mesg != null) {
			// lazy equality for null
			errMesg += '\n\nError';

			if (where != null) {
				// lazy equality for null
				errMesg += ' [' + where + ']';
			}

			if (mesg != null) {
				// lazy equality for null
				errMesg += ': ' + mesg.replace(/^(?:(?:uncaught\s+(?:exception:\s+)?)?error:\s+)+/i, '') + '.';
			} else {
				errMesg += ': unknown error.';
			}
		}

		if (error && error.stack) {
			errMesg += '\n\nStack Trace:\n' + error.stack;
		}

		window.alert(errMesg); // eslint-disable-line no-alert
	}

	function alertError(where, mesg, error) {
		_alertMesg(null, where, mesg, error);
	}

	function alertFatal(where, mesg, error) {
		_alertMesg('fatal', where, mesg, error);
	}

	/*******************************************************************************************************************
  * Error Event.
  ******************************************************************************************************************/
	/*
 	Setup a global error handler for uncaught exceptions.
 */
	(function (origOnError) {
		window.onerror = function (mesg, url, lineNum, colNum, error) {
			// Uncaught exceptions during play may be recoverable/ignorable.
			if (document.readyState === 'complete') {
				alertError(null, mesg, error);
			}

			// Uncaught exceptions during startup should be fatal.
			else {
					alertFatal(null, mesg, error);
					window.onerror = origOnError;

					if (typeof window.onerror === 'function') {
						window.onerror.apply(this, arguments);
					}
				}
		};
	})(window.onerror);

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		error: { value: alertError },
		fatal: { value: alertFatal }
	}));
}();

/***********************************************************************************************************************
 *
 * lib/extensions.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Wikifier */
/* eslint-disable no-extend-native */

/*
	Returns `document.activeElement` or `null`.
*/
function safeActiveElement() {
	'use strict';

	/*
 	IE9 contains a bug where trying to access the active element of an iframe's
 	parent document (i.e. `window.parent.document.activeElement`) will throw an
 	exception, so we must allow for an exception to be thrown.
 		We could simply return `undefined` here, but since the API's default behavior
 	should be to return `document.body` or `null` when there is no selection, we
 	choose to return `null` in all non-element cases (i.e. whether it returns
 	`null` or throws an exception).  Just a bit of normalization.
 */

	try {
		return document.activeElement || null;
	} catch (e) {
		return null;
	}
}

/*
	JavaScript Polyfills.

	n.b. Most of the ES5 & ES6 polyfills now come from the `es5-shim.js` and `es6-shim.js`
	     libraries, respectively.
*/
(function () {
	'use strict';

	/*******************************************************************************************************************
  * JavaScript Polyfills.
  ******************************************************************************************************************/
	/*
 	[ES7/Proposed] Returns whether the given element was found within the array.
 */

	if (!Array.prototype.includes) {
		Object.defineProperty(Array.prototype, 'includes', {
			configurable: true,
			writable: true,

			value: function value() /* needle [, fromIndex] */{
				if (this == null) {
					// lazy equality for null
					throw new TypeError('Array.prototype.includes called on null or undefined');
				}

				if (arguments.length === 0) {
					return false;
				}

				var length = this.length >>> 0;

				if (length === 0) {
					return false;
				}

				var needle = arguments[0];
				var i = Number(arguments[1]) || 0;

				if (i < 0) {
					i = Math.max(0, length + i);
				}

				for (; /* empty */i < length; ++i) {
					var current = this[i];

					if (needle === current || needle !== needle && current !== current // eslint-disable-line no-extra-parens
					) {
							return true;
						}
				}

				return false;
			}
		});
	}

	/*
 	[ES7/Proposed] Returns a string with all whitespace removed from the start/left-side of the string.
 */
	if (!String.prototype.trimLeft) {
		Object.defineProperty(String.prototype, 'trimLeft', {
			configurable: true,
			writable: true,

			value: function value() {
				if (this == null) {
					// lazy equality for null
					throw new TypeError('String.prototype.trimLeft called on null or undefined');
				}

				return this.replace(/^[\s\uFEFF\u00A0]+/, ''); // include UTF BOM and NBSP
			}
		});
	}
	if (!String.prototype.trimStart) {
		Object.defineProperty(String.prototype, 'trimStart', {
			configurable: true,
			writable: true,

			value: function value() {
				if (this == null) {
					// lazy equality for null
					throw new TypeError('String.prototype.trimStart called on null or undefined');
				}

				return this.trimLeft();
			}
		});
	}

	/*
 	[ES7/Proposed] Returns a string with all whitespace removed from the end/right-side of the string.
 */
	if (!String.prototype.trimRight) {
		Object.defineProperty(String.prototype, 'trimRight', {
			configurable: true,
			writable: true,

			value: function value() {
				if (this == null) {
					// lazy equality for null
					throw new TypeError('String.prototype.trimRight called on null or undefined');
				}

				return this.replace(/[\s\uFEFF\u00A0]+$/, ''); // include UTF BOM and NBSP
			}
		});
	}
	if (!String.prototype.trimEnd) {
		Object.defineProperty(String.prototype, 'trimEnd', {
			configurable: true,
			writable: true,

			value: function value() {
				if (this == null) {
					// lazy equality for null
					throw new TypeError('String.prototype.trimEnd called on null or undefined');
				}

				return this.trimRight();
			}
		});
	}
})();

/*
	JavaScript Extensions.
*/
(function () {
	'use strict';

	var _nativeMathRandom = Math.random;

	/*******************************************************************************************************************
  * Utility Functions.
  ******************************************************************************************************************/
	/*
 	Returns a pseudo-random whole number (integer) within the range of the given bounds.
 */
	function _random() /* variadic(min:inclusive, max:inclusive) */{
		if (arguments.length === 0) {
			throw new Error('_random called with insufficient parameters');
		}

		var min = void 0,
		    max = void 0;

		if (arguments.length === 1) {
			min = 0;
			max = arguments[0];
		} else {
			min = arguments[0];
			max = arguments[1];
		}

		if (min > max) {
			var _ref = [max, min];
			min = _ref[0];
			max = _ref[1];
		}

		return Math.floor(_nativeMathRandom() * (max - min + 1)) + min;
	}

	/*******************************************************************************************************************
  * JavaScript Extensions, General.
  ******************************************************************************************************************/
	/*
 	Returns a random element from the given array, within the range of the lower and upper
 	bounds, if they are specified.
 */
	Object.defineProperty(Array, 'random', {
		configurable: true,
		writable: true,

		value: function value(array, lowerBound, upperBound) {
			var lower = lowerBound,
			    upper = upperBound;

			if (arguments.length === 2) {
				upper = lower;
				lower = 0;
			}

			if (Array.isArray(array)) {
				return array.random(lower, upper);
			} else if (array.hasOwnProperty('length')) {
				return [].concat(_toConsumableArray(array)).random(lower, upper);
			}

			return;
		}
	});

	/*
 	Returns whether the given element was found within the array.
 */
	Object.defineProperty(Array.prototype, 'contains', {
		configurable: true,
		writable: true,

		value: function value() /* needle [, fromIndex] */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.contains called on null or undefined');
			}

			return Array.prototype.indexOf.apply(this, arguments) !== -1;
		}
	});

	/*
 	Returns whether all of the given elements were found within the array.
 */
	Object.defineProperty(Array.prototype, 'containsAll', {
		configurable: true,
		writable: true,

		value: function value() /* needles */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.containsAll called on null or undefined');
			}

			if (arguments.length === 1) {
				if (Array.isArray(arguments[0])) {
					return Array.prototype.containsAll.apply(this, arguments[0]);
				} else {
					return Array.prototype.indexOf.apply(this, arguments) !== -1;
				}
			} else {
				for (var i = 0, iend = arguments.length; i < iend; ++i) {
					if (!Array.prototype.some.call(this, function (v) {
						return v === this.val;
					}, { val: arguments[i] })) {
						return false;
					}
				}

				return true;
			}
		}
	});

	/*
 	Returns whether any of the given elements were found within the array.
 */
	Object.defineProperty(Array.prototype, 'containsAny', {
		configurable: true,
		writable: true,

		value: function value() /* needles */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.containsAny called on null or undefined');
			}

			if (arguments.length === 1) {
				if (Array.isArray(arguments[0])) {
					return Array.prototype.containsAny.apply(this, arguments[0]);
				} else {
					return Array.prototype.indexOf.apply(this, arguments) !== -1;
				}
			} else {
				for (var i = 0, iend = arguments.length; i < iend; ++i) {
					if (Array.prototype.some.call(this, function (v) {
						return v === this.val;
					}, { val: arguments[i] })) {
						return true;
					}
				}

				return false;
			}
		}
	});

	/*
 	Returns the number of times the given element was found within the array.
 */
	Object.defineProperty(Array.prototype, 'count', {
		configurable: true,
		writable: true,

		value: function value() /* needle [, fromIndex ] */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.count called on null or undefined');
			}

			var indexOf = Array.prototype.indexOf,
			    needle = arguments[0];
			var pos = Number(arguments[1]) || 0,
			    count = 0;

			while ((pos = indexOf.call(this, needle, pos)) !== -1) {
				++count;
				++pos;
			}

			return count;
		}
	});

	/*
 	Removes and returns all of the given elements from the array.
 */
	Object.defineProperty(Array.prototype, 'delete', {
		configurable: true,
		writable: true,

		value: function value() /* needles */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.delete called on null or undefined');
			}

			if (arguments.length === 0) {
				return [];
			}

			var length = this.length >>> 0;

			if (length === 0) {
				return [];
			}

			var indexOf = Array.prototype.indexOf,
			    push = Array.prototype.push,
			    splice = Array.prototype.splice,
			    needles = Array.prototype.concat.apply([], arguments),
			    result = [];

			for (var i = 0, iend = needles.length; i < iend; ++i) {
				var needle = needles[i];
				var pos = 0;

				while ((pos = indexOf.call(this, needle, pos)) !== -1) {
					push.apply(result, splice.call(this, pos, 1));
				}
			}

			return result;
		}
	});

	/*
 	Removes and returns all of the elements at the given indices from the array.
 */
	Object.defineProperty(Array.prototype, 'deleteAt', {
		configurable: true,
		writable: true,

		value: function value() /* indices */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.deleteAt called on null or undefined');
			}

			if (arguments.length === 0) {
				return [];
			}

			var length = this.length >>> 0;

			if (length === 0) {
				return [];
			}

			var splice = Array.prototype.splice,
			    cpyIndices = [].concat(_toConsumableArray(new Set(Array.prototype.concat.apply([], arguments)
			// Map negative indices to their positive counterparts,
			// so the Set can properly filter out duplicates.
			.map(function (x) {
				return x < 0 ? Math.max(0, length + x) : x;
			})).values())),
			    delIndices = [].concat(_toConsumableArray(cpyIndices)).sort(function (a, b) {
				return b - a;
			}),
			    result = [];

			// Copy the elements (in original indices order).
			for (var i = 0, iend = cpyIndices.length; i < iend; ++i) {
				result[i] = this[cpyIndices[i]];
			}

			// Delete the elements (in descending numeric order).
			for (var _i = 0, _iend = delIndices.length; _i < _iend; ++_i) {
				splice.call(this, delIndices[_i], 1);
			}

			return result;
		}
	});

	/*
 	Returns a new array consisting of the flattened source array (flat map reduce).
 */
	Object.defineProperty(Array.prototype, 'flatten', {
		configurable: true,
		writable: true,

		value: function value() {
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.flatten called on null or undefined');
			}

			return Array.prototype.reduce.call(this, function (prev, cur) {
				return prev.concat(Array.isArray(cur) ? cur.flatten() : cur);
			}, []);
		}
	});

	/*
 	Removes and returns a random element from the array, within the range of the lower and
 	upper bounds, if they are specified.
 */
	Object.defineProperty(Array.prototype, 'pluck', {
		configurable: true,
		writable: true,

		value: function value(lowerBound, upperBound) {
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.pluck called on null or undefined');
			}

			var length = this.length >>> 0;

			if (length === 0) {
				return;
			}

			var lower = lowerBound,
			    upper = upperBound;

			if (arguments.length === 1) {
				upper = lower;
				lower = 0;
			}

			if (lower == null) {
				// lazy equality for null
				lower = 0;
			} else if (lower < 0) {
				lower = length + lower;

				if (lower < 0) {
					lower = 0;
				}
			} else if (lower >= length) {
				lower = length - 1;
			}

			if (upper == null) {
				// lazy equality for null
				upper = length - 1;
			} else if (upper < 0) {
				upper = length + upper;

				if (upper < 0) {
					upper = length - 1;
				}
			} else if (upper >= length) {
				upper = length - 1;
			}

			return Array.prototype.splice.call(this, _random(lower, upper), 1)[0];
		}
	});

	/*
 	Returns a random element from the array, within the range of the lower and upper bounds,
 	if they are specified.
 */
	Object.defineProperty(Array.prototype, 'random', {
		configurable: true,
		writable: true,

		value: function value(lowerBound, upperBound) {
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.random called on null or undefined');
			}

			var length = this.length >>> 0;

			if (length === 0) {
				return;
			}

			var lower = lowerBound,
			    upper = upperBound;

			if (arguments.length === 1) {
				upper = lower;
				lower = 0;
			}

			if (lower == null) {
				// lazy equality for null
				lower = 0;
			} else if (lower < 0) {
				lower = length + lower;

				if (lower < 0) {
					lower = 0;
				}
			} else if (lower >= length) {
				lower = length - 1;
			}

			if (upper == null) {
				// lazy equality for null
				upper = length - 1;
			} else if (upper < 0) {
				upper = length + upper;

				if (upper < 0) {
					upper = length - 1;
				}
			} else if (upper >= length) {
				upper = length - 1;
			}

			return this[_random(lower, upper)];
		}
	});

	/*
 	Randomly shuffles the array.
 */
	Object.defineProperty(Array.prototype, 'shuffle', {
		configurable: true,
		writable: true,

		value: function value() {
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Array.prototype.shuffle called on null or undefined');
			}

			var length = this.length >>> 0;

			if (length === 0) {
				return;
			}

			for (var i = length - 1; i > 0; --i) {
				var j = Math.floor(_nativeMathRandom() * (i + 1)),
				    swap = this[i];
				this[i] = this[j];
				this[j] = swap;
			}

			return this;
		}
	});

	/*
 	Returns a bound function that supplies the given arguments to the base function, followed
 	by the arguments are supplied to the bound function, whenever it is called.
 */
	Object.defineProperty(Function.prototype, 'partial', {
		configurable: true,
		writable: true,

		value: function value() /* variadic */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Function.prototype.partial called on null or undefined');
			}

			var slice = Array.prototype.slice,
			    fn = this,
			    bound = slice.call(arguments, 0);

			return function () {
				var applied = [];
				var argc = 0;

				for (var i = 0; i < bound.length; ++i) {
					applied.push(bound[i] === undefined ? arguments[argc++] : bound[i]);
				}

				return fn.apply(this, applied.concat(slice.call(arguments, argc)));
			};
		}
	});

	/*
 	Returns the given numerical clamped to the specified bounds.
 */
	Object.defineProperty(Math, 'clamp', {
		configurable: true,
		writable: true,

		value: function value(num, min, max) {
			var n = Number(num);
			return isNaN(n) ? NaN : n.clamp(min, max);
		}
	});

	/*
 	Returns a decimal number eased from 0 to 1.
 		n.b. The magnitude of the returned value decreases if num < 0.5 or increases if num > 0.5.
 */
	Object.defineProperty(Math, 'easeInOut', {
		configurable: true,
		writable: true,

		value: function value(num) {
			return 1 - (Math.cos(Number(num) * Math.PI) + 1) / 2;
		}
	});

	/*
 	Returns the number clamped to the specified bounds.
 */
	Object.defineProperty(Number.prototype, 'clamp', {
		configurable: true,
		writable: true,

		value: function value() /* min, max */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('Number.prototype.clamp called on null or undefined');
			}

			if (arguments.length !== 2) {
				throw new Error('Number.prototype.clamp called with an incorrect number of parameters');
			}

			var min = Number(arguments[0]),
			    max = Number(arguments[1]);

			if (min > max) {
				var _ref2 = [max, min];
				min = _ref2[0];
				max = _ref2[1];
			}

			return Math.min(Math.max(this, min), max);
		}
	});

	/*
 	Returns a copy of the given string with all RegExp metacharacters escaped.
 */
	if (!RegExp.escape) {
		(function () {
			var _regExpMetaCharsRe = /[\\^$*+?.()|[\]{}]/g,
			    _hasRegExpMetaCharsRe = new RegExp(_regExpMetaCharsRe.source); // to drop the global flag

			Object.defineProperty(RegExp, 'escape', {
				configurable: true,
				writable: true,

				value: function value(str) {
					var s = String(str);
					return s && _hasRegExpMetaCharsRe.test(s) ? s.replace(_regExpMetaCharsRe, '\\$&') : s;
				}
			});
		})();
	}

	/*
 	Returns a formatted string, after replacing each format item in the given format string
 	with the text equivalent of the corresponding argument's value.
 */
	Object.defineProperty(String, 'format', {
		configurable: true,
		writable: true,

		value: function value(format) {
			function padString(str, align, pad) {
				if (!align) {
					return str;
				}

				var plen = Math.abs(align) - str.length;

				if (plen < 1) {
					return str;
				}

				var padding = Array(plen + 1).join(pad);
				return align < 0 ? str + padding : padding + str;
			}

			if (arguments.length < 2) {
				return arguments.length === 0 ? '' : format;
			}

			var args = arguments.length === 2 && Array.isArray(arguments[1]) ? arguments[1].slice(0) : Array.prototype.slice.call(arguments, 1);

			if (args.length === 0) {
				return format;
			}

			return format.replace(/{(\d+)(?:,([+-]?\d+))?}/g, function (match, index, align) {
				var retval = args[index];

				if (retval == null) {
					// lazy equality for null
					return '';
				}

				while (typeof retval === 'function') {
					retval = retval();
				}

				switch (typeof retval === 'undefined' ? 'undefined' : _typeof(retval)) {
					case 'string':
						/* nothing */
						break;

					case 'object':
						retval = JSON.stringify(retval);
						break;

					default:
						retval = String(retval);
						break;
				}

				return padString(retval, !align ? 0 : parseInt(align, 10), ' ');
			});
		}
	});

	/*
 	Returns whether the given string was found within the string.
 */
	Object.defineProperty(String.prototype, 'contains', {
		configurable: true,
		writable: true,

		value: function value() /* needle [, fromIndex] */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('String.prototype.contains called on null or undefined');
			}

			return String.prototype.indexOf.apply(this, arguments) !== -1;
		}
	});

	/*
 	Returns the number of times the given substring was found within the string.
 */
	Object.defineProperty(String.prototype, 'count', {
		configurable: true,
		writable: true,

		value: function value() /* needle [, fromIndex ] */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('String.prototype.count called on null or undefined');
			}

			var needle = String(arguments[0] || '');

			if (needle === '') {
				return 0;
			}

			var indexOf = String.prototype.indexOf,
			    step = needle.length;
			var pos = Number(arguments[1]) || 0,
			    count = 0;

			while ((pos = indexOf.call(this, needle, pos)) !== -1) {
				++count;
				pos += step;
			}
			return count;
		}
	});

	/*
 	Returns a copy of the base string with `count` characters replaced with `replacement`, starting at `startAt`.
 */
	Object.defineProperty(String.prototype, 'splice', {
		configurable: true,
		writable: true,

		value: function value(startAt, charCount, replacement) {
			if (this == null) {
				// lazy equality for null
				throw new TypeError('String.prototype.splice called on null or undefined');
			}

			var length = this.length >>> 0;

			if (length === 0) {
				return '';
			}

			var start = +startAt || 0;

			if (!isFinite(start)) {
				start = 0;
			} else if (start < 0) {
				start += length;

				if (start < 0) {
					start = 0;
				}
			}

			if (start > length) {
				start = length;
			}

			var count = +charCount || 0;

			if (!isFinite(count) || count < 0) {
				count = 0;
			}

			var res = this.slice(0, start);

			if (typeof replacement !== 'undefined') {
				res += replacement;
			}

			if (start + count < length) {
				res += this.slice(start + count);
			}

			return res;
		}
	});

	/*
 	Returns an array of strings, split from the string, or an empty array if the string is empty.
 */
	Object.defineProperty(String.prototype, 'splitOrEmpty', {
		configurable: true,
		writable: true,

		value: function value() /* [ separator [, limit ]] */{
			if (this == null) {
				// lazy equality for null
				throw new TypeError('String.prototype.splitOrEmpty called on null or undefined');
			}

			// Required as `this` could be a `String` object or come from a `call()` or `apply()`.
			if (String(this) === '') {
				return [];
			}

			return String.prototype.split.apply(this, arguments);
		}
	});

	/*
 	[DEPRECATED] Returns an array of link titles, parsed from the string.
 		n.b. Unused in SugarCube, only included for compatibility.
 */
	Object.defineProperty(String.prototype, 'readBracketedList', {
		configurable: true,
		writable: true,

		value: function value() {
			if (this == null) {
				// lazy equality for null
				throw new TypeError('String.prototype.readBracketedList called on null or undefined');
			}

			// RegExp groups: Double-square-bracket quoted | Unquoted.
			var re = new RegExp('(?:\\[\\[((?:\\s|\\S)*?)\\]\\])|([^"\'\\s]\\S*)', 'gm'),
			    names = [];
			var match = void 0;

			while ((match = re.exec(this)) !== null) {
				if (match[1]) {
					// double-square-bracket quoted
					names.push(match[1]);
				} else if (match[2]) {
					// unquoted
					names.push(match[2]);
				}
			}

			return names;
		}
	});

	/*******************************************************************************************************************
  * JavaScript Extensions, JSON.
  ******************************************************************************************************************/
	/*
 	Define `toJSON()` methods on each prototype we wish to support.
 */
	Object.defineProperty(Date.prototype, 'toJSON', {
		configurable: true,
		writable: true,

		value: function value() {
			return ['(revive:date)', this.toISOString()];
		}
	});
	Object.defineProperty(Function.prototype, 'toJSON', {
		configurable: true,
		writable: true,

		value: function value() {
			/*
   	The enclosing parenthesis here are necessary to force the function expression code
   	string, returned by `this.toString()`, to be evaluated as an expression during
   	revival.  Without them, the function expression, which is likely nameless, will be
   	evaluated as a function definition—which will throw a syntax error exception, since
   	function definitions must have a name.
   */
			return ['(revive:eval)', '(' + this.toString() + ')'];
		}
	});
	Object.defineProperty(Map.prototype, 'toJSON', {
		configurable: true,
		writable: true,

		value: function value() {
			return ['(revive:map)', [].concat(_toConsumableArray(this))];
		}
	});
	Object.defineProperty(RegExp.prototype, 'toJSON', {
		configurable: true,
		writable: true,

		value: function value() {
			return ['(revive:eval)', this.toString()];
		}
	});
	Object.defineProperty(Set.prototype, 'toJSON', {
		configurable: true,
		writable: true,

		value: function value() {
			return ['(revive:set)', [].concat(_toConsumableArray(this))];
		}
	});

	/*
 	Utility method to allow users to easily wrap their code in the revive wrapper.
 */
	Object.defineProperty(JSON, 'reviveWrapper', {
		configurable: true,
		writable: true,

		value: function value(code) {
			if (typeof code !== 'string') {
				throw new TypeError('JSON.reviveWrapper code parameter must be a string');
			}

			return ['(revive:eval)', code];
		}
	});

	/*
 	Backup the original `JSON.parse()` and replace it with a revive wrapper aware version.
 */
	Object.defineProperty(JSON, '_real_parse', {
		value: JSON.parse
	});
	Object.defineProperty(JSON, 'parse', {
		configurable: true,
		writable: true,

		value: function value(text, reviver) {
			return JSON._real_parse(text, function (key, val) {
				var value = val;

				/*
    	Attempt to revive wrapped values.
    */
				if (Array.isArray(value) && value.length === 2) {
					switch (value[0]) {
						case '(revive:set)':
							value = new Set(value[1]);
							break;
						case '(revive:map)':
							value = new Map(value[1]);
							break;
						case '(revive:date)':
							value = new Date(value[1]);
							break;
						case '(revive:eval)':
							try {
								value = eval(value[1]); // eslint-disable-line no-eval
							} catch (e) {/* no-op; although, perhaps, it would be better to throw an error here */}
							break;
					}
				}

				/* legacy */
				else if (typeof value === 'string' && value.slice(0, 10) === '@@revive@@') {
						try {
							value = eval(value.slice(10)); // eslint-disable-line no-eval
						} catch (e) {/* no-op; although, perhaps, it would be better to throw an error here */}
					}
				/* /legacy */

				/*
    	Call the custom reviver, if specified.
    */
				if (typeof reviver === 'function') {
					try {
						value = reviver(key, value);
					} catch (e) {/* no-op; although, perhaps, it would be better to throw an error here */}
				}

				return value;
			});
		}
	});
})();

/***********************************************************************************************************************
 * jQuery Plugins.
 **********************************************************************************************************************/
/*
	`ariaClick([options,] handler)` method plugin.

	Makes the target element(s) WAI-ARIA compatible clickables.

	n.b. Has a dependency in the `safeActiveElement()` function (see: top of file).
*/
(function () {
	'use strict';

	/*
 	Event handler & utility functions.
 		n.b. Do not replace the anonymous functions herein with arrow functions.
 */

	function onKeypressFn(evt) {
		// 13 is Enter/Return, 32 is Space.
		if (evt.which === 13 || evt.which === 32) {
			evt.preventDefault();

			// To allow delegation, attempt to trigger the event on `document.activeElement`,
			// if possible, elsewise on `this`.
			jQuery(safeActiveElement() || this).trigger('click');
		}
	}

	function onClickFnWrapper(fn) {
		return function () {
			var $this = jQuery(this);

			// Toggle "aria-pressed" status, if the attribute exists.
			if ($this.is('[aria-pressed]')) {
				$this.attr('aria-pressed', $this.attr('aria-pressed') === 'true' ? 'false' : 'true');
			}

			// Call the true handler.
			fn.apply(this, arguments);
		};
	}

	function oneClickFnWrapper(fn) {
		return onClickFnWrapper(function () {
			// Remove both event handlers (keypress & click) and the other components.
			jQuery(this).off('.aria-clickable').removeAttr('tabindex aria-controls aria-pressed').not('a,button').removeAttr('role').end().filter('button').prop('disabled', true);

			// Call the true handler.
			fn.apply(this, arguments);
		});
	}

	/*
 	Extend jQuery's chainable methods with an `ariaClick()` method.
 */
	jQuery.fn.extend({
		ariaClick: function ariaClick(options, handler) {
			// Bail out if there are no target element(s) or parameters.
			if (this.length === 0 || arguments.length === 0) {
				return this;
			}

			var opts = options,
			    fn = handler;

			if (fn == null) {
				// lazy equality for null
				fn = opts;
				opts = undefined;
			}

			opts = jQuery.extend({
				namespace: undefined,
				one: false,
				selector: undefined,
				data: undefined,
				controls: undefined,
				pressed: undefined,
				label: undefined
			}, opts);

			if (typeof opts.namespace !== 'string') {
				opts.namespace = '';
			} else if (opts.namespace[0] !== '.') {
				opts.namespace = '.' + opts.namespace;
			}

			if (typeof opts.pressed === 'boolean') {
				opts.pressed = opts.pressed ? 'true' : 'false';
			}

			// Set `type` to `button` to suppress "submit" semantics, for <button> elements.
			this.filter('button').prop('type', 'button');

			// Set `role` to `button`, for non-<a>/-<button> elements.
			this.not('a,button').attr('role', 'button');

			// Set `tabindex` to `0` to make them focusable (unnecessary on <button> elements, but it doesn't hurt).
			this.attr('tabindex', 0);

			// Set `aria-controls`.
			if (opts.controls != null) {
				// lazy equality for null
				this.attr('aria-controls', opts.controls);
			}

			// Set `aria-pressed`.
			if (opts.pressed != null) {
				// lazy equality for null
				this.attr('aria-pressed', opts.pressed);
			}

			// Set `aria-label` and `title`.
			if (opts.label != null) {
				// lazy equality for null
				this.attr({
					'aria-label': opts.label,
					title: opts.label
				});
			}

			// Set the keypress handlers, for non-<button> elements.
			//   n.b. For the single-use case, the click handler will also remove this handler.
			this.not('button').on('keypress.aria-clickable' + opts.namespace, opts.selector, onKeypressFn);

			// Set the click handlers.
			//   n.b. To ensure both handlers are properly removed, `one()` must not be used here.
			this.on('click.aria-clickable' + opts.namespace, opts.selector, opts.data, opts.one ? oneClickFnWrapper(fn) : onClickFnWrapper(fn));

			// Return `this` for further chaining.
			return this;
		}
	});
})();

/*
	`wiki(source)` method plugin.

	Wikifies the source text and appends the result to the target element(s).
*/
(function () {
	'use strict';

	/*
 	Extend jQuery's chainable methods with a `wiki()` method.
 */

	jQuery.fn.extend({
		wiki: function wiki(source) {
			// Bail out if there are no target element(s) or parameters.
			if (this.length === 0 || arguments.length === 0) {
				return this;
			}

			// Wikify the source text into a fragment and append it to the target element(s).
			var frag = document.createDocumentFragment();
			new Wikifier(frag, source);
			this.append(frag);

			// Return `this` for further chaining.
			return this;
		}
	});
})();

/***********************************************************************************************************************
 *
 * lib/browser.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var Browser = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';
	/* eslint-disable max-len */

	var ua = {
		userAgent: navigator.userAgent.toLowerCase()
	};

	ua.isGecko = navigator && navigator.product === 'Gecko' && !/webkit|trident/.test(ua.userAgent);

	ua.isIE = /msie|trident/.test(ua.userAgent) && !ua.userAgent.includes('opera');
	ua.ieVersion = function () {
		var ver = /(?:msie\s+|rv:)(\d{1,2}\.\d)/.exec(ua.userAgent);
		return ver ? +ver[1] : 0;
	}();

	// opera <= 12: "opera/9.80 (windows nt 6.1; wow64) presto/2.12.388 version/12.16"
	// opera >= 15: "mozilla/5.0 (windows nt 6.1; wow64) applewebkit/537.36 (khtml, like gecko) chrome/28.0.1500.52 safari/537.36 opr/15.0.1147.130"
	ua.isOpera = ua.userAgent.includes('opera') || ua.userAgent.includes(' opr/');
	ua.operaVersion = function () {
		var re = new RegExp((/applewebkit|chrome/.test(ua.userAgent) ? 'opr' : 'version') + '\\/(\\d{1,2}\\.\\d+)'),
		    ver = re.exec(ua.userAgent);
		return ver ? +ver[1] : 0;
	}();

	ua.isMobile = Object.freeze({
		Android: /android/.test(ua.userAgent),
		BlackBerry: /blackberry/.test(ua.userAgent),
		iOS: /ip(?:hone|ad|od)/.test(ua.userAgent),
		Windows: /iemobile/.test(ua.userAgent),

		any: function any() {
			var m = ua.isMobile;
			return m.Android || m.BlackBerry || m.iOS || m.Windows;
		}
	});

	// Module Exports.
	return Object.freeze(ua);
	/* eslint-enable max-len */
}();

/***********************************************************************************************************************
 *
 * lib/has.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Browser */

var Has = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	function webStorageIsOK(store) {
		try {
			if (store != null && store.length >= 0) {
				// lazy equality for null
				var tkey = 'SugarCube.WebStorage.test',
				    tval = '1701 Guilty Scott';

				store.setItem(tkey, tval);

				if (store.getItem(tkey) === tval) {
					store.removeItem(tkey);
					return true;
				}
			}
		} catch (e) {/* no-op */}

		return false;
	}

	// Module Exports.
	return Object.freeze({
		audio: typeof document.createElement('audio').canPlayType === 'function',

		/*
  	It's probably safe to assume the existence of `Blob` by the existence of `File`.
  */
		fileAPI: 'File' in window && 'FileList' in window && 'FileReader' in window && !Browser.isMobile.any() && (!Browser.isOpera || Browser.operaVersion >= 15),

		geolocation: 'geolocation' in navigator && typeof navigator.geolocation.getCurrentPosition === 'function' && typeof navigator.geolocation.watchPosition === 'function',

		/*
  	The extended Web Storage testing (`webStorageIsOK()`) is required by implementation
  	bugs in various browsers.
  		Caveats by browser:
  		Firefox bug #748620 [https://bugzilla.mozilla.org/show_bug.cgi?id=748620].
  			The iOS browser core will throw an exception on `setItem()` calls when in
  		private browsing mode.
  */
		localStorage: 'localStorage' in window && webStorageIsOK(window.localStorage),
		sessionStorage: 'sessionStorage' in window && webStorageIsOK(window.sessionStorage)
	});
}();

/***********************************************************************************************************************
 *
 * lib/helpers.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Story, StyleWrapper, Wikifier, strings */

var _ref3 = function () {
	'use strict';

	/*
 	Appends a new <style> element to the document's <head>.
 */

	var _imageMarkupRe = /\[[<>]?[Ii][Mm][Gg]\[(?:\s|\S)*?\]\]+/g,
	    _hasImageMarkupRe = new RegExp(_imageMarkupRe.source); // to drop the global flag

	function addStyle(rawCSS) {
		var style = document.getElementById('style-story');

		if (style === null) {
			style = document.createElement('style');
			style.id = 'style-story';
			style.type = 'text/css';
			document.head.appendChild(style);
		}

		style = new StyleWrapper(style);

		var css = rawCSS;

		// Check for wiki image transclusion.
		if (_hasImageMarkupRe.test(css)) {
			css = css.replace(_imageMarkupRe, function (wikiImage) {
				var markup = Wikifier.helpers.parseSquareBracketedMarkup({
					source: wikiImage,
					matchStart: 0
				});

				if (markup.hasOwnProperty('error') || markup.pos < wikiImage.length) {
					return wikiImage;
				}

				var source = markup.source;

				// Handle image passage transclusion.
				if (source.slice(0, 5) !== 'data:' && Story.has(source)) {
					var passage = Story.get(source);

					if (passage.tags.includes('Twine.image')) {
						source = passage.text;
					}
				}

				/*
    	The source may be URI- or Base64-encoded, so we cannot use encodeURIComponent()
    	here.  Instead, we simply encode any double quotes, since the URI will be
    	delimited by them.
    */
				return 'url("' + source.replace(/"/g, '%22') + '")';
			});
		}

		style.add(css);
	}

	/*
 	Returns a deep copy of the passed object.
 		n.b. 1. `clone()` does not clone functions, however, since function definitions are immutable,
 	        the only issues are with expando properties and scope.  The former really should not
 	        be done.  The latter is problematic either way (damned if you do, damned if you don't).
 	     2. `clone()` does not maintain referential relationships (e.g. multiple references to the
 	        same object will, post-cloning, refer to different equivalent objects; i.e. each
 	        reference will get its own clone of the original object).
 */
	function clone(orig) {
		/*
  	Immediately return non-objects.
  */
		if ((typeof orig === 'undefined' ? 'undefined' : _typeof(orig)) !== 'object' || orig == null) {
			// lazy equality for null
			return orig;
		}

		/*
  	Honor native clone methods.
  */
		if (typeof orig.clone === 'function') {
			return orig.clone(true);
		} else if (orig.nodeType && typeof orig.cloneNode === 'function') {
			return orig.cloneNode(true);
		}

		/*
  	Create a copy of the original object.
  		n.b. 1. Each non-generic object that we wish to support must receive a special case below.
  	     2. Since we're using the `instanceof` operator to identify special cases, this may
  	        fail to properly identify such cases if the author engages in cross-<iframe>
  	        object manipulation.  The solution to this problem would be for the author to
  	        pass messages between the frames, rather than doing direct cross-frame object
  	        manipulation.  That is, in fact, what they should be doing in the first place.
  	     3. We cannot use `Object.prototype.toString.call(orig)` to solve #2 because the shims
  	        for `Map` and `Set` return `[object Object]` rather than `[object Map]` and
  	        `[object Set]`.
  */
		var copy = void 0;

		if (Array.isArray(orig)) {
			// considering #2, `orig instanceof Array` might be more appropriate
			copy = [];
		} else if (orig instanceof Date) {
			copy = new Date(orig.getTime());
		} else if (orig instanceof Map) {
			copy = new Map();
			orig.forEach(function (v, k) {
				copy.set(k, clone(v));
			});
		} else if (orig instanceof RegExp) {
			copy = new RegExp(orig);
		} else if (orig instanceof Set) {
			copy = new Set();
			orig.forEach(function (v) {
				copy.add(clone(v));
			});
		} else {
			// unknown or generic object
			// Try to ensure that the returned object has the same prototype as the original.
			copy = Object.create(Object.getPrototypeOf(orig));
		}

		/*
  	Duplicate the original object's own enumerable properties, which will include expando
  	properties on non-generic objects.
  		n.b. This does not preserve ES5 property attributes.  Neither does the delta coding
  		 or serialization code, however, so it's not really an issue at the moment.
  */
		Object.keys(orig).forEach(function (name) {
			return copy[name] = clone(orig[name]);
		});

		return copy;
	}

	/*
 	Converts <br> elements to <p> elements within the given node tree.
 */
	function convertBreaks(source) {
		var output = document.createDocumentFragment();
		var para = document.createElement('p'),
		    node = void 0;

		while ((node = source.firstChild) !== null) {
			if (node.nodeType === Node.ELEMENT_NODE) {
				var tagName = node.nodeName.toUpperCase();

				switch (tagName) {
					case 'BR':
						if (node.nextSibling !== null && node.nextSibling.nodeType === Node.ELEMENT_NODE && node.nextSibling.nodeName.toUpperCase() === 'BR') {
							source.removeChild(node.nextSibling);
							source.removeChild(node);
							output.appendChild(para);
							para = document.createElement('p');
							continue;
						} else if (!para.hasChildNodes()) {
							source.removeChild(node);
							continue;
						}
						break;

					case 'ADDRESS':
					case 'ARTICLE':
					case 'ASIDE':
					case 'BLOCKQUOTE':
					case 'CENTER':
					case 'DIV':
					case 'DL':
					case 'FIGURE':
					case 'FOOTER':
					case 'FORM':
					case 'H1':
					case 'H2':
					case 'H3':
					case 'H4':
					case 'H5':
					case 'H6':
					case 'HEADER':
					case 'HR':
					case 'MAIN':
					case 'NAV':
					case 'OL':
					case 'P':
					case 'PRE':
					case 'SECTION':
					case 'TABLE':
					case 'UL':
						if (para.hasChildNodes()) {
							output.appendChild(para);
							para = document.createElement('p');
						}

						output.appendChild(node);
						continue;
				}
			}

			para.appendChild(node);
		}

		if (para.hasChildNodes()) {
			output.appendChild(para);
		}

		source.appendChild(output);
	}

	/*
 	Returns the simple string representation of the passed value or, if there is none,
 	the passed default value.
 */
	function toStringOrDefault(val, defVal) {
		switch (typeof val === 'undefined' ? 'undefined' : _typeof(val)) {
			case 'number':
				if (isNaN(val)) {
					return defVal;
				}
				break;

			case 'object':
				if (val === null) {
					return defVal;
				} else if (Array.isArray(val) || val instanceof Set) {
					return [].concat(_toConsumableArray(val)).map(function (v) {
						return toStringOrDefault(v, defVal);
					}).join(', ');
				} else if (val instanceof Map) {
					var _ret8 = function () {
						/* eslint-disable prefer-template */
						var tSOD = toStringOrDefault;
						return {
							v: '( ' + [].concat(_toConsumableArray(val)).map(function (kv) {
								return tSOD(kv[0], defVal) + ' ⇒ ' + tSOD(kv[1], defVal);
							}).join('; ') + ' )'
						};
						/* eslint-enable prefer-template */
					}();

					if ((typeof _ret8 === 'undefined' ? 'undefined' : _typeof(_ret8)) === "object") return _ret8.v;
				} else if (val instanceof Date) {
					return val.toLocaleString();
				} else if (typeof val.toString === 'function') {
					return val.toString();
				}

				return Object.prototype.toString.call(val);

			case 'function':
			case 'undefined':
				return defVal;
		}

		return String(val);
	}

	/*
 	Wikifies a passage into a DOM element corresponding to the passed ID and returns the element.
 */
	function setPageElement(idOrElement, titles, defaultText) {
		var el = (typeof idOrElement === 'undefined' ? 'undefined' : _typeof(idOrElement)) === 'object' ? idOrElement : document.getElementById(idOrElement);

		if (el == null) {
			// lazy equality for null
			return null;
		}

		var ids = Array.isArray(titles) ? titles : [titles];

		jQuery(el).empty();

		for (var i = 0, iend = ids.length; i < iend; ++i) {
			if (Story.has(ids[i])) {
				new Wikifier(el, Story.get(ids[i]).processText().trim());
				return el;
			}
		}

		if (defaultText != null) {
			// lazy equality for null
			var text = String(defaultText).trim();

			if (text !== '') {
				new Wikifier(el, text);
			}
		}

		return el;
	}

	/*
 	Appends an error message to the passed DOM element.
 */
	function throwError(place, message, title) {
		jQuery(document.createElement('span')).addClass('error').attr('title', title).text(strings.errors.title + ': ' + (message || 'unknown error')).appendTo(place);
		return false;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		addStyle: { value: addStyle },
		clone: { value: clone },
		convertBreaks: { value: convertBreaks },
		toStringOrDefault: { value: toStringOrDefault },
		setPageElement: { value: setPageElement },
		throwError: { value: throwError }
	}));
}();

var addStyle = _ref3.addStyle;
var clone = _ref3.clone;
var convertBreaks = _ref3.convertBreaks;
var toStringOrDefault = _ref3.toStringOrDefault;
var setPageElement = _ref3.setPageElement;
var throwError = _ref3.throwError;

/***********************************************************************************************************************
 *
 * lib/util.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Scripting, clone */

var Util = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * Type Functions.
  ******************************************************************************************************************/
	/**
 	Returns whether the passed value is a finite number or a numeric string which yields
 	a finite number when parsed.
 **/

	function utilIsNumeric(obj) {
		var num = void 0;

		switch (typeof obj === 'undefined' ? 'undefined' : _typeof(obj)) {
			case 'number':
				num = obj;
				break;

			case 'string':
				num = Number(obj);
				break;

			default:
				return false;
		}

		return !isNaN(num) && isFinite(num);
	}

	/**
 	Returns whether the passed value is a boolean or one of the strings "true" or "false".
 **/
	function utilIsBoolean(obj) {
		return typeof obj === 'boolean' || typeof obj === 'string' && (obj === 'true' || obj === 'false');
	}

	/*******************************************************************************************************************
  * String Encoding Functions.
  ******************************************************************************************************************/
	/**
 	Returns a lowercased and hyphen encoded version of the passed string.
 **/
	function utilSlugify(str) {
		return String(str).trim().replace(/[^\w\s\u2013\u2014-]+/g, '').replace(/[_\s\u2013\u2014-]+/g, '-').toLocaleLowerCase();
	}

	/**
 	Returns an entity encoded version of the passed string.
 **/
	var _htmlCharsRe = /[&<>"'`]/g,
	    _hasHtmlCharsRe = new RegExp(_htmlCharsRe.source),
	    // to drop the global flag
	_htmlCharsMap = Object.freeze({
		'&': '&amp;',
		'<': '&lt;',
		'>': '&gt;',
		'"': '&quot;',
		"'": '&#39;',
		'`': '&#96;'
	});

	function utilEscape(str) {
		if (str == null) {
			// lazy equality for null
			return '';
		}

		var s = String(str);
		return s && _hasHtmlCharsRe.test(s) ? s.replace(_htmlCharsRe, function (c) {
			return _htmlCharsMap[c];
		}) : s;
	}

	/**
 	Returns a decoded version of the passed entity encoded string.
 **/
	var _escapedHtmlRe = /&(?:amp|lt|gt|quot|apos|#39|#x27|#96|#x60);/g,
	    _hasEscapedHtmlRe = new RegExp(_escapedHtmlRe.source),
	    // to drop the global flag
	_escapedHtmlMap = Object.freeze({
		'&amp;': '&',
		'&lt;': '<',
		'&gt;': '>',
		'&quot;': '"',
		'&apos;': "'", // apostrophe from XML shenanigans
		'&#39;': "'", // apostrophe from decimal NCR
		'&#x27;': "'", // apostrophe from hexadecimal NCR (fuck you, Underscorejs)
		'&#96;': '`', // backtick from decimal NCR
		'&#x60;': '`' // backtick from hexadecimal NCR (fuck you, Underscorejs)
	});

	function utilUnescape(str) {
		if (str == null) {
			// lazy equality for null
			return '';
		}

		var s = String(str);
		return s && _hasEscapedHtmlRe.test(s) ? s.replace(_escapedHtmlRe, function (c) {
			return _escapedHtmlMap[c];
		}) : s;
	}

	/*******************************************************************************************************************
  * Conversion Functions.
  ******************************************************************************************************************/
	/**
 	Returns the number of miliseconds represented by the passed CSS time string.
 **/
	function utilFromCssTime(cssTime) {
		var re = /^([+-]?(?:\d*\.)?\d+)([Mm]?[Ss])$/,
		    match = re.exec(String(cssTime));

		if (match === null) {
			throw new SyntaxError('invalid time value syntax: "' + cssTime + '"');
		}

		var msec = Number(match[1]);

		if (/^[Ss]$/.test(match[2])) {
			msec *= 1000;
		}

		if (isNaN(msec) || !isFinite(msec)) {
			throw new RangeError('invalid time value: "' + cssTime + '"');
		}

		return msec;
	}

	/**
 	Returns the CSS time string represented by the passed number of milliseconds.
 **/
	function utilToCssTime(msec) {
		if (typeof msec !== 'number' || isNaN(msec) || !isFinite(msec)) {
			var what = void 0;

			switch (typeof msec === 'undefined' ? 'undefined' : _typeof(msec)) {
				case 'string':
					what = '"' + msec + '"';
					break;

				case 'number':
					what = String(msec);
					break;

				default:
					what = Object.prototype.toString.call(msec);
					break;
			}

			throw new Error('invalid milliseconds: ' + what);
		}

		return msec + 'ms';
	}

	/**
 	Returns the DOM property name represented by the passed CSS property name.
 **/
	function utilFromCssProperty(cssName) {
		if (!cssName.includes('-')) {
			switch (cssName) {
				case 'bgcolor':
					return 'backgroundColor';
				case 'float':
					return 'cssFloat';
				default:
					return cssName;
			}
		}

		return cssName.split('-').map(function (part, i) {
			return i === 0 ? part : part.slice(0, 1).toUpperCase() + part.slice(1);
		}).join('');
	}

	/**
 	Returns an object containing the component properties parsed from the passed URL.
 **/
	function utilParseUrl(url) {
		var el = document.createElement('a'),
		    queryObj = Object.create(null);

		// Let the `<a>` element parse the URL.
		el.href = url;

		// Populate the `queryObj` object with the query string attributes.
		el.search.replace(/^\?/, '').split(/(?:&(?:amp;)?|;)/).forEach(function (query) {
			var _query$split = query.split('=');

			var _query$split2 = _slicedToArray(_query$split, 2);

			var key = _query$split2[0];
			var value = _query$split2[1];

			queryObj[key] = value;
		});

		/*
  	Caveats by browser:
  		Edge and Internet Explorer (≥8) do not support authentication information
  		within a URL at all and will throw a security exception on *any* property
  		access if its included.
  			Internet Explorer does not include the leading forward slash on `pathname`
  		when required.
  			Opera (Presto) strips the authentication information from `href` and does
  		not supply `username` or `password`.
  			Safari (circa. 5.1.x) does not supply `username` or `password` and peforms
  		URI decoding on `pathname`.
  */

		// Patch for IE not including the leading slash on `pathname` when required.
		var pathname = el.host && el.pathname[0] !== '/' ? '/' + el.pathname : el.pathname;

		return {
			// The full URL that was originally parsed.
			href: el.href,

			// The request protocol, lowercased.
			protocol: el.protocol,

			// // The full authentication information.
			// auth : el.username || el.password // eslint-disable-line no-nested-ternary
			// 	? `${el.username}:${el.password}`
			// 	: typeof el.username === 'string' ? '' : undefined,
			//
			// // The username portion of the auth info.
			// username : el.username,
			//
			// // The password portion of the auth info.
			// password : el.password,

			// The full host information, including port number, lowercased.
			host: el.host,

			// The hostname portion of the host info, lowercased.
			hostname: el.hostname,

			// The port number portion of the host info.
			port: el.port,

			// The full path information, including query info.
			path: '' + pathname + el.search,

			// The pathname portion of the path info.
			pathname: pathname,

			// The query string portion of the path info, including the leading question mark.
			query: el.search,
			search: el.search,

			// The attributes portion of the query string, parsed into an object.
			queries: queryObj,
			searches: queryObj,

			// The fragment string, including the leading hash/pound sign.
			hash: el.hash
		};
	}

	/*******************************************************************************************************************
  * Diff Functions.
  ******************************************************************************************************************/
	/*
 	Diff operations enumeration.
 */
	var DiffOp = Object.freeze({
		Delete: 0,
		SpliceArray: 1,
		Copy: 2,
		CopyDate: 3
	});

	/**
 	Returns a patch object containing the differences between the orig and the dest objects.
 **/
	function utilDiff(orig, dest) /* diff object */{
		var objToString = Object.prototype.toString,
		    origIsArray = Array.isArray(orig),
		    keys = [].concat(Object.keys(orig), Object.keys(dest)).sort().filter(function (v, i, a) {
			return i === 0 || a[i - 1] !== v;
		}),
		    diff = {};
		var aOpRef = void 0;

		for (var i = 0, klen = keys.length; i < klen; ++i) {
			var p = keys[i],
			    origP = orig[p],
			    destP = dest[p];

			if (orig.hasOwnProperty(p)) {
				// Key exists in both.
				if (dest.hasOwnProperty(p)) {
					// Values are exactly the same, so do nothing.
					if (origP === destP) {
						continue;
					}

					// Values are of the same basic type.
					if ((typeof origP === 'undefined' ? 'undefined' : _typeof(origP)) === (typeof destP === 'undefined' ? 'undefined' : _typeof(destP))) {
						// Values are functions.
						if (typeof origP === 'function') {
							/* diff[p] = [DiffOp.Copy, destP]; */
							if (origP.toString() !== destP.toString()) {
								diff[p] = [DiffOp.Copy, destP];
							}
						}
						// Values are scalars or null.
						else if ((typeof origP === 'undefined' ? 'undefined' : _typeof(origP)) !== 'object' || origP === null) {
								diff[p] = [DiffOp.Copy, destP];
							}
							// Values are objects.
							else {
									var origPType = objToString.call(origP),
									    destPType = objToString.call(destP);

									// Values are objects of the same prototype.
									if (origPType === destPType) {
										// Special case: `Date` object.
										if (origPType === '[object Date]') {
											if (+origP !== +destP) {
												diff[p] = [DiffOp.CopyDate, +destP];
											}
										}
										// Special case: `RegExp` object.
										else if (origPType === '[object RegExp]') {
												if (origP.toString() !== destP.toString()) {
													diff[p] = [DiffOp.Copy, clone(destP)];
												}
											} else {
												var recurse = Util.diff(origP, destP);

												if (recurse !== null) {
													diff[p] = recurse;
												}
											}
									}
									// Values are objects of different prototypes.
									else {
											diff[p] = [DiffOp.Copy, clone(destP)];
										}
								}
					}
					// Values are of different types.
					else {
							diff[p] = [DiffOp.Copy, (typeof destP === 'undefined' ? 'undefined' : _typeof(destP)) !== 'object' || destP === null ? destP : clone(destP)];
						}
				}
				// Key only exists in orig.
				else {
						if (origIsArray && Util.isNumeric(p)) {
							var np = +p;

							if (!aOpRef) {
								aOpRef = '';

								do {
									aOpRef += '~';
								} while (keys.some(function (v) {
									return v === this.val;
								}, { val: aOpRef }));

								diff[aOpRef] = [DiffOp.SpliceArray, np, np];
							}

							if (np < diff[aOpRef][1]) {
								diff[aOpRef][1] = np;
							}

							if (np > diff[aOpRef][2]) {
								diff[aOpRef][2] = np;
							}
						} else {
							diff[p] = DiffOp.Delete;
						}
					}
			}
			// Key only exists in dest.
			else {
					diff[p] = [DiffOp.Copy, (typeof destP === 'undefined' ? 'undefined' : _typeof(destP)) !== 'object' || destP === null ? destP : clone(destP)];
				}
		}

		return Object.keys(diff).length > 0 ? diff : null;
	}

	/**
 	Returns an object resulting from updating the orig object with the diff object.
 **/
	function utilPatch(orig, diff) /* patched object */{
		var keys = Object.keys(diff || {}),
		    patched = clone(orig);

		for (var i = 0, klen = keys.length; i < klen; ++i) {
			var p = keys[i],
			    diffP = diff[p];

			if (diffP === DiffOp.Delete) {
				delete patched[p];
			} else if (Array.isArray(diffP)) {
				switch (diffP[0]) {
					case DiffOp.SpliceArray:
						patched.splice(diffP[1], 1 + (diffP[2] - diffP[1]));
						break;
					case DiffOp.Copy:
						patched[p] = clone(diffP[1]);
						break;
					case DiffOp.CopyDate:
						patched[p] = new Date(diffP[1]);
						break;
				}
			} else {
				patched[p] = Util.patch(patched[p], diffP);
			}
		}

		return patched;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	Type Functions.
  */
		isNumeric: { value: utilIsNumeric },
		isBoolean: { value: utilIsBoolean },

		/*
  	String Encoding Functions.
  */
		slugify: { value: utilSlugify },
		escape: { value: utilEscape },
		unescape: { value: utilUnescape },

		/*
  	Conversion Functions.
  */
		fromCssTime: { value: utilFromCssTime },
		toCssTime: { value: utilToCssTime },
		fromCssProperty: { value: utilFromCssProperty },
		parseUrl: { value: utilParseUrl },

		/*
  	Diff Functions.
  */
		DiffOp: { value: DiffOp },
		diff: { value: utilDiff },
		patch: { value: utilPatch },

		/*
  	Legacy Aliases.
  */
		random: { value: Math.random },
		entityEncode: { value: utilEscape },
		entityDecode: { value: utilUnescape },
		evalExpression: { value: function value() {
				return Scripting.evalJavaScript.apply(Scripting, arguments);
			} }, // See: `markup/scripting.js`.
		evalStatements: { value: function value() {
				return Scripting.evalJavaScript.apply(Scripting, arguments);
			} } // See: `markup/scripting.js`.
	}));
}();

/***********************************************************************************************************************
 *
 * lib/audiowrapper.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var AudioWrapper = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// Events supported by the `on()`, `one()`, and `off()` methods.
	_events = new Map([['end', 'ended'], ['fade', 'aw:fade'], ['pause', 'pause'], ['play', 'playing'], ['rate', 'ratechange'], ['seek', 'seeked'], ['stop', 'aw:stop'], ['volume', 'volumechange']]);

	/*******************************************************************************************************************
  * AudioWrapper Class.
  ******************************************************************************************************************/

	var AudioWrapper = function () {
		function AudioWrapper(audio) {
			_classCallCheck(this, AudioWrapper);

			Object.defineProperties(this, {
				audio: {
					value: audio
				},

				_faderId: {
					writable: true,
					value: null
				}
			});

			// Ensure that, at least, the metadata is loaded.
			if (this.audio.preload !== 'metadata' && this.audio.preload !== 'auto') {
				this.audio.preload = 'metadata';
			}
		}

		/*
  	n.b. The various data constants (e.g. for comparison to `readyState` or `networkState`)
  	     are not defined by all browsers on the descendant elements `HTMLAudioElement` and
  	     `HTMLVideoElement` (notably, IE/Edge do not).  Therefore, the base media element,
  	     `HTMLMediaElement`, must be used to reference the constants.
  */

		_createClass(AudioWrapper, [{
			key: 'hasMetadata',
			value: function hasMetadata() {
				return this.audio.readyState >= HTMLMediaElement.HAVE_METADATA;
			}
		}, {
			key: 'hasSomeData',
			value: function hasSomeData() {
				return this.audio.readyState >= HTMLMediaElement.HAVE_CURRENT_DATA;
			}
		}, {
			key: 'hasData',
			value: function hasData() {
				return this.audio.readyState === HTMLMediaElement.HAVE_ENOUGH_DATA;
			}
		}, {
			key: 'noSource',
			value: function noSource() {
				return !(this.audio.src || this.audio.hasChildNodes()) || this.audio.networkState === HTMLMediaElement.NETWORK_NO_SOURCE;
			}
		}, {
			key: 'isLoading',
			value: function isLoading() {
				return this.audio.networkState === HTMLMediaElement.NETWORK_LOADING;
			}
		}, {
			key: 'isPlaying',
			value: function isPlaying() {
				return !(this.audio.ended || this.audio.paused || !this.hasSomeData());
			}
		}, {
			key: 'isEnded',
			value: function isEnded() {
				return this.audio.ended;
			}
		}, {
			key: 'isPaused',
			value: function isPaused() {
				return this.audio.paused;
			}
		}, {
			key: 'isMuted',
			value: function isMuted() {
				return this.audio.muted;
			}
		}, {
			key: 'isLooped',
			value: function isLooped() {
				return this.audio.loop;
			}
		}, {
			key: 'load',
			value: function load() {
				if (this.audio.preload !== 'auto') {
					this.audio.preload = 'auto';
				}

				this.audio.load();
			}
		}, {
			key: 'play',
			value: function play() {
				if (!this.hasData() && !this.isLoading()) {
					this.load();
				}

				this.audio.play();
			}
		}, {
			key: 'pause',
			value: function pause() {
				this.audio.pause();
			}
		}, {
			key: 'stop',
			value: function stop() {
				this.audio.pause();
				this.time = 0;
				jQuery(this.audio).triggerHandler('aw:stop');
			}
		}, {
			key: 'mute',
			value: function mute() {
				this.audio.muted = true;
			}
		}, {
			key: 'unmute',
			value: function unmute() {
				this.audio.muted = false;
			}
		}, {
			key: 'loop',
			value: function loop() {
				this.audio.loop = true;
			}
		}, {
			key: 'unloop',
			value: function unloop() {
				this.audio.loop = false;
			}
		}, {
			key: 'fadeWithDuration',
			value: function fadeWithDuration(fadeDuration, toVol, fromVol) {
				var _this2 = this;

				if (this._faderId !== null) {
					clearInterval(this._faderId);
					this._faderId = null;
				}

				var from = Math.clamp(fromVol == null ? this.volume : fromVol, 0, 1),
				    // lazy equality for null
				to = Math.clamp(toVol, 0, 1);

				if (from === to) {
					return;
				}

				this.volume = from;

				/*
    	We listen for the `timeupdate` event here, rather than `playing`, because
    	various browsers (notably, mobile browsers) are poor at firing media events
    	in a timely fashion, so we use `timeupdate` to ensure that we don't start
    	the fade until the track is actually progressing.
    */
				jQuery(this.audio).off('timeupdate.AudioWrapper:fadeWithDuration').one('timeupdate.AudioWrapper:fadeWithDuration', function () {
					var min = void 0,
					    max = void 0;

					if (from < to) {
						// Fade in.
						min = from;
						max = to;
					} else {
						// Fade out.
						min = to;
						max = from;
					}

					var duration = Math.clamp(fadeDuration, 1, _this2.remaining),
					    interval = 25,
					    // in milliseconds
					delta = (to - from) / (duration / (interval / 1000));

					_this2._faderId = setInterval(function () {
						if (!_this2.isPlaying()) {
							clearInterval(_this2._faderId);
							_this2._faderId = null;
							return;
						}

						_this2.volume = Math.clamp(_this2.volume + delta, min, max);

						if (_this2.volume === 0) {
							_this2.pause();
						}

						if (_this2.volume === to) {
							clearInterval(_this2._faderId);
							_this2._faderId = null;
							jQuery(_this2.audio).triggerHandler('aw:fade');
						}
					}, interval);
				});

				this.play();
			}
		}, {
			key: 'fade',
			value: function fade(toVol, fromVol) {
				this.fadeWithDuration(5, toVol, fromVol);
			}
		}, {
			key: 'fadeIn',
			value: function fadeIn() {
				this.fade(1);
			}
		}, {
			key: 'fadeOut',
			value: function fadeOut() {
				this.fade(0);
			}
		}, {
			key: 'on',
			value: function on(eventName, listener) {
				if (!_events.has(eventName)) {
					throw new Error('unknown event "' + eventName + '"; valid: ' + [].concat(_toConsumableArray(_events.keys())).join(', '));
				} else if (typeof listener !== 'function') {
					throw new Error('listener parameter must be a function');
				}

				return jQuery(this.audio).on(_events.get(eventName) + '.AudioWrapperEvents', listener);
			}
		}, {
			key: 'one',
			value: function one(eventName, listener) {
				if (!_events.has(eventName)) {
					throw new Error('unknown event "' + eventName + '"; valid: ' + [].concat(_toConsumableArray(_events.keys())).join(', '));
				} else if (typeof listener !== 'function') {
					throw new Error('listener parameter must be a function');
				}

				return jQuery(this.audio).one(_events.get(eventName) + '.AudioWrapperEvents', listener);
			}
		}, {
			key: 'off',
			value: function off(eventName, listener) {
				if (eventName && !_events.has(eventName)) {
					throw new Error('unknown event "' + eventName + '"; valid: ' + [].concat(_toConsumableArray(_events.keys())).join(', '));
				} else if (listener && typeof listener !== 'function') {
					throw new Error('listener parameter must be a function');
				}

				return jQuery(this.audio).off((eventName ? _events.get(eventName) : '') + '.AudioWrapperEvents', listener);
			}
		}, {
			key: 'clone',
			value: function clone() {
				// Do not use `jQuery.clone()` here, as we do not want event handlers carried over.
				// return new AudioWrapper(this.audio.cloneNode(true));
				return new this.constructor(this.audio.cloneNode(true));
			}
		}, {
			key: 'duration',
			get: function get() {
				// n.b. May return a double, NaN, or Infinity.
				return this.audio.duration;
			}
		}, {
			key: 'rate',
			get: function get() {
				return this.audio.playbackRate;
			},
			set: function set(playRate) {
				// Clamp the playback rate to sane values.  Some browsers also do this to varying degrees.
				this.audio.playbackRate = Math.clamp(playRate, 0.2, 5); // clamp to 5× slower & faster
			}
		}, {
			key: 'remaining',
			get: function get() {
				// n.b. May return a double, NaN, or Infinity.
				return this.audio.duration - this.audio.currentTime;
			}
		}, {
			key: 'time',
			get: function get() {
				return this.audio.currentTime;
			},
			set: function set(time) {
				var _this3 = this;

				/*
    	This workaround is no longer strictly necessary in most browsers (as of 2016),
    	however, it will still be required for some time to service legacy browsers.
    		If we try to modify the audio clip's `.currentTime` property before its metadata
    	has been loaded, it will throw an `InvalidStateError` (since it doesn't know its
    	duration, allowing `.currentTime` to be set would be undefined behavior), so in
    	case an exception is thrown we provide a fallback using the `loadedmetadata` event.
    */
				try {
					this.audio.currentTime = time;
				} catch (e) {
					jQuery(this.audio).off('loadedmetadata.AudioWrapper:time').one('loadedmetadata.AudioWrapper:time', function () {
						return _this3.audio.currentTime = time;
					});
				}
			}
		}, {
			key: 'volume',
			get: function get() {
				return this.audio.volume;
			},
			set: function set(vol) {
				this.audio.volume = Math.clamp(vol, 0, 1); // clamp to 0 (silent) & 1 (full loudness)
			}
		}]);

		return AudioWrapper;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return AudioWrapper;
}();

/***********************************************************************************************************************
 *
 * lib/debugview.js
 *
 * Copyright © 2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global strings */

/*
	TODO: Make this use jQuery throughout.
*/
var DebugView = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * DebugView Class.
  ******************************************************************************************************************/

	var DebugView = function () {
		function DebugView(parent, type, name, title) {
			_classCallCheck(this, DebugView);

			Object.defineProperties(this, {
				parent: {
					value: parent
				},

				view: {
					value: document.createElement('span')
				},

				break: {
					value: document.createElement('wbr')
				}
			});

			// Setup the wrapper (`<span>`) element.
			jQuery(this.view).attr({
				title: title,
				'aria-label': title,
				'data-type': type != null ? type : '', // lazy equality for null
				'data-name': name != null ? name : '' // lazy equality for null
			}).addClass('debug');

			// Add the wrapper (`<span>`) and word break (`<wbr>`) elements to the `parent` element.
			this.parent.appendChild(this.view);
			this.parent.appendChild(this.break);
		}

		_createClass(DebugView, [{
			key: 'append',
			value: function append(el) {
				jQuery(this.view).append(el);
				return this;
			}
		}, {
			key: 'modes',
			value: function modes(options) {
				var _this4 = this;

				if (options == null) {
					var _ret2 = function () {
						// lazy equality for null
						var current = {};

						_this4.view.className.splitOrEmpty(/\s+/).forEach(function (name) {
							if (name !== 'debug') {
								current[name] = true;
							}
						});

						return {
							v: current
						};
					}();

					if ((typeof _ret2 === 'undefined' ? 'undefined' : _typeof(_ret2)) === "object") return _ret2.v;
				} else if ((typeof options === 'undefined' ? 'undefined' : _typeof(options)) === 'object') {
					Object.keys(options).forEach(function (name) {
						this[options[name] ? 'addClass' : 'removeClass'](name);
					}, jQuery(this.view));

					return this;
				} else {
					throw new Error('DebugView.prototype.modes options parameter must be an object or null/undefined');
				}
			}
		}, {
			key: 'remove',
			value: function remove() {
				var $view = jQuery(this.view);

				if (this.view.hasChildNodes()) {
					$view.contents().appendTo(this.parent);
				}

				$view.remove();
				jQuery(this.break).remove();
			}
		}, {
			key: 'output',
			get: function get() {
				return this.view;
			}
		}, {
			key: 'type',
			get: function get() {
				return this.view.getAttribute('data-type');
			},
			set: function set(type) {
				this.view.setAttribute('data-type', type != null ? type : ''); // lazy equality for null
			}
		}, {
			key: 'name',
			get: function get() {
				return this.view.getAttribute('data-name');
			},
			set: function set(name) {
				this.view.setAttribute('data-name', name != null ? name : ''); // lazy equality for null
			}
		}, {
			key: 'title',
			get: function get() {
				return this.view.title;
			},
			set: function set(title) {
				this.view.title = title;
			}
		}], [{
			key: 'init',
			value: function init() {
				// Inject the the debug view toggle button into the UI bar.
				jQuery('<button id="debug-view-toggle">' + strings.debugView.title + '</button>').ariaClick({
					label: strings.debugView.toggle
				}, function () {
					return DebugView.toggle();
				}).prependTo('#ui-bar-body');

				// Enable the debug view initially.
				DebugView.enable();
			}
		}, {
			key: 'enable',
			value: function enable() {
				jQuery(document.documentElement).addClass('debug-view');
				jQuery.event.trigger('tw:debugviewupdate');
			}
		}, {
			key: 'disable',
			value: function disable() {
				jQuery(document.documentElement).removeClass('debug-view');
				jQuery.event.trigger('tw:debugviewupdate');
			}
		}, {
			key: 'toggle',
			value: function toggle() {
				jQuery(document.documentElement).toggleClass('debug-view');
				jQuery.event.trigger('tw:debugviewupdate');
			}
		}]);

		return DebugView;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return DebugView;
}();

/***********************************************************************************************************************
 *
 * lib/keyvaluestore.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Alert, Has */

var KeyValueStore = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * _WebStorageDriver Class.
  ******************************************************************************************************************/

	var _WebStorageDriver = function () {
		function _WebStorageDriver(persist, storageId) {
			_classCallCheck(this, _WebStorageDriver);

			var prefix = storageId + '.';
			var engine = null,
			    name = null;

			if (persist) {
				if (Has.localStorage) {
					engine = window.localStorage;
					name = 'localStorage';
				}
			} else {
				if (Has.sessionStorage) {
					engine = window.sessionStorage;
					name = 'sessionStorage';
				}
			}

			Object.defineProperties(this, {
				_ok: {
					value: engine !== null
				},

				_engine: {
					value: engine
				},

				_prefix: {
					value: prefix
				},

				_prefixRe: {
					value: new RegExp('^' + RegExp.escape(prefix))
				},

				name: {
					value: name
				},

				id: {
					value: storageId
				},

				persist: {
					value: !!persist
				}
			});
		}

		_createClass(_WebStorageDriver, [{
			key: 'keys',
			value: function keys() {
				if (this._engine === null) {
					return [];
				}

				var keys = [];

				for (var i = 0; i < this._engine.length; ++i) {
					var key = this._engine.key(i);

					if (this._prefixRe.test(key)) {
						keys.push(key.replace(this._prefixRe, ''));
					}
				}

				return keys;
			}
		}, {
			key: 'has',
			value: function has(key) {
				if (this._engine === null || !key) {
					return false;
				}

				// Ideally, we really should be checking keys here.
				return this._engine.getItem(this._prefix + key) != null; // lazy equality for null
			}
		}, {
			key: 'get',
			value: function get(key) {
				if (this._engine === null || !key) {
					return null;
				}

				return this._engine.getItem(this._prefix + key);
			}
		}, {
			key: 'set',
			value: function set(key, value) {
				if (this._engine === null || !key) {
					return false;
				}

				try {
					this._engine.setItem(this._prefix + key, value);
				} catch (e) {
					/*
     	Massage the quota exceeded error—the most likely error—into something
     	a bit nicer for the player.
     		Ideally, we could simply do:
     		e.code === 22
     	Or, preferably, something like:
     		e.code === DOMException.QUOTA_EXCEEDED_ERR
     	However, both of those are browser convention, not part of the standard,
     	and are not supported in all browsers.  So, we have to resort to pattern
     	matching the damn name.  I hate the parties responsible for this snafu
     	so much.
     */
					if (/quota_?(?:exceeded|reached)/i.test(e.name)) {
						e.message = this.name + ' quota exceeded';
					}

					throw e;
				}

				return true;
			}
		}, {
			key: 'delete',
			value: function _delete(key) {
				if (this._engine === null || !key) {
					return false;
				}

				this._engine.removeItem(this._prefix + key);

				return true;
			}
		}, {
			key: 'serialize',
			value: function serialize(obj) {
				return LZString.compressToUTF16(JSON.stringify(obj));
			}
		}, {
			key: 'deserialize',
			value: function deserialize(str) {
				return JSON.parse(LZString.decompressFromUTF16(str));
			}
		}, {
			key: 'length',
			get: function get() {
				/*
    	DO NOT do something like `return this._engine.length;` as that will return
    	the length of the entire store, rather than just our prefixed keys.
    */
				return this.keys().length;
			}
		}]);

		return _WebStorageDriver;
	}();

	/*******************************************************************************************************************
  * _CookieDriver Class.
  ******************************************************************************************************************/


	var _CookieDriver = function () {
		function _CookieDriver(persist, storageId) {
			_classCallCheck(this, _CookieDriver);

			var prefix = storageId + '.';

			Object.defineProperties(this, {
				_ok: {
					value: 'cookie' in document // should really try to test cookie functionality
				},

				_prefix: {
					value: prefix
				},

				_prefixRe: {
					value: new RegExp('^' + RegExp.escape(prefix))
				},

				name: {
					value: 'cookie'
				},

				id: {
					value: storageId
				},

				persist: {
					value: !!persist
				}
			});
		}

		_createClass(_CookieDriver, [{
			key: 'keys',
			value: function keys() {
				return Object.keys(this._getCookies());
			}
		}, {
			key: 'has',
			value: function has(key) {
				if (!key) {
					return false;
				}

				return this._getCookies().hasOwnProperty(this._prefix + key);
			}
		}, {
			key: 'get',
			value: function get(key) {
				if (!key) {
					return null;
				}

				var cookies = this._getCookies(),
				    pKey = this._prefix + key;

				if (cookies.hasOwnProperty(pKey)) {
					return cookies[pKey];
				}

				return null;
			}
		}, {
			key: 'set',
			value: function set(key, value) {
				if (!key) {
					return false;
				}

				try {
					// Undefined expiry means a session cookie.
					this._setCookie(key, value, this.persist ? 'Tue, 19 Jan 2038 03:14:07 GMT' : undefined);
				} catch (e) {
					e.message = 'cookie error: ' + e.message;
					throw e;
				}

				if (!this.has(key)) {
					throw new Error('unknown cookie error');
				}

				return true;
			}
		}, {
			key: 'delete',
			value: function _delete(key) {
				if (!key) {
					return false;
				}

				try {
					this._setCookie(key, undefined, 'Thu, 01 Jan 1970 00:00:00 GMT');
				} catch (e) {
					e.message = 'cookie error: ' + e.message;
					throw e;
				}

				// It seems like we cannot simply use `.has()` here for validation because of IE shenanigans?
				// if (this.has(key)) {
				var test = this.get(key);
				if (test !== null && test !== '') {
					throw new Error('unknown cookie error');
				}

				return true;
			}
		}, {
			key: 'serialize',
			value: function serialize(obj) {
				return LZString.compressToBase64(JSON.stringify(obj));
			}
		}, {
			key: 'deserialize',
			value: function deserialize(str) {
				return JSON.parse(LZString.decompressFromBase64(str));
			}
		}, {
			key: '_getCookies',
			value: function _getCookies() {
				var cookieObj = {};

				if ('cookie' in document && document.cookie !== '') {
					var cookies = document.cookie.split(/;\s*/);

					for (var i = 0; i < cookies.length; ++i) {
						var kv = cookies[i].split('='),
						    key = decodeURIComponent(kv[0]);

						if (this._prefixRe.test(key)) {
							cookieObj[key] = decodeURIComponent(kv[1]);
						}
					}
				}

				return cookieObj;
			}
		}, {
			key: '_setCookie',
			value: function _setCookie(key, value, expiry) {
				if ('cookie' in document) {
					var payload = encodeURIComponent(this._prefix + key) + '=';

					if (value != null) {
						// lazy equality for null
						payload += encodeURIComponent(value);
					}

					if (expiry != null) {
						// lazy equality for null
						payload += '; ' + expiry;
					}

					payload += '; path=/';
					document.cookie = payload;
				}
			}
		}, {
			key: 'length',
			get: function get() {
				return this.keys().length;
			}
		}]);

		return _CookieDriver;
	}();

	/*******************************************************************************************************************
  * KeyValueStore Class.
  ******************************************************************************************************************/


	var KeyValueStore = function () {
		function KeyValueStore(driverType, persist, storageId) {
			_classCallCheck(this, KeyValueStore);

			var driver = null;

			switch (driverType) {
				case 'cookie':
					driver = new _CookieDriver(persist, storageId);
					break;

				case 'webStorage':
					driver = new _WebStorageDriver(persist, storageId);

					if (!driver._ok) {
						// Fallback to cookies.  Perhaps, this should be handled externally?
						driver = new _CookieDriver(persist, storageId);
					}
					break;

				default:
					throw new Error('unknown driver type');
			}

			if (!driver._ok) {
				throw new Error('unknown driver error');
			}

			Object.defineProperties(this, {
				_driver: {
					value: driver
				},

				name: {
					value: driver.name
				},

				type: {
					value: driverType
				},

				id: {
					value: storageId
				},

				persist: {
					value: persist
				}
			});
		}

		_createClass(KeyValueStore, [{
			key: 'keys',
			value: function keys() {
				if (DEBUG) {
					console.log('[<KeyValueStore>.keys()]');
				}

				if (this._driver === null) {
					return [];
				}

				return this._driver.keys();
			}
		}, {
			key: 'clear',
			value: function clear() {
				if (DEBUG) {
					console.log('[<KeyValueStore>.clear()]');
				}

				if (this._driver === null) {
					return false;
				}

				var keys = this.keys();

				for (var i = 0; i < keys.length; ++i) {
					if (DEBUG) {
						console.log('\tdeleting key:', keys[i]);
					}

					this.delete(keys[i]);
				}

				return true;
			}
		}, {
			key: 'has',
			value: function has(key, quiet) {
				if (DEBUG) {
					console.log('[<KeyValueStore>.has(key: "' + key + '", quiet: "' + quiet + '")]');
				}

				if (this._driver === null || !key) {
					return false;
				}

				try {
					return this._driver.has(key);
				} catch (e) {
					if (!quiet) {
						Alert.error(null, 'unable to check key "' + key + '"; ' + e.message, e);
					}

					return false;
				}
			}
		}, {
			key: 'get',
			value: function get(key, quiet) {
				if (DEBUG) {
					console.log('[<KeyValueStore>.get(key: "' + key + '", quiet: "' + quiet + '")]');
				}

				if (this._driver === null || !key) {
					return null;
				}

				try {
					var value = this._driver.get(key);

					if (value == null) {
						// lazy equality for null
						return null;
					}

					return this._driver.deserialize(value);
				} catch (e) {
					if (!quiet) {
						Alert.error(null, 'unable to get key "' + key + '"; ' + e.message, e);
					}

					return null;
				}
			}
		}, {
			key: 'set',
			value: function set(key, value, quiet) {
				if (DEBUG) {
					console.log('[<KeyValueStore>.set(key: "' + key + '", value: …, quiet: "' + quiet + '")]');
				}

				if (this._driver === null || !key) {
					return false;
				}

				try {
					return this._driver.set(key, this._driver.serialize(value), quiet);
				} catch (e) {
					if (!quiet) {
						Alert.error(null, 'unable to set key "' + key + '"; ' + e.message, e);
					}

					return false;
				}
			}
		}, {
			key: 'delete',
			value: function _delete(key, quiet) {
				if (DEBUG) {
					console.log('[<KeyValueStore>.delete(key: "' + key + '", quiet: "' + quiet + '")]');
				}

				if (this._driver === null || !key) {
					return false;
				}

				try {
					return this._driver.delete(key, quiet);
				} catch (e) {
					if (!quiet) {
						Alert.error(null, 'unable to delete key "' + key + '"; ' + e.message, e);
					}

					return false;
				}
			}
		}, {
			key: 'deleteMatching',
			value: function deleteMatching(subKey, quiet) {
				if (DEBUG) {
					console.log('[<KeyValueStore>.deleteMatching(subKey: "' + subKey + '", quiet: "' + quiet + '")]');
				}

				if (this._driver === null || !subKey) {
					return false;
				}

				var keys = this.keys(),
				    re = new RegExp('^' + RegExp.escape(subKey));

				for (var i = 0; i < keys.length; ++i) {
					if (re.test(keys[i])) {
						if (DEBUG) {
							console.log('\tdeleting key:', keys[i]);
						}

						this.delete(keys[i], quiet);
					}
				}

				return true;
			}
		}, {
			key: 'length',
			get: function get() {
				if (DEBUG) {
					console.log('[<KeyValueStore>.length]');
				}

				if (this._driver === null) {
					return 0;
				}

				return this._driver.length;
			}
		}]);

		return KeyValueStore;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return KeyValueStore;
}();

/***********************************************************************************************************************
 *
 * lib/prngwrapper.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var PRNGWrapper = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * PRNGWrapper Class.
  ******************************************************************************************************************/

	var PRNGWrapper = function () {
		function PRNGWrapper(seed, useEntropy) {
			_classCallCheck(this, PRNGWrapper);

			/* eslint-disable new-cap */
			Object.defineProperties(this, new Math.seedrandom(seed, useEntropy, function (prng, seed) {
				return {
					_prng: {
						value: prng
					},

					seed: {
						/*
      	TODO: Make this non-writable.
      */
						writable: true,
						value: seed
					},

					pull: {
						writable: true,
						value: 0
					},

					random: {
						value: function value() {
							++this.pull;
							return this._prng();
						}
					}
				};
			}));
			/* eslint-enable new-cap */
		}

		_createClass(PRNGWrapper, null, [{
			key: 'marshal',
			value: function marshal(prng) {
				if (!prng || !prng.hasOwnProperty('seed') || !prng.hasOwnProperty('pull')) {
					throw new Error('PRNG is missing required data');
				}

				return {
					seed: prng.seed,
					pull: prng.pull
				};
			}
		}, {
			key: 'unmarshal',
			value: function unmarshal(prngObj) {
				if (!prngObj || !prngObj.hasOwnProperty('seed') || !prngObj.hasOwnProperty('pull')) {
					throw new Error('PRNG object is missing required data');
				}

				/*
    	Create a new PRNG using the original seed and pull values from it until it
    	has reached the original pull count.
    */
				var prng = new PRNGWrapper(prngObj.seed, false);

				for (var i = prngObj.pull; i > 0; --i) {
					prng.random();
				}

				return prng;
			}
		}]);

		return PRNGWrapper;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return PRNGWrapper;
}();

/***********************************************************************************************************************
 *
 * lib/stylewrapper.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var StyleWrapper = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * StyleWrapper Class.
  ******************************************************************************************************************/

	var StyleWrapper = function () {
		function StyleWrapper(style) {
			_classCallCheck(this, StyleWrapper);

			if (style == null) {
				// lazy equality for null
				throw new TypeError('StyleWrapper style parameter must be an HTMLStyleElement object');
			}

			Object.defineProperties(this, {
				style: {
					value: style
				}
			});
		}

		_createClass(StyleWrapper, [{
			key: 'isEmpty',
			value: function isEmpty() {
				/*
    return this.style.styleSheet
    	? this.style.styleSheet.cssText === '' // for IE ≤ 10
    	: this.style.hasChildNodes();          // for all other browsers (incl. IE ≥ 11)
    */
				// This should work in all supported browsers.
				return this.style.cssRules.length === 0;
			}
		}, {
			key: 'set',
			value: function set(css) {
				this.clear();
				this.add(css);
			}
		}, {
			key: 'add',
			value: function add(css) {
				// For IE ≤ 10.
				if (this.style.styleSheet) {
					this.style.styleSheet.cssText += css;
				}

				// For all other browsers (incl. IE ≥ 11).
				else {
						this.style.appendChild(document.createTextNode(css));
					}
			}
		}, {
			key: 'clear',
			value: function clear() {
				// For IE ≤ 10.
				if (this.style.styleSheet) {
					this.style.styleSheet.cssText = '';
				}

				// For all other browsers (incl. IE ≥ 11).
				else {
						jQuery(this.style).empty();
					}
			}
		}]);

		return StyleWrapper;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return StyleWrapper;
}();

/***********************************************************************************************************************
 *
 * config.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var Config = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var Config = Object.seal({
		/*
  	General properties.
  */
		debug: false,
		addVisitedLinkClass: false,
		cleanupWikifierOutput: false,
		loadDelay: 0,

		/*
  	State history properties.
  */
		history: Object.seal({
			controls: true,
			maxStates: 100,

			// Die if deprecated `Config.history` properties are accessed.
			get mode() {
				_throwHistoryModeError();
			},
			set mode(_) {
				_throwHistoryModeError();
			},
			get tracking() {
				_throwHistoryTrackingError();
			},
			set tracking(_) {
				_throwHistoryTrackingError();
			}
		}),

		/*
  	Macros properties.
  */
		macros: Object.seal({
			ifAssignmentError: true,
			maxLoopIterations: 1000
		}),

		/*
  	Passages properties.
  */
		passages: Object.seal({
			descriptions: undefined,
			displayTitles: false,
			start: undefined, // set by `Story.load()`
			transitionOut: undefined
		}),

		/*
  	Saves properties.
  */
		saves: Object.seal({
			autoload: undefined,
			autosave: undefined,
			id: 'untitled-story',
			isAllowed: undefined,
			onLoad: undefined,
			onSave: undefined,
			slots: 8,
			version: undefined
		}),

		/*
  	UI properties.
  */
		ui: Object.seal({
			stowBarInitially: false,
			updateStoryElements: true
		}),

		/*
  	Transition properties.
  */
		transitionEndEventName: function () {
			var teMap = new Map([['transition', 'transitionend'], ['MSTransition', 'msTransitionEnd'], ['WebkitTransition', 'webkitTransitionEnd'], ['MozTransition', 'transitionend']]),
			    teKeys = [].concat(_toConsumableArray(teMap.keys())),
			    el = document.createElement('div');

			for (var i = 0; i < teKeys.length; ++i) {
				if (el.style[teKeys[i]] !== undefined) {
					return teMap.get(teKeys[i]);
				}
			}

			return '';
		}()
	});

	function _throwHistoryModeError() {
		throw new Error('Config.history.mode has been deprecated and' + ' is no longer used by SugarCube, please remove it from your code');
	}

	function _throwHistoryTrackingError() {
		throw new Error('Config.history.tracking has been deprecated, use Config.history.maxStates instead');
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Config;
}();

/***********************************************************************************************************************
 *
 * markup/patterns.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/*
	TODO: Move all markup patterns into here.
*/

var Patterns = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// Some versions of Safari do not handle Unicode properly.
	_unicodeOk = /[\u0150\u0170]/g.test('Ő');

	/*******************************************************************************************************************
  * Patterns.
  ******************************************************************************************************************/
	var
	// whitespace patterns.
	space = '[\\s\\u00A0\\u2028\\u2029]',
	    // Unicode space-character escapes required for IE < 11 (maybe < 10?)

	// Character patterns.
	anyLetter = '[0-9A-Z_a-z\\-\\u00C0-\\u00D6\\u00D8-\\u00DE\\u00DF-\\u00F6\\u00F8-\\u00FF' + ((_unicodeOk ? '\\u0150\\u0170\\u0151\\u0171' /* Include surrogate pairs? '\\uD800-\\uDFFF' */ : '') + ']'),
	    anyLetterStrict = anyLetter.replace('\\-', ''),
	    // anyLetter sans hyphens

	/*
 	Identifier patterns.
 		These are kludges.  Since JavaScript's RegExp syntax isn't fully Unicode-enabled,
 	not supporting Unicode character classes, the correct regular expression to match
 	a valid identifier (within the scope of our needs) would be on the order of 11 kB.
 	That being the case, for the time being, we restrict valid TwineScript identifiers
 	to US-ASCII.
 		FIXME: Fix this to, at least, approximate the correct range.
 */
	identifierFirstChar = '[$A-Z_a-z]',
	    identifier = identifierFirstChar + '[$0-9A-Z_a-z]*',


	// Variable patterns.
	variableSigil = '[$_]',
	    variable = variableSigil + identifier,


	// Inline CSS pattern.
	inlineCss = ['(?:(' + anyLetter + '+)\\(([^\\)\\|\\n]+)\\):)', // [1,2]=style(value):
	'(?:(' + anyLetter + '+):([^;\\|\\n]+);)', // [3,4]=style:value;
	'(?:((?:\\.' + anyLetter + '+)+);)', // [5]  =.className;
	'(?:((?:#' + anyLetter + '+)+);)' // [6]  =#id;
	].join('|'),


	// URL pattern.
	url = '(?:file|https?|mailto|ftp|javascript|irc|news|data):[^\\s\'"]+(?:/|\\b)';

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze({
		space: space,
		anyLetter: anyLetter,
		anyLetterStrict: anyLetterStrict,
		identifierFirstChar: identifierFirstChar,
		identifier: identifier,
		variableSigil: variableSigil,
		variable: variable,
		inlineCss: inlineCss,
		url: url
	});
}();

/***********************************************************************************************************************
 *
 * markup/scripting.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Engine, Patterns, State, Story */

var Scripting = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/* eslint-disable no-unused-vars */

	/*******************************************************************************************************************
  * Deprecated Legacy Functions.
  ******************************************************************************************************************/
	/*
 	[DEPRECATED] Returns the jQuery-wrapped target element(s) after making them accessible
 	clickables (ARIA compatibility).
 		n.b. Unused, included only for compatibility.
 */

	function addAccessibleClickHandler(targets, selector, handler, one, namespace) {
		if (arguments.length < 2) {
			throw new Error('addAccessibleClickHandler insufficient number of parameters');
		}

		var fn = void 0,
		    opts = void 0;

		if (typeof selector === 'function') {
			fn = selector;
			opts = {
				namespace: one,
				one: !!handler
			};
		} else {
			fn = handler;
			opts = {
				namespace: namespace,
				one: !!one,
				selector: selector
			};
		}

		if (typeof fn !== 'function') {
			throw new TypeError('addAccessibleClickHandler handler parameter must be a function');
		}

		return jQuery(targets).ariaClick(opts, fn);
	}

	/*
 	[DEPRECATED] Returns a new DOM element, optionally appending it to the passed DOM element, if any.
 		n.b. Unused, included only for compatibility.
 */
	function insertElement(place, type, id, classNames, text, title) {
		var $el = jQuery(document.createElement(type));

		// Add attributes/properties.
		if (id) {
			$el.attr('id', id);
		}

		if (classNames) {
			$el.addClass(classNames);
		}

		if (title) {
			$el.attr('title', title);
		}

		// Add text content.
		if (text) {
			$el.text(text);
		}

		// Append it to the given node.
		if (place) {
			$el.appendTo(place);
		}

		return $el[0];
	}

	/*
 	[DEPRECATED] Creates a new text node and appends it to the passed DOM element.
 		n.b. Unused, included only for compatibility.
 */
	function insertText(place, text) {
		jQuery(place).append(document.createTextNode(text));
	}

	/*
 	[DEPRECATED] Removes all children from the passed DOM node.
 		n.b. Unused, included only for compatibility.
 */
	function removeChildren(node) {
		jQuery(node).empty();
	}

	/*
 	[DEPRECATED] Removes the passed DOM node.
 		n.b. Unused, included only for compatibility.
 */
	function removeElement(node) {
		jQuery(node).remove();
	}

	/*
 	[DEPRECATED] Fades a DOM element in or out.
 		n.b. Unused, included only for compatibility.
 */
	function fade(el, options) {
		/* eslint-disable no-param-reassign */
		var direction = options.fade === 'in' ? 1 : -1;
		var current = void 0,
		    proxy = el.cloneNode(true),
		    intervalId = void 0;

		function tick() {
			current += 0.05 * direction;
			setOpacity(proxy, Math.easeInOut(current));

			if (direction === 1 && current >= 1 || direction === -1 && current <= 0) {
				el.style.visibility = options.fade === 'in' ? 'visible' : 'hidden';
				proxy.parentNode.replaceChild(el, proxy);
				proxy = null;
				window.clearInterval(intervalId);

				if (options.onComplete) {
					options.onComplete();
				}
			}
		}

		function setOpacity(el, opacity) {
			// Old IE.
			el.style.zoom = 1;
			el.style.filter = 'alpha(opacity=' + Math.floor(opacity * 100) + ')';

			// CSS.
			el.style.opacity = opacity;
		}

		el.parentNode.replaceChild(proxy, el);

		if (options.fade === 'in') {
			current = 0;
			proxy.style.visibility = 'visible';
		} else {
			current = 1;
		}

		setOpacity(proxy, current);
		intervalId = window.setInterval(tick, 25);
		/* eslint-enable no-param-reassign */
	}

	/*
 	[DEPRECATED] Scrolls the browser window to ensure that a DOM element is in view.
 		n.b. Unused, included only for compatibility.
 */
	function scrollWindowTo(el, incrementBy) {
		/* eslint-disable no-param-reassign */
		var increment = incrementBy != null ? Number(incrementBy) : 0.1; // lazy equality for null

		if (isNaN(increment) || !isFinite(increment) || increment < 0) {
			increment = 0.1;
		} else if (increment > 1) {
			increment = 1;
		}

		var start = window.scrollY ? window.scrollY : document.body.scrollTop,
		    end = ensureVisible(el),
		    distance = Math.abs(start - end),
		    direction = start > end ? -1 : 1;
		var progress = 0,
		    intervalId = void 0;

		function tick() {
			progress += increment;
			window.scroll(0, start + direction * (distance * Math.easeInOut(progress)));

			if (progress >= 1) {
				window.clearInterval(intervalId);
			}
		}

		function findPosY(el) {
			// eslint-disable-line no-shadow
			var curtop = 0;

			while (el.offsetParent) {
				curtop += el.offsetTop;
				el = el.offsetParent;
			}

			return curtop;
		}

		function ensureVisible(el) {
			// eslint-disable-line no-shadow
			var posTop = findPosY(el),
			    posBottom = posTop + el.offsetHeight,
			    winTop = window.scrollY ? window.scrollY : document.body.scrollTop,
			    winHeight = window.innerHeight ? window.innerHeight : document.body.clientHeight,
			    winBottom = winTop + winHeight;

			if (posTop < winTop) {
				return posTop;
			} else {
				if (posBottom > winBottom) {
					if (el.offsetHeight < winHeight) {
						return posTop - (winHeight - el.offsetHeight) + 20;
					} else {
						return posTop;
					}
				} else {
					return posTop;
				}
			}
		}

		intervalId = window.setInterval(tick, 25);
		/* eslint-enable no-param-reassign */
	}

	/*******************************************************************************************************************
  * User Functions.
  ******************************************************************************************************************/
	/**
 	Returns a random value from its given arguments.
 **/
	function either() /* variadic */{
		if (arguments.length === 0) {
			return;
		}

		return Array.prototype.concat.apply([], arguments).random();
	}

	/**
 	Returns whether a passage with the given title exists within the story
 	history.  If multiple passage titles are given, returns the logical-AND
 	aggregate of the set.
 **/
	function hasVisited() /* variadic */{
		if (arguments.length === 0) {
			throw new Error('hasVisited called with insufficient parameters');
		}
		if (State.isEmpty()) {
			return false;
		}

		var needles = Array.prototype.concat.apply([], arguments),
		    played = State.passages;

		for (var i = 0, iend = needles.length; i < iend; ++i) {
			if (!played.includes(needles[i])) {
				return false;
			}
		}

		return true;
	}

	/**
 	Returns the number of turns that have passed since the last instance of the given passage
 	occurred within the story history or `-1` if it does not exist.  If multiple passages are
 	given, returns the lowest count (which can be `-1`).
 **/
	function lastVisited() /* variadic */{
		if (arguments.length === 0) {
			throw new Error('lastVisited called with insufficient parameters');
		}
		if (State.isEmpty()) {
			return -1;
		}

		var needles = Array.prototype.concat.apply([], arguments),
		    played = State.passages,
		    uBound = played.length - 1;
		var turns = State.turns;

		for (var i = 0, iend = needles.length; i < iend && turns > -1; ++i) {
			var lastIndex = played.lastIndexOf(needles[i]);
			turns = Math.min(turns, lastIndex === -1 ? -1 : uBound - lastIndex);
		}

		return turns;
	}

	/**
 	Returns the title of the current passage.
 **/
	function passage() {
		return State.passage;
	}

	/**
 	Returns the title of a previous passage, either the most recent one whose title does not
 	match that of the active passage or the one at the optional offset, or an empty string,
 	if there is no such passage.
 **/
	function previous() /* legacy: offset */{
		var passages = State.passages;

		/* legacy: behavior with an offset */
		if (arguments.length > 0) {
			var offset = Number(arguments[0]);

			if (isNaN(offset) || !isFinite(offset) || offset < 1) {
				throw new RangeError('previous offset parameter must be a positive integer greater than zero');
			}

			return passages.length > offset ? passages[passages.length - 1 - offset] : '';
		}
		/* /legacy */

		for (var i = passages.length - 2; i >= 0; --i) {
			if (passages[i] !== State.passage) {
				return passages[i];
			}
		}

		return '';
	}

	/**
 	Returns a pseudo-random whole number (integer) within the range of the given bounds.
 **/
	function random() /* variadic(min:inclusive, max:inclusive) */{
		if (arguments.length === 0) {
			throw new Error('random called with insufficient parameters');
		}

		var min = void 0,
		    max = void 0;

		if (arguments.length === 1) {
			min = 0;
			max = arguments[0];
		} else {
			min = arguments[0];
			max = arguments[1];
		}

		if (min > max) {
			var _ref4 = [max, min];
			min = _ref4[0];
			max = _ref4[1];
		}

		return Math.floor(State.random() * (max - min + 1)) + min;
	}

	/**
 	Returns a pseudo-random real number (floating-point) within the range of the given bounds.
 		n.b. Unlike with its sibling function `random()`, the `max` parameter is exclusive, not
 	     inclusive (i.e. the range goes to, but does not include, the given value).
 **/
	function randomFloat() /* variadic(min:inclusive, max:exclusive) */{
		if (arguments.length === 0) {
			throw new Error('randomFloat called with insufficient parameters');
		}

		var min = void 0,
		    max = void 0;

		if (arguments.length === 1) {
			min = 0.0;
			max = arguments[0];
		} else {
			min = arguments[0];
			max = arguments[1];
		}

		if (min > max) {
			var _ref5 = [max, min];
			min = _ref5[0];
			max = _ref5[1];
		}

		return State.random() * (max - min) + min;
	}

	/**
 	Returns a new array consisting of all of the tags of the given passages.
 **/
	function tags() /* variadic */{
		if (arguments.length === 0) {
			return Story.get(State.passage).tags.slice(0);
		}

		var passages = Array.prototype.concat.apply([], arguments);
		var tags = [];

		for (var i = 0, iend = passages.length; i < iend; ++i) {
			tags = tags.concat(Story.get(passages[i]).tags);
		}

		return tags;
	}

	/**
 	Returns the number of milliseconds which have passed since the current passage was rendered.
 **/
	function time() {
		return Engine.lastPlay === null ? 0 : Date.now() - Engine.lastPlay;
	}

	/**
 	Returns the number of passages that the player has visited.
 		n.b. Passages which were visited but have been undone (e.g. via the Backward button or
 	     the `<<back>>` macro) are no longer part of the in-play story history and thus are
 	     not tallied.  Passages which were visited but have expired from the story history,
 	     on the other hand, are tallied.
 **/
	function turns() {
		return State.turns;
	}

	/**
 	Returns a reference to the current $variables store.
 **/
	function variables() {
		return State.variables;
	}

	/**
 	Returns the number of times that the passage with the given title exists within the story
 	history.  If multiple passage titles are given, returns the lowest count.
 **/
	function visited() /* variadic */{
		if (State.isEmpty()) {
			return 0;
		}

		var needles = Array.prototype.concat.apply([], arguments.length === 0 ? [State.passage] : arguments),
		    played = State.passages;
		var count = State.turns;

		for (var i = 0, iend = needles.length; i < iend && count > 0; ++i) {
			count = Math.min(count, played.count(needles[i]));
		}

		return count;
	}

	/**
 	Returns the number of passages within the story history which are tagged with all of the given tags.
 **/
	function visitedTags() /* variadic */{
		if (arguments.length === 0) {
			throw new Error('visitedTags called with insufficient parameters');
		}
		if (State.isEmpty()) {
			return 0;
		}

		var needles = Array.prototype.concat.apply([], arguments),
		    nLength = needles.length,
		    played = State.passages,
		    seen = new Map();
		var count = 0;

		for (var i = 0, iend = played.length; i < iend; ++i) {
			var title = played[i];

			if (seen.has(title)) {
				if (seen.get(title)) {
					++count;
				}
			} else {
				var _tags2 = Story.get(title).tags;

				if (_tags2.length > 0) {
					var found = 0;

					for (var j = 0; j < nLength; ++j) {
						if (_tags2.includes(needles[j])) {
							++found;
						}
					}

					if (found === nLength) {
						++count;
						seen.set(title, true);
					} else {
						seen.set(title, false);
					}
				}
			}
		}

		return count;
	}

	/* eslint-enable no-unused-vars */

	/*******************************************************************************************************************
  * Parsing Functions.
  ******************************************************************************************************************/
	/*
 	Returns the given string after converting all TwineScript syntactical sugars to
 	their native JavaScript counterparts.
 */
	var parse = function () {
		var parseMap = Object.freeze({
			/* eslint-disable quote-props */
			// Story $variable sigil-prefix.
			'$': 'State.variables.',
			// Temporary _variable sigil-prefix.
			'_': 'TempVariables.',
			// Assignment operators.
			'to': '=',
			// Equality operators.
			'eq': '==',
			'neq': '!=',
			'is': '===',
			'isnot': '!==',
			// Relational operators.
			'gt': '>',
			'gte': '>=',
			'lt': '<',
			'lte': '<=',
			// Logical operators.
			'and': '&&',
			'or': '||',
			// Unary operators.
			'not': '!',
			'def': '"undefined" !== typeof',
			'ndef': '"undefined" === typeof'
			/* eslint-enable quote-props */
		}),
		    parseRe = new RegExp(['(""|\'\')', // 1=Empty quotes
		'("(?:\\\\.|[^"\\\\])+")', // 2=Double quoted, non-empty
		"('(?:\\\\.|[^'\\\\])+')", // 3=Single quoted, non-empty
		'([=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}]+)', // 4=Operator delimiters
		'([^"\'=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}\\s]+)' // 5=Barewords
		].join('|'), 'g'),
		    varTest = new RegExp('^' + Patterns.variable);

		function parse(rawCodeString) {
			if (parseRe.lastIndex !== 0) {
				throw new RangeError('Scripting.parse last index is non-zero at start');
			}

			var code = rawCodeString,
			    match = void 0;

			while ((match = parseRe.exec(code)) !== null) {
				// no-op: Empty quotes | Double quoted | Single quoted | Operator delimiters

				/*
    	Barewords.
    */
				if (match[5]) {
					var token = match[5];

					/*
     	If the token is simply a dollar-sign or underscore, then it's either
     	just the raw character or, probably, a function alias, so skip it.
     */
					if (token === '$' || token === '_') {
						continue;
					}

					/*
     	If the token is a story $variable or temporary _variable, reset it
     	to just its sigil—for later mapping.
     */
					else if (varTest.test(token)) {
							token = token[0];
						}

						/*
      	If the token is `is`, check to see if it's followed by `not`, if so,
      	convert them into the `isnot` operator.
      		n.b. This is a safety feature, since `$a is not $b` probably sounds
      	     reasonable to most users.
      */
						else if (token === 'is') {
								var start = parseRe.lastIndex,
								    part = code.slice(start);

								if (/^\s+not\b/.test(part)) {
									code = code.splice(start, part.search(/\S/));
									token = 'isnot';
								}
							}

					/*
     	If the finalized token has a mapping, replace it within the code string
     	with its counterpart.
     		n.b. We must use `parseMap.hasOwnProperty(token)` here, rather than simply
     	     using something like `parseMap[token]`, otherwise tokens which match
     	     properties from the prototype chain will cause shenanigans.
     */
					if (parseMap.hasOwnProperty(token)) {
						code = code.splice(match.index, // starting index
						token.length, // replace how many
						parseMap[token] // replacement string
						);
						parseRe.lastIndex += parseMap[token].length - token.length;
					}
				}
			}

			return code;
		}

		return parse;
	}();

	/*******************************************************************************************************************
  * Eval Functions.
  ******************************************************************************************************************/
	/* eslint-disable no-eval, no-extra-parens, no-unused-vars */
	/*
 	Evaluates the given JavaScript code and returns the result, throwing if there were errors.
 */
	function evalJavaScript(code, output) {
		return function (code, output) {
			return eval(code);
		}.call(output ? { output: output } : null, String(code), output);
	}

	/*
 	Evaluates the given TwineScript code and returns the result, throwing if there were errors.
 */
	function evalTwineScript(code, output) {
		return function (code, output) {
			return eval(code);
		}.call(output ? { output: output } : null, parse(String(code)), output);
	}
	/* eslint-enable no-eval, no-extra-parens, no-unused-vars */

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		parse: { value: parse },
		evalJavaScript: { value: evalJavaScript },
		evalTwineScript: { value: evalTwineScript }
	}));
}();

/***********************************************************************************************************************
 *
 * markup/wikifier.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 ***********************************************************************************************************************
 *
 * Portions of this code are based on:
 * ____
 *
 * TiddlyWiki 1.2.39 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)
 *
 * Published under a BSD open source license
 *
 * Copyright (c) Osmosoft Limited 2005
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * Redistributions of source code must retain the above copyright notice, this list
 * of conditions and the following disclaimer.
 *
 * Redistributions in binary form must reproduce the above copyright notice, this
 * list of conditions and the following disclaimer in the documentation and/or
 * other materials provided with the distribution.
 *
 * Neither the name of the Osmosoft Limited nor the names of its contributors may
 * be used to endorse or promote products derived from this software without
 * specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 **********************************************************************************************************************/
/*
	global Config, DebugView, Engine, Macro, MacroContext, Patterns, Scripting, State, Story, TempState, TempVariables,
	       Util, toStringOrDefault, throwError
*/
/* eslint "no-param-reassign": [ 2, { "props" : false } ] */

/*
	TODO: The Wikifier, and associated code, could stand to receive a serious refactoring.
*/
/* eslint-disable max-len */
var Wikifier = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// The Wikifier formatter object cache.
	_formatterCache = void 0;

	/*******************************************************************************************************************
  * Wikifier Class.
  ******************************************************************************************************************/

	var Wikifier = function () {
		function Wikifier(destination, source) {
			_classCallCheck(this, Wikifier);

			Object.defineProperties(this, {
				// General Wikifier properties.
				formatter: {
					value: _formatterCache || Wikifier.compileFormatters()
				},

				source: {
					value: source
				},

				nextMatch: {
					writable: true,
					value: 0
				},

				output: {
					writable: true,
					value: null
				},

				// Formatter-related properties.
				_rawArgs: {
					writable: true,
					value: ''
				},

				_nobr: {
					writable: true,
					value: []
				}
			});

			// No destination specified.  Create a fragment to act as the output buffer.
			if (destination == null) {
				// lazy equality for null
				this.output = document.createDocumentFragment();
			}

			// jQuery-wrapped destination.  Grab the first element.
			else if (destination.jquery) {
					// cannot use `hasOwnProperty()` here as `jquery` is from jQuery's prototype
					this.output = destination[0];
				}

				// Normal destination.
				else {
						this.output = destination;
					}

			// Wikify the source into the output buffer element.
			this.subWikify(this.output);
		}

		_createClass(Wikifier, [{
			key: 'subWikify',
			value: function subWikify(output, terminator, terminatorIgnoreCase) {
				// Cache and temporarily replace the current output buffer.
				var oldOutput = this.output;
				this.output = output;

				var terminatorRegExp = terminator ? new RegExp('(?:' + terminator + ')', terminatorIgnoreCase ? 'gim' : 'gm') : null;
				var terminatorMatch = void 0,
				    formatterMatch = void 0;

				do {
					// Prepare the RegExp match positions.
					this.formatter.formatterRegExp.lastIndex = this.nextMatch;

					if (terminatorRegExp) {
						terminatorRegExp.lastIndex = this.nextMatch;
					}

					// Get the first matches.
					formatterMatch = this.formatter.formatterRegExp.exec(this.source);
					terminatorMatch = terminatorRegExp ? terminatorRegExp.exec(this.source) : null;

					// Check for a terminator & formatter match.
					if (terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
						// Output any text before the match.
						if (terminatorMatch.index > this.nextMatch) {
							this.outputText(this.output, this.nextMatch, terminatorMatch.index);
						}

						// Set the match parameters.
						this.matchStart = terminatorMatch.index;
						this.matchLength = terminatorMatch[0].length;
						this.matchText = terminatorMatch[0];
						this.nextMatch = terminatorRegExp.lastIndex;

						// Restore the output buffer and exit.
						this.output = oldOutput;
						return;
					} else if (formatterMatch) {
						// Output any text before the match.
						if (formatterMatch.index > this.nextMatch) {
							this.outputText(this.output, this.nextMatch, formatterMatch.index);
						}

						// Set the match parameters.
						this.matchStart = formatterMatch.index;
						this.matchLength = formatterMatch[0].length;
						this.matchText = formatterMatch[0];
						this.nextMatch = this.formatter.formatterRegExp.lastIndex;

						// Figure out which formatter matched.
						var matchingFormatter = void 0;

						for (var i = 1, iend = formatterMatch.length; i < iend; ++i) {
							if (formatterMatch[i]) {
								matchingFormatter = i - 1;
								break; // stop once we've found the matching formatter
							}
						}

						// Call the formatter.
						this.formatter.formatters[matchingFormatter].handler(this);

						if (TempState.break != null) {
							// lazy equality for null
							break;
						}
					}
				} while (terminatorMatch || formatterMatch);

				// Output any text after the last match.
				if (TempState.break == null) {
					// lazy equality for null
					if (this.nextMatch < this.source.length) {
						this.outputText(this.output, this.nextMatch, this.source.length);
						this.nextMatch = this.source.length;
					}
				}

				// In case of <<break>>/<<continue>>, remove the last <br>.
				else if (this.output.lastChild && this.output.lastChild.nodeType === Node.ELEMENT_NODE && this.output.lastChild.nodeName.toUpperCase() === 'BR') {
						jQuery(this.output.lastChild).remove();
					}

				// Restore the output buffer.
				this.output = oldOutput;
			}
		}, {
			key: 'outputText',
			value: function outputText(destination, startPos, endPos) {
				jQuery(destination).append(document.createTextNode(this.source.substring(startPos, endPos)));
			}

			/*
   	Meant to be called by macros, this returns the raw, unprocessed text given to the
   	currently executing macro.
   */

		}, {
			key: 'rawArgs',
			value: function rawArgs() {
				return this._rawArgs;
			}

			/*
   	Meant to be called by macros, this returns the text given to the currently executing
   	macro after doing TwineScript-to-JavaScript transformations.
   */

		}, {
			key: 'fullArgs',
			value: function fullArgs() {
				return Scripting.parse(this.rawArgs());
			}

			/*
   	Returns a compiled Wikifier formatter object.
   */

		}], [{
			key: 'compileFormatters',
			value: function compileFormatters() {
				if (DEBUG) {
					console.log('[Wikifier.compileFormatters]');
				}

				var formatters = Wikifier.formatters;
				_formatterCache = {
					formatters: formatters,
					formatterRegExp: new RegExp(formatters.map(function (formatter) {
						return '(' + formatter.match + ')';
					}).join('|'), 'gm')
				};
				return _formatterCache;
			}

			/*
   	Returns the value of the given story/temporary variable.
   */

		}, {
			key: 'getValue',
			value: function getValue(storyVar) {
				var varData = Wikifier.parseStoryVariable(storyVar);
				var retVal = void 0;

				if (varData !== null) {
					retVal = varData.store;

					var pNames = varData.names;

					for (var i = 0, iend = pNames.length; i < iend; ++i) {
						if (typeof retVal[pNames[i]] !== 'undefined') {
							retVal = retVal[pNames[i]];
						} else {
							retVal = undefined;
							break;
						}
					}
				}

				return retVal;
			}

			/*
   	Sets the value of the given story/temporary variable.
   */

		}, {
			key: 'setValue',
			value: function setValue(storyVar, newValue) {
				var varData = Wikifier.parseStoryVariable(storyVar);

				if (varData !== null) {
					var pNames = varData.names,
					    varName = pNames.pop();
					var baseObj = varData.store;

					for (var i = 0, iend = pNames.length; i < iend; ++i) {
						if (typeof baseObj[pNames[i]] !== 'undefined') {
							baseObj = baseObj[pNames[i]];
						} else {
							baseObj = undefined;
							break;
						}
					}

					if (baseObj !== undefined) {
						baseObj[varName] = newValue;
						return true;
					}
				}

				return false;
			}

			/*
   	Returns the property name chain of the given story/temporary variable, which may be
   	of arbitrary complexity.
   */

		}, {
			key: 'parseStoryVariable',
			value: function parseStoryVariable(varText) {
				var retVal = {
					store: varText[0] === '$' ? State.variables : TempVariables,
					names: []
				};
				var text = varText,
				    match = void 0;

				while ((match = Wikifier._parseVarRegExp.exec(text)) !== null) {
					// Remove full match from text.
					text = text.slice(match[0].length);

					// Base variable.
					if (match[1]) {
						retVal.names.push(match[1]);
					}

					// Dot property.
					else if (match[2]) {
							retVal.names.push(match[2]);
						}

						// Square-bracketed property (double quoted).
						else if (match[3]) {
								retVal.names.push(match[3]);
							}

							// Square-bracketed property (single quoted).
							else if (match[4]) {
									retVal.names.push(match[4]);
								}

								// Square-bracketed property (embedded variable).
								else if (match[5]) {
										retVal.names.push(Wikifier.getValue(match[5]));
									}

									// Square-bracketed property (numeric index).
									else if (match[6]) {
											retVal.names.push(Number(match[6]));
										}
				}

				return text === '' ? retVal : null;
			}

			/*
   	Returns the output generated by wikifying the given text, throwing if there were errors.
   */

		}, {
			key: 'wikifyEval',
			value: function wikifyEval(text) {
				var output = document.createDocumentFragment();

				new Wikifier(output, text);

				var errors = output.querySelector('.error');

				if (errors !== null) {
					throw new Error(errors.textContent.replace(/^(?:(?:Uncaught\s+)?Error:\s+)+/, ''));
				}

				return output;
			}

			/*
   	Create and return an internal link.
   */

		}, {
			key: 'createInternalLink',
			value: function createInternalLink(destination, passage, text, callback) {
				var $link = jQuery(document.createElement('a'));

				if (passage != null) {
					// lazy equality for null
					$link.attr('data-passage', passage);

					if (Story.has(passage)) {
						$link.addClass('link-internal');

						if (Config.addVisitedLinkClass && State.hasPlayed(passage)) {
							$link.addClass('link-visited');
						}
					} else {
						$link.addClass('link-broken');
					}

					$link.ariaClick({ one: true }, function () {
						if (typeof callback === 'function') {
							callback();
						}

						Engine.play(passage);
					});
				}

				if (text) {
					$link.append(document.createTextNode(text));
				}

				if (destination) {
					$link.appendTo(destination);
				}

				// For legacy-compatibility we must return the DOM node.
				return $link[0];
			}

			/*
   	Create and return an external link.
   */

		}, {
			key: 'createExternalLink',
			value: function createExternalLink(destination, url, text) {
				var $link = jQuery(document.createElement('a')).attr('target', '_blank').addClass('link-external').text(text).appendTo(destination);

				if (url != null) {
					// lazy equality for null
					$link.attr({
						href: url,
						tabindex: 0 // for accessiblity
					});
				}

				// For legacy-compatibility we must return the DOM node.
				return $link[0];
			}

			/*
   	Returns whether the given link source is external (probably).
   */

		}, {
			key: 'isExternalLink',
			value: function isExternalLink(link) {
				if (Story.has(link)) {
					return false;
				}

				var urlRegExp = new RegExp('^' + Patterns.url, 'gim');
				return urlRegExp.test(link) || /[\.\/\\#]/.test(link);
			}
		}]);

		return Wikifier;
	}();

	/*******************************************************************************************************************
  * Additional Static Properties.
  ******************************************************************************************************************/


	Object.defineProperties(Wikifier, {
		_parseVarRegExp: {
			value: new RegExp(['^(?:', Patterns.variableSigil, '(', Patterns.identifier, ')|\\.(', Patterns.identifier, ')|\\[(?:(?:"((?:\\\\.|[^"\\\\])+)")|(?:\'((?:\\\\.|[^\'\\\\])+)\')|(', Patterns.variableSigil, Patterns.identifierFirstChar, '.*)|(\\d+))\\])'].join(''))
		},
		helpers: { value: {} },

		/*
  	Legacy Aliases.
  */
		parse: { value: Scripting.parse },
		evalExpression: { value: Scripting.evalTwineScript }, // See: `markup/scripting.js`.
		evalStatements: { value: Scripting.evalTwineScript }, // See: `markup/scripting.js`.
		textPrimitives: { value: Patterns } // See: `markup/patterns.js`.
	});

	/*******************************************************************************************************************
  * Helper Static Methods.
  ******************************************************************************************************************/
	Object.defineProperties(Wikifier.helpers, {
		/*
  charFormat : {
  	value(w) {
  		w.subWikify(
  			jQuery(document.createElement(this.element)).appendTo(w.output).get(0),
  			this.terminator
  		);
  	}
  },
  */

		_inlineCssLookahead: {
			value: new RegExp(Patterns.inlineCss, 'gm')
		},
		inlineCss: {
			value: function value(w) {
				var css = { classes: [], id: '', styles: {} },
				    lookahead = this._inlineCssLookahead;
				var matched = void 0;

				do {
					lookahead.lastIndex = w.nextMatch;

					var match = lookahead.exec(w.source);

					matched = match && match.index === w.nextMatch;

					if (matched) {
						if (match[1]) {
							css.styles[Util.fromCssProperty(match[1])] = match[2].trim();
						} else if (match[3]) {
							css.styles[Util.fromCssProperty(match[3])] = match[4].trim();
						} else if (match[5]) {
							css.classes = css.classes.concat(match[5].slice(1).split(/\./));
						} else if (match[6]) {
							css.id = match[6].slice(1).split(/#/).pop();
						}

						w.nextMatch = lookahead.lastIndex;
					}
				} while (matched);

				return css;
			}
		},

		evalText: {
			value: function value(text) {
				var result = void 0;

				try {
					result = Scripting.evalTwineScript(text);

					if (result == null || typeof result === 'function') {
						// use lazy equality for null
						result = text;
					} else {
						result = String(result);

						if (/\[(?:object(?:\s+[^\]]+)?|native\s+code)\]/.test(result)) {
							result = text;
						}
					}
				} catch (e) {
					result = text;
				}

				return result;
			}
		},

		evalPassageId: {
			value: function value(passage) {
				if (passage == null || Story.has(passage)) {
					// lazy equality for null; `0` is a valid name, so we cannot simply evaluate `passage`
					return passage;
				}

				return Wikifier.helpers.evalText(passage);
			}
		},

		parseSquareBracketedMarkup: {
			/* eslint-disable no-use-before-define, no-labels */

			value: function value(w) {
				function next() {
					if (pos >= w.source.length) {
						return EOF;
					}

					return w.source[pos++];
				}

				function peek() {
					if (pos >= w.source.length) {
						return EOF;
					}

					return w.source[pos];
				}

				function peekAhead(count) {
					if (count < 1 || pos + count >= w.source.length) {
						return EOF;
					}

					return w.source[pos + count];
				}

				function error() /* variadic: fmt [, … ] */{
					return {
						error: String.format.apply(null, arguments),
						pos: pos
					};
				}

				function ignore() {
					start = pos;
				}

				function emit(type) {
					var text = w.source.slice(start, pos).trim();

					if (text === '') {
						throw new Error('malformed wiki ' + (isLink ? 'link' : 'image') + ', empty ' + type + ' component');
					}

					if (type === 'link' && text[0] === '~') {
						item.forceInternal = true;
						item.link = text.slice(1);
					} else {
						item[type] = text;
					}

					start = pos;
				}

				function slurpQuote(endQuote) {
					++pos;
					loop: for (;;) {
						switch (peek()) {
							case '\\':
								{
									++pos;
									var _c = peek();

									if (_c !== EOF && _c !== '\n') {
										break;
									}
								}
							/* falls through */

							case EOF:
							case '\n':
								return EOF;

							case endQuote:
								break loop;
						}

						++pos;
					}

					return pos;
				}

				var EOF = -1; // end of file (string, really)
				var item = {},
				    // scanned item object
				start = w.matchStart,
				    // start position of a component
				pos = start + 1,
				    // current position in w.source
				depth = void 0,
				    // current square bracket nesting depth
				cid = void 0,
				    // current component ID
				isLink = void 0,
				    // markup is a link, else image
				c = void 0;

				// [[text|~link][setter]]
				// [<>img[title|source][~link][setter]]

				// Scan left delimiter.
				c = peek();

				if (c === '[') {
					// Link.
					isLink = item.isLink = true;
				} else {
					// Image.
					isLink = false;

					switch (c) {
						case '<':
							item.align = 'left';
							++pos;
							break;

						case '>':
							item.align = 'right';
							++pos;
							break;
					}

					if (!/^[Ii][Mm][Gg]$/.test(w.source.slice(pos, pos + 3))) {
						return error('malformed square-bracketed wiki markup');
					}

					pos += 3;
					item.isImage = true;
				}

				// Scan for sections.
				if (next() !== '[') {
					return error('malformed wiki {0}', isLink ? 'link' : 'image');
				}

				depth = 1;
				cid = 0; // 0=title, 1=link(link)|source(image), 2=setter(link)|link(image), 3=setter(image)
				ignore();

				try {
					loop: for (;;) {
						switch (c = peek()) {// eslint-disable-line no-extra-parens
							case EOF:
							case '\n':
								return error('unterminated wiki {0}', isLink ? 'link' : 'image');

							case '"':
								/*
        	This is not entirely reliable within the non-setter component sections (i.e. the
        	sections which allow raw strings), since it's possible, however unlikely, for a raw
        	string to contain unpaired double quotes.  The likelihood is low enough, however,
        	that I'm deeming the risk acceptable, for now at least.
        */
								if (slurpQuote(c) === EOF) {
									return error('unterminated double quoted string in wiki {0}', isLink ? 'link' : 'image');
								}
								break;

							case "'":
								/*
        	Disallow the use of single quotes as delimiters for quoted strings within all but
        	the setter component section, since it's entirely possible for raw strings to contain
        	unpaired single quotes.
        */
								if (cid === 4 || cid === 3 && isLink) {
									if (slurpQuote(c) === EOF) {
										return error('unterminated single quoted string in wiki {0}', isLink ? 'link' : 'image');
									}
								}
								break;

							case '|':
								// core section pipe ('|') separator
								if (cid === 0) {
									emit(isLink ? 'text' : 'title');
									++start;
									cid = 1;
								}
								break;

							case '-':
								// possible core section right arrow ('->') separator (Twine 2 extension)
								if (cid === 0 && peekAhead(1) === '>') {
									emit(isLink ? 'text' : 'title');
									++pos;
									start += 2;
									cid = 1;
								}
								break;

							case '<':
								// possible core section left arrow ('<-') separator (Twine 2 extension)
								if (cid === 0 && peekAhead(1) === '-') {
									emit(isLink ? 'link' : 'source');
									++pos;
									start += 2;
									cid = 2;
								}
								break;

							case '[':
								if (cid === -1) {
									return error("unexpected left square bracket '['");
								}

								++depth;

								if (depth === 1) {
									ignore();
									++start;
								}
								break;

							case ']':
								--depth;

								if (depth === 0) {
									switch (cid) {
										case 0: // core section (nothing emitted yet)
										case 1:
											// core section (already emitted link-text|image-title)
											emit(isLink ? 'link' : 'source');
											cid = 3;
											break;

										case 2:
											// core section (already emitted link-link|image-source)
											emit(isLink ? 'text' : 'title');
											cid = 3;
											break;

										case 3:
											// link-setter|image-link section
											if (isLink) {
												emit('setter');
												cid = -1;
											} else {
												emit('link');
												cid = 4;
											}
											break;

										case 4:
											// image-setter section
											emit('setter');
											cid = -1;
											break;
									}

									++pos;

									if (peek() === ']') {
										++pos;
										break loop;
									}

									--pos;
								}
								break;
						}

						++pos;
					}
				} catch (e) {
					return error(e.message);
				}

				item.pos = pos;

				return item;
			}
			/* eslint-enable no-use-before-define, no-labels */

		}
	});

	/*******************************************************************************************************************
  * Formatters.
  ******************************************************************************************************************/
	Object.defineProperty(Wikifier, 'formatters', {
		value: [{
			name: 'macro',
			match: '<<',
			lookahead: /<<(\/?[A-Za-z][^>\s]*|[=-])(?:\s*)((?:(?:\"(?:\\.|[^\"\\])*\")|(?:\'(?:\\.|[^\'\\])*\')|(?:\[(?:[<>]?[Ii][Mm][Gg])?\[[^\r\n]*?\]\]+)|[^>]|(?:>(?!>)))*)>>/gm,
			argsPattern: ['(``)', // 1=Empty backticks
			'`((?:\\\\.|[^`\\\\])+)`', // 2=Backticked, non-empty
			'(""|\'\')', // 3=Empty quotes
			'("(?:\\\\.|[^"\\\\])+")', // 4=Double quoted, non-empty
			"('(?:\\\\.|[^'\\\\])+')", // 5=Single quoted, non-empty
			'(\\[(?:[<>]?[Ii][Mm][Gg])?\\[[^\\r\\n]*?\\]\\]+)', // 6=Double square-bracketed
			'([^`"\'\\s]+)', // 7=Barewords
			'(`|"|\')' // 8=Unterminated backticks and quotes
			].join('|'),
			working: { source: '', name: '', arguments: '', index: 0 }, // the working parse object
			context: null, // last execution context object (top-level macros, hierarchically, have a null context)

			handler: function handler(w) {
				var matchStart = this.lookahead.lastIndex = w.matchStart;

				if (this.parseTag(w)) {
					/*
     	If `parseBody()` is called below, it will modify the current working
     	values, so we must cache them now.
     */
					var nextMatch = w.nextMatch,
					    source = this.working.source,
					    name = this.working.name,
					    rawArgs = this.working.arguments;
					var macro = void 0;

					try {
						macro = Macro.get(name);

						if (macro) {
							var payload = null;

							if (macro.hasOwnProperty('tags')) {
								payload = this.parseBody(w, macro);

								if (!payload) {
									w.nextMatch = nextMatch; // we must reset `w.nextMatch` here, as `parseBody()` modifies it
									return throwError(w.output, 'cannot find a closing tag for macro <<' + name + '>>', w.source.slice(matchStart, w.nextMatch) + '…');
								}
							}

							if (typeof macro.handler === 'function') {
								var args = !payload ? this.createArgs(rawArgs, macro.hasOwnProperty('skipArgs') && !!macro.skipArgs || macro.hasOwnProperty('skipArg0') && !!macro.skipArg0) : payload[0].args;

								/*
        	New-style macros.
        */
								if (macro.hasOwnProperty('_MACRO_API')) {
									/*
         	Add the macro's execution context to the context chain.
         */
									this.context = new MacroContext({
										parent: this.context,
										macro: macro,
										name: name,
										args: args,
										payload: payload,
										parser: w,
										source: source
									});

									/*
         	Call the handler.
         		n.b. There's no catch clause here because this try/finally exists simply
         	     to ensure that the execution context is properly restored in the event
         	     that an uncaught exception is thrown during the handler call.
         */
									try {
										macro.handler.call(this.context);
									} finally {
										this.context = this.context.parent;
									}
								}

								/*
        	Old-style macros.
        */
								else {
										var prevRawArgs = w._rawArgs;
										w._rawArgs = rawArgs; // cache the raw arguments for use by `Wikifier.rawArgs()` & `Wikifier.fullArgs()`
										macro.handler(w.output, name, args, w, payload);
										w._rawArgs = prevRawArgs;
									}
							} else {
								return throwError(w.output, 'macro <<' + name + '>> handler function ' + ('' + (macro.hasOwnProperty('handler') ? 'is not a function' : 'does not exist')), w.source.slice(matchStart, w.nextMatch));
							}
						} else if (Macro.tags.has(name)) {
							var tags = Macro.tags.get(name);
							return throwError(w.output, 'child tag <<' + name + '>> was found outside of a call to its parent macro' + ((tags.length === 1 ? '' : 's') + ' <<' + tags.join('>>, <<') + '>>'), w.source.slice(matchStart, w.nextMatch));
						} else {
							return throwError(w.output, 'macro <<' + name + '>> does not exist', w.source.slice(matchStart, w.nextMatch));
						}
					} catch (e) {
						return throwError(w.output, 'cannot execute ' + (macro && macro.isWidget ? 'widget' : 'macro') + ' <<' + name + '>>: ' + e.message, w.source.slice(matchStart, w.nextMatch));
					} finally {
						this.working.source = '';
						this.working.name = '';
						this.working.arguments = '';
						this.working.index = 0;
					}
				} else {
					w.outputText(w.output, w.matchStart, w.nextMatch);
				}
			},
			parseTag: function parseTag(w) {
				var match = this.lookahead.exec(w.source);

				if (match && match.index === w.matchStart && match[1]) {
					w.nextMatch = this.lookahead.lastIndex;

					this.working.source = w.source.slice(match.index, this.lookahead.lastIndex);
					this.working.name = match[1];
					this.working.arguments = match[2];
					this.working.index = match.index;

					return true;
				}

				return false;
			},
			parseBody: function parseBody(w, macro) {
				var openTag = this.working.name,
				    closeTag = '/' + openTag,
				    closeAlt = 'end' + openTag,
				    bodyTags = Array.isArray(macro.tags) ? macro.tags : false,
				    payload = [],
				    skipArgs = macro.hasOwnProperty('skipArgs') && macro.skipArgs,
				    skipArg0 = macro.hasOwnProperty('skipArg0') && macro.skipArg0;
				var end = -1,
				    opened = 1,
				    curSource = this.working.source,
				    curTag = this.working.name,
				    curArgument = this.working.arguments,
				    contentStart = w.nextMatch;

				while ((w.matchStart = w.source.indexOf(this.match, w.nextMatch)) !== -1) {
					if (!this.parseTag(w)) {
						this.lookahead.lastIndex = w.nextMatch = w.matchStart + this.match.length;
						continue;
					}

					var tagSource = this.working.source,
					    tagName = this.working.name,
					    tagArgs = this.working.arguments,
					    tagBegin = this.working.index,
					    tagEnd = w.nextMatch;

					switch (tagName) {
						case openTag:
							++opened;
							break;

						case closeAlt:
						case closeTag:
							--opened;
							break;

						default:
							if (opened === 1 && bodyTags) {
								for (var i = 0, iend = bodyTags.length; i < iend; ++i) {
									if (tagName === bodyTags[i]) {
										payload.push({
											source: curSource,
											name: curTag,
											arguments: curArgument,
											args: this.createArgs(curArgument, skipArgs || payload.length === 0 && skipArg0),
											contents: w.source.slice(contentStart, tagBegin)
										});
										curSource = tagSource;
										curTag = tagName;
										curArgument = tagArgs;
										contentStart = tagEnd;
									}
								}
							}
							break;
					}

					if (opened === 0) {
						payload.push({
							source: curSource,
							name: curTag,
							arguments: curArgument,
							args: this.createArgs(curArgument, skipArgs || payload.length === 0 && skipArg0),
							contents: w.source.slice(contentStart, tagBegin)
						});
						end = tagEnd;
						break;
					}
				}

				if (end !== -1) {
					w.nextMatch = end;
					return payload;
				}

				return null;
			},
			createArgs: function createArgs(rawArgsString, skipArgs) {
				var args = skipArgs ? [] : this.parseArgs(rawArgsString);

				// Extend the args array with the raw and full argument strings.
				Object.defineProperties(args, {
					raw: {
						value: rawArgsString
					},
					full: {
						value: Scripting.parse(rawArgsString)
					}
				});

				return args;
			},
			parseArgs: function parseArgs(rawArgsString) {
				/*
    	`this.argsPattern` capture groups:
    		1=Empty backticks
    		2=Backticked, non-empty
    		3=Empty quotes
    		4=Double quoted, non-empty
    		5=Single quoted, non-empty
    		6=Double square-bracketed
    		7=Barewords
    		8=Unterminated backticks and quotes
    */
				var argsRe = new RegExp(this.argsPattern, 'gm'),
				    args = [],
				    varTest = new RegExp('^' + Patterns.variable);
				var match = void 0;

				while ((match = argsRe.exec(rawArgsString)) !== null) {
					var arg = void 0;

					// Empty backticks.
					if (match[1]) {
						arg = undefined;
					}

					// Backticked, non-empty.
					else if (match[2]) {
							arg = match[2]; // the pattern excludes the backticks, so this is just the expression

							// Evaluate the expression.
							try {
								arg = Scripting.evalTwineScript(arg);
							} catch (e) {
								throw new Error('unable to parse macro argument "' + arg + '": ' + e.message);
							}
						}

						// Empty quotes.
						else if (match[3]) {
								arg = '';
							}

							// Double quoted, non-empty.
							else if (match[4]) {
									arg = match[4];

									// Evaluate the string to handle escaped characters.
									try {
										arg = Scripting.evalJavaScript(arg);
									} catch (e) {
										throw new Error('unable to parse macro argument \'' + arg + '\': ' + e.message);
									}
								}

								// Single quoted, non-empty.
								else if (match[5]) {
										arg = match[5];

										// Evaluate the string to handle escaped characters.
										try {
											arg = Scripting.evalJavaScript(arg);
										} catch (e) {
											throw new Error('unable to parse macro argument "' + arg + '": ' + e.message);
										}
									}

									// Double square-bracketed.
									else if (match[6]) {
											arg = match[6];

											var markup = Wikifier.helpers.parseSquareBracketedMarkup({
												source: arg,
												matchStart: 0
											});

											if (markup.hasOwnProperty('error')) {
												throw new Error('unable to parse macro argument "' + arg + '": ' + markup.error);
											}

											if (markup.pos < arg.length) {
												throw new Error('unable to parse macro argument "' + arg + '": unexpected character(s)' + (' "' + arg.slice(markup.pos) + '" (pos: ' + markup.pos + ')'));
											}

											// Convert to a link or image object.
											if (markup.isLink) {
												// .isLink, [.text], [.forceInternal], .link, [.setter]
												arg = { isLink: true };
												arg.count = markup.hasOwnProperty('text') ? 2 : 1;
												arg.link = Wikifier.helpers.evalPassageId(markup.link);
												arg.text = markup.hasOwnProperty('text') ? Wikifier.helpers.evalText(markup.text) : arg.link;
												arg.external = !markup.forceInternal && Wikifier.isExternalLink(arg.link);
												arg.setFn = markup.hasOwnProperty('setter') ? function (ex) {
													return function () {
														return Scripting.evalJavaScript(ex);
													};
												}(Scripting.parse(markup.setter)) : null;
											} else if (markup.isImage) {
												// .isImage, [.align], [.title], .source, [.forceInternal], [.link], [.setter]
												arg = function (source) {
													var imgObj = {
														source: source,
														isImage: true
													};

													// Check for Twine 1.4 Base64 image passage transclusion.
													if (source.slice(0, 5) !== 'data:' && Story.has(source)) {
														var passage = Story.get(source);

														if (passage.tags.includes('Twine.image')) {
															imgObj.source = passage.text;
															imgObj.passage = passage.title;
														}
													}

													return imgObj;
												}(markup.source);

												if (markup.hasOwnProperty('align')) {
													arg.align = markup.align;
												}

												if (markup.hasOwnProperty('title')) {
													arg.title = Wikifier.helpers.evalText(markup.title);
												}

												if (markup.hasOwnProperty('link')) {
													arg.link = Wikifier.helpers.evalPassageId(markup.link);
													arg.external = !markup.forceInternal && Wikifier.isExternalLink(arg.link);
												}

												arg.setFn = markup.hasOwnProperty('setter') ? function (ex) {
													return function () {
														return Scripting.evalJavaScript(ex);
													};
												}(Scripting.parse(markup.setter)) : null;
											}
										}

										// Barewords.
										else if (match[7]) {
												arg = match[7];

												// variable, so substitute its value.
												if (varTest.test(arg)) {
													arg = Wikifier.getValue(arg);
												}

												// Settings or setup object, so try to evaluate it.
												else if (/^(?:settings|setup)[\.\[]/.test(arg)) {
														try {
															arg = Scripting.evalTwineScript(arg);
														} catch (e) {
															throw new Error('unable to parse macro argument "' + arg + '": ' + e.message);
														}
													}

													// // Object or Array literal, so try to evaluate it.
													// //
													// // n.b. Authors really shouldn't be passing object/array literals as arguments.  If they
													// //      want to pass a complex type, then store it in a variable and pass that instead.
													// else if (/^(?:\{.*\}|\[.*\])$/.test(arg)) {
													// 	try {
													// 		// The parens are to protect object literals from being confused with blocks.
													// 		arg = Scripting.evalTwineScript(`(${arg})`);
													// 	}
													// 	catch (e) {
													// 		throw new Error(`unable to parse macro argument "${arg}": ${e.message}`);
													// 	}
													// }

													// Null literal, so convert it into null.
													else if (arg === 'null') {
															arg = null;
														}

														// Undefined literal, so convert it into undefined.
														else if (arg === 'undefined') {
																arg = undefined;
															}

															// Boolean true literal, so convert it into boolean true.
															else if (arg === 'true') {
																	arg = true;
																}

																// Boolean false literal, so convert it into boolean false.
																else if (arg === 'false') {
																		arg = false;
																	}

																	// Numeric literal, so convert it into a number.
																	else if (!isNaN(parseFloat(arg)) && isFinite(arg)) {
																			arg = Number(arg);
																		}
											}

											// Unterminated backticks and quotes.
											else if (match[8]) {
													var what = void 0;

													switch (match[8]) {
														case '`':
															what = 'backtick expression';
															break;

														case '"':
															what = 'double quoted string';
															break;

														case "'":
															what = 'single quoted string';
															break;
													}

													throw new Error('unterminated ' + what + ' in macro argument string');
												}

					args.push(arg);
				}

				return args;
			}
		}, {
			name: 'prettyLink',
			match: '\\[\\[[^[]',

			handler: function handler(w) {
				var markup = Wikifier.helpers.parseSquareBracketedMarkup(w);

				if (markup.hasOwnProperty('error')) {
					w.outputText(w.output, w.matchStart, w.nextMatch);
					return;
				}

				w.nextMatch = markup.pos;

				// text=(text), forceInternal=(~), link=link, setter=(setter)
				var link = Wikifier.helpers.evalPassageId(markup.link),
				    text = markup.hasOwnProperty('text') ? Wikifier.helpers.evalText(markup.text) : link,
				    setFn = markup.hasOwnProperty('setter') ? function (ex) {
					return function () {
						return Scripting.evalJavaScript(ex);
					};
				}(Scripting.parse(markup.setter)) : null;

				// Debug view setup.
				var output = (Config.debug ? new DebugView(w.output, 'wiki-link', '[[link]]', w.source.slice(w.matchStart, w.nextMatch)) : w).output;

				if (markup.forceInternal || !Wikifier.isExternalLink(link)) {
					Wikifier.createInternalLink(output, link, text, setFn);
				} else {
					Wikifier.createExternalLink(output, link, text);
				}
			}
		}, {
			name: 'urlLink',
			match: Patterns.url,

			handler: function handler(w) {
				w.outputText(Wikifier.createExternalLink(w.output, w.matchText), w.matchStart, w.nextMatch);
			}
		}, {
			name: 'image',
			match: '\\[[<>]?[Ii][Mm][Gg]\\[',

			handler: function handler(w) {
				var markup = Wikifier.helpers.parseSquareBracketedMarkup(w);

				if (markup.hasOwnProperty('error')) {
					w.outputText(w.output, w.matchStart, w.nextMatch);
					return;
				}

				w.nextMatch = markup.pos;

				// Debug view setup.
				var debugView = void 0;

				if (Config.debug) {
					debugView = new DebugView(w.output, 'wiki-image', markup.hasOwnProperty('link') ? '[img[][link]]' : '[img[]]', w.source.slice(w.matchStart, w.nextMatch));
					debugView.modes({ block: true });
				}

				// align=(left|right), title=(title), source=source, forceInternal=(~), link=(link), setter=(setter)
				var setFn = markup.hasOwnProperty('setter') ? function (ex) {
					return function () {
						return Scripting.evalJavaScript(ex);
					};
				}(Scripting.parse(markup.setter)) : null;
				var el = (Config.debug ? debugView : w).output,
				    source = void 0;

				if (markup.hasOwnProperty('link')) {
					var link = Wikifier.helpers.evalPassageId(markup.link);

					if (markup.forceInternal || !Wikifier.isExternalLink(link)) {
						el = Wikifier.createInternalLink(el, link, null, setFn);
					} else {
						el = Wikifier.createExternalLink(el, link);
					}

					el.classList.add('link-image');
				}

				el = jQuery(document.createElement('img')).appendTo(el).get(0);
				source = Wikifier.helpers.evalPassageId(markup.source);

				// Check for image passage transclusion.
				if (source.slice(0, 5) !== 'data:' && Story.has(source)) {
					var passage = Story.get(source);

					if (passage.tags.includes('Twine.image')) {
						el.setAttribute('data-passage', passage.title);
						source = passage.text;
					}
				}

				el.src = source;

				if (markup.hasOwnProperty('title')) {
					el.title = Wikifier.helpers.evalText(markup.title);
				}

				if (markup.hasOwnProperty('align')) {
					el.align = markup.align;
				}
			}
		}, {
			name: 'monospacedByLine',
			match: '^\\{\\{\\{\\n',
			lookahead: /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/gm,

			handler: function handler(w) {
				this.lookahead.lastIndex = w.matchStart;

				var match = this.lookahead.exec(w.source);

				if (match && match.index === w.matchStart) {
					jQuery(document.createElement('pre')).text(match[1]).appendTo(w.output);
					w.nextMatch = this.lookahead.lastIndex;
				}
			}
		}, {
			name: 'formatByChar',
			match: "''|//|__|\\^\\^|~~|==|\\{\\{\\{",

			handler: function handler(w) {
				switch (w.matchText) {
					case "''":
						w.subWikify(jQuery(document.createElement('strong')).appendTo(w.output).get(0), "''");
						break;

					case '//':
						w.subWikify(jQuery(document.createElement('em')).appendTo(w.output).get(0), '//');
						break;

					case '__':
						w.subWikify(jQuery(document.createElement('u')).appendTo(w.output).get(0), '__');
						break;

					case '^^':
						w.subWikify(jQuery(document.createElement('sup')).appendTo(w.output).get(0), '\\^\\^');
						break;

					case '~~':
						w.subWikify(jQuery(document.createElement('sub')).appendTo(w.output).get(0), '~~');
						break;

					case '==':
						w.subWikify(jQuery(document.createElement('s')).appendTo(w.output).get(0), '==');
						break;

					case '{{{':
						{
							var lookahead = /\{\{\{((?:.|\n)*?)\}\}\}/gm;

							lookahead.lastIndex = w.matchStart;

							var match = lookahead.exec(w.source);

							if (match && match.index === w.matchStart) {
								jQuery(document.createElement('code')).text(match[1]).appendTo(w.output);
								w.nextMatch = lookahead.lastIndex;
							}
						}
						break;
				}
			}
		}, {
			name: 'customStyle',
			match: '@@',
			terminator: '@@',
			blockRegExp: /\s*\n/gm,

			handler: function handler(w) {
				var css = Wikifier.helpers.inlineCss(w);

				this.blockRegExp.lastIndex = w.nextMatch; // must follow the call to `inlineCss()`

				var blockMatch = this.blockRegExp.exec(w.source),
				    blockLevel = blockMatch && blockMatch.index === w.nextMatch,
				    $el = jQuery(document.createElement(blockLevel ? 'div' : 'span')).appendTo(w.output);

				if (css.classes.length === 0 && css.id === '' && Object.keys(css.styles).length === 0) {
					$el.addClass('marked');
				} else {
					css.classes.forEach(function (className) {
						return $el.addClass(className);
					});

					if (css.id !== '') {
						$el.attr('id', css.id);
					}

					$el.css(css.styles);
				}

				if (blockLevel) {
					// Skip the leading and, if it exists, trailing newlines.
					w.nextMatch += blockMatch[0].length;
					w.subWikify($el[0], '\\n?' + this.terminator);
				} else {
					w.subWikify($el[0], this.terminator);
				}
			}
		}, {
			name: 'verbatimText',
			match: '"{3}|<nowiki>',
			lookahead: /(?:\"{3}((?:.|\n)*?)\"{3})|(?:<nowiki>((?:.|\n)*?)<\/nowiki>)/gm,

			handler: function handler(w) {
				this.lookahead.lastIndex = w.matchStart;

				var match = this.lookahead.exec(w.source);

				if (match && match.index === w.matchStart) {
					jQuery(document.createElement('span')).addClass('verbatim').text(match[1] || match[2]).appendTo(w.output);
					w.nextMatch = this.lookahead.lastIndex;
				}
			}
		}, {
			name: 'rule',
			match: '^----+$\\n?|<hr\s*/?>\\n?',

			handler: function handler(w) {
				jQuery(document.createElement('hr')).appendTo(w.output);
			}
		}, {
			name: 'emdash',
			match: '--',

			handler: function handler(w) {
				jQuery(document.createTextNode('—')).appendTo(w.output);
			}
		}, {
			name: 'doubleDollarSign',
			match: '\\${2}',

			handler: function handler(w) {
				jQuery(document.createTextNode('$')).appendTo(w.output);
			}
		}, {
			name: 'nakedVariable',
			match: [Patterns.variable, '(?:(?:\\.', Patterns.identifier, ')|(?:\\[\\d+\\])|(?:\\["(?:\\\\.|[^"\\\\])+"\\])|(?:\\[\'(?:\\\\.|[^\'\\\\])+\'\\])|(?:\\[', Patterns.variable, '\\]))*'].join(''),

			handler: function handler(w) {
				var result = toStringOrDefault(Wikifier.getValue(w.matchText), null);

				if (result === null) {
					jQuery(document.createTextNode(w.matchText)).appendTo(w.output);
				} else {
					new Wikifier((Config.debug ? new DebugView(w.output, 'variable', w.matchText, w.matchText) // Debug view setup.
					: w).output, result);
				}
			}
		}, {
			name: 'heading',
			match: '^!{1,6}',
			terminator: '\\n',

			handler: function handler(w) {
				var isHeading = function (nodes) {
					var hasGCS = typeof window.getComputedStyle === 'function';

					for (var i = nodes.length - 1; i >= 0; --i) {
						var node = nodes[i];

						switch (node.nodeType) {
							case Node.ELEMENT_NODE:
								{
									var tagName = node.nodeName.toUpperCase();

									if (tagName === 'BR') {
										return true;
									}

									var styles = hasGCS ? window.getComputedStyle(node, null) : node.currentStyle;

									if (styles && styles.display) {
										if (styles.display === 'none') {
											continue;
										}

										return styles.display === 'block';
									}

									/*
         	WebKit/Blink-based browsers do not attach any computed style
         	information to elements until they're inserted into the DOM
         	(and probably visible), not even the default browser styles
         	and any user styles.  So, we make an assumption based on the
         	element.
         */
									switch (tagName) {
										case 'ADDRESS':
										case 'ARTICLE':
										case 'ASIDE':
										case 'BLOCKQUOTE':
										case 'CENTER':
										case 'DIV':
										case 'DL':
										case 'FIGURE':
										case 'FOOTER':
										case 'FORM':
										case 'H1':
										case 'H2':
										case 'H3':
										case 'H4':
										case 'H5':
										case 'H6':
										case 'HEADER':
										case 'HR':
										case 'MAIN':
										case 'NAV':
										case 'OL':
										case 'P':
										case 'PRE':
										case 'SECTION':
										case 'TABLE':
										case 'UL':
											return true;
									}
								}

								return false;

							case Node.COMMENT_NODE:
								continue;

							default:
								return false;
						}
					}

					return true;
				}(w.output.childNodes);

				if (isHeading) {
					w.subWikify(jQuery(document.createElement('h' + w.matchLength)).appendTo(w.output).get(0), this.terminator);
				} else {
					jQuery(w.output).append(document.createTextNode(w.matchText));
				}
			}
		}, {
			name: 'table',
			match: '^\\|(?:[^\\n]*)\\|(?:[fhck]?)$',
			lookahead: /^\|([^\n]*)\|([fhck]?)$/gm,
			rowTerminator: '\\|(?:[cfhk]?)$\\n?',
			cellPattern: '(?:\\|([^\\n\\|]*)\\|)|(\\|[cfhk]?$\\n?)',
			cellTerminator: '(?:\\u0020*)\\|',
			rowTypes: { c: 'caption', f: 'tfoot', h: 'thead', '': 'tbody' },

			handler: function handler(w) {
				var table = jQuery(document.createElement('table')).appendTo(w.output).get(0),
				    prevColumns = [];
				var curRowType = null,
				    $rowContainer = null,
				    rowCount = 0,
				    matched = void 0;

				w.nextMatch = w.matchStart;

				do {
					this.lookahead.lastIndex = w.nextMatch;

					var match = this.lookahead.exec(w.source);

					matched = match && match.index === w.nextMatch;

					if (matched) {
						var nextRowType = match[2];

						if (nextRowType === 'k') {
							table.className = match[1];
							w.nextMatch += match[0].length + 1;
						} else {
							if (nextRowType !== curRowType) {
								curRowType = nextRowType;
								$rowContainer = jQuery(document.createElement(this.rowTypes[nextRowType])).appendTo(table);
							}

							if (curRowType === 'c') {
								$rowContainer.css('caption-side', rowCount === 0 ? 'top' : 'bottom');
								w.nextMatch += 1;
								w.subWikify($rowContainer[0], this.rowTerminator);
							} else {
								this.rowHandler(w, jQuery(document.createElement('tr')).appendTo($rowContainer).get(0), prevColumns);
							}

							++rowCount;
						}
					}
				} while (matched);
			},
			rowHandler: function rowHandler(w, rowEl, prevColumns) {
				var _this5 = this;

				var cellRegExp = new RegExp(this.cellPattern, 'gm');
				var col = 0,
				    curColCount = 1,
				    matched = void 0;

				do {
					cellRegExp.lastIndex = w.nextMatch;

					var cellMatch = cellRegExp.exec(w.source);

					matched = cellMatch && cellMatch.index === w.nextMatch;

					if (matched) {
						if (cellMatch[1] === '~') {
							var last = prevColumns[col];

							if (last) {
								++last.rowCount;
								last.$element.attr('rowspan', last.rowCount).css('vertical-align', 'middle');
							}

							w.nextMatch = cellMatch.index + cellMatch[0].length - 1;
						} else if (cellMatch[1] === '>') {
							++curColCount;
							w.nextMatch = cellMatch.index + cellMatch[0].length - 1;
						} else if (cellMatch[2]) {
							w.nextMatch = cellMatch.index + cellMatch[0].length;
							break;
						} else {
							(function () {
								++w.nextMatch;

								var css = Wikifier.helpers.inlineCss(w);
								var spaceLeft = false,
								    spaceRight = false,
								    $cell = void 0;

								while (w.source.substr(w.nextMatch, 1) === ' ') {
									spaceLeft = true;
									++w.nextMatch;
								}

								if (w.source.substr(w.nextMatch, 1) === '!') {
									$cell = jQuery(document.createElement('th')).appendTo(rowEl);
									++w.nextMatch;
								} else {
									$cell = jQuery(document.createElement('td')).appendTo(rowEl);
								}

								prevColumns[col] = {
									rowCount: 1,
									$element: $cell
								};

								if (curColCount > 1) {
									$cell.attr('colspan', curColCount);
									curColCount = 1;
								}

								w.subWikify($cell[0], _this5.cellTerminator);

								if (w.matchText.substr(w.matchText.length - 2, 1) === ' ') {
									spaceRight = true;
								}

								css.classes.forEach(function (className) {
									return $cell.addClass(className);
								});

								if (css.id !== '') {
									$cell.attr('id', css.id);
								}

								if (spaceLeft && spaceRight) {
									css.styles['text-align'] = 'center';
								} else if (spaceLeft) {
									css.styles['text-align'] = 'right';
								} else if (spaceRight) {
									css.styles['text-align'] = 'left';
								}

								$cell.css(css.styles);

								w.nextMatch = w.nextMatch - 1;
							})();
						}

						++col;
					}
				} while (matched);
			}
		}, {
			name: 'list',
			match: '^(?:(?:\\*+)|(?:#+))',
			lookahead: /^(?:(\*+)|(#+))/gm,
			terminator: '\\n',

			handler: function handler(w) {
				w.nextMatch = w.matchStart;

				var destStack = [w.output];
				var curType = null,
				    curLevel = 0,
				    matched = void 0,
				    i = void 0;

				do {
					this.lookahead.lastIndex = w.nextMatch;

					var match = this.lookahead.exec(w.source);

					matched = match && match.index === w.nextMatch;

					if (matched) {
						var newType = match[2] ? 'ol' : 'ul',
						    newLevel = match[0].length;

						w.nextMatch += match[0].length;

						if (newLevel > curLevel) {
							for (i = curLevel; i < newLevel; ++i) {
								destStack.push(jQuery(document.createElement(newType)).appendTo(destStack[destStack.length - 1]).get(0));
							}
						} else if (newLevel < curLevel) {
							for (i = curLevel; i > newLevel; --i) {
								destStack.pop();
							}
						} else if (newLevel === curLevel && newType !== curType) {
							destStack.pop();
							destStack.push(jQuery(document.createElement(newType)).appendTo(destStack[destStack.length - 1]).get(0));
						}

						curLevel = newLevel;
						curType = newType;
						w.subWikify(jQuery(document.createElement('li')).appendTo(destStack[destStack.length - 1]).get(0), this.terminator);
					}
				} while (matched);
			}
		}, {
			name: 'quoteByBlock',
			match: '^<<<\\n',
			terminator: '^<<<\\n',

			handler: function handler(w) {
				w.subWikify(jQuery(document.createElement('blockquote')).appendTo(w.output).get(0), this.terminator);
			}
		}, {
			name: 'quoteByLine',
			match: '^>+',
			lookahead: /^>+/gm,
			terminator: '\\n',
			element: 'blockquote',

			handler: function handler(w) {
				var destStack = [w.output];
				var curLevel = 0,
				    newLevel = w.matchLength,
				    matched = void 0,
				    i = void 0;

				do {
					if (newLevel > curLevel) {
						for (i = curLevel; i < newLevel; ++i) {
							destStack.push(jQuery(document.createElement(this.element)).appendTo(destStack[destStack.length - 1]).get(0));
						}
					} else {
						if (newLevel < curLevel) {
							for (i = curLevel; i > newLevel; --i) {
								destStack.pop();
							}
						}
					}

					curLevel = newLevel;
					w.subWikify(destStack[destStack.length - 1], this.terminator);
					jQuery(document.createElement('br')).appendTo(destStack[destStack.length - 1]);

					this.lookahead.lastIndex = w.nextMatch;

					var match = this.lookahead.exec(w.source);

					matched = match && match.index === w.nextMatch;

					if (matched) {
						newLevel = match[0].length;
						w.nextMatch += match[0].length;
					}
				} while (matched);
			}
		}, {
			name: 'html',
			match: '<[Hh][Tt][Mm][Ll]>',
			lookahead: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/gm,

			handler: function handler(w) {
				this.lookahead.lastIndex = w.matchStart;

				var match = this.lookahead.exec(w.source);

				if (match && match.index === w.matchStart) {
					w.nextMatch = this.lookahead.lastIndex;

					jQuery(document.createDocumentFragment()).append(match[1]).appendTo(w.output);
				}
			}
		}, {
			name: 'commentByBlock',
			match: '(?:/(?:%|\\*))|(?:<!--)',
			lookahead: /(?:\/(%|\*)(?:(?:.|\n)*?)\1\/)|(?:<!--(?:(?:.|\n)*?)-->)/gm,

			handler: function handler(w) {
				this.lookahead.lastIndex = w.matchStart;

				var match = this.lookahead.exec(w.source);

				if (match && match.index === w.matchStart) {
					w.nextMatch = this.lookahead.lastIndex;
				}
			}
		}, {
			name: 'lineContinuation',
			// The end-of-line patter must come first.
			match: '\\\\' + Patterns.space + '*?(?:\\n|$)|(?:^|\\n)' + Patterns.space + '*?\\\\',

			handler: function handler(w) {
				w.nextMatch = w.matchStart + w.matchLength;
			}
		}, {
			name: 'lineBreak',
			match: '\\n|<br\s*/?>',

			handler: function handler(w) {
				if (w._nobr.length === 0 || !w._nobr[0]) {
					jQuery(document.createElement('br')).appendTo(w.output);
				}
			}
		}, {
			name: 'htmlCharacterReference',
			match: '(?:(?:&#?[0-9A-Za-z]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9A-Fa-f]|1D[C-Fc-f][0-9A-Fa-f]|20[D-Fd-f][0-9A-Fa-f]|FE2[0-9A-Fa-f])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[0-9A-Za-z]{2,8};)',

			handler: function handler(w) {
				jQuery(document.createDocumentFragment()).append(w.matchText).appendTo(w.output);
			}
		}, { // This formatter MUST come after any formatter which handles HTML tag-like constructs (e.g. html & rawText).
			name: 'htmlTag',
			match: '<\\w+(?:\\s+[^\\u0000-\\u001F\\u007F-\\u009F\\s"\'>\\/=]+(?:\\s*=\\s*(?:"[^"]*?"|\'[^\']*?\'|[^\\s"\'=<>`]+))?)*\\s*\\/?>',
			tagPattern: '<(\\w+)',
			voidElements: ['area', 'base', 'br', 'col', 'embed', 'hr', 'img', 'input', 'keygen', 'link', 'menuitem', 'meta', 'param', 'source', 'track', 'wbr'],
			nobrElements: ['colgroup', 'datalist', 'dl', 'figure', 'ol', 'optgroup', 'select', 'table', 'tbody', 'tfoot', 'thead', 'tr', 'ul'],

			handler: function handler(w) {
				var tagMatch = new RegExp(this.tagPattern).exec(w.matchText),
				    tag = tagMatch && tagMatch[1],
				    tagName = tag && tag.toLowerCase();

				if (tagName) {
					var isVoid = this.voidElements.includes(tagName),
					    isNobr = this.nobrElements.includes(tagName);
					var terminator = void 0,
					    terminatorMatch = void 0;

					if (!isVoid) {
						terminator = '<\\/' + tagName + '\\s*>';

						var terminatorRegExp = new RegExp(terminator, 'gim'); // ignore case during match

						terminatorRegExp.lastIndex = w.matchStart;
						terminatorMatch = terminatorRegExp.exec(w.source);
					}

					if (isVoid || terminatorMatch) {
						var output = w.output,
						    el = document.createElement(w.output.tagName),
						    debugView = void 0;

						el.innerHTML = w.matchText;

						while (el.firstChild) {
							el = el.firstChild;
						}

						if (el.hasAttribute('data-passage')) {
							this.processDataAttributes(el);

							// Debug view setup.
							if (Config.debug) {
								debugView = new DebugView(w.output, 'html-' + tagName, tagName, w.matchText);
								debugView.modes({
									block: tagName === 'img',
									nonvoid: terminatorMatch
								});
								output = debugView.output;
							}
						}

						if (terminatorMatch) {
							if (isNobr) {
								w._nobr.unshift(true);
							} else if (w._nobr.length > 0) {
								w._nobr.unshift(false);
							}

							try {
								w.subWikify(el, terminator, true); // ignore case during match

								/*
        	Debug view modification.  If the current element has any debug
        	view descendants who have "block" mode set, then set its debug
        	view to the same.  It just makes things look a bit nicer.
        */
								if (debugView && jQuery(el).find('.debug.block').length > 0) {
									debugView.modes({ block: true });
								}
							} finally {
								if (w._nobr.length > 0) {
									w._nobr.shift();
								}
							}
						}

						output.appendChild(el);
					} else {
						throwError(w.output, 'HTML tag "' + tag + '" is not closed', w.matchText + '…');
					}
				}
			},
			processDataAttributes: function processDataAttributes(el) {
				var passage = el.getAttribute('data-passage');

				if (passage == null) {
					// lazy equality for null
					return;
				}

				var evaluated = Wikifier.helpers.evalPassageId(passage);

				if (evaluated !== passage) {
					passage = evaluated;
					el.setAttribute('data-passage', evaluated);
				}

				if (passage !== '') {
					if (el.tagName.toUpperCase() === 'IMG') {
						// Handle image passage transclusion.
						if (passage.slice(0, 5) !== 'data:' && Story.has(passage)) {
							passage = Story.get(passage);
							if (passage.tags.includes('Twine.image')) {
								el.src = passage.text.trim();
							}
						}
					} else {
						(function () {
							var setter = el.getAttribute('data-setter'),
							    setFn = void 0;

							if (setter != null) {
								// lazy equality for null
								setter = String(setter).trim();

								if (setter !== '') {
									setFn = function (ex) {
										return function () {
											return Scripting.evalJavaScript(ex);
										};
									}(Scripting.parse(setter));
								}
							}

							if (Story.has(passage)) {
								el.classList.add('link-internal');

								if (Config.addVisitedLinkClass && State.hasPlayed(passage)) {
									el.classList.add('link-visited');
								}
							} else {
								el.classList.add('link-broken');
							}

							jQuery(el).ariaClick({ one: true }, function () {
								if (typeof setFn === 'function') {
									setFn.call(this);
								}

								Engine.play(passage);
							});
						})();
					}
				}
			}
		}]
	}); // End formatters

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Wikifier;
}();
/* eslint-enable max-len */

/***********************************************************************************************************************
 *
 * macros/macro.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Scripting, clone, macros */

var Macro = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// Macro definitions.
	_macros = {},


	// Map of all macro tags and their parents (key: 'tag name' => value: ['list of parent names']).
	_tags = {};

	/*******************************************************************************************************************
  * Macros Functions.
  ******************************************************************************************************************/
	function macrosAdd(name, def, deep) {
		if (Array.isArray(name)) {
			name.forEach(function (n) {
				return macrosAdd(n, def, deep);
			});
			return;
		}

		if (macrosHas(name)) {
			throw new Error('cannot clobber existing macro <<' + name + '>>');
		} else if (tagsHas(name)) {
			throw new Error(String.format('cannot clobber child tag <<{0}>> of parent macro{1} <<{2}>>', name, _tags[name].length === 1 ? '' : 's', _tags[name].join('>>, <<')));
		}

		try {
			if ((typeof def === 'undefined' ? 'undefined' : _typeof(def)) === 'object') {
				// Add the macro definition.
				_macros[name] = deep ? clone(def) : def;
			} else {
				// Add the macro alias.
				if (macrosHas(def)) {
					_macros[name] = deep ? clone(_macros[def]) : _macros[def];
				} else {
					throw new Error('cannot create alias of nonexistent macro <<' + def + '>>');
				}
			}
			Object.defineProperty(_macros, name, { writable: false });

			/* legacy */
			/*
   	Since `macrosGet()` may return legacy macros, we have to add a flag to (modern)
   	API macros, so that the macro formatter will know how to call the macro.
   */
			_macros[name]._MACRO_API = true;
			/* /legacy */
		} catch (e) {
			if (e.name === 'TypeError') {
				throw new Error('cannot clobber protected macro <<' + name + '>>');
			} else {
				throw new Error('unknown error when attempting to add macro <<' + name + '>>: [' + e.name + '] ' + e.message);
			}
		}

		// Tags post-processing.
		if (_macros[name].hasOwnProperty('tags')) {
			if (_macros[name].tags == null) {
				// lazy equality for null
				tagsRegister(name);
			} else if (Array.isArray(_macros[name].tags)) {
				tagsRegister(name, _macros[name].tags);
			} else {
				throw new Error('bad value for "tags" property of macro <<' + name + '>>');
			}
		}
	}

	function macrosDelete(name) {
		if (Array.isArray(name)) {
			name.forEach(function (n) {
				return macrosDelete(n);
			});
			return;
		}

		if (macrosHas(name)) {
			// Tags pre-processing.
			if (_macros[name].hasOwnProperty('tags')) {
				tagsUnregister(name);
			}

			try {
				// Remove the macro definition.
				Object.defineProperty(_macros, name, { writable: true });
				delete _macros[name];
			} catch (e) {
				throw new Error('unknown error removing macro <<' + name + '>>: ' + e.message);
			}
		} else if (tagsHas(name)) {
			throw new Error('cannot remove child tag <<' + name + '>> of parent macro <<' + _tags[name] + '>>');
		}
	}

	function macrosIsEmpty() {
		return Object.keys(_macros).length === 0;
	}

	function macrosHas(name) {
		return _macros.hasOwnProperty(name);
	}

	function macrosGet(name) {
		var macro = null;

		if (macrosHas(name) && typeof _macros[name].handler === 'function') {
			macro = _macros[name];
		}
		/* legacy macro support */
		else if (macros.hasOwnProperty(name) && typeof macros[name].handler === 'function') {
				macro = macros[name];
			}
		/* /legacy macro support */

		return macro;
	}

	function macrosInit() {
		var handler = arguments.length <= 0 || arguments[0] === undefined ? 'init' : arguments[0];
		// eslint-disable-line no-unused-vars
		Object.keys(_macros).forEach(function (name) {
			if (typeof _macros[name][handler] === 'function') {
				_macros[name][handler].call(_macros[name], name);
			}
		});

		/* legacy macro support */
		Object.keys(macros).forEach(function (name) {
			if (typeof macros[name][handler] === 'function') {
				macros[name][handler].call(macros[name], name);
			}
		});
		/* /legacy macro support */
	}

	/*******************************************************************************************************************
  * Tags Functions.
  ******************************************************************************************************************/
	function tagsRegister(parent, bodyTags) {
		if (!parent) {
			throw new Error('no parent specified');
		}

		var endTags = ['/' + parent, 'end' + parent],
		    // automatically create the closing tags
		allTags = [].concat(endTags, Array.isArray(bodyTags) ? bodyTags : []);

		for (var i = 0; i < allTags.length; ++i) {
			var tag = allTags[i];

			if (macrosHas(tag)) {
				throw new Error('cannot register tag for an existing macro');
			}

			if (tagsHas(tag)) {
				if (!_tags[tag].includes(parent)) {
					_tags[tag].push(parent);
					_tags[tag].sort();
				}
			} else {
				_tags[tag] = [parent];
			}
		}
	}

	function tagsUnregister(parent) {
		if (!parent) {
			throw new Error('no parent specified');
		}

		Object.keys(_tags).forEach(function (tag) {
			var i = _tags[tag].indexOf(parent);

			if (i !== -1) {
				if (_tags[tag].length === 1) {
					delete _tags[tag];
				} else {
					_tags[tag].splice(i, 1);
				}
			}
		});
	}

	function tagsHas(name) {
		return _tags.hasOwnProperty(name);
	}

	function tagsGet(name) {
		return tagsHas(name) ? _tags[name] : null;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	Macro Functions.
  */
		add: { value: macrosAdd },
		delete: { value: macrosDelete },
		isEmpty: { value: macrosIsEmpty },
		has: { value: macrosHas },
		get: { value: macrosGet },
		init: { value: macrosInit },

		/*
  	Tags Functions.
  */
		tags: {
			value: Object.freeze(Object.defineProperties({}, {
				register: { value: tagsRegister },
				unregister: { value: tagsUnregister },
				has: { value: tagsHas },
				get: { value: tagsGet }
			}))
		},

		/*
  	Legacy Aliases.
  */
		evalStatements: { value: function value() {
				return Scripting.evalJavaScript.apply(Scripting, arguments);
			} } // See: `markup/scripting.js`.
	}));
}();

/***********************************************************************************************************************
 *
 * macros/macrocontext.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Config, DebugView, throwError */

var MacroContext = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	/*******************************************************************************************************************
  * MacroContext Class.
  ******************************************************************************************************************/

	var MacroContext = function () {
		function MacroContext(contextData) {
			_classCallCheck(this, MacroContext);

			var context = Object.assign({
				parent: null,
				macro: null,
				name: '',
				args: null,
				payload: null,
				parser: null,
				source: ''
			}, contextData);

			if (context.macro === null || context.name === '' || context.parser === null) {
				throw new TypeError('context object missing required properties');
			}

			Object.defineProperties(this, {
				parent: {
					value: context.parent
				},

				self: {
					value: context.macro
				},

				name: {
					value: context.name
				},

				args: {
					value: context.args
				},

				payload: {
					value: context.payload
				},

				source: {
					value: context.source
				},

				parser: {
					value: context.parser
				},

				_output: {
					value: context.parser.output
				},

				_debugView: {
					writable: true,
					value: null
				},

				_debugViewEnabled: {
					writable: true,
					value: Config.debug
				}
			});
		}

		_createClass(MacroContext, [{
			key: 'contextHas',
			value: function contextHas(filter) {
				var context = this;

				while ((context = context.parent) !== null) {
					if (filter(context)) {
						return true;
					}
				}

				return false;
			}
		}, {
			key: 'contextSelect',
			value: function contextSelect(filter) {
				var context = this;

				while ((context = context.parent) !== null) {
					if (filter(context)) {
						return context;
					}
				}

				return null;
			}
		}, {
			key: 'contextSelectAll',
			value: function contextSelectAll(filter) {
				var result = [];
				var context = this;

				while ((context = context.parent) !== null) {
					if (filter(context)) {
						result.push(context);
					}
				}

				return result;
			}
		}, {
			key: 'createDebugView',
			value: function createDebugView(name, title) {
				this._debugView = new DebugView(this._output, 'macro', name ? name : this.name, title ? title : this.source);

				if (this.payload !== null && this.payload.length > 0) {
					this._debugView.modes({ nonvoid: true });
				}

				this._debugViewEnabled = true;
				return this._debugView;
			}
		}, {
			key: 'removeDebugView',
			value: function removeDebugView() {
				if (this._debugView !== null) {
					this._debugView.remove();
					this._debugView = null;
				}

				this._debugViewEnabled = false;
			}
		}, {
			key: 'error',
			value: function error(message, title) {
				return throwError(this._output, '<<' + this.name + '>>: ' + message, title ? title : this.source);
			}
		}, {
			key: 'output',
			get: function get() {
				return this._debugViewEnabled ? this.debugView.output : this._output;
			}
		}, {
			key: 'debugView',
			get: function get() {
				if (this._debugViewEnabled) {
					return this._debugView !== null ? this._debugView : this.createDebugView();
				}

				return null;
			}
		}]);

		return MacroContext;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return MacroContext;
}();

/***********************************************************************************************************************
 *
 * macros/macrolib.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/*
	global AudioWrapper, Config, DebugView, Engine, Has, Macro, Scripting, State, Story, TempState, TempVariables,
	       Util, Wikifier, postdisplay, prehistory, storage, strings, toStringOrDefault
*/

(function () {
	'use strict';

	/*******************************************************************************************************************
  * Utility Functions.
  ******************************************************************************************************************/

	function _getWikifyEvalHandler(content, widgetArgs, callback) {
		return function () {
			if (content !== '') {
				var argsCache = void 0;
				/*
    	There's no catch clause because this try/finally is here simply to ensure that
    	proper cleanup is done in the event that an exception is thrown during the
    	`Wikifier.wikifyEval()` call.
    */
				try {
					// Setup the `$args` variable, caching the existing value if necessary.
					if (typeof widgetArgs !== 'undefined') {
						if (State.variables.hasOwnProperty('args')) {
							argsCache = State.variables.args;
						}

						State.variables.args = widgetArgs;
					}

					// Wikify the content and discard any output, unless there were errors.
					Wikifier.wikifyEval(content);
				} finally {
					// Teardown the `$args` variable, restoring the cached value if necessary.
					if (typeof widgetArgs !== 'undefined') {
						if (typeof argsCache !== 'undefined') {
							State.variables.args = argsCache;
						} else {
							delete State.variables.args;
						}
					}
				}
			}

			// Call the given callback function, if any.
			if (typeof callback === 'function') {
				callback.call(this);
			}
		};
	}

	/*******************************************************************************************************************
  * Variables Macros.
  ******************************************************************************************************************/
	/*
 	<<set>>
 */
	Macro.add('set', {
		skipArgs: true,

		handler: function handler() {
			if (this.args.full.length === 0) {
				return this.error('no expression specified');
			}

			try {
				Scripting.evalJavaScript(this.args.full);
			} catch (e) {
				return this.error('bad evaluation: ' + e.message);
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ hidden: true });
			}
		}
	});

	/*
 	<<unset>>
 */
	Macro.add('unset', {
		skipArgs: true,

		handler: function handler() {
			if (this.args.full.length === 0) {
				return this.error('no story/temporary variable list specified');
			}

			var re = new RegExp('(?:(State\\.variables)|(TempVariables))\\.(' + Wikifier.textPrimitives.identifier + ')', 'g');
			var match = void 0;

			while ((match = re.exec(this.args.full)) !== null) {
				var store = match[1] ? State.variables : TempVariables,
				    name = match[3];

				if (store.hasOwnProperty(name)) {
					delete store[name];
				}
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ hidden: true });
			}
		}
	});

	/*
 	<<remember>>
 */
	Macro.add('remember', {
		skipArgs: true,

		handler: function handler() {
			if (this.args.full.length === 0) {
				return this.error('no expression specified');
			}

			try {
				Scripting.evalJavaScript(this.args.full);
			} catch (e) {
				return this.error('bad evaluation: ' + e.message);
			}

			var remember = storage.get('remember') || {},
			    re = new RegExp('State\\.variables\\.(' + Wikifier.textPrimitives.identifier + ')', 'g');
			var match = void 0;

			while ((match = re.exec(this.args.full)) !== null) {
				var name = match[1];
				remember[name] = State.variables[name];
			}

			if (!storage.set('remember', remember)) {
				return this.error('unknown error, cannot remember: ' + this.args.raw);
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ hidden: true });
			}
		},
		init: function init() {
			var remember = storage.get('remember');

			if (remember) {
				Object.keys(remember).forEach(function (name) {
					return State.variables[name] = remember[name];
				});
			}
		}
	});

	/*
 	<<forget>>
 */
	Macro.add('forget', {
		skipArgs: true,

		handler: function handler() {
			if (this.args.full.length === 0) {
				return this.error('no story variable list specified');
			}

			var remember = storage.get('remember'),
			    re = new RegExp('State\\.variables\\.(' + Wikifier.textPrimitives.identifier + ')', 'g');
			var match = void 0,
			    needStore = false;

			while ((match = re.exec(this.args.full)) !== null) {
				var name = match[1];

				if (State.variables.hasOwnProperty(name)) {
					delete State.variables[name];
				}

				if (remember && remember.hasOwnProperty(name)) {
					needStore = true;
					delete remember[name];
				}
			}

			if (needStore && !storage.set('remember', remember)) {
				return this.error('unknown error, cannot update remember store');
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ hidden: true });
			}
		}
	});

	/*******************************************************************************************************************
  * Scripting Macros.
  ******************************************************************************************************************/
	/*
 	<<run>>
 */
	Macro.add('run', 'set'); // add <<run>> as an alias of <<set>>

	/*
 	<<script>>
 */
	Macro.add('script', {
		skipArgs: true,
		tags: null,

		handler: function handler() {
			var output = document.createDocumentFragment();

			try {
				Scripting.evalJavaScript(this.payload[0].contents, output);

				// Custom debug view setup.
				if (Config.debug) {
					this.createDebugView(this.name, this.source + this.payload[0].contents + '<</' + this.name + '>>');
				}
			} catch (e) {
				return this.error('bad evaluation: ' + e.message, this.source + this.payload[0].contents + '<</' + this.name + '>>');
			}

			if (output.hasChildNodes()) {
				this.output.appendChild(output);
			}
		}
	});

	/*******************************************************************************************************************
  * Display Macros.
  ******************************************************************************************************************/
	/*
 	<<display>>
 */
	Macro.add('display', {
		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no passage specified');
			}

			var passage = void 0;

			if (_typeof(this.args[0]) === 'object') {
				// Argument was in wiki link syntax.
				passage = this.args[0].link;
			} else {
				// Argument was simply the passage name.
				passage = this.args[0];
			}

			if (!Story.has(passage)) {
				return this.error('passage "' + passage + '" does not exist');
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ block: true });
			}

			passage = Story.get(passage);
			var $el = void 0;

			if (this.args[1]) {
				$el = jQuery(document.createElement(this.args[1])).addClass(passage.domId + ' macro-' + this.name).attr('data-passage', passage.title).appendTo(this.output);
			} else {
				$el = jQuery(this.output);
			}

			$el.wiki(passage.processText());
		}
	});

	/*
 	<<nobr>>
 */
	Macro.add('nobr', {
		skipArgs: true,
		tags: null,

		handler: function handler() {
			/*
   	Wikify the contents, after removing all leading & trailing newlines and compacting
   	all internal sequences of newlines into single spaces.
   */
			new Wikifier(this.output, this.payload[0].contents.replace(/^\n+|\n+$/g, '').replace(/\n+/g, ' '));
		}
	});

	/*
 	<<print>>, <<=>>, & <<->>
 */
	Macro.add(['print', '=', '-'], {
		skipArgs: true,

		handler: function handler() {
			if (this.args.full.length === 0) {
				return this.error('no expression specified');
			}

			try {
				var result = toStringOrDefault(Scripting.evalJavaScript(this.args.full), null);

				if (result !== null) {
					new Wikifier(this.output, this.name === '-' ? Util.escape(result) : result);
				}
			} catch (e) {
				return this.error('bad evaluation: ' + e.message);
			}
		}
	});

	/*
 	<<silently>>
 */
	Macro.add('silently', {
		skipArgs: true,
		tags: null,

		handler: function handler() {
			var frag = document.createDocumentFragment();
			new Wikifier(frag, this.payload[0].contents.trim());

			if (Config.debug) {
				// Custom debug view setup.
				this.debugView.modes({ hidden: true });
				this.output.appendChild(frag);
			} else {
				// Discard the output, unless there were errors.
				var errList = [].concat(_toConsumableArray(frag.querySelectorAll('.error'))).map(function (errEl) {
					return errEl.textContent;
				});

				if (errList.length > 0) {
					return this.error('error' + (errList.length === 1 ? '' : 's') + ' within contents (' + errList.join('; ') + ')', this.source + this.payload[0].contents + '<</' + this.name + '>>');
				}
			}
		}
	});

	/*******************************************************************************************************************
  * Control Macros.
  ******************************************************************************************************************/
	/*
 	<<if>>, <<elseif>>, & <<else>>
 */
	Macro.add('if', {
		skipArgs: true,
		tags: ['elseif', 'else'],

		handler: function handler() {
			var i = 0;

			try {
				var evalJavaScript = Scripting.evalJavaScript,
				    len = this.payload.length;
				var success = false;

				for (; /* empty */i < len; ++i) {
					// Sanity checks.
					/* eslint-disable prefer-template */
					switch (this.payload[i].name) {
						case 'else':
							if (i + 1 !== len) {
								return this.error('<<else>> must be the final clause');
							}
							if (this.payload[i].args.raw.length > 0) {
								if (/^\s*if\b/i.test(this.payload[i].args.raw)) {
									return this.error('whitespace is not allowed between the "else" and "if" in <<elseif>> clause' + (i > 0 ? ' (#' + i + ')' : ''));
								}

								return this.error('<<else>> does not accept a conditional expression' + ' (perhaps you meant to use <<elseif>>),' + (' invalid: ' + this.payload[i].args.raw));
							}
							break;

						default:
							if (this.payload[i].args.full.length === 0) {
								return this.error('no conditional expression specified for <<' + this.payload[i].name + '>> clause' + (i > 0 ? ' (#' + i + ')' : ''));
							} else if (Config.macros.ifAssignmentError && /[^!=&^|<>*/%+-]=[^=]/.test(this.payload[i].args.full)) {
								return this.error('assignment operator found within <<' + this.payload[i].name + '>> clause' + (i > 0 ? ' (#' + i + ')' : '') + ' (perhaps you meant to use an equality operator: ==, ===, eq, is),' + (' invalid: ' + this.payload[i].args.raw));
							}
							break;
					}
					/* eslint-enable prefer-template */

					// Custom debug view setup for the current clause.
					if (Config.debug) {
						this.createDebugView(this.payload[i].name, this.payload[i].source).modes({ nonvoid: false });
					}

					// Conditional test.
					if (this.payload[i].name === 'else' || !!evalJavaScript(this.payload[i].args.full)) {
						success = true;
						new Wikifier(this.output, this.payload[i].contents);
						break;
					} else if (Config.debug) {
						// Custom debug view setup for a failed conditional.
						this.debugView.modes({
							hidden: true,
							invalid: true
						});
					}
				}

				// Custom debug view setup for the remaining clauses.
				if (Config.debug) {
					for (++i; i < len; ++i) {
						this.createDebugView(this.payload[i].name, this.payload[i].source).modes({
							nonvoid: false,
							hidden: true,
							invalid: true
						});
					}

					/*
     	Fake a debug view for `<</if>>`.  We do this to aid the checking of nesting
     	and as a quick indicator of if any of the clauses matched.
     */
					this.createDebugView('/' + this.name, '<</' + this.name + '>>').modes({
						nonvoid: false,
						hidden: !success,
						invalid: !success
					});
				}
			} catch (e) {
				return this.error('bad conditional expression in <<' + (i === 0 ? 'if' : 'elseif') + '>> clause' + ((i > 0 ? ' (#' + i + ')' : '') + ': ' + e.message)); // eslint-disable-line prefer-template
			}
		}
	});

	/*
 	<<switch>>, <<case>>, & <<default>>
 */
	Macro.add('switch', {
		skipArg0: true,
		tags: ['case', 'default'],

		handler: function handler() {
			if (this.args.full.length === 0) {
				return this.error('no expression specified');
			}

			var len = this.payload.length;
			var result = void 0;

			// if (len === 1 || !this.payload.some(p => p.name === 'case')) {
			if (len === 1) {
				return this.error('no cases specified');
			}

			try {
				result = Scripting.evalJavaScript(this.args.full);
			} catch (e) {
				return this.error('bad evaluation: ' + e.message);
			}

			var debugView = this.debugView; // cache it now, to be modified later
			var i = 1,
			    success = false;

			// Initial debug view setup for `<<switch>>`.
			if (Config.debug) {
				debugView.modes({
					nonvoid: false,
					hidden: true
				});
			}

			for (; /* empty */i < len; ++i) {
				// Sanity checks.
				switch (this.payload[i].name) {
					case 'default':
						if (i + 1 !== len) {
							return this.error('<<default>> must be the final case');
						}
						if (this.payload[i].args.length > 0) {
							return this.error('<<default>> does not accept values, invalid: ' + this.payload[i].args.raw);
						}
						break;

					default:
						if (this.payload[i].args.length === 0) {
							return this.error('no value(s) specified for <<' + this.payload[i].name + '>> (#' + i + ')');
						}
						break;
				}

				// Custom debug view setup for the current case.
				if (Config.debug) {
					this.createDebugView(this.payload[i].name, this.payload[i].source).modes({ nonvoid: false });
				}

				// Case test(s).
				if (this.payload[i].name === 'default' || this.payload[i].args.some(function (v) {
					return v === result;
				})) {
					success = true;
					new Wikifier(this.output, this.payload[i].contents);
					break;
				} else if (Config.debug) {
					// Custom debug view setup for a failed case.
					this.debugView.modes({
						hidden: true,
						invalid: true
					});
				}
			}

			// Custom debug view setup for the remaining cases.
			if (Config.debug) {
				for (++i; i < len; ++i) {
					this.createDebugView(this.payload[i].name, this.payload[i].source).modes({
						nonvoid: false,
						hidden: true,
						invalid: true
					});
				}

				/*
    	Finalize the debug view for `<<switch>>` and fake a debug view for `<</switch>>`.
    	We do both as a quick indicator of if any of the cases matched and the latter
    	to aid the checking of nesting.
    */
				debugView.modes({
					nonvoid: false,
					hidden: true, // !success,
					invalid: !success
				});
				this.createDebugView('/' + this.name, '<</' + this.name + '>>').modes({
					nonvoid: false,
					hidden: true, // !success,
					invalid: !success
				});
			}
		}
	});

	/*
 	<<for>>, <<break>>, & <<continue>>
 */
	Macro.add('for', {
		skipArgs: true,
		tags: null,

		handler: function handler() {
			var evalJavaScript = Scripting.evalJavaScript,
			    payload = this.payload[0].contents.replace(/\n$/, '');
			var init = void 0,
			    condition = this.args.full.trim(),
			    post = void 0,
			    first = true,
			    safety = Config.macros.maxLoopIterations;

			if (condition.length === 0) {
				condition = true;
			} else if (condition.indexOf(';') !== -1) {
				var parts = condition.match(/^([^;]*?)\s*;\s*([^;]*?)\s*;\s*([^;]*?)$/);

				if (parts !== null) {
					init = parts[1];
					condition = parts[2];
					post = parts[3];
				} else {
					return this.error('invalid 3-part syntax, format: init ; condition ; post');
				}
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ block: true });
			}

			try {
				TempState.break = null;

				if (init) {
					try {
						evalJavaScript(init);
					} catch (e) {
						return this.error('bad init expression: ' + e.message);
					}
				}

				while (evalJavaScript(condition)) {
					if (--safety < 0) {
						return this.error('exceeded configured maximum loop iterations' + (' (' + Config.macros.maxLoopIterations + ')'));
					}

					new Wikifier(this.output, first ? payload.replace(/^\n/, '') : payload);

					if (first) {
						first = false;
					}

					if (TempState.break != null) {
						// lazy equality for null
						if (TempState.break === 1) {
							TempState.break = null;
						} else if (TempState.break === 2) {
							TempState.break = null;
							break;
						}
					}

					if (post) {
						try {
							evalJavaScript(post);
						} catch (e) {
							return this.error('bad post expression: ' + e.message);
						}
					}
				}
			} catch (e) {
				return this.error('bad conditional expression: ' + e.message);
			} finally {
				TempState.break = null;
			}
		}
	});
	Macro.add(['break', 'continue'], {
		skipArgs: true,

		handler: function handler() {
			if (this.contextHas(function (c) {
				return c.name === 'for';
			})) {
				TempState.break = this.name === 'continue' ? 1 : 2;
			} else {
				return this.error('must only be used in conjunction with its parent macro <<for>>');
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ hidden: true });
			}
		}
	});

	/*******************************************************************************************************************
  * Interactive Macros.
  ******************************************************************************************************************/
	/*
 	<<button>> & <<click>>
 */
	Macro.add(['button', 'click'], {
		tags: null,

		handler: function handler() {
			var _this6 = this;

			if (this.args.length === 0) {
				return this.error('no ' + (this.name === 'click' ? 'link' : 'button') + ' text specified');
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.createDebugView(this.name, this.source + this.payload[0].contents + '<</' + this.name + '>>');
			}

			var $el = jQuery(document.createElement(this.name === 'click' ? 'a' : 'button')),
			    widgetArgs = function () {
				var wargs = void 0;

				if (State.variables.hasOwnProperty('args') && _this6.contextHas(function (c) {
					return c.self.isWidget;
				})) {
					wargs = State.variables.args;
				}

				return wargs;
			}();
			var passage = void 0;

			if (_typeof(this.args[0]) === 'object') {
				if (this.args[0].isImage) {
					// Argument was in wiki image syntax.
					var $image = jQuery(document.createElement('img')).attr('src', this.args[0].source).appendTo($el);

					if (this.args[0].hasOwnProperty('passage')) {
						$image.attr('data-passage', this.args[0].passage);
					}

					if (this.args[0].hasOwnProperty('title')) {
						$image.attr('title', this.args[0].title);
					}

					if (this.args[0].hasOwnProperty('align')) {
						$image.attr('align', this.args[0].align);
					}

					if (this.args[0].hasOwnProperty('link')) {
						passage = this.args[0].link;
					}

					passage = this.args[0].link;
				} else {
					// Argument was in wiki link syntax.
					$el.append(document.createTextNode(this.args[0].text));
					passage = this.args[0].link;
				}
			} else {
				// Argument was simply the link text.
				$el.append(document.createTextNode(this.args[0]));
				passage = this.args.length > 1 ? this.args[1] : undefined;
			}

			if (passage != null) {
				// lazy equality for null
				$el.attr('data-passage', passage);

				if (Story.has(passage)) {
					$el.addClass('link-internal');

					if (Config.addVisitedLinkClass && State.hasPlayed(passage)) {
						$el.addClass('link-visited');
					}
				} else {
					$el.addClass('link-broken');
				}
			} else {
				$el.addClass('link-internal');
			}

			$el.addClass('macro-' + this.name).ariaClick({
				namespace: '.macros',
				one: passage != null // lazy equality for null
			}, _getWikifyEvalHandler(this.payload[0].contents.trim(), widgetArgs, passage != null ? function () {
				return Engine.play(passage);
			} : undefined // lazy equality for null
			)).appendTo(this.output);
		}
	});

	/*
 	<<checkbox>>
 */
	Macro.add('checkbox', {
		handler: function handler() {
			if (this.args.length < 3) {
				var errors = [];
				if (this.args.length < 1) {
					errors.push('story variable name');
				}
				if (this.args.length < 2) {
					errors.push('unchecked value');
				}
				if (this.args.length < 3) {
					errors.push('checked value');
				}
				return this.error('no ' + errors.join(' or ') + ' specified');
			}

			/*
   	Try to ensure that we receive the story variable's name (incl. sigil), not its value.
   */
			if (typeof this.args[0] !== 'string' || this.args[0].trim()[0] !== '$') {
				return this.error('story variable name "' + this.args[0] + '" is missing its sigil ($)');
			}

			var varName = this.args[0].trim(),
			    varId = Util.slugify(varName),
			    uncheckValue = this.args[1],
			    checkValue = this.args[2],
			    el = document.createElement('input');

			/*
   	Setup and append the input element to the output buffer.
   */
			jQuery(el).attr({
				id: this.name + '-' + varId,
				name: this.name + '-' + varId,
				type: 'checkbox',
				tabindex: 0 // for accessiblity
			}).addClass('macro-' + this.name).on('change', function () {
				Wikifier.setValue(varName, this.checked ? checkValue : uncheckValue);
			}).appendTo(this.output);

			/*
   	Set the story variable and input element to the appropriate value and state, as requested.
   */
			if (this.args.length > 3 && this.args[3] === 'checked') {
				el.checked = true;
				Wikifier.setValue(varName, checkValue);
			} else {
				Wikifier.setValue(varName, uncheckValue);
			}
		}
	});

	/*
 	<<radiobutton>>
 */
	Macro.add('radiobutton', {
		handler: function handler() {
			if (this.args.length < 2) {
				var errors = [];
				if (this.args.length < 1) {
					errors.push('story variable name');
				}
				if (this.args.length < 2) {
					errors.push('checked value');
				}
				return this.error('no ' + errors.join(' or ') + ' specified');
			}

			/*
   	Try to ensure that we receive the story variable's name (incl. sigil), not its value.
   */
			if (typeof this.args[0] !== 'string' || this.args[0].trim()[0] !== '$') {
				return this.error('story variable name "' + this.args[0] + '" is missing its sigil ($)');
			}

			var varName = this.args[0].trim(),
			    varId = Util.slugify(varName),
			    checkValue = this.args[1],
			    el = document.createElement('input');

			/*
   	Setup and initialize the group counter.
   */
			if (!TempState.hasOwnProperty(this.name)) {
				TempState[this.name] = {};
				TempState[this.name][varId] = 0;
			}

			/*
   	Setup and append the input element to the output buffer.
   */
			jQuery(el).attr({
				id: this.name + '-' + varId + '-' + TempState[this.name][varId]++,
				name: this.name + '-' + varId,
				type: 'radio',
				tabindex: 0 // for accessiblity
			}).addClass('macro-' + this.name).on('change', function () {
				if (this.checked) {
					Wikifier.setValue(varName, checkValue);
				}
			}).appendTo(this.output);

			/*
   	Set the story variable to the checked value and the input element to checked, if requested.
   */
			if (this.args.length > 2 && this.args[2] === 'checked') {
				el.checked = true;
				Wikifier.setValue(varName, checkValue);
			}
		}
	});

	/*
 	<<textarea>>
 */
	Macro.add('textarea', {
		handler: function handler() {
			if (this.args.length < 2) {
				var errors = [];
				if (this.args.length < 1) {
					errors.push('story variable name');
				}
				if (this.args.length < 2) {
					errors.push('default value');
				}
				return this.error('no ' + errors.join(' or ') + ' specified');
			}

			/*
   	Try to ensure that we receive the story variable's name (incl. sigil), not its value.
   */
			if (typeof this.args[0] !== 'string' || this.args[0].trim()[0] !== '$') {
				return this.error('story variable name "' + this.args[0] + '" is missing its sigil ($)');
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ block: true });
			}

			var varName = this.args[0].trim(),
			    varId = Util.slugify(varName),
			    defaultValue = this.args[1],
			    autofocus = this.args[2] === 'autofocus',
			    el = document.createElement('textarea');

			/*
   	Setup and append the textarea element to the output buffer.
   */
			jQuery(el).attr({
				id: this.name + '-' + varId,
				name: this.name + '-' + varId,
				rows: 4,
				// cols     : 68, // instead of setting "cols" we set the `min-width` in CSS
				tabindex: 0 // for accessiblity
			}).addClass('macro-' + this.name).on('change', function () {
				Wikifier.setValue(varName, this.value);
			}).appendTo(this.output);

			/*
   	Set the story variable and textarea element to the default value.
   */
			Wikifier.setValue(varName, defaultValue);
			// Ideally, we should be setting the `.defaultValue` property here, but IE doesn't support
			// it, so we have to use `.textContent`, which is equivalent to `.defaultValue` anyway.
			el.textContent = defaultValue;

			/*
   	Autofocus the textarea element, if requested.
   */
			if (autofocus) {
				// Set the element's "autofocus" attribute.
				el.setAttribute('autofocus', 'autofocus');

				// Setup a single-use post-display task to autofocus the element.
				postdisplay['#autofocus:' + el.id] = function (task) {
					setTimeout(function () {
						return el.focus();
					}, Engine.minDomActionDelay);
					delete postdisplay[task]; // single-use task
				};
			}
		}
	});

	/*
 	<<textbox>>
 */
	Macro.add('textbox', {
		handler: function handler() {
			if (this.args.length < 2) {
				var errors = [];
				if (this.args.length < 1) {
					errors.push('story variable name');
				}
				if (this.args.length < 2) {
					errors.push('default value');
				}
				return this.error('no ' + errors.join(' or ') + ' specified');
			}

			/*
   	Try to ensure that we receive the story variable's name (incl. sigil), not its value.
   */
			if (typeof this.args[0] !== 'string' || this.args[0].trim()[0] !== '$') {
				return this.error('story variable name "' + this.args[0] + '" is missing its sigil ($)');
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ block: true });
			}

			var varName = this.args[0].trim(),
			    varId = Util.slugify(varName),
			    defaultValue = this.args[1],
			    el = document.createElement('input');
			var autofocus = false,
			    passage = void 0;

			if (this.args.length > 3) {
				passage = this.args[2];
				autofocus = this.args[3] === 'autofocus';
			} else if (this.args.length > 2) {
				if (this.args[2] === 'autofocus') {
					autofocus = true;
				} else {
					passage = this.args[2];
				}
			}

			/*
   	Setup and append the input element to the output buffer.
   */
			jQuery(el).attr({
				id: this.name + '-' + varId,
				name: this.name + '-' + varId,
				type: 'text',
				tabindex: 0 // for accessiblity
			}).addClass('macro-' + this.name).on('change', function () {
				Wikifier.setValue(varName, this.value);
			}).on('keypress', function (evt) {
				// If Return/Enter is pressed, set the story variable and, optionally, forward to another passage.
				if (evt.which === 13) {
					// 13 is Return/Enter
					evt.preventDefault();
					Wikifier.setValue(varName, this.value);
					if (passage != null) {
						// lazy equality for null
						Engine.play(passage);
					}
				}
			}).appendTo(this.output);

			/*
   	Set the story variable and input element to the default value.
   */
			Wikifier.setValue(varName, defaultValue);
			el.value = defaultValue;

			/*
   	Autofocus the input element, if requested.
   */
			if (autofocus) {
				// Set the element's "autofocus" attribute.
				el.setAttribute('autofocus', 'autofocus');

				// Setup a single-use post-display task to autofocus the element.
				postdisplay['#autofocus:' + el.id] = function (task) {
					setTimeout(function () {
						return el.focus();
					}, Engine.minDomActionDelay);
					delete postdisplay[task]; // single-use task
				};
			}
		}
	});

	/*******************************************************************************************************************
  * Links Macros.
  ******************************************************************************************************************/
	/*
 	<<actions>>
 */
	Macro.add('actions', {
		handler: function handler() {
			var $list = jQuery(document.createElement('ul')).addClass(this.name).appendTo(this.output);

			if (!State.variables['#actions']) {
				State.variables['#actions'] = {};
			}

			for (var i = 0; i < this.args.length; ++i) {
				var passage = void 0,
				    text = void 0,
				    $image = void 0,
				    setFn = void 0;

				if (_typeof(this.args[i]) === 'object') {
					if (this.args[i].isImage) {
						// Argument was in wiki image syntax.
						$image = jQuery(document.createElement('img')).attr('src', this.args[i].source);

						if (this.args[i].hasOwnProperty('passage')) {
							$image.attr('data-passage', this.args[i].passage);
						}

						if (this.args[i].hasOwnProperty('title')) {
							$image.attr('title', this.args[i].title);
						}

						if (this.args[i].hasOwnProperty('align')) {
							$image.attr('align', this.args[i].align);
						}

						passage = this.args[i].link;
						setFn = this.args[i].setFn;
					} else {
						// Argument was in wiki link syntax.
						text = this.args[i].text;
						passage = this.args[i].link;
						setFn = this.args[i].setFn;
					}
				} else {
					// Argument was simply the passage name.
					text = passage = this.args[i];
				}

				if (State.variables['#actions'].hasOwnProperty(passage) && State.variables['#actions'][passage]) {
					continue;
				}

				jQuery(Wikifier.createInternalLink(jQuery(document.createElement('li')).appendTo($list), passage, null, function (p, fn) {
					return function () {
						State.variables['#actions'][p] = true;
						if (typeof fn === 'function') {
							fn();
						}
					};
				}(passage, setFn))).addClass('macro-' + this.name).append($image || document.createTextNode(text));
			}
		}
	});

	/*
 	<<back>> & <<return>>
 */
	Macro.add(['back', 'return'], {
		handler: function handler() {
			/* legacy */
			if (this.args.length > 1) {
				return this.error('too many arguments specified, check the documentation for details');
			}
			/* /legacy */

			var momentIndex = -1,
			    passage = void 0,
			    text = void 0,
			    $image = void 0;

			if (this.args.length === 1) {
				if (_typeof(this.args[0]) === 'object') {
					if (this.args[0].isImage) {
						// Argument was in wiki image syntax.
						$image = jQuery(document.createElement('img')).attr('src', this.args[0].source);

						if (this.args[0].hasOwnProperty('passage')) {
							$image.attr('data-passage', this.args[0].passage);
						}

						if (this.args[0].hasOwnProperty('title')) {
							$image.attr('title', this.args[0].title);
						}

						if (this.args[0].hasOwnProperty('align')) {
							$image.attr('align', this.args[0].align);
						}

						if (this.args[0].hasOwnProperty('link')) {
							passage = this.args[0].link;
						}
					} else {
						// Argument was in wiki link syntax.
						if (this.args[0].count === 1) {
							// Simple link syntax: `[[...]]`.
							passage = this.args[0].link;
						} else {
							// Pretty link syntax: `[[...|...]]`.
							text = this.args[0].text;
							passage = this.args[0].link;
						}
					}
				} else if (this.args.length === 1) {
					// Argument was simply the link text.
					text = this.args[0];
				}
			}

			if (passage == null) {
				// lazy equality for null
				/*
    	Find the index and title of the most recent moment whose title does not match
    	that of the active (present) moment's.
    */
				for (var i = State.length - 2; i >= 0; --i) {
					if (State.history[i].title !== State.passage) {
						momentIndex = i;
						passage = State.history[i].title;
						break;
					}
				}

				// If we failed to find a passage and we're `<<return>>`, fallback to `State.expired`.
				if (passage == null && this.name === 'return') {
					// lazy equality for null
					for (var _i2 = State.expired.length - 1; _i2 >= 0; --_i2) {
						if (State.expired[_i2] !== State.passage) {
							passage = State.expired[_i2];
							break;
						}
					}
				}
			} else {
				if (!Story.has(passage)) {
					return this.error('passage "' + passage + '" does not exist');
				}

				if (this.name === 'back') {
					/*
     	Find the index of the most recent moment whose title matches that of the
     	specified passage.
     */
					for (var _i3 = State.length - 2; _i3 >= 0; --_i3) {
						if (State.history[_i3].title === passage) {
							momentIndex = _i3;
							break;
						}
					}

					if (momentIndex === -1) {
						return this.error('cannot find passage "' + passage + '" in the current story history');
					}
				}
			}

			if (passage == null) {
				// lazy equality for null
				return this.error('cannot find passage');
			}

			// if (this.name === "back" && momentIndex === -1) {
			// 	// no-op; we're already at the first passage in the current story history
			// 	return;
			// }

			var $el = void 0;

			if (this.name !== 'back' || momentIndex !== -1) {
				$el = jQuery(document.createElement('a')).addClass('link-internal').ariaClick({ one: true }, this.name === 'return' ? function () {
					return Engine.play(passage);
				} : function () {
					return Engine.goTo(momentIndex);
				});
			} else {
				$el = jQuery(document.createElement('span')).addClass('link-disabled');
			}

			$el.addClass('macro-' + this.name).append($image || document.createTextNode(text || strings.macros[this.name].text)).appendTo(this.output);
		}
	});

	/*
 	<<choice>>
 */
	Macro.add('choice', {
		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no passage specified');
			}

			var choiceId = State.passage;
			var passage = void 0,
			    text = void 0,
			    $image = void 0,
			    setFn = void 0;

			if (this.args.length === 1) {
				if (_typeof(this.args[0]) === 'object') {
					if (this.args[0].isImage) {
						// Argument was in wiki image syntax.
						$image = jQuery(document.createElement('img')).attr('src', this.args[0].source);

						if (this.args[0].hasOwnProperty('passage')) {
							$image.attr('data-passage', this.args[0].passage);
						}

						if (this.args[0].hasOwnProperty('title')) {
							$image.attr('title', this.args[0].title);
						}

						if (this.args[0].hasOwnProperty('align')) {
							$image.attr('align', this.args[0].align);
						}

						passage = this.args[0].link;
						setFn = this.args[0].setFn;
					} else {
						// Argument was in wiki link syntax.
						text = this.args[0].text;
						passage = this.args[0].link;
						setFn = this.args[0].setFn;
					}
				} else {
					// Argument was simply the passage name.
					text = passage = this.args[0];
				}
			} else {
				// Yes, the arguments are backwards.
				passage = this.args[0];
				text = this.args[1];
			}

			if (!State.variables.hasOwnProperty('#choice')) {
				State.variables['#choice'] = {};
			} else if (State.variables['#choice'].hasOwnProperty(choiceId) && State.variables['#choice'][choiceId]) {
				jQuery(document.createElement('span')).addClass('link-disabled macro-' + this.name).attr('tabindex', -1).append($image || document.createTextNode(text)).appendTo(this.output);
				return;
			}

			jQuery(Wikifier.createInternalLink(this.output, passage, null, function () {
				State.variables['#choice'][choiceId] = true;
				if (typeof setFn === 'function') {
					setFn();
				}
			})).addClass('macro-' + this.name).append($image || document.createTextNode(text));
		}
	});

	/*******************************************************************************************************************
  * DOM Macros.
  ******************************************************************************************************************/
	/*
 	<<addclass>> & <<toggleclass>>
 */
	Macro.add(['addclass', 'toggleclass'], {
		handler: function handler() {
			if (this.args.length < 2) {
				var errors = [];
				if (this.args.length < 1) {
					errors.push('selector');
				}
				if (this.args.length < 2) {
					errors.push('class names');
				}
				return this.error('no ' + errors.join(' or ') + ' specified');
			}

			var $targets = jQuery(this.args[0]);

			if ($targets.length === 0) {
				return this.error('no elements matched the selector "' + this.args[0] + '"');
			}

			switch (this.name) {
				case 'addclass':
					$targets.addClass(this.args[1].trim());
					break;

				case 'toggleclass':
					$targets.toggleClass(this.args[1].trim());
					break;
			}
		}
	});

	/*
 	<<removeclass>>
 */
	Macro.add('removeclass', {
		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no selector specified');
			}

			var $targets = jQuery(this.args[0]);

			if ($targets.length === 0) {
				return this.error('no elements matched the selector "' + this.args[0] + '"');
			}

			if (this.args.length > 1) {
				$targets.removeClass(this.args[1].trim());
			} else {
				$targets.removeClass();
			}
		}
	});

	/*
 	<<copy>>
 */
	Macro.add('copy', {
		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no selector specified');
			}

			var $targets = jQuery(this.args[0]);

			if ($targets.length === 0) {
				return this.error('no elements matched the selector "' + this.args[0] + '"');
			}

			jQuery(this.output).append($targets.html());
		}
	});

	/*
 	<<append>>, <<prepend>>, & <<replace>>
 */
	Macro.add(['append', 'prepend', 'replace'], {
		tags: null,

		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no selector specified');
			}

			var $targets = jQuery(this.args[0]);

			if ($targets.length === 0) {
				return this.error('no elements matched the selector "' + this.args[0] + '"');
			}

			if (this.payload[0].contents !== '') {
				var frag = document.createDocumentFragment();
				new Wikifier(frag, this.payload[0].contents);

				switch (this.name) {
					case 'replace':
						$targets.empty();
					/* falls through */

					case 'append':
						$targets.append(frag);
						break;

					case 'prepend':
						$targets.prepend(frag);
						break;
				}
			} else if (this.name === 'replace') {
				$targets.empty();
			}
		}
	});

	/*
 	<<remove>>
 */
	Macro.add('remove', {
		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no selector specified');
			}

			var $targets = jQuery(this.args[0]);

			if ($targets.length === 0) {
				return this.error('no elements matched the selector "' + this.args[0] + '"');
			}

			$targets.remove();
		}
	});

	/*******************************************************************************************************************
  * Audio Macros.
  ******************************************************************************************************************/
	if (!Has.audio) {
		Macro.add(['cacheaudio', 'audio', 'stopallaudio', 'playlist', 'setplaylist'], {
			handler: function handler() {/* empty */}
		});
	} else {
		/*
  	<<cacheaudio>>
  */
		Macro.add('cacheaudio', {
			handler: function handler() {
				if (this.args.length < 2) {
					var errors = [];
					if (this.args.length < 1) {
						errors.push('track ID');
					}
					if (this.args.length < 2) {
						errors.push('sources');
					}
					return this.error('no ' + errors.join(' or ') + ' specified');
				}

				var types = this.self.types,
				    canPlay = this.self.canPlay,

				/*
    	Use `document.createElement('audio')` in favor of `new Audio()` as the
    	latter is treated differently (often unfavorably) in certain cases,
    	chiefly in mobile browsers.
    */
				audio = document.createElement('audio'),
				    id = this.args[0],
				    extRe = this.self.extRe;

				for (var i = 1; i < this.args.length; ++i) {
					var url = this.args[i],
					    match = extRe.exec(Util.parseUrl(url).pathname);

					if (match === null) {
						continue;
					}

					var ext = match[1].toLowerCase(),
					    type = types.hasOwnProperty(ext) ? types[ext] : 'audio/' + ext;

					// Determine and cache the `canPlay` status for the audio type.
					if (!canPlay.hasOwnProperty(type)) {
						// Some early implementations return 'no' instead of the empty string.
						canPlay[type] = audio.canPlayType(type).replace(/^no$/i, '') !== '';
					}

					if (canPlay[type]) {
						var source = document.createElement('source');
						source.src = url;
						source.type = type;
						audio.appendChild(source);
					}
				}

				// If in Test Mode and no <source> elements were generated, return an error.
				if (Config.debug && !audio.hasChildNodes()) {
					return this.error('no supported audio tracks found');
				}

				// Wrap the <audio> element and add it to the tracks.  We do this even if no <source>
				// elements were generated to suppress errors for players.  The above Test Mode error
				// should suffice for authors.
				audio.preload = 'auto';
				this.self.tracks[id] = new AudioWrapper(audio);

				// Custom debug view setup.
				if (Config.debug) {
					this.createDebugView();
				}
			},


			extRe: /\.([^\.\/\\]+)$/,
			types: Object.freeze({
				/*
    	Define a file extension to MIME-type mapping for some common audio types.
    	Do not include the codecs property in most cases, however, as we have no way
    	of knowing what codec the given files were actually encoded with—the browser
    	will figure it out.  In some cases, however, the relationship between extension
    	and codec is strong, so we may include the codec in those cases.
    		Caveats by browser:
    		Opera (Presto) will return a false-negative if the codecs value is quoted
    		with single quotes, requiring the use of either double quotes or no quotes.
    			Blink-based browsers (e.g. Chrome, Opera ≥15) will return a false-negative
    		for WAVE audio if the preferred MIME-type of 'audio/wave' is specified,
    		requiring the use of 'audio/wav' instead.
    */
				aac: 'audio/aac', //
				mp3: 'audio/mpeg; codecs="mp3"', // .mp3 files should be MPEG Layer-III audio in an MPEG Audio container
				mp4: 'audio/mp4', // codecs vary, but commonly "mp4a.40.2"
				m4a: 'audio/mp4', // (ditto)
				ogg: 'audio/ogg', // codecs vary, but commonly "vorbis" and, recently, "opus"
				oga: 'audio/ogg', // (ditto)
				opus: 'audio/ogg; codecs="opus"', // .opus files should be Opus audio in an Ogg container
				wav: 'audio/wav', // codecs vary, but commonly "1" (1 is the FourCC for PCM/LPCM)
				weba: 'audio/webm', // codecs vary, but commonly "vorbis" and, recently, "opus"
				webm: 'audio/webm' // codecs vary, but commonly "vorbis" and, recently, "opus"
			}),
			canPlay: {},
			tracks: {}
		});

		/*
  	<<audio>>
  */
		Macro.add('audio', {
			handler: function handler() {
				if (this.args.length < 2) {
					var errors = [];
					if (this.args.length < 1) {
						errors.push('track ID');
					}
					if (this.args.length < 2) {
						errors.push('actions');
					}
					return this.error('no ' + errors.join(' or ') + ' specified');
				}

				var tracks = Macro.get('cacheaudio').tracks,
				    id = this.args[0];

				if (!tracks.hasOwnProperty(id)) {
					return this.error('track "' + id + '" does not exist');
				}

				var audio = tracks[id],
				    args = this.args.slice(1);
				var action = void 0,
				    volume = void 0,
				    mute = void 0,
				    time = void 0,
				    loop = void 0,
				    fadeTo = void 0,
				    fadeOver = 5,
				    passage = void 0,
				    raw = void 0;

				// Process arguments.
				while (args.length > 0) {
					var arg = args.shift();

					switch (arg) {
						case 'play':
						case 'pause':
						case 'stop':
							action = arg;
							break;

						case 'fadein':
							action = 'fade';
							fadeTo = 1;
							break;

						case 'fadeout':
							action = 'fade';
							fadeTo = 0;
							break;

						case 'fadeto':
							if (args.length === 0) {
								return this.error('fadeto missing required level value');
							}

							action = 'fade';
							raw = args.shift();
							fadeTo = parseFloat(raw);

							if (isNaN(fadeTo) || !isFinite(fadeTo)) {
								return this.error('cannot parse fadeto: ' + raw);
							}
							break;

						case 'fadeoverto':
							if (args.length < 2) {
								var _errors = [];
								if (args.length < 1) {
									_errors.push('seconds');
								}
								if (args.length < 2) {
									_errors.push('level');
								}
								return this.error('fadeoverto missing required ' + _errors.join(' and ') + (' value' + (_errors.length > 1 ? 's' : '')));
							}

							action = 'fade';
							raw = args.shift();
							fadeOver = parseFloat(raw);

							if (isNaN(fadeOver) || !isFinite(fadeOver)) {
								return this.error('cannot parse fadeoverto: ' + raw);
							}

							raw = args.shift();
							fadeTo = parseFloat(raw);

							if (isNaN(fadeTo) || !isFinite(fadeTo)) {
								return this.error('cannot parse fadeoverto: ' + raw);
							}
							break;

						case 'volume':
							if (args.length === 0) {
								return this.error('volume missing required level value');
							}

							raw = args.shift();
							volume = parseFloat(raw);

							if (isNaN(volume) || !isFinite(volume)) {
								return this.error('cannot parse volume: ' + raw);
							}
							break;

						case 'mute':
						case 'unmute':
							mute = arg === 'mute';
							break;

						case 'time':
							if (args.length === 0) {
								return this.error('time missing required seconds value');
							}

							raw = args.shift();
							time = parseFloat(raw);

							if (isNaN(time) || !isFinite(time)) {
								return this.error('cannot parse time: ' + raw);
							}
							break;

						case 'loop':
						case 'unloop':
							loop = arg === 'loop';
							break;

						case 'goto':
							if (args.length === 0) {
								return this.error('goto missing required passage title');
							}

							raw = args.shift();

							if ((typeof raw === 'undefined' ? 'undefined' : _typeof(raw)) === 'object') {
								// Argument was in wiki link syntax.
								passage = raw.link;
							} else {
								// Argument was simply the passage name.
								passage = raw;
							}

							if (!Story.has(passage)) {
								return this.error('passage "' + passage + '" does not exist');
							}
							break;

						default:
							return this.error('unknown action: ' + arg);
					}
				}

				try {
					if (volume != null) {
						// lazy equality for null
						audio.volume = volume;
					}

					if (time != null) {
						// lazy equality for null
						audio.time = time;
					}

					if (mute != null) {
						// lazy equality for null
						if (mute) {
							audio.mute();
						} else {
							audio.unmute();
						}
					}

					if (loop != null) {
						// lazy equality for null
						if (loop) {
							audio.loop();
						} else {
							audio.unloop();
						}
					}

					if (passage != null) {
						// lazy equality for null
						audio.one('end', function () {
							return Engine.play(passage);
						}); // execute the callback once only
					}

					switch (action) {
						case 'play':
							audio.play();
							break;

						case 'pause':
							audio.pause();
							break;

						case 'stop':
							audio.stop();
							break;

						case 'fade':
							if (audio.volume === fadeTo) {
								if (fadeTo === 0) {
									audio.volume = 1;
								} else if (fadeTo === 1) {
									audio.volume = 0;
								}
							}

							audio.fadeWithDuration(fadeOver, fadeTo);
							break;
					}

					// Custom debug view setup.
					if (Config.debug) {
						this.createDebugView();
					}
				} catch (e) {
					return this.error('error playing audio: ' + e.message);
				}
			}
		});

		/*
  	<<fadeoutplayingaudio>>
  */
		Macro.add('fadeoutplayingaudio', {
			handler: function handler() {
				var tracks = Macro.get('cacheaudio').tracks,
				    fadeOver = this.args.length === 0 ? 5 : Number(this.args[0]);

				if (isNaN(fadeOver) || !isFinite(fadeOver) || fadeOver <= 0) {
					return this.error('seconds value (' + this.args[0] + ') is not a finite number greater than zero');
				}

				Object.keys(tracks).filter(function (id) {
					return tracks[id].isPlaying();
				}).forEach(function (id) {
					var track = tracks[id];
					track.fadeWithDuration(fadeOver, 0);
				});

				// Custom debug view setup.
				if (Config.debug) {
					this.createDebugView();
				}
			}
		});

		/*
  	<<stopallaudio>>
  */
		Macro.add('stopallaudio', {
			skipArgs: true,

			handler: function handler() {
				var tracks = Macro.get('cacheaudio').tracks;
				Object.keys(tracks).forEach(function (id) {
					return tracks[id].stop();
				});

				// Custom debug view setup.
				if (Config.debug) {
					this.createDebugView();
				}
			}
		});

		/*
  	<<playlist>>
  */
		Macro.add('playlist', {
			handler: function handler() {
				if (this.args.length === 0) {
					return this.error('no actions specified');
				}

				var self = this.self,
				    args = this.args.slice(0);
				var action = void 0,
				    volume = void 0,
				    mute = void 0,
				    loop = void 0,
				    shuffle = void 0,
				    fadeTo = void 0,
				    fadeOver = 5,
				    raw = void 0;

				// Process arguments.
				while (args.length > 0) {
					var arg = args.shift();

					switch (arg) {
						case 'play':
						case 'pause':
						case 'stop':
							action = arg;
							break;

						case 'fadein':
							action = 'fade';
							fadeTo = 1;
							break;

						case 'fadeout':
							action = 'fade';
							fadeTo = 0;
							break;

						case 'fadeto':
							if (args.length === 0) {
								return this.error('fadeto missing required level value');
							}

							action = 'fade';
							raw = args.shift();
							fadeTo = parseFloat(raw);

							if (isNaN(fadeTo) || !isFinite(fadeTo)) {
								return this.error('cannot parse fadeto: ' + raw);
							}
							break;

						case 'fadeoverto':
							if (args.length < 2) {
								var errors = [];
								if (args.length < 1) {
									errors.push('seconds');
								}
								if (args.length < 2) {
									errors.push('level');
								}
								return this.error('fadeoverto missing required ' + errors.join(' and ') + (' value' + (errors.length > 1 ? 's' : '')));
							}

							action = 'fade';
							raw = args.shift();
							fadeOver = parseFloat(raw);

							if (isNaN(fadeOver) || !isFinite(fadeOver)) {
								return this.error('cannot parse fadeoverto: ' + raw);
							}

							raw = args.shift();
							fadeTo = parseFloat(raw);

							if (isNaN(fadeTo) || !isFinite(fadeTo)) {
								return this.error('cannot parse fadeoverto: ' + raw);
							}
							break;

						case 'volume':
							if (args.length === 0) {
								return this.error('volume missing required level value');
							}

							raw = args.shift();
							volume = parseFloat(raw);

							if (isNaN(volume) || !isFinite(volume)) {
								return this.error('cannot parse volume: ' + raw);
							}
							break;

						case 'mute':
						case 'unmute':
							mute = arg === 'mute';
							break;

						case 'loop':
						case 'unloop':
							loop = arg === 'loop';
							break;

						case 'shuffle':
						case 'unshuffle':
							shuffle = arg === 'shuffle';
							break;

						default:
							return this.error('unknown action: ' + arg);
					}
				}

				try {
					if (volume != null) {
						// lazy equality for null
						self.setVolume(volume);
					}

					if (mute != null) {
						// lazy equality for null
						self.muted = mute;

						if (mute) {
							self.mute();
						} else {
							self.unmute();
						}
					}

					if (loop != null) {
						// lazy equality for null
						self.loop = loop;
					}

					if (shuffle != null) {
						// lazy equality for null
						self.shuffle = shuffle;
						self.buildList();
					}

					switch (action) {
						case 'play':
							self.play();
							break;

						case 'pause':
							self.pause();
							break;

						case 'stop':
							self.stop();
							break;

						case 'fade':
							if (self.volume === fadeTo) {
								if (fadeTo === 0) {
									self.setVolume(1);
								} else if (fadeTo === 1) {
									self.setVolume(0);
								}
							}

							self.fade(fadeOver, fadeTo);
							break;
					}

					// Custom debug view setup.
					if (Config.debug) {
						this.createDebugView();
					}
				} catch (e) {
					return this.error('error playing audio: ' + e.message);
				}
			},
			play: function play() {
				if (this.list.length === 0) {
					this.buildList();
				}

				if (this.current === null || this.current.isEnded()) {
					if (!this.next()) {
						return;
					}
				}

				this.current.play();
			},
			pause: function pause() {
				if (this.current !== null) {
					this.current.pause();
				}
			},
			stop: function stop() {
				if (this.current !== null) {
					this.current.stop();
				}
			},
			fade: function fade(over, to) {
				if (this.list.length === 0) {
					this.buildList();
				}

				if (this.current === null || this.current.isEnded()) {
					if (!this.next()) {
						return;
					}
				} else {
					this.current.volume = this.volume;
				}

				this.current.fadeWithDuration(over, to);
				this.volume = to; // kludgey, but necessary
			},
			mute: function mute() {
				if (this.current !== null) {
					this.current.mute();
				}
			},
			unmute: function unmute() {
				if (this.current !== null) {
					this.current.unmute();
				}
			},
			next: function next() {
				this.current = this.list.shift();

				if (this.current == null) {
					// lazy equality for null
					this.current = null;
					return false;
				}

				if (this.current.noSource()) {
					return this.next();
				}

				this.current.volume = this.volume;

				return true;
			},
			setVolume: function setVolume(vol) {
				this.volume = vol;

				if (this.current !== null) {
					this.current.volume = vol;
				}
			},
			onEnd: function onEnd() {
				var _this = Macro.get('playlist');

				if (_this.list.length === 0) {
					if (!_this.loop) {
						return;
					}

					_this.buildList();
				}

				if (!_this.next()) {
					return;
				}

				if (_this.muted) {
					_this.mute();
				}

				_this.current.play();
			},
			buildList: function buildList() {
				this.list = this.tracks.slice(0);

				if (this.shuffle) {
					this.list.shuffle();

					// Try not to immediately replay the last track when shuffling.
					if (this.list.length > 1 && this.list[0] === this.current) {
						this.list.push(this.list.shift());
					}
				}
			},


			tracks: [],
			list: [],
			current: null,
			volume: 1,
			muted: false,
			loop: true,
			shuffle: false
		});

		/*
  	<<setplaylist>>
  */
		Macro.add('setplaylist', {
			handler: function handler() {
				if (this.args.length === 0) {
					return this.error('no track ID(s) specified');
				}

				var tracks = Macro.get('cacheaudio').tracks,
				    playlist = Macro.get('playlist'),
				    list = [];

				for (var i = 0; i < this.args.length; ++i) {
					var id = this.args[i];

					if (!tracks.hasOwnProperty(id)) {
						return this.error('track "' + id + '" does not exist');
					}

					var track = tracks[id].clone();
					track.stop();
					track.unloop();
					track.unmute();
					track.volume = 1;
					jQuery(track.audio).on('ended.macro-playlist', playlist.onEnd);
					list.push(track);
				}

				if (playlist.current !== null) {
					playlist.current.pause();
				}

				playlist.tracks = list;
				playlist.list = [];
				playlist.current = null;
				playlist.volume = 1;
				playlist.muted = false;
				playlist.loop = true;
				playlist.shuffle = false;

				// Custom debug view setup.
				if (Config.debug) {
					this.createDebugView();
				}
			}
		});
	}

	/*******************************************************************************************************************
  * Miscellaneous Macros.
  ******************************************************************************************************************/
	/*
 	<<goto>>
 */
	Macro.add('goto', {
		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no passage specified');
			}

			var passage = void 0;

			if (_typeof(this.args[0]) === 'object') {
				// Argument was in wiki link syntax.
				passage = this.args[0].link;
			} else {
				// Argument was simply the passage name.
				passage = this.args[0];
			}

			if (!Story.has(passage)) {
				return this.error('passage "' + passage + '" does not exist');
			}

			/*
   	Call `Engine.play()`.
   		n.b. This does not terminate the current Wikifier call chain, though, ideally, it
   	     probably should.  Doing so would not be trivial, however, and then there's the
   	     question of whether that behavior would be unwanted by users, who are used to
   	     the current behavior from similar macros and constructs.
   */
			setTimeout(function () {
				return Engine.play(passage);
			}, Engine.minDomActionDelay);
		}
	});

	/*
 	<<timed>> & <<next>>
 */
	Macro.add('timed', {
		tags: ['next'],
		timers: new Set(),

		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no time value specified in <<timed>>');
			}

			var items = [];

			try {
				items.push({
					name: this.name,
					source: this.source,
					delay: Math.max(Engine.minDomActionDelay, Util.fromCssTime(this.args[0])),
					content: this.payload[0].contents
				});
			} catch (e) {
				return this.error(e.message + ' in <<timed>>');
			}

			if (this.payload.length > 1) {
				var i = void 0;

				try {
					var len = void 0;

					for (i = 1, len = this.payload.length; i < len; ++i) {
						items.push({
							name: this.payload[i].name,
							source: this.payload[i].source,
							delay: this.payload[i].args.length === 0 ? items[items.length - 1].delay : Math.max(Engine.minDomActionDelay, Util.fromCssTime(this.payload[i].args[0])),
							content: this.payload[i].contents
						});
					}
				} catch (e) {
					return this.error(e.message + ' in <<next>> (#' + i + ')');
				}
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ block: true });
			}

			// Register the timer and, possibly, a cleanup task.
			this.self.registerTimeout(jQuery(document.createElement('span')).addClass('macro-' + this.name).appendTo(this.output), items, this.args.length > 1 && /^(?:transition|t8n)$/.test(this.args[1]));
		},
		registerTimeout: function registerTimeout($output, items, transition) {
			var turnId = State.turns,
			    timers = this.timers;
			var timerId = null,
			    nextItem = items.shift();

			var worker = function worker() {
				/*
    	1. Bookkeeping.
    */
				timers.delete(timerId);

				if (turnId !== State.turns) {
					return;
				}

				/*
    	2. Set the current item and setup the next worker, if any.
    */
				var curItem = nextItem;

				if ((nextItem = items.shift()) != null) {
					// lazy equality for null
					timerId = setTimeout(worker, nextItem.delay);
					timers.add(timerId);
				}

				/*
    	3. Wikify the content last to reduce temporal drift.
    */
				var frag = document.createDocumentFragment();
				new Wikifier(frag, curItem.content);

				/*
    	4. Output.
    */
				// Custom debug view setup for `<<next>>`.
				if (Config.debug && curItem.name === 'next') {
					$output = jQuery(new DebugView( // eslint-disable-line no-param-reassign
					$output[0], 'macro', curItem.name, curItem.source).output);
				}

				if (transition) {
					$output = jQuery(document.createElement('span')) // eslint-disable-line no-param-reassign
					.addClass('macro-timed-insert macro-timed-in').appendTo($output);
				}

				$output.append(frag);

				if (transition) {
					setTimeout(function () {
						return $output.removeClass('macro-timed-in');
					}, Engine.minDomActionDelay);
				}
			};

			// Setup the timeout.
			timerId = setTimeout(worker, nextItem.delay);
			timers.add(timerId);

			// Setup a single-use `prehistory` task to remove pending timers.
			if (!prehistory.hasOwnProperty('#timed-timers-cleanup')) {
				prehistory['#timed-timers-cleanup'] = function (task) {
					timers.forEach(function (timerId) {
						return clearTimeout(timerId);
					}); // eslint-disable-line no-shadow
					timers.clear();
					delete prehistory[task]; // single-use task
				};
			}
		}
	});

	/*
 	<<repeat>> & <<stop>>
 */
	Macro.add('repeat', {
		tags: null,
		timers: new Set(),

		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no time value specified');
			}

			var delay = void 0;

			try {
				delay = Math.max(Engine.minDomActionDelay, Util.fromCssTime(this.args[0]));
			} catch (e) {
				return this.error(e.message);
			}

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ block: true });
			}

			// Register the timer and, possibly, a cleanup task.
			this.self.registerInterval(jQuery(document.createElement('span')).addClass('macro-' + this.name).appendTo(this.output), this.payload[0].contents, delay, this.args.length > 1 && /^(?:transition|t8n)$/.test(this.args[1]));
		},
		registerInterval: function registerInterval($output, content, delay, transition) {
			var turnId = State.turns,
			    timers = this.timers;
			var timerId = null;

			// Setup the interval.
			timerId = setInterval(function () {
				// Terminate the timer if the turn IDs do not match.
				if (turnId !== State.turns) {
					clearInterval(timerId);
					timers.delete(timerId);
					return;
				}

				var timerIdCache = void 0;
				/*
    	There's no catch clause because this try/finally is here simply to ensure that
    	proper cleanup is done in the event that an exception is thrown during the
    	`Wikifier` call.
    */
				try {
					TempState.break = null;

					// Setup the `repeatTimerId` value, caching the existing value, if necessary.
					if (TempState.hasOwnProperty('repeatTimerId')) {
						timerIdCache = TempState.repeatTimerId;
					}
					TempState.repeatTimerId = timerId;

					// Wikify the content.
					var frag = document.createDocumentFragment();
					new Wikifier(frag, content);

					if (transition) {
						$output = jQuery(document.createElement('span')) // eslint-disable-line no-param-reassign
						.addClass('macro-repeat-insert macro-repeat-in').appendTo($output);
					}

					$output.append(frag);

					if (transition) {
						setTimeout(function () {
							return $output.removeClass('macro-repeat-in');
						}, Engine.minDomActionDelay);
					}
				} finally {
					// Teardown the `repeatTimerId` property, restoring the cached value, if necessary.
					if (typeof timerIdCache !== 'undefined') {
						TempState.repeatTimerId = timerIdCache;
					} else {
						delete TempState.repeatTimerId;
					}

					TempState.break = null;
				}
			}, delay);
			timers.add(timerId);

			// Setup a single-use `prehistory` task to remove pending timers.
			if (!prehistory.hasOwnProperty('#repeat-timers-cleanup')) {
				prehistory['#repeat-timers-cleanup'] = function (task) {
					timers.forEach(function (timerId) {
						return clearInterval(timerId);
					});
					timers.clear();
					delete prehistory[task]; // single-use task
				};
			}
		}
	});
	Macro.add('stop', {
		skipArgs: true,

		handler: function handler() {
			if (!TempState.hasOwnProperty('repeatTimerId')) {
				return this.error('must only be used in conjunction with its parent macro <<repeat>>');
			}

			var timers = Macro.get('repeat').timers,
			    timerId = TempState.repeatTimerId;
			clearInterval(timerId);
			timers.delete(timerId);
			TempState.break = 2;

			// Custom debug view setup.
			if (Config.debug) {
				this.debugView.modes({ hidden: true });
			}
		}
	});

	/*
 	<<widget>>
 */
	Macro.add('widget', {
		tags: null,

		handler: function handler() {
			if (this.args.length === 0) {
				return this.error('no widget name specified');
			}

			var widgetName = this.args[0];

			if (Macro.has(widgetName)) {
				if (!Macro.get(widgetName).isWidget) {
					return this.error('cannot clobber existing macro "' + widgetName + '"');
				}

				// Delete the existing widget.
				Macro.delete(widgetName);
			}

			try {
				Macro.add(widgetName, {
					isWidget: true,
					handler: function (contents) {
						return function () {
							var _this7 = this;

							var argsCache = void 0;

							try {
								var _ret5 = function () {
									// Setup the `$args` variable, caching the existing value if necessary.
									if (State.variables.hasOwnProperty('args')) {
										argsCache = State.variables.args;
									}

									State.variables.args = [];

									for (var i = 0, len = _this7.args.length; i < len; ++i) {
										State.variables.args[i] = _this7.args[i];
									}

									State.variables.args.raw = _this7.args.raw;
									State.variables.args.full = _this7.args.full;

									// Setup the error trapping variables.
									var resFrag = document.createDocumentFragment(),
									    errList = [];

									// Wikify the widget contents.
									new Wikifier(resFrag, contents);

									// Carry over the output, unless there were errors.
									Array.from(resFrag.querySelectorAll('.error')).forEach(function (errEl) {
										errList.push(errEl.textContent);
									});

									if (errList.length === 0) {
										_this7.output.appendChild(resFrag);
									} else {
										return {
											v: _this7.error('error' + (errList.length > 1 ? 's' : '') + ' within' + (' widget contents (' + errList.join('; ') + ')'))
										};
									}
								}();

								if ((typeof _ret5 === 'undefined' ? 'undefined' : _typeof(_ret5)) === "object") return _ret5.v;
							} catch (e) {
								return this.error('cannot execute widget: ' + e.message);
							} finally {
								// Teardown the `$args` variable, restoring the cached value if necessary.
								if (typeof argsCache !== 'undefined') {
									State.variables.args = argsCache;
								} else {
									delete State.variables.args;
								}
							}
						};
					}(this.payload[0].contents)
				});

				// Custom debug view setup.
				if (Config.debug) {
					this.createDebugView(this.name, this.source + this.payload[0].contents + '<</' + this.name + '>>');
				}
			} catch (e) {
				return this.error('cannot create widget macro "' + widgetName + '": ' + e.message);
			}
		}
	});
})();

/***********************************************************************************************************************
 *
 * dialog.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Engine, safeActiveElement, strings */

var Dialog = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var _$overlay = null,
	    _$dialog = null,
	    _$dialogTitle = null,
	    _$dialogBody = null,
	    _lastActive = null,
	    _scrollbarWidth = 0;

	/*******************************************************************************************************************
  * Core Functions.
  ******************************************************************************************************************/
	function dialogInit() {
		if (DEBUG) {
			console.log('[Dialog/dialogInit()]');
		}

		/*
  	Calculate and cache the width of scrollbars.
  */
		_scrollbarWidth = function () {
			var scrollbarWidth = void 0;

			try {
				var inner = document.createElement('p'),
				    outer = document.createElement('div');

				inner.style.width = '100%';
				inner.style.height = '200px';
				outer.style.position = 'absolute';
				outer.style.left = '0px';
				outer.style.top = '0px';
				outer.style.width = '100px';
				outer.style.height = '100px';
				outer.style.visibility = 'hidden';
				outer.style.overflow = 'hidden';

				outer.appendChild(inner);
				document.body.appendChild(outer);

				var w1 = inner.offsetWidth;
				/*
    	The `overflow: scroll` style property value does not work consistently
    	with scrollbars which are styled with `::-webkit-scrollbar`, so we use
    	`overflow: auto` with dimensions guaranteed to force a scrollbar.
    */
				outer.style.overflow = 'auto';
				var w2 = inner.offsetWidth;

				if (w1 === w2) {
					w2 = outer.clientWidth;
				}

				document.body.removeChild(outer);

				scrollbarWidth = w1 - w2;
			} catch (e) {/* no-op */}

			return scrollbarWidth || 17; // 17px is a reasonable failover
		}();

		/*
  	Generate the dialog elements.
  */
		var $uiTree = jQuery(document.createDocumentFragment()).append(
		/* eslint-disable max-len */
		'<div id="ui-overlay" class="ui-close"></div>' + '<div id="ui-dialog" tabindex="0" role="dialog" aria-labelledby="ui-dialog-title">' + '<div id="ui-dialog-titlebar">' + '<h1 id="ui-dialog-title"></h1>' + ('<button id="ui-dialog-close" class="ui-close" tabindex="0" aria-label="' + strings.close + '"></button>') + '</div>' + '<div id="ui-dialog-body"></div>' + '</div>'
		/* eslint-enable max-len */
		);

		/*
  	Cache the dialog elements, since they're going to be used often.
  		n.b. We rewrap the elements themselves, rather than simply using the results of
  	     `find()`, so that we cache uncluttered jQuery-wrappers (i.e. `context` refers
  	     to the elements and there is no `prevObject`).
  */
		_$overlay = jQuery($uiTree.find('#ui-overlay').get(0));
		_$dialog = jQuery($uiTree.find('#ui-dialog').get(0));
		_$dialogTitle = jQuery($uiTree.find('#ui-dialog-title').get(0));
		_$dialogBody = jQuery($uiTree.find('#ui-dialog-body').get(0));

		/*
  	Insert the dialog elements into the page before the store area.
  */

		// OLDFASHIONED
		$('#hud').prepend($uiTree);
		//$uiTree.insertBefore('#store-area');
	}

	/*******************************************************************************************************************
  * Dialog Functions.
  ******************************************************************************************************************/
	function dialogIsOpen(classNames) {
		return _$dialog.hasClass('open') && (classNames ? classNames.splitOrEmpty(/\s+/).every(function (c) {
			return _$dialogBody.hasClass(c);
		}) : true);
	}

	function dialogBody() {
		return _$dialogBody.get(0);
	}

	function dialogSetup(title, classNames) {
		_$dialogBody.empty().removeClass();

		if (classNames != null) {
			// lazy equality for null
			_$dialogBody.addClass(classNames);
		}

		_$dialogTitle.empty().append((title != null ? String(title) : '') || ' '); // lazy equality for null
		return _$dialogBody.get(0);
	}

	/**
 	Adds a click hander to the target element(s) which opens the dialog modal.
 **/
	function dialogAddClickHandler(targets, options, startFn, doneFn, closeFn) {
		return jQuery(targets).ariaClick(function (evt) {
			evt.preventDefault();

			// Call the start function.
			if (typeof startFn === 'function') {
				startFn(evt);
			}

			// Open the dialog.
			dialogOpen(options, closeFn);

			// Call the done function.
			if (typeof doneFn === 'function') {
				doneFn(evt);
			}
		});
	}

	function dialogOpen(options, closeFn) {
		var _jQuery$extend = jQuery.extend({ top: 50 }, options);

		var top = _jQuery$extend.top;

		// Record the last active/focused non-dialog element.

		if (!dialogIsOpen()) {
			_lastActive = safeActiveElement();
		}

		// Add the <html> level class (mostly used to style <body>).
		jQuery(document.documentElement).addClass('ui-dialog-open');

		// Display the overlay.
		_$overlay.addClass('open');

		// Add the imagesLoaded handler to the dialog body, if necessary.
		// n.b. We use `querySelector()` as jQuery has no equivalent.
		if (_$dialogBody[0].querySelector('img') !== null) {
			_$dialogBody.imagesLoaded().always(function () {
				return dialogResizeHandler({ data: { top: top } });
			});
		}

		// Add `aria-hidden=true` to all direct non-dialog-children of <body> to
		// hide the underlying page form screen readers while the dialog is open.
		jQuery('body>:not(script,#store-area,#ui-bar,#ui-overlay,#ui-dialog)').attr('tabindex', -3).attr('aria-hidden', true);
		jQuery('#ui-bar,#story').find('[tabindex]:not([tabindex^=-])').attr('tabindex', -2).attr('aria-hidden', true);

		// Display the dialog.
		var position = dialogCalcPosition(top);
		_$dialog.css(position).addClass('open').focus();

		// Add the UI resize handler.
		jQuery(window).on('resize.ui-resize', null, { top: top }, jQuery.throttle(40, dialogResizeHandler));

		// Setup the delegated UI close handler.
		jQuery(document).on('click.ui-close', '.ui-close', { closeFn: closeFn }, dialogClose) // yes, namespace and class have the same name
		.on('keypress.ui-close', '.ui-close', function (evt) {
			// 13 is Enter/Return, 32 is Space.
			if (evt.which === 13 || evt.which === 32) {
				jQuery(this).trigger('click');
			}
		});

		// Trigger a global `tw:dialogopened` event.
		setTimeout(function () {
			return jQuery.event.trigger('tw:dialogopened');
		}, Engine.minDomActionDelay);
	}

	function dialogClose(evt) {
		// Largely reverse the actions taken in `dialogOpen()`.
		jQuery(document).off('.ui-close'); // namespace, not to be confused with the class by the same name
		jQuery(window).off('resize.ui-resize');
		_$dialog.removeClass('open').css({ left: '', right: '', top: '', bottom: '' });

		jQuery('#ui-bar,#story').find('[tabindex=-2]').removeAttr('aria-hidden').attr('tabindex', 0);
		jQuery('body>[tabindex=-3]').removeAttr('aria-hidden').removeAttr('tabindex');

		_$dialogTitle.empty();
		_$dialogBody.empty().removeClass();
		_$overlay.removeClass('open');
		jQuery(document.documentElement).removeClass('ui-dialog-open');

		// Attempt to restore focus to whichever element had it prior to opening the dialog.
		if (_lastActive !== null) {
			jQuery(_lastActive).focus();
			_lastActive = null;
		}

		// Call the given "on close" callback function, if any.
		if (evt && evt.data && typeof evt.data.closeFn === 'function') {
			evt.data.closeFn(evt);
		}

		// Trigger a global `tw:dialogclosed` event.
		setTimeout(function () {
			return jQuery.event.trigger('tw:dialogclosed');
		}, Engine.minDomActionDelay);
	}

	function dialogResizeHandler(evt) {
		var top = evt && evt.data && typeof evt.data.top !== 'undefined' ? evt.data.top : 50;

		if (_$dialog.css('display') === 'block') {
			// Stow the dialog.
			_$dialog.css({ display: 'none' });

			// Restore the dialog with its new positional properties.
			_$dialog.css(jQuery.extend({ display: '' }, dialogCalcPosition(top)));
		}
	}

	function dialogCalcPosition(topPos) {
		var top = topPos != null ? topPos : 50,
		    // lazy equality for null
		$parent = jQuery(window),
		    dialogPos = { left: '', right: '', top: '', bottom: '' };

		// Unset the dialog's positional properties before checking its dimensions.
		_$dialog.css(dialogPos);

		var horzSpace = $parent.width() - _$dialog.outerWidth(true) - 1,
		    // -1 to address a Firefox issue
		vertSpace = $parent.height() - _$dialog.outerHeight(true) - 1; // -1 to address a Firefox issue

		if (horzSpace <= 32 + _scrollbarWidth) {
			vertSpace -= _scrollbarWidth;
		}
		if (vertSpace <= 32 + _scrollbarWidth) {
			horzSpace -= _scrollbarWidth;
		}

		if (horzSpace <= 32) {
			dialogPos.left = dialogPos.right = 16;
		} else {
			dialogPos.left = dialogPos.right = ~~(horzSpace / 2);
		}

		if (vertSpace <= 32) {
			dialogPos.top = dialogPos.bottom = 16;
		} else {
			if (vertSpace / 2 > top) {
				dialogPos.top = top;
			} else {
				dialogPos.top = dialogPos.bottom = ~~(vertSpace / 2);
			}
		}

		Object.keys(dialogPos).forEach(function (p) {
			if (dialogPos[p] !== '') {
				dialogPos[p] += 'px';
			}
		});

		return dialogPos;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		init: { value: dialogInit },
		isOpen: { value: dialogIsOpen },
		body: { value: dialogBody },
		setup: { value: dialogSetup },
		addClickHandler: { value: dialogAddClickHandler },
		open: { value: dialogOpen },
		close: { value: dialogClose },
		resize: { value: function value() {
				return dialogResizeHandler();
			} } // Forbid params on the exported method.
	}));
}();

/***********************************************************************************************************************
 *
 * engine.js
 *
 * Copyright © 2015–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/*
	global Alert, Config, DebugView, Save, State, Story, TempVariables:true, UI, Wikifier, postdisplay, predisplay,
	       prehistory
*/

var Engine = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// Minimum delay for DOM actions (in milliseconds).
	minDomActionDelay = 40;

	var
	// Current state of the engine (values: 'idle', 'playing', 'rendering').
	_state = 'idle',


	// Last time `enginePlay()` was called (in milliseconds).
	_lastPlay = null,


	// Cache of the debug view for the StoryInit special passage.
	_storyInitDebugView = null;

	/*******************************************************************************************************************
  * Engine Functions.
  ******************************************************************************************************************/
	function engineStart() {
		if (DEBUG) {
			console.log('[Engine/engineStart()]');
		}

		/*
  	Execute the StoryInit special passage.
  */
		if (Story.has('StoryInit')) {
			try {
				var debugBuffer = Wikifier.wikifyEval(Story.get('StoryInit').text);

				if (Config.debug) {
					var debugView = new DebugView(document.createDocumentFragment(), 'special', 'StoryInit', 'StoryInit');
					debugView.modes({ hidden: true });
					debugView.append(debugBuffer);
					_storyInitDebugView = debugView.output;
				}
			} catch (e) {
				Alert.error('StoryInit', e.message);
			}
		}

		/*
  	Finalize various `Config` properties here, before any passages are displayed.
  		n.b. We do this here to give authors every opportunity to modify these properties.
  */
		Config.history.maxStates = Math.max(0, Config.history.maxStates);

		if (isNaN(Config.history.maxStates) || !isFinite(Config.history.maxStates)) {
			// TODO: Maybe this should throw instead?
			Config.history.maxStates = 100;
		}

		if (Config.history.maxStates === 1) {
			Config.history.controls = false;
		}

		if (Config.debug) {
			DebugView.init();
		}

		/*
  	Attempt to restore an active session.  Failing that, attempt to autoload the autosave,
  	if requested.  Failing that, display the starting passage.
  */
		if (Config.passages.start == null) {
			// lazy equality for null
			throw new Error('starting passage not selected');
		}

		if (!Story.has(Config.passages.start)) {
			throw new Error('starting passage ("' + Config.passages.start + '") not found');
		}

		if (State.restore()) {
			engineShow();
		} else {
			var loadStart = true;

			switch (_typeof(Config.saves.autoload)) {
				case 'boolean':
					if (Config.saves.autoload && Save.autosave.ok() && Save.autosave.has()) {
						if (DEBUG) {
							console.log('\tattempting autoload: "' + Save.autosave.get().title + '"');
						}

						loadStart = !Save.autosave.load();
					}
					break;
				case 'string':
					if (Config.saves.autoload === 'prompt' && Save.autosave.ok() && Save.autosave.has()) {
						loadStart = false;
						UI.buildDialogAutoload();
						UI.open();
					}
					break;
				case 'function':
					if (Save.autosave.ok() && Save.autosave.has() && !!Config.saves.autoload()) {
						if (DEBUG) {
							console.log('\tattempting autoload: "' + Save.autosave.get().title + '"');
						}

						loadStart = !Save.autosave.load();
					}
					break;
			}

			if (loadStart) {
				if (DEBUG) {
					console.log('\tstarting passage: "' + Config.passages.start + '"');
				}

				enginePlay(Config.passages.start);
			}
		}
	}

	/**
 	Restarts the story.
 **/
	function engineRestart() {
		if (DEBUG) {
			console.log('[Engine/engineRestart()]');
		}

		/*
  	Trigger the loading screen to hide any unsightly rendering shenanigans during
  	the page reload.
  */
		jQuery(document.documentElement).addClass('init-loading');

		/*
  	Scroll the window to the top.
  		This is required by most browsers for the starting passage or it will remain at
  	whatever its current scroll position is after the page reload.  We do it generally,
  	rather than only for the currently set starting passage, since the starting passage
  	may be dynamically manipulated.
  */
		window.scroll(0, 0);

		/*
  	Delete the active session and reload the page.
  */
		State.reset();
		window.location.reload();
	}

	/**
 	Returns the current state of the engine.
 **/
	function engineState() {
		return _state;
	}

	/**
 	Returns the last time `enginePlay()` was called (in milliseconds).
 **/
	function engineLastPlay() {
		return _lastPlay;
	}

	/**
 	Activate the moment at the given index within the state history and show it.
 **/
	function engineGoTo(idx) {
		var succeded = State.goTo(idx);

		if (succeded) {
			engineShow();
		}

		return succeded;
	}

	/**
 	Activate the moment at the given offset from the active moment within the state history
 	and show it.
 **/
	function engineGo(offset) {
		var succeded = State.go(offset);

		if (succeded) {
			engineShow();
		}

		return succeded;
	}

	/**
 	Go to the moment which directly precedes the active moment and show it.
 **/
	function engineBackward() {
		return engineGo(-1);
	}

	/**
 	Go to the moment which directly follows the active moment and show it.
 **/
	function engineForward() {
		return engineGo(1);
	}

	/**
 	Renders and displays the active (present) moment's associated passage without adding
 	a new moment to the history.
 **/
	function engineShow() {
		return enginePlay(State.passage, true);
	}

	/**
 	Renders and displays the passage referenced by the given title, optionally without
 	adding a new moment to the history.
 **/
	function enginePlay(title, noHistory) {
		if (DEBUG) {
			console.log('[Engine/enginePlay(title: "' + title + '", noHistory: ' + noHistory + ')]');
		}

		/*
  	Update the engine state.
  */
		_state = 'playing';

		/*
  	Reset the temporary state and variables objects.
  */
		TempState = {}; // eslint-disable-line no-undef
		TempVariables = {};

		// We must also update the `window.SugarCube` debugging references.
		// window.SugarCube.TempState = TempState;
		window.SugarCube.TempVariables = TempVariables;

		/*
  	Debug view setup.
  */
		var passageReadyOutput = void 0,
		    passageDoneOutput = void 0;

		/*
  	Retrieve the passage by the given title.
  		n.b. The `title` parameter may be empty, a string, or a number (though using a number
  	     as reference to a numeric title should be discouraged), so after loading the
  	     passage, always refer to `passage.title` and never the `title` parameter.
  */
		var passage = Story.get(title);

		/*
  	Execute the pre-history tasks.
  */
		Object.keys(prehistory).forEach(function (task) {
			if (typeof prehistory[task] === 'function') {
				prehistory[task].call(this, task);
			}
		}, passage);

		/*
  	Create a new entry in the history.
  */
		if (!noHistory) {
			State.create(passage.title);
		}

		/*
  	Clear `<body>` classes, then execute the `PassageReady` passage and `predisplay` tasks.
  */
		if (document.body.className) {
			document.body.className = '';
		}

		Object.keys(predisplay).forEach(function (task) {
			if (typeof predisplay[task] === 'function') {
				predisplay[task].call(this, task);
			}
		}, passage);

		if (Story.has('PassageReady')) {
			try {
				passageReadyOutput = Wikifier.wikifyEval(Story.get('PassageReady').text);
			} catch (e) {
				Alert.error('PassageReady', e.message);
			}
		}

		/*
  	Update the engine state.
  */
		_state = 'rendering';

		/*
  	Render the incoming passage and add it to the page.
  */
		var $incoming = jQuery(passage.render()),
		    passages = document.getElementById('passages');

		if (passages.hasChildNodes()) {
			if (
			/* eslint-disable no-extra-parens */
			typeof Config.passages.transitionOut === 'number' || typeof Config.passages.transitionOut === 'string' && Config.passages.transitionOut !== '' && Config.transitionEndEventName !== ''
			/* eslint-enable no-extra-parens */
			) {
					[].concat(_toConsumableArray(passages.childNodes)).forEach(function (outgoing) {
						var $outgoing = jQuery(outgoing);

						if (outgoing.nodeType === Node.ELEMENT_NODE && $outgoing.hasClass('passage')) {
							if ($outgoing.hasClass('passage-out')) {
								return;
							}

							$outgoing.attr('id', 'out-' + $outgoing.attr('id')).addClass('passage-out');

							if (typeof Config.passages.transitionOut === 'string') {
								$outgoing.on(Config.transitionEndEventName, function (evt) {
									if (evt.originalEvent.propertyName === Config.passages.transitionOut) {
										$outgoing.remove();
									}
								});
							} else {
								setTimeout(function () {
									return $outgoing.remove();
								}, Math.max(minDomActionDelay, Config.passages.transitionOut));
							}
						} else {
							$outgoing.remove();
						}
					});
				} else {
				jQuery(passages).empty();
			}
		}
		$incoming.addClass('passage-in').appendTo(passages);
		setTimeout(function () {
			return $incoming.removeClass('passage-in');
		}, minDomActionDelay);

		/*
  	Set the document title.
  */
		document.title = Config.passages.displayTitles && passage.title !== Config.passages.start ? passage.title + ' | ' + Story.title : Story.title;

		/*
  	Scroll the window to the top.
  */
		window.scroll(0, 0);

		/*
  	Update the engine state.
  */
		_state = 'playing';

		/*
  	Execute the `PassageDone` passage and `postdisplay` tasks, then update the non-passage
  	page elements, if enabled.
  */
		if (Story.has('PassageDone')) {
			try {
				passageDoneOutput = Wikifier.wikifyEval(Story.get('PassageDone').text);
			} catch (e) {
				Alert.error('PassageDone', e.message);
			}
		}

		Object.keys(postdisplay).forEach(function (task) {
			if (typeof postdisplay[task] === 'function') {
				postdisplay[task].call(this, task);
			}
		}, passage);

		if (Config.ui.updateStoryElements) {
			UI.setStoryElements();
		}

		/*
  	Add the completed debug views for `StoryInit`, `PassageReady`, and `PassageDone`
  	to the incoming passage element.
  */
		if (Config.debug) {
			var debugView = void 0;

			// Prepend the `PassageReady` debug view.
			if (passageReadyOutput != null) {
				// lazy equality for null
				debugView = new DebugView(document.createDocumentFragment(), 'special', 'PassageReady', 'PassageReady');
				debugView.modes({ hidden: true });
				debugView.append(passageReadyOutput);
				$incoming.prepend(debugView.output);
			}

			// Append the `PassageDone` debug view.
			if (passageDoneOutput != null) {
				// lazy equality for null
				debugView = new DebugView(document.createDocumentFragment(), 'special', 'PassageDone', 'PassageDone');
				debugView.modes({ hidden: true });
				debugView.append(passageDoneOutput);
				$incoming.append(debugView.output);
			}

			// Prepend the cached `StoryInit` debug view, if we're showing the first moment/turn.
			if (State.turns === 1 && _storyInitDebugView != null) {
				// lazy equality for null
				$incoming.prepend(_storyInitDebugView);
			}
		}

		/*
  	Update the last display time.
  */
		_lastPlay = Date.now();

		/*
  	Last second post-processing for accessibility and other things.
  */
		UI.hideOutlines(); // initially hide outlines
		jQuery('#story')
		// Add `link-external` to all `href` bearing `<a>` elements which don't have it.
		.find('a[href]:not(.link-external)').addClass('link-external').end()
		// Add `tabindex=0` to all interactive elements which don't have it.
		.find('a,link,button,input,select,textarea').not('[tabindex]').attr('tabindex', 0);

		/*
  	Handle autosaves.
  */
		switch (_typeof(Config.saves.autosave)) {
			case 'boolean':
				if (Config.saves.autosave) {
					Save.autosave.save();
				}
				break;
			case 'string':
				if (passage.tags.includes(Config.saves.autosave)) {
					Save.autosave.save();
				}
				break;
			case 'object':
				if (Array.isArray(Config.saves.autosave) && passage.tags.some(function (t) {
					return Config.saves.autosave.includes(t);
				})) {
					Save.autosave.save();
				}
				break;
		}

		/*
  	Reset the engine state.
  */
		_state = 'idle';

		// TODO: Let this return the jQuery wrapped element, rather than just the element.
		return $incoming[0];
	}

	/*******************************************************************************************************************
  * Legacy Functions.
  ******************************************************************************************************************/
	/**
 	[DEPRECATED] Play the given passage, optionally without altering the history.
 **/
	function engineDisplay(title, link, option) {
		if (DEBUG) {
			console.log('[Engine/engineDisplay()]');
		}

		var noHistory = false;

		// Process the option parameter.
		switch (option) {
			case undefined:
				/* no-op */
				break;

			case 'replace':
			case 'back':
				noHistory = true;
				break;

			default:
				throw new Error('Engine.display option parameter called with' + (' obsolete value "' + option + '"; please notify the developer'));
		}

		enginePlay(title, noHistory);
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	Constants.
  */
		minDomActionDelay: { value: minDomActionDelay },

		/*
  	Core Functions.
  */
		start: { value: engineStart },
		restart: { value: engineRestart },
		state: { get: engineState },
		lastPlay: { get: engineLastPlay },
		goTo: { value: engineGoTo },
		go: { value: engineGo },
		backward: { value: engineBackward },
		forward: { value: engineForward },
		show: { value: engineShow },
		play: { value: enginePlay },

		/*
  	Legacy Functions.
  */
		display: { value: engineDisplay }
	}));
}();

/***********************************************************************************************************************
 *
 * passage.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Config, Story, Util, Wikifier, convertBreaks, postrender, prerender, strings */

var Passage = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var _tagsToSkip = void 0,
	    _unescapeTwine1Chars = void 0;

	/*
 	Tags which should not be transformed into classes:
 		debug      → special tag
 		nobr       → special tag
 		passage    → the default class
 		script     → special tag (only in Twine 1)
 		stylesheet → special tag (only in Twine 1)
 		twine.*    → special tag
 		widget     → special tag
 */
	// For Twine 1
	if (TWINE1) {
		_tagsToSkip = /^(?:debug|nobr|passage|script|stylesheet|widget|twine\..*)$/i;
	}
	// For Twine 2
	else {
			_tagsToSkip = /^(?:debug|nobr|passage|widget|twine\..*)$/i;
		}

	// For Twine 1
	if (TWINE1) {
		(function () {
			/*
   	Returns a decoded version of the passed Twine 1 passage store encoded string.
   */
			var _escapedTwine1CharsRe = /(?:\\n|\\t|\\s|\\|\r)/g,
			    _hasEscapedTwine1CharsRe = new RegExp(_escapedTwine1CharsRe.source),
			    // to drop the global flag
			_escapedTwine1CharsMap = Object.freeze({
				'\\n': '\n',
				'\\t': '\t',
				'\\s': '\\',
				'\\': '\\',
				'\r': ''
			});

			_unescapeTwine1Chars = function _unescapeTwine1Chars(str) {
				if (str == null) {
					// lazy equality for null
					return '';
				}

				var s = String(str);
				return s && _hasEscapedTwine1CharsRe.test(s) ? s.replace(_escapedTwine1CharsRe, function (c) {
					return _escapedTwine1CharsMap[c];
				}) : s;
			};
		})();
	}

	/*******************************************************************************************************************
  * Passage Class.
  ******************************************************************************************************************/

	var Passage = function () {
		function Passage(title, el) {
			var _this8 = this;

			_classCallCheck(this, Passage);

			Object.defineProperties(this, {
				// Passage title/ID.
				title: {
					value: Util.unescape(title)
				},

				// Passage data element (within the story data element; i.e. T1: '[tiddler]', T2: 'tw-passagedata').
				element: {
					value: el || null
				},

				// Passage tags array (sorted and unique).
				tags: {
					value: Object.freeze(el && el.hasAttribute('tags') ? el.getAttribute('tags').trim().splitOrEmpty(/\s+/).sort().filter(function (tag, i, aref) {
						return i === 0 || aref[i - 1] !== tag;
					}) : [])
				},

				// Passage excerpt.  Used by the `description()` method.
				_excerpt: {
					writable: true,
					value: null
				}
			});

			// Properties dependant on the above set.
			Object.defineProperties(this, {
				// Passage DOM-compatible ID.
				domId: {
					value: 'passage-' + Util.slugify(this.title)
				},

				// Passage classes array (sorted and unique).
				classes: {
					value: Object.freeze(this.tags.length === 0 ? [] : function () {
						return(
							/*
       	Return the sorted list of unique classes.
       		n.b. The `this.tags` array is already sorted and unique, so we only need
       	     to filter and map here.
       */
							_this8.tags.filter(function (tag) {
								return !_tagsToSkip.test(tag);
							}).map(function (tag) {
								return Util.slugify(tag);
							})
						);
					}())
				}
			});
		}

		// Getters.


		_createClass(Passage, [{
			key: 'description',
			value: function description() {
				var descriptions = Config.passages.descriptions;

				if (descriptions != null) {
					// lazy equality for null
					switch (typeof descriptions === 'undefined' ? 'undefined' : _typeof(descriptions)) {
						case 'boolean':
							if (descriptions) {
								return this.title;
							}
							break;

						case 'object':
							if (descriptions instanceof Map && descriptions.has(this.title)) {
								return descriptions.get(this.title);
							} else if (descriptions.hasOwnProperty(this.title)) {
								return descriptions[this.title];
							}
							break;

						case 'function':
							{
								var result = descriptions.call(this);

								if (result) {
									return result;
								}
							}
							break;

						default:
							throw new TypeError('Config.passages.descriptions must be a boolean, object, or function');
					}
				}

				// Initialize the excerpt cache from the raw passage text, if necessary.
				if (this._excerpt === null) {
					this._excerpt = Passage.getExcerptFromText(this.text);
				}

				return this._excerpt;
			}
		}, {
			key: 'processText',
			value: function processText() {
				var processed = this.text;

				// Handle the `nobr` tag.
				if (this.tags.includes('nobr')) {
					// Remove all leading & trailing newlines and compact all internal sequences
					// of newlines into single spaces.
					processed = processed.replace(/^\n+|\n+$/g, '').replace(/\n+/g, ' ');
				}

				// Handle image passage transclusion.
				if (this.tags.includes('Twine.image')) {
					processed = '[img[' + processed + ']]';
				}

				return processed;
			}
		}, {
			key: 'render',
			value: function render() {
				var _this9 = this;

				if (DEBUG) {
					console.log('[<Passage: "' + this.title + '">.render()]');
				}

				// Create and setup the new passage element.
				var passageEl = document.createElement('div');
				jQuery(passageEl).attr({
					id: this.domId,
					'data-passage': this.title,
					'data-tags': this.tags.join(' ')
				}).addClass('passage ' + this.className);

				// Add the passage's classes to the <body>.
				jQuery(document.body).addClass(this.className);

				// Execute pre-render tasks.
				Object.keys(prerender).forEach(function (task) {
					if (typeof prerender[task] === 'function') {
						prerender[task].call(_this9, passageEl, task);
					}
				});

				// Wikify the PassageHeader passage, if it exists, into the passage element.
				if (Story.has('PassageHeader')) {
					new Wikifier(passageEl, Story.get('PassageHeader').processText());
				}

				// Wikify the passage into its element.
				new Wikifier(passageEl, this.processText());

				// Wikify the PassageFooter passage, if it exists, into the passage element.
				if (Story.has('PassageFooter')) {
					new Wikifier(passageEl, Story.get('PassageFooter').processText());
				}

				// Convert breaks to paragraphs within the output passage.
				if (Config.cleanupWikifierOutput) {
					convertBreaks(passageEl);
				}

				// Execute post-render tasks.
				Object.keys(postrender).forEach(function (task) {
					if (typeof postrender[task] === 'function') {
						postrender[task].call(_this9, passageEl, task);
					}
				});

				// Update the excerpt cache to reflect the rendered text.
				this._excerpt = Passage.getExcerptFromNode(passageEl);

				return passageEl;
			}
		}, {
			key: 'className',
			get: function get() {
				return this.classes.join(' ');
			}
		}, {
			key: 'text',
			get: function get() {
				if (this.element == null) {
					// lazy equality for null
					return ('<span class="error" title="%passage%">' + (strings.errors.title + ': ' + strings.errors.nonexistentPassage) + '</span>').replace(/%passage%/g, Util.escape(this.title));
				}

				// For Twine 1
				if (TWINE1) {
					return _unescapeTwine1Chars(this.element.textContent);
				}
				// For Twine 2
				else {
						return this.element.textContent.replace(/\r/g, '');
					}
			}
		}], [{
			key: 'getExcerptFromNode',
			value: function getExcerptFromNode(node, count) {
				if (!node.hasChildNodes()) {
					return '';
				}

				var excerpt = node.textContent.trim();

				if (excerpt !== '') {
					var excerptRe = new RegExp('(\\S+(?:\\s+\\S+){0,' + (count > 0 ? count - 1 : 7) + '})');
					excerpt = excerpt
					// Compact whitespace.
					.replace(/\s+/g, ' ')
					// Attempt to match the excerpt regexp.
					.match(excerptRe);
				}

				return excerpt ? excerpt[1] + '…' : '…'; // horizontal ellipsis
			}
		}, {
			key: 'getExcerptFromText',
			value: function getExcerptFromText(text, count) {
				if (text === '') {
					return '';
				}

				var excerptRe = new RegExp('(\\S+(?:\\s+\\S+){0,' + (count > 0 ? count - 1 : 7) + '})'),
				    excerpt = text
				// Strip macro tags (replace with a space).
				.replace(/<<.*?>>/g, ' ')
				// Strip html tags (replace with a space).
				.replace(/<.*?>/g, ' ')
				// The above might have left problematic whitespace, so trim.
				.trim()
				// Strip wiki tables.
				.replace(/^\s*\|.*\|.*?$/gm, '')
				// Strip wiki images.
				.replace(/\[[<>]?img\[[^\]]*\]\]/g, '')
				// Clean wiki links, i.e. remove all but the link text.
				.replace(/\[\[([^|\]]*)(?:|[^\]]*)?\]\]/g, '$1')
				// Clean wiki !headings.
				.replace(/^\s*!+(.*?)$/gm, '$1')
				// Clean wiki bold/italic/underline/highlight formatting.
				.replace(/\'{2}|\/{2}|_{2}|@{2}/g, '')
				// A final trim.
				.trim()
				// Compact whitespace.
				.replace(/\s+/g, ' ')
				// Attempt to match the excerpt regexp.
				.match(excerptRe);
				return excerpt ? excerpt[1] + '…' : '…'; // horizontal ellipsis
			}
		}]);

		return Passage;
	}();

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/


	return Passage;
}();

/***********************************************************************************************************************
 *
 * save.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Config, Engine, State, Story, UI, Util, storage, strings */

var Save = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var _slotsUBound = -1; // The upper bound of the saves slots.

	/*******************************************************************************************************************
  * Saves Functions.
  ******************************************************************************************************************/
	function savesInit() {
		if (DEBUG) {
			console.log('[Save/savesInit()]');
		}

		// Disable save slots and the autosave when Web Storage is unavailable.
		if (storage.name === 'cookie') {
			savesObjClear();
			Config.saves.autosave = undefined;
			Config.saves.slots = 0;
			return false;
		}

		// Finalize the `Config.saves.slots` property here, before it's used.
		Config.saves.slots = Math.max(0, Config.saves.slots);

		if (isNaN(Config.saves.slots) || !isFinite(Config.saves.slots)) {
			// TODO: Maybe this should throw instead?
			Config.saves.slots = 8;
		}

		var saves = savesObjGet(),
		    updated = false;

		/* legacy */
		// Convert an ancient saves array into a new saves object.
		if (Array.isArray(saves)) {
			saves = {
				autosave: null,
				slots: saves
			};
			updated = true;
		}
		/* /legacy */

		// Handle the author changing the number of save slots.
		if (Config.saves.slots !== saves.slots.length) {
			if (Config.saves.slots < saves.slots.length) {
				// Attempt to decrease the number of slots; this will only compact
				// the slots array, by removing empty slots, no saves will be deleted.
				saves.slots.reverse();

				saves.slots = saves.slots.filter(function (val) {
					if (val === null && this.count > 0) {
						--this.count;
						return false;
					}

					return true;
				}, { count: saves.slots.length - Config.saves.slots });

				saves.slots.reverse();
			} else if (Config.saves.slots > saves.slots.length) {
				// Attempt to increase the number of slots.
				_appendSlots(saves.slots, Config.saves.slots - saves.slots.length);
			}

			updated = true;
		}

		/* legacy */
		// Update saves with old/obsolete properties.
		if (_savesObjUpdate(saves.autosave)) {
			updated = true;
		}

		for (var i = 0; i < saves.slots.length; ++i) {
			if (_savesObjUpdate(saves.slots[i])) {
				updated = true;
			}
		}

		// Remove save stores which are empty.
		if (_savesObjIsEmpty(saves)) {
			storage.delete('saves');
			updated = false;
		}
		/* /legacy */

		// If the saves object was updated, then update the store.
		if (updated) {
			_savesObjSave(saves);
		}

		_slotsUBound = saves.slots.length - 1;

		return true;
	}

	function savesObjCreate() {
		return {
			autosave: null,
			slots: _appendSlots([], Config.saves.slots)
		};
	}

	function savesObjGet() {
		var saves = storage.get('saves');
		return saves === null ? savesObjCreate() : saves;
	}

	function savesObjClear() {
		storage.delete('saves');
		return true;
	}

	function savesOK() {
		return autosaveOK() || slotsOK();
	}

	/*******************************************************************************************************************
  * Autosave Functions.
  ******************************************************************************************************************/
	function autosaveOK() {
		return storage.name !== 'cookie' && typeof Config.saves.autosave !== 'undefined';
	}

	function autosaveHas() {
		var saves = savesObjGet();

		if (saves.autosave === null) {
			return false;
		}

		return true;
	}

	function autosaveGet() {
		var saves = savesObjGet();
		return saves.autosave;
	}

	function autosaveLoad() {
		var saves = savesObjGet();

		if (saves.autosave === null) {
			return false;
		}

		return _unmarshal(saves.autosave);
	}

	function autosaveSave(title, metadata) {
		if (typeof Config.saves.isAllowed === 'function' && !Config.saves.isAllowed()) {
			return false;
		}

		var saves = savesObjGet();
		saves.autosave = _marshal();
		saves.autosave.title = title || Story.get(State.passage).description();
		saves.autosave.date = Date.now();

		if (metadata != null) {
			// lazy equality for null
			saves.autosave.metadata = metadata;
		}

		return _savesObjSave(saves);
	}

	function autosaveDelete() {
		var saves = savesObjGet();
		saves.autosave = null;
		return _savesObjSave(saves);
	}

	/*******************************************************************************************************************
  * Slots Functions.
  ******************************************************************************************************************/
	function slotsOK() {
		return storage.name !== 'cookie' && _slotsUBound !== -1;
	}

	function slotsLength() {
		return _slotsUBound + 1;
	}

	function slotsCount() {
		if (!slotsOK()) {
			return 0;
		}

		var saves = savesObjGet();
		var count = 0;

		for (var i = 0, iend = saves.slots.length; i < iend; ++i) {
			if (saves.slots[i] !== null) {
				++count;
			}
		}
		return count;
	}

	function slotsIsEmpty() {
		return slotsCount() === 0;
	}

	function slotsHas(slot) {
		if (slot < 0 || slot > _slotsUBound) {
			return false;
		}

		var saves = savesObjGet();

		if (slot >= saves.slots.length || saves.slots[slot] === null) {
			return false;
		}

		return true;
	}

	function slotsGet(slot) {
		if (slot < 0 || slot > _slotsUBound) {
			return null;
		}

		var saves = savesObjGet();

		if (slot >= saves.slots.length) {
			return null;
		}

		return saves.slots[slot];
	}

	function slotsLoad(slot) {
		if (slot < 0 || slot > _slotsUBound) {
			return false;
		}

		var saves = savesObjGet();

		if (slot >= saves.slots.length || saves.slots[slot] === null) {
			return false;
		}

		return _unmarshal(saves.slots[slot]);
	}

	function slotsSave(slot, title, metadata) {
		if (typeof Config.saves.isAllowed === 'function' && !Config.saves.isAllowed()) {
			UI.alert(strings.saves.disallowed);
			return false;
		}

		if (slot < 0 || slot > _slotsUBound) {
			return false;
		}

		var saves = savesObjGet();
		if (slot >= saves.slots.length) {
			return false;
		}

		saves.slots[slot] = _marshal();
		saves.slots[slot].title = title || Story.get(State.passage).description();
		saves.slots[slot].date = Date.now();

		if (metadata != null) {
			// lazy equality for null
			saves.slots[slot].metadata = metadata;
		}

		return _savesObjSave(saves);
	}

	function slotsDelete(slot) {
		if (slot < 0 || slot > _slotsUBound) {
			return false;
		}

		var saves = savesObjGet();

		if (slot >= saves.slots.length) {
			return false;
		}

		saves.slots[slot] = null;
		return _savesObjSave(saves);
	}

	/*******************************************************************************************************************
  * Disk Functions.
  ******************************************************************************************************************/
	function exportSave(filename) {
		if (typeof Config.saves.isAllowed === 'function' && !Config.saves.isAllowed()) {
			UI.alert(strings.saves.disallowed);
			return;
		}

		function datestamp() {
			var now = new Date();
			var MM = now.getMonth() + 1,
			    DD = now.getDate(),
			    hh = now.getHours(),
			    mm = now.getMinutes(),
			    ss = now.getSeconds();

			if (MM < 10) {
				MM = '0' + MM;
			}
			if (DD < 10) {
				DD = '0' + DD;
			}
			if (hh < 10) {
				hh = '0' + hh;
			}
			if (mm < 10) {
				mm = '0' + mm;
			}
			if (ss < 10) {
				ss = '0' + ss;
			}

			return '' + now.getFullYear() + MM + DD + '-' + hh + mm + ss;
		}

		var saveName = '' + (filename == null ? Story.domId : Util.slugify(filename)) // lazy equality for null
		+ ('-' + datestamp() + '.save'),
		    saveObj = LZString.compressToBase64(JSON.stringify(_marshal()));
		saveAs(new Blob([saveObj], { type: 'text/plain;charset=UTF-8' }), saveName);
	}

	function importSave(event) {
		var file = event.target.files[0],
		    reader = new FileReader();

		// Add the handler that will capture the file information once the load is finished.
		jQuery(reader).on('load', function (evt) {
			if (!evt.target.result) {
				return;
			}

			var saveObj = void 0;

			try {
				saveObj = JSON.parse(/\.json$/i.test(file.name) || /^\{/.test(evt.target.result) ? evt.target.result : LZString.decompressFromBase64(evt.target.result));
			} catch (e) {/* no-op; `_unmarshal()` will handle the error */}

			_unmarshal(saveObj);
		});

		// Initiate the file load.
		reader.readAsText(file);
	}

	/*******************************************************************************************************************
  * Utility Functions.
  ******************************************************************************************************************/
	function _appendSlots(array, num) {
		for (var i = 0; i < num; ++i) {
			array.push(null);
		}

		return array;
	}

	function _savesObjIsEmpty(saves) {
		var slots = saves.slots;
		var isSlotsEmpty = true;

		for (var i = 0, iend = slots.length; i < iend; ++i) {
			if (slots[i] !== null) {
				isSlotsEmpty = false;
				break;
			}
		}

		return saves.autosave === null && isSlotsEmpty;
	}

	function _savesObjSave(saves) {
		if (_savesObjIsEmpty(saves)) {
			storage.delete('saves');
			return true;
		}

		return storage.set('saves', saves);
	}

	function _savesObjUpdate(saveObj) {
		if (saveObj === null) {
			return false;
		}

		var updated = false;

		/* eslint-disable no-param-reassign */
		if (!saveObj.hasOwnProperty('state') || !saveObj.state.hasOwnProperty('delta') || !saveObj.state.hasOwnProperty('index')) {
			if (saveObj.hasOwnProperty('data')) {
				delete saveObj.mode;
				saveObj.state = {
					delta: State.deltaEncode(saveObj.data)
				};
				delete saveObj.data;
			} else if (!saveObj.state.hasOwnProperty('delta')) {
				delete saveObj.state.mode;
				saveObj.state.delta = State.deltaEncode(saveObj.state.history);
				delete saveObj.state.history;
			} else if (!saveObj.state.hasOwnProperty('index')) {
				delete saveObj.state.mode;
			}

			saveObj.state.index = saveObj.state.delta.length - 1;
			updated = true;
		}

		if (saveObj.state.hasOwnProperty('rseed')) {
			saveObj.state.seed = saveObj.state.rseed;
			delete saveObj.state.rseed;

			saveObj.state.delta.forEach(function (_, i, delta) {
				if (delta[i].hasOwnProperty('rcount')) {
					delta[i].pull = delta[i].rcount;
					delete delta[i].rcount;
				}
			});

			updated = true;
		}

		if (saveObj.state.hasOwnProperty('expired') && typeof saveObj.state.expired === 'number' || // eslint-disable-line no-extra-parens, max-len
		saveObj.state.hasOwnProperty('unique') || saveObj.state.hasOwnProperty('last')) {
			if (saveObj.state.hasOwnProperty('expired') && typeof saveObj.state.expired === 'number') {
				delete saveObj.state.expired;
			}

			if (saveObj.state.hasOwnProperty('unique') || saveObj.state.hasOwnProperty('last')) {
				saveObj.state.expired = [];

				if (saveObj.state.hasOwnProperty('unique')) {
					saveObj.state.expired.push(saveObj.state.unique);
					delete saveObj.state.unique;
				}

				if (saveObj.state.hasOwnProperty('last')) {
					saveObj.state.expired.push(saveObj.state.last);
					delete saveObj.state.last;
				}
			}

			updated = true;
		}
		/* eslint-enable no-param-reassign */

		return updated;
	}

	function _marshal() {
		if (DEBUG) {
			console.log('[Save/_marshal()]');
		}

		var saveObj = {
			id: Config.saves.id,
			state: State.marshalForSave()
		};

		if (Config.saves.version) {
			saveObj.version = Config.saves.version;
		}

		if (typeof Config.saves.onSave === 'function') {
			Config.saves.onSave(saveObj);
		}

		// Delta encode the state history and delete the non-encoded property.
		saveObj.state.delta = State.deltaEncode(saveObj.state.history);
		delete saveObj.state.history;

		return saveObj;
	}

	function _unmarshal(saveObj) {
		if (DEBUG) {
			console.log('[Save/_unmarshal()]');
		}

		try {
			/* eslint-disable no-param-reassign */
			/* legacy */
			// Update saves with old/obsolete properties.
			_savesObjUpdate(saveObj);
			/* /legacy */

			if (!saveObj || !saveObj.hasOwnProperty('id') || !saveObj.hasOwnProperty('state')) {
				throw new Error(strings.errors.saveMissingData);
			}

			// Delta decode the state history.
			saveObj.state.history = State.deltaDecode(saveObj.state.delta);
			delete saveObj.state.delta;

			if (typeof Config.saves.onLoad === 'function') {
				Config.saves.onLoad(saveObj);
			}

			if (saveObj.id !== Config.saves.id) {
				throw new Error(strings.errors.saveIdMismatch.replace(/%identity%/g, strings.identity));
			}

			// Restore the state.
			State.unmarshalForSave(saveObj.state); // may also throw exceptions

			// Show the active moment.
			Engine.show();
			/* eslint-enable no-param-reassign */
		} catch (e) {
			UI.alert(e.message[0].toUpperCase() + e.message.slice(1) + '.</p><p>' + strings.aborting + '.');
			return false;
		}

		return true;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	Save Functions.
  */
		init: { value: savesInit },
		get: { value: savesObjGet },
		clear: { value: savesObjClear },
		ok: { value: savesOK },

		/*
  	Autosave  Functions.
  */
		autosave: {
			value: Object.freeze(Object.defineProperties({}, {
				ok: { value: autosaveOK },
				has: { value: autosaveHas },
				get: { value: autosaveGet },
				load: { value: autosaveLoad },
				save: { value: autosaveSave },
				delete: { value: autosaveDelete }
			}))
		},

		/*
  	Slots  Functions.
  */
		slots: {
			value: Object.freeze(Object.defineProperties({}, {
				ok: { value: slotsOK },
				length: { get: slotsLength },
				isEmpty: { value: slotsIsEmpty },
				count: { value: slotsCount },
				has: { value: slotsHas },
				get: { value: slotsGet },
				load: { value: slotsLoad },
				save: { value: slotsSave },
				delete: { value: slotsDelete }
			}))
		},

		/*
  	Disk Functions.
  */
		export: { value: exportSave },
		import: { value: importSave }
	}));
}();

/***********************************************************************************************************************
 *
 * setting.js
 *
 * Copyright © 2015–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global settings:true, storage */

var Setting = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// Setting definition array.
	_definitions = [],


	// Setting control types object (pseudo-enumeration).
	Types = Object.freeze({
		Header: 0,
		Toggle: 1,
		List: 2
	});

	/*******************************************************************************************************************
  * Settings Functions.
  ******************************************************************************************************************/
	function settingsInit() {
		if (DEBUG) {
			console.log('[Setting/settingsInit()]');
		}

		/* legacy */
		// Attempt to migrate an existing `options` store to `settings`.
		if (storage.has('options')) {
			var old = storage.get('options');

			if (old !== null) {
				window.SugarCube.settings = settings = Object.assign(settingsCreate(), old);
			}

			settingsSave();
			storage.delete('options');
		}
		/* /legacy */

		// Load existing settings.
		settingsLoad();

		// Execute `onInit` callbacks.
		_definitions.forEach(function (d) {
			if (d.hasOwnProperty('onInit')) {
				var thisArg = {
					name: d.name,
					value: settings[d.name],
					default: d.default
				};

				if (d.hasOwnProperty('list')) {
					thisArg.list = d.list;
				}

				d.onInit.call(thisArg);
			}
		});
	}

	function settingsCreate() {
		return Object.create(null);
	}

	function settingsSave() {
		var savedSettings = settingsCreate();

		if (Object.keys(settings).length > 0) {
			// _definitions.forEach(definition => {
			// 	if (definition.type !== Types.Header && settings[definition.name] !== definition.default) {
			// 		savedSettings[definition.name] = settings[definition.name];
			// 	}
			// });
			_definitions.filter(function (d) {
				return d.type !== Types.Header && settings[d.name] !== d.default;
			}).forEach(function (d) {
				return savedSettings[d.name] = settings[d.name];
			});
		}

		if (Object.keys(savedSettings).length === 0) {
			storage.delete('settings');
			return true;
		}

		return storage.set('settings', savedSettings);
	}

	function settingsLoad() {
		var defaultSettings = settingsCreate(),
		    loadedSettings = storage.get('settings') || settingsCreate();

		// Load the defaults.
		// _definitions.forEach(definition => {
		// 	if (definition.type !== Types.Header) {
		// 		defaultSettings[definition.name] = definition.default;
		// 	}
		// });
		_definitions.filter(function (d) {
			return d.type !== Types.Header;
		}).forEach(function (d) {
			return defaultSettings[d.name] = d.default;
		});

		// Assign to the `settings` object while overwriting the defaults with the loaded settings.
		window.SugarCube.settings = settings = Object.assign(defaultSettings, loadedSettings);
	}

	function settingsClear() {
		window.SugarCube.settings = settings = settingsCreate();
		storage.delete('settings');
		return true;
	}

	function settingsReset(name) {
		if (arguments.length === 0) {
			settingsClear();
			settingsLoad();
		} else {
			if (name == null || !definitionsHas(name)) {
				// lazy equality for null
				throw new Error('nonexistent setting "' + name + '"');
			}

			var d = definitionsGet(name);

			if (d.type !== Types.Header) {
				settings[name] = d.default;
			}
		}

		return settingsSave();
	}

	/*******************************************************************************************************************
  * Definitions Functions.
  ******************************************************************************************************************/
	function definitionsForEach(callback, thisArg) {
		_definitions.forEach(callback, thisArg);
	}

	function definitionsAdd(type, name, def) {
		if (arguments.length < 3) {
			var errors = [];
			if (arguments.length < 1) {
				errors.push('type');
			}
			if (arguments.length < 2) {
				errors.push('name');
			}
			if (arguments.length < 3) {
				errors.push('definition');
			}
			throw new Error('missing parameters, no ' + errors.join(' or ') + ' specified');
		}

		if ((typeof def === 'undefined' ? 'undefined' : _typeof(def)) !== 'object') {
			throw new TypeError('definition parameter must be an object');
		}

		if (definitionsHas(name)) {
			throw new Error('cannot clobber existing setting "' + name + '"');
		}

		/*
  	Definition objects.
  	{
  		type     : (both:Setting.Types),
  		name     : (both:string),
  		label    : (both:string),
  		default  : (toggle:boolean, list:[as array]), // if undefined (toggle:false, list:list[0])
  		list     : (list:array),
  		onInit   : (both:function),
  		onChange : (both:function)
  	}
  */
		var definition = {
			type: type,
			name: name,
			label: def.label == null ? '' : String(def.label).trim() // lazy equality for null
		};

		switch (type) {
			case Types.Header:
				break;

			case Types.Toggle:
				definition.default = !!def.default;
				break;

			case Types.List:
				if (!def.hasOwnProperty('list')) {
					throw new Error('no list specified');
				} else if (!Array.isArray(def.list)) {
					throw new TypeError('list must be an array');
				} else if (def.list.length === 0) {
					throw new Error('list must not be empty');
				}

				definition.list = Object.freeze(def.list);

				if (def.default == null) {
					// lazy equality for null
					definition.default = def.list[0];
				} else {
					var defaultIndex = def.list.indexOf(def.default);

					if (defaultIndex === -1) {
						throw new Error('list does not contain default');
					}

					definition.default = def.list[defaultIndex];
				}
				break;

			default:
				throw new Error('unknown Setting type: ' + type);
		}

		if (typeof def.onInit === 'function') {
			definition.onInit = Object.freeze(def.onInit);
		}

		if (typeof def.onChange === 'function') {
			definition.onChange = Object.freeze(def.onChange);
		}

		_definitions.push(Object.freeze(definition));
	}

	function definitionsAddHeader(name, label) {
		definitionsAdd(Types.Header, name, { label: label });
	}

	function definitionsAddToggle() {
		for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
			args[_key] = arguments[_key];
		}

		definitionsAdd.apply(undefined, [Types.Toggle].concat(args));
	}

	function definitionsAddList() {
		for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
			args[_key2] = arguments[_key2];
		}

		definitionsAdd.apply(undefined, [Types.List].concat(args));
	}

	function definitionsIsEmpty() {
		return _definitions.length === 0;
	}

	function definitionsHas(name) {
		return _definitions.some(function (definition) {
			return definition.name === name;
		});
	}

	function definitionsGet(name) {
		return _definitions.find(function (definition) {
			return definition.name === name;
		});
	}

	function definitionsDelete(name) {
		if (definitionsHas(name)) {
			delete settings[name];
		}

		for (var i = 0; i < _definitions.length; ++i) {
			if (_definitions[i].name === name) {
				_definitions.splice(i, 1);
				definitionsDelete(name);
				break;
			}
		}
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	Enumerations.
  */
		Types: { value: Types },

		/*
  	Settings Functions.
  */
		init: { value: settingsInit },
		create: { value: settingsCreate },
		save: { value: settingsSave },
		load: { value: settingsLoad },
		clear: { value: settingsClear },
		reset: { value: settingsReset },

		/*
  	Definitions Functions.
  */
		forEach: { value: definitionsForEach },
		add: { value: definitionsAdd },
		addHeader: { value: definitionsAddHeader },
		addToggle: { value: definitionsAddToggle },
		addList: { value: definitionsAddList },
		isEmpty: { value: definitionsIsEmpty },
		has: { value: definitionsHas },
		get: { value: definitionsGet },
		delete: { value: definitionsDelete }
	}));
}();

/***********************************************************************************************************************
 *
 * state.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Config, Engine, PRNGWrapper, Util, clone, session */

var State = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// History moment stack.
	_history = [],


	// Currently active/played moment.
	_active = momentCreate(),


	// Currently active/played moment index.
	_activeIndex = -1,


	// Titles of all moments which have expired (i.e. fallen off the bottom of the stack).
	_expired = [],


	// (optional) Seedable PRNG object.
	_prng = null;

	/*******************************************************************************************************************
  * State Functions.
  ******************************************************************************************************************/
	/**
 	Resets the story state.
 **/
	function stateReset() {
		// eslint-disable-line no-unused-vars
		if (DEBUG) {
			console.log('[State/stateReset()]');
		}

		/*
  	Delete the active session.
  */
		session.delete('state');

		/*
  	Reset the properties.
  */
		_history = [];
		_active = momentCreate();
		_activeIndex = -1;
		_expired = [];
		_prng = _prng === null ? null : new PRNGWrapper(_prng.seed, false);
	}

	/**
 	Restores the story state from the active session.
 **/
	function stateRestore() {
		if (DEBUG) {
			console.log('[State/stateRestore()]');
		}

		/*
  	Attempt to restore an active session.
  */
		if (session.has('state')) {
			/*
   	Retrieve the session.
   */
			var stateObj = session.get('state');

			if (DEBUG) {
				console.log('\tsession state:', stateObj);
			}

			if (stateObj == null) {
				// lazy equality for null
				return false;
			}

			/*
   	Restore the session.
   */
			stateUnmarshal(stateObj);
			return true;
		}

		return false;
	}

	/**
 	Returns the current story state marshaled into a serializable object.
 **/
	function stateMarshal(noDelta) {
		/*
  	Gather the properties.
  */
		var stateObj = {
			index: _activeIndex
		};

		if (noDelta) {
			stateObj.history = clone(_history);
		} else {
			stateObj.delta = historyDeltaEncode(_history);
		}

		if (_expired.length > 0) {
			stateObj.expired = [].concat(_toConsumableArray(_expired));
		}

		if (_prng !== null) {
			stateObj.seed = _prng.seed;
		}

		return stateObj;
	}

	/**
 	Restores the story state from a marshaled story state serialization object.
 **/
	function stateUnmarshal(stateObj, noDelta) {
		if (stateObj == null) {
			// lazy equality for null
			throw new Error('state object is null or undefined');
		}

		if (!stateObj.hasOwnProperty(noDelta ? 'history' : 'delta') || stateObj[noDelta ? 'history' : 'delta'].length === 0) {
			throw new Error('state object has no history or history is empty');
		}

		if (!stateObj.hasOwnProperty('index')) {
			throw new Error('state object has no index');
		}

		if (_prng !== null && !stateObj.hasOwnProperty('seed')) {
			throw new Error('state object has no seed, but PRNG is enabled');
		}

		if (_prng === null && stateObj.hasOwnProperty('seed')) {
			throw new Error('state object has seed, but PRNG is disabled');
		}

		/*
  	Restore the properties.
  */
		_history = noDelta ? clone(stateObj.history) : historyDeltaDecode(stateObj.delta);
		_activeIndex = stateObj.index;
		_expired = stateObj.hasOwnProperty('expired') ? [].concat(_toConsumableArray(stateObj.expired)) : [];

		if (stateObj.hasOwnProperty('seed')) {
			/*
   	We only need to restore the PRNG's seed here as `momentActivate()` will handle
   	fully restoring the PRNG to its proper state.
   */
			_prng.seed = stateObj.seed;
		}

		/*
  	Activate the current moment (do this only after all properties have been restored).
  */
		momentActivate(_activeIndex);
	}

	/**
 	Returns the current story state marshaled into a save-compatible serializable object.
 **/
	function stateMarshalForSave() {
		return stateMarshal(true);
	}

	/**
 	Restores the story state from a marshaled save-compatible story state serialization object.
 **/
	function stateUnmarshalForSave(stateObj) {
		return stateUnmarshal(stateObj, true);
	}

	/**
 	Returns the titles of expired moments.
 **/
	function stateExpired() {
		return _expired;
	}

	/**
 	Returns the total number of played moments (expired + in-play history moments).
 **/
	function stateTurns() {
		return _expired.length + historyLength();
	}

	/**
 	Returns the passage titles of all played moments (expired + in-play history moments).
 **/
	function stateTitles() {
		return _expired.concat(_history.slice(0, historyLength()).map(function (m) {
			return m.title;
		}));
	}

	/**
 	Returns whether a passage with the given title has been played (expired + in-play history moments).
 **/
	function stateHasPlayed(title) {
		if (title == null || title === '') {
			// lazy equality for null
			return false;
		}

		if (_expired.includes(title)) {
			return true;
		} else if (_history.slice(0, historyLength()).some(function (m) {
			return m.title === title;
		})) {
			return true;
		}

		return false;
	}

	/*******************************************************************************************************************
  * Moment Functions.
  ******************************************************************************************************************/
	/**
 	Returns a new moment object created from the given passage title and variables object.
 **/
	function momentCreate(title, variables) {
		return {
			title: title == null ? '' : String(title), // lazy equality for null
			variables: variables == null ? {} : clone(variables) // lazy equality for null
		};
	}

	/**
 	Returns the active (present) moment.
 **/
	function momentActive() {
		return _active;
	}

	/**
 	Returns the index within the history of the active (present) moment.
 **/
	function momentActiveIndex() {
		return _activeIndex;
	}

	/**
 	Returns the title from the active (present) moment.
 **/
	function momentActiveTitle() {
		return _active.title;
	}

	/**
 	Returns the variables from the active (present) moment.
 **/
	function momentActiveVariables() {
		return _active.variables;
	}

	/**
 	Returns the active (present) moment after setting it to either the given moment object
 	or the moment object at the given history index.  Additionally, updates the active session
 	and triggers a history update event.
 **/
	function momentActivate(moment) {
		if (moment == null) {
			// lazy equality for null
			throw new Error('moment activation attempted with null or undefined');
		}

		/*
  	Set the active moment.
  */
		switch (typeof moment === 'undefined' ? 'undefined' : _typeof(moment)) {
			case 'object':
				_active = clone(moment);
				break;

			case 'number':
				if (historyIsEmpty()) {
					throw new Error('moment activation attempted with index on empty history');
				}

				if (moment < 0 || moment >= historySize()) {
					throw new RangeError('moment activation attempted with out-of-bounds index;' + (' need [0, ' + (historySize() - 1) + '], got ' + moment));
				}

				_active = clone(_history[moment]);
				break;

			default:
				throw new TypeError('moment activation attempted with a "' + (typeof moment === 'undefined' ? 'undefined' : _typeof(moment)) + '";' + ' must be an object or valid history stack index');
		}

		/*
  	Restore the seedable PRNG.
  		n.b. We cannot simply set `_prng.pull` to `_active.pull` as that would not
  	     properly mutate the PRNG's internal state.
  */
		if (_prng !== null) {
			_prng = PRNGWrapper.unmarshal({
				seed: _prng.seed,
				pull: _active.pull
			});
		}

		/*
  	Update the active session.
  */
		session.set('state', stateMarshal());

		/*
  	Trigger a global `tw:historyupdate` event.
  		n.b. We do this here because setting a new active moment is a core component of,
  	     virtually, all history updates.
  */
		jQuery.event.trigger('tw:historyupdate');

		return _active;
	}

	/*******************************************************************************************************************
  * History Functions.
  ******************************************************************************************************************/
	/**
 	Returns the moment history.
 **/
	function historyGet() {
		return _history;
	}

	/**
 	Returns the number of active history moments (past only).
 **/
	function historyLength() {
		return _activeIndex + 1;
	}

	/**
 	Returns the total number of history moments (past + future).
 **/
	function historySize() {
		return _history.length;
	}

	/**
 	Returns whether the history is empty.
 **/
	function historyIsEmpty() {
		return _history.length === 0;
	}

	/**
 	Returns the topmost (most recent) moment within the history.
 **/
	function historyTop() {
		return _history.length > 0 ? _history[_history.length - 1] : null;
	}

	/**
 	Returns the bottommost (least recent) moment within the history.
 **/
	function historyBottom() {
		return _history.length > 0 ? _history[0] : null;
	}

	/**
 	Returns the moment at the given index within the history.
 **/
	function historyIndex(index) {
		if (historyIsEmpty() || index < 0 || index > _activeIndex) {
			return null;
		}

		return _history[index];
	}

	/**
 	Returns the moment at the given offset from the active moment within the history.
 **/
	function historyPeek(offset) {
		if (historyIsEmpty()) {
			return null;
		}

		var lengthOffset = 1 + (offset ? Math.abs(offset) : 0);

		if (lengthOffset > historyLength()) {
			return null;
		}

		return _history[historyLength() - lengthOffset];
	}

	/**
 	Returns whether a moment with the given title exists within the history.
 **/
	function historyHas(title) {
		if (historyIsEmpty() || title == null || title === '') {
			// lazy equality for null
			return false;
		}

		for (var i = _activeIndex; i >= 0; --i) {
			if (_history[i].title === title) {
				return true;
			}
		}

		return false;
	}

	/**
 	Creates a new moment and pushes it onto the history, discarding future moments if necessary.
 **/
	function historyCreate(title) {
		if (DEBUG) {
			console.log('[State/historyCreate(title: "' + title + '")]');
		}

		/*
  	TODO: It might be good to have some assertions about the passage title here.
  */

		/*
  	If we're not at the top of the stack, discard the future moments.
  */
		if (historyLength() < historySize()) {
			if (DEBUG) {
				console.log('\tnon-top push; discarding ' + (historySize() - historyLength()) + ' future moments');
			}

			_history.splice(historyLength(), historySize() - historyLength());
		}

		/*
  	Push the new moment onto the history stack.
  */
		_history.push(momentCreate(title, _active.variables));

		if (_prng) {
			historyTop().pull = _prng.pull;
		}

		/*
  	Truncate the history, if necessary, by discarding moments from the bottom.
  */
		if (Config.history.maxStates > 0) {
			while (historySize() > Config.history.maxStates) {
				_expired.push(_history.shift().title);
			}
		}

		/*
  	Activate the new top moment.
  */
		_activeIndex = historySize() - 1;
		momentActivate(_activeIndex);

		return historyLength();
	}

	/**
 	Activate the moment at the given index within the history.
 **/
	function historyGoTo(index) {
		if (DEBUG) {
			console.log('[State/historyGoTo(index: ' + index + ')]');
		}

		if (index == null /* lazy equality for null */
		|| index < 0 || index >= historySize() || index === _activeIndex) {
			return false;
		}

		_activeIndex = index;
		momentActivate(_activeIndex);

		return true;
	}

	/**
 	Activate the moment at the given offset from the active moment within the history.
 **/
	function historyGo(offset) {
		if (DEBUG) {
			console.log('[State/historyGo(offset: ' + offset + ')]');
		}

		if (offset == null || offset === 0) {
			// lazy equality for null
			return false;
		}

		return historyGoTo(_activeIndex + offset);
	}

	/**
 	Returns the delta encoded form of the given history array.
 **/
	function historyDeltaEncode(historyArr) {
		if (!Array.isArray(historyArr)) {
			return null;
		}

		if (historyArr.length === 0) {
			return [];
		}

		var delta = [clone(historyArr[0])];

		for (var i = 1, iend = historyArr.length; i < iend; ++i) {
			delta.push(Util.diff(historyArr[i - 1], historyArr[i]));
		}

		return delta;
	}

	/**
 	Returns a history array from the given delta encoded history array.
 **/
	function historyDeltaDecode(delta) {
		if (!Array.isArray(delta)) {
			return null;
		}

		if (delta.length === 0) {
			return [];
		}

		var historyArr = [clone(delta[0])];

		for (var i = 1, iend = delta.length; i < iend; ++i) {
			historyArr.push(Util.patch(historyArr[i - 1], delta[i]));
		}

		return historyArr;
	}

	/*******************************************************************************************************************
  * PRNG Functions.
  ******************************************************************************************************************/
	function prngInit(seed, useEntropy) {
		if (DEBUG) {
			console.log('[State/prngInit(seed: ' + seed + ', useEntropy: ' + useEntropy + ')]');
		}

		if (!historyIsEmpty()) {
			var scriptSection = void 0;

			if (TWINE1) {
				// for Twine 1
				scriptSection = 'a script-tagged passage';
			} else {
				// for Twine 2
				scriptSection = 'the Story JavaScript';
			}

			throw new Error('State.initPRNG must be called during initialization,' + (' within either ' + scriptSection + ' or the StoryInit special passage'));
		}

		_prng = new PRNGWrapper(seed, useEntropy);
		_active.pull = _prng.pull;
	}

	function prngRandom() {
		if (DEBUG) {
			console.log('[State/prngRandom()]');
		}

		return _prng ? _prng.random() : Math.random();
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	State Functions.
  */
		reset: { value: stateReset },
		restore: { value: stateRestore },
		marshalForSave: { value: stateMarshalForSave },
		unmarshalForSave: { value: stateUnmarshalForSave },
		expired: { get: stateExpired },
		turns: { get: stateTurns },
		passages: { get: stateTitles },
		hasPlayed: { value: stateHasPlayed },

		/*
  	Moment Functions.
  */
		active: { get: momentActive },
		activeIndex: { get: momentActiveIndex },
		passage: { get: momentActiveTitle }, // shortcut for `State.active.title`
		variables: { get: momentActiveVariables }, // shortcut for `State.active.variables`

		/*
  	History Functions.
  */
		history: { get: historyGet },
		length: { get: historyLength },
		size: { get: historySize },
		isEmpty: { value: historyIsEmpty },
		top: { value: historyTop },
		bottom: { value: historyBottom },
		index: { value: historyIndex },
		peek: { value: historyPeek },
		has: { value: historyHas },
		create: { value: historyCreate },
		goTo: { value: historyGoTo },
		go: { value: historyGo },
		deltaEncode: { value: historyDeltaEncode },
		deltaDecode: { value: historyDeltaDecode },

		/*
  	PRNG Functions.
  */
		initPRNG: { value: prngInit },
		random: { value: prngRandom },

		/*
  	Legacy Aliases.
  */
		restart: { value: function value() {
				return Engine.restart();
			} },
		backward: { value: function value() {
				return Engine.backward();
			} },
		forward: { value: function value() {
				return Engine.forward();
			} },
		display: { value: function value() {
				return Engine.display.apply(Engine, arguments);
			} },
		show: { value: function value() {
				return Engine.show.apply(Engine, arguments);
			} },
		play: { value: function value() {
				return Engine.play.apply(Engine, arguments);
			} }
	}));
}();

/***********************************************************************************************************************
 *
 * story.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* global Alert, Config, Passage, Scripting, Util, Wikifier, addStyle */

var Story = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var
	// Map of normal passages.
	_passages = {},


	// List of style passages.
	_styles = [],


	// List of script passages.
	_scripts = [],


	// List of widget passages.
	_widgets = [];

	var
	// Story title.
	_title = '',


	// Story IFID.
	_ifId = '',


	// DOM-compatible ID.
	_domId = '';

	/*******************************************************************************************************************
  * Story Functions.
  ******************************************************************************************************************/
	function storyLoad() {
		// For Twine 1.
		if (TWINE1) {
			if (DEBUG) {
				console.log('[Story/storyLoad()]');
			}

			/*
   	Set the default starting passage.
   */
			Config.passages.start = function () {
				// Handle the Twine 1.4+ Test Play From Here feature (pattern: "START_AT").
				var testPlay = "START_AT"; // eslint-disable-line quotes
				if (testPlay !== '') {
					if (DEBUG) {
						console.log('\tTest play; starting passage: "' + testPlay + '"');
					}

					Config.debug = true;
					return testPlay;
				}

				// In the absence of a `testPlay` value, return 'Start'.
				return 'Start';
			}();

			/*
   	Process the passages, excluding any tagged 'Twine.private' or 'annotation'.
   */
			jQuery('#store-area').children(':not([tags~="Twine.private"],[tags~="annotation"])').each(function () {
				var $this = jQuery(this),
				    passage = new Passage($this.attr('tiddler'), this);

				// Special cases.
				if (passage.tags.includes('stylesheet')) {
					_styles.push(passage);
				} else if (passage.tags.includes('script')) {
					_scripts.push(passage);
				} else if (passage.tags.includes('widget')) {
					_widgets.push(passage);
				}

				// Normal passages.
				else {
						_passages[passage.title] = passage;
					}
			});

			/*
   	Set the story title or throw an exception.
   */
			if (_passages.hasOwnProperty('StoryTitle')) {
				var buf = document.createDocumentFragment();
				new Wikifier(buf, _passages.StoryTitle.processText().trim());
				_storySetTitle(buf.textContent.trim());
			} else {
				throw new Error('cannot find the StoryTitle special passage');
			}

			/*
   	Set the default saves ID (must be done after the call to `_storySetTitle()`).
   		n.b. If not for the requirement to support Twine 1/Twee, we could use the
   	     story's IFID attribute here.
   */
			Config.saves.id = Story.domId;
		}

		// For Twine 2.
		else {
				(function () {
					if (DEBUG) {
						console.log('[Story/storyLoad()]');
					}

					var $storydata = jQuery('#store-area>tw-storydata'),
					    startNode = $storydata.attr('startnode') || '';

					/*
     	Set the default starting passage.
     */
					Config.passages.start = null; // no default in Twine 2

					/*
     	Process story options.
     		n.b. Currently, the only option of interest to us is 'debug' (it may be the
     	     only one period), so we simply use `<RegExp>.test()` to check for it.
     */
					Config.debug = /\bdebug\b/.test($storydata.attr('options'));

					/*
     	Process stylesheet passages.
     */
					$storydata.children('style') // alternatively: '[type="text/twine-css"]' or '#twine-user-stylesheet'
					.each(function (i) {
						_styles.push(new Passage('tw-user-style-' + i, this));
					});

					/*
     	Process script passages.
     */
					$storydata.children('script') // alternatively: '[type="text/twine-javascript"]' or '#twine-user-script'
					.each(function (i) {
						_scripts.push(new Passage('tw-user-script-' + i, this));
					});

					/*
     	Process normal passages, excluding any tagged 'Twine.private' or 'annotation'.
     */
					$storydata.children('tw-passagedata:not([tags~="Twine.private"],[tags~="annotation"])').each(function () {
						var $this = jQuery(this),
						    pid = $this.attr('pid') || '',
						    passage = new Passage($this.attr('name'), this);

						if (pid === startNode && startNode !== '') {
							Config.passages.start = passage.title;
						}

						// Special cases.
						if (passage.tags.includes('widget')) {
							_widgets.push(passage);
						}

						// Normal passages.
						else {
								_passages[passage.title] = passage;
							}
					});

					/*
     	Get the story IFID.
     */
					_ifId = $storydata.attr('ifid');

					/*
     	Set the story title.
     		TODO: Maybe `$storydata.attr('name')` should be used instead of `'understanding-ar'`?
     */
					_storySetTitle(Util.unescape('understanding-ar'));

					/*
     	Set the default saves ID (must be done after the call to `_storySetTitle()`).
     		n.b. If not for the requirement to support Twine 1/Twee, we could use the
     	     story's IFID attribute here.
     */
					Config.saves.id = Story.domId;
				})();
			}
	}

	function storyInit() {
		if (DEBUG) {
			console.log('[Story/storyInit()]');
		}

		/*
  	Add the story styles.
  */
		for (var i = 0; i < _styles.length; ++i) {
			addStyle(_styles[i].text);
		}

		/*
  	Evaluate the story scripts.
  */
		for (var _i4 = 0; _i4 < _scripts.length; ++_i4) {
			try {
				Scripting.evalJavaScript(_scripts[_i4].text);
			} catch (e) {
				Alert.error(_scripts[_i4].title, e.message);
			}
		}

		/*
  	Process the story widgets.
  */
		for (var _i5 = 0; _i5 < _widgets.length; ++_i5) {
			try {
				Wikifier.wikifyEval(_widgets[_i5].processText());
			} catch (e) {
				Alert.error(_widgets[_i5].title, e.message);
			}
		}
	}

	function _storySetTitle(title) {
		if (title == null || title === '') {
			// lazy equality for null
			throw new Error('story title cannot be null or empty');
		}

		document.title = _title = Util.unescape(title);
		_domId = Util.slugify(_title);
	}

	function storyTitle() {
		return _title;
	}

	function storyDomId() {
		return _domId;
	}

	function storyIfId() {
		return _ifId;
	}

	/*******************************************************************************************************************
  * Passage Functions.
  ******************************************************************************************************************/
	function passagesHas(title) {
		var type = typeof title === 'undefined' ? 'undefined' : _typeof(title);

		switch (type) {
			// Valid types.
			case 'number':
			case 'string':
				{
					var id = String(title);
					return _passages.hasOwnProperty(id);
				}

			// Invalid types.  We do the extra processing just to make a nicer error.
			case 'boolean':
			case 'function':
				type = 'a ' + type;
				break;

			case 'undefined':
				/* no-op */
				break;

			default:
				// 'object'
				if (title === null) {
					type = 'null';
				} else {
					type = 'an ' + type;
				}
				break;
		}

		throw new TypeError('Story.has title parameter cannot be ' + type);
	}

	function passagesGet(title) {
		var type = typeof title === 'undefined' ? 'undefined' : _typeof(title);

		switch (type) {
			// Valid types.
			case 'number':
			case 'string':
				{
					var id = String(title);
					return _passages.hasOwnProperty(id) ? _passages[id] : new Passage(id || '(unknown)');
				}

			// Invalid types.  We do the extra processing just to make a nicer error.
			case 'boolean':
			case 'function':
				type = 'a ' + type;
				break;

			case 'undefined':
				/* no-op */
				break;

			default:
				// 'object'
				if (title === null) {
					type = 'null';
				} else {
					type = 'an ' + type;
				}
				break;
		}

		throw new TypeError('Story.get title parameter cannot be ' + type);
	}

	function passagesLookup(key, value) {
		var sortKey = arguments.length <= 2 || arguments[2] === undefined ? 'title' : arguments[2];

		var pnames = Object.keys(_passages),
		    results = [];

		for (var i = 0; i < pnames.length; ++i) {
			var passage = _passages[pnames[i]];

			if (passage.hasOwnProperty(key)) {
				switch (_typeof(passage[key])) {
					case 'undefined':
						/* no-op */
						break;

					case 'object':
						// Currently, we assume that the only properties which are objects will
						// either be arrays or array-like-objects.
						for (var j = 0, jend = passage[key].length; j < jend; ++j) {
							/* eslint-disable eqeqeq */
							if (passage[key][j] == value) {
								// lazy equality, since null & undefined are both possible
								results.push(passage);
								break;
							}
							/* eslint-enable eqeqeq */
						}
						break;

					default:
						/* eslint-disable eqeqeq */
						if (passage[key] == value) {
							// lazy equality, since null & undefined are both possible
							results.push(passage);
						}
						/* eslint-enable eqeqeq */
						break;
				}
			}
		}

		/* eslint-disable eqeqeq, no-nested-ternary, max-len */
		results.sort(function (a, b) {
			return a[sortKey] == b[sortKey] ? 0 : a[sortKey] < b[sortKey] ? -1 : +1;
		}); // lazy equality for null
		/* eslint-enable eqeqeq, no-nested-ternary, max-len */

		return results;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	Passage Containers.
  		TODO: These should probably have getters, rather than being exported directly.
  */
		passages: { value: _passages },
		styles: { value: _styles },
		scripts: { value: _scripts },
		widgets: { value: _widgets },

		/*
  	Story Functions.
  */
		load: { value: storyLoad },
		init: { value: storyInit },
		title: { get: storyTitle }, // a setter is probably not required here
		domId: { get: storyDomId },
		ifId: { get: storyIfId },

		/*
  	Passage Functions.
  */
		has: { value: passagesHas },
		get: { value: passagesGet },
		lookup: { value: passagesLookup }
	}));
}();

/***********************************************************************************************************************
 *
 * strings.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/* eslint-disable max-len, prefer-template */

/*
	Notes:

	1. The capitalization and punctuation used herein is deliberate, especially within the error strings.
	2. The replacement patterns (%…%) are only supported for the strings in which they can be found
	   herein.  During replacement, all instances of the patterns are replaced, so, where they are
	   found, they may be used as many times as desired.
*/
var strings = Object.seal({ // eslint-disable-line no-unused-vars, no-var
	/*
 	Identity.
 */
	identity: 'game',

	/*
 	General.
 */
	aborting: 'Aborting',
	cancel: 'Cancel',
	close: 'Close',
	ok: 'OK',

	/*
 	Errors.
 */
	errors: {
		title: 'Error',
		nonexistentPassage: 'the passage "%passage%" does not exist',
		saveMissingData: "save is missing required data. Either you've loaded a file which is not a save or the save has become corrupted",
		saveIdMismatch: 'save is from the wrong %identity%'
	},

	/*
 	Warnings.
 */
	warnings: {
		degraded: 'Apologies! Your browser either lacks some of the capabilities required by this %identity% or has disabled them, so this %identity% is running in a degraded mode. You may be able to continue, but some parts may not work properly.\n\nThe former may, probably, be solved by upgrading your browser. The latter may be solved by loosening its security restrictions' + (window.location.protocol === 'file:' ? ' or, perhaps, by viewing this %identity% via the HTTP protocol.' : '.')
	},

	/*
 	Debug View.
 */
	debugView: {
		title: 'Debug View',
		toggle: 'Toggle the debug view'
	},

	/*
 	UI bar.
 */
	uiBar: {
		toggle: 'Toggle the UI bar',
		backward: 'Go backward within the %identity% history',
		forward: 'Go forward within the %identity% history',
		jumpto: 'Jump to a specific point within the %identity% history'
	},

	/*
 	Jump To.
 */
	jumpto: {
		title: 'Jump To',
		turn: 'Turn',
		unavailable: 'No jump points currently available…'
	},

	/*
 	Saves.
 */
	saves: {
		title: 'Saves',
		disallowed: 'Saving has been disallowed on this passage.',
		emptySlot: '— slot empty —',
		incapable: 'Apologies! Your browser either lacks the capabilities required to support saves or has disabled them, so saves have been disabled for this session.<br><br>The former may, probably, be solved by <a href="http://browsehappy.com/" target="_blank">upgrading your browser</a>. The latter may be solved by loosening its security restrictions' + (window.location.protocol === 'file:' ? ' or, perhaps, by viewing this %identity% via the HTTP protocol.' : '.'),
		labelAuto: 'Autosave',
		labelDelete: 'Delete',
		labelExport: 'Save to Disk…',
		labelImport: 'Load from Disk…',
		labelLoad: 'Load',
		labelClear: 'Delete All',
		labelSave: 'Save',
		labelSlot: 'Slot',
		savedOn: 'Saved on',
		unavailable: 'No save slots found…',
		unknownDate: 'unknown'
	},

	/*
 	Settings.
 */
	settings: {
		title: 'Settings',
		off: 'Off',
		on: 'On',
		reset: 'Reset to Defaults'
	},

	/*
 	Restart.
 */
	restart: {
		title: 'Restart',
		prompt: 'Are you sure that you want to restart? Unsaved progress will be lost.'
	},

	/*
 	Share.
 */
	share: {
		title: 'Share'
	},

	/*
 	Alert.
 */
	alert: {
		/* empty*/
	},

	/*
 	Autoload.
 */
	autoload: {
		title: 'Autoload',
		cancel: 'Go to start',
		ok: 'Load autosave',
		prompt: 'An autosave exists. Load it now or go to the start?'
	},

	/*
 	Macros.
 */
	macros: {
		back: {
			text: 'Back'
		},
		return: {
			text: 'Return'
		}
	}
});

/***********************************************************************************************************************
 *
 * ui.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/*
	global Dialog, Engine, Has, Save, Setting, State, Story, StyleWrapper, Util, Wikifier, Config, setPageElement,
	       settings, strings
*/

var UI = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var _outlinePatch = null;

	/*******************************************************************************************************************
  * UI Functions, Core.
  ******************************************************************************************************************/
	function uiInit() {
		if (DEBUG) {
			console.log('[UI/uiInit()]');
		}

		/*
  	Remove #init-no-js & #init-lacking from #init-screen.
  */
		jQuery('#init-no-js,#init-lacking').remove();

		/*
  	Generate and cache the outline patching <style> element (`StyleWrapper`-wrapped).
  */
		_outlinePatch = new StyleWrapper(function () {
			return jQuery(document.createElement('style')).attr({
				id: 'style-outline-patch',
				type: 'text/css'
			}).appendTo(document.head).get(0);
		} // return the <style> element itself
		());

		/*
  	Generate the UI bar elements and insert them into the page before the store area.
  */
		(function () {
			var $uiTree = jQuery(document.createDocumentFragment()),
			    toggleLabel = strings.uiBar.toggle,
			    backwardLabel = strings.uiBar.backward.replace(/%identity%/g, strings.identity),
			    jumptoLabel = strings.uiBar.jumpto.replace(/%identity%/g, strings.identity),
			    forwardLabel = strings.uiBar.forward.replace(/%identity%/g, strings.identity);

			// OLDFASHIONED
			// -- added "hud"
			$uiTree.append(
			/* eslint-disable max-len */
			'<div id="ui-bar">' + '<div id="ui-bar-tray">' + ('<button id="ui-bar-toggle" tabindex="0" title="' + toggleLabel + '" aria-label="' + toggleLabel + '"></button>') + '<div id="ui-bar-history">' + ('<button id="history-backward" tabindex="0" title="' + backwardLabel + '" aria-label="' + backwardLabel + '"><i class="fa fa-arrow-left" aria-hidden="true"></i></button>') + ('<button id="history-jumpto" tabindex="0" title="' + jumptoLabel + '" aria-label="' + jumptoLabel + '"></button>') + ('<button id="history-forward" tabindex="0" title="' + forwardLabel + '" aria-label="' + forwardLabel + '"><i class="fa fa-arrow-right" aria-hidden="true"></i></button>') + '</div>' + '</div>' + '<div id="ui-bar-body">' + '<header id="title" role="banner">' + '<div id="story-banner"></div>' + '<h1 id="story-title"></h1>' + '<div id="story-subtitle"></div>' + '<div id="story-title-separator"></div>' + '<p id="story-author"></p>' + '</header>' + '<div id="story-caption"></div>' + '<nav id="menu" role="navigation">' + '<ul id="menu-story"></ul>' + '<ul id="menu-core">' + ('<li id="menu-item-saves"><a tabindex="0">' + strings.saves.title + '</a></li>') + ('<li id="menu-item-settings"><a tabindex="0">' + strings.settings.title + '</a></li>') + ('<li id="menu-item-restart"><a tabindex="0">' + strings.restart.title + '</a></li>') + ('<li id="menu-item-share"><a tabindex="0">' + strings.share.title + '</a></li>') + '</ul>' + '</nav>' + '</div>' + '</div>' + '<div id="story" role="main">' + '<div id="passages"></div>' + '</div>'
			/* eslint-enable max-len */
			);

			$("#hud").append($uiTree);
			//.insertBefore('#store-area');
		})();

		/*
  	Setup the UI bar's global event handlers.
  */
		jQuery(document)
		// Setup a handler for the history-backward/-forward buttons.
		.on('tw:historyupdate', function ($backward, $forward) {
			return function () {
				$backward.prop('disabled', State.length < 2);
				$forward.prop('disabled', State.length === State.size);
			};
		}(jQuery('#history-backward'), jQuery('#history-forward')))
		// Setup accessible outline handling.
		//   based on: http://www.paciellogroup.com/blog/2012/04/how-to-remove-css-outlines-in-an-accessible-manner/
		.on('mousedown.outline-handler keydown.outline-handler', function (evt) {
			switch (evt.type) {
				case 'mousedown':
					uiHideOutlines();
					break;

				case 'keydown':
					uiShowOutlines();
					break;
			}
		});
	}

	function uiStart() {
		if (DEBUG) {
			console.log('[UI/uiStart()]');
		}

		var $uiBar = jQuery('#ui-bar');

		// Setup the #ui-bar's initial state.
		if (Config.ui.stowBarInitially || jQuery(window).width() <= 800) {
			(function () {
				var $uiBarStory = jQuery($uiBar).add('#story');
				$uiBarStory.addClass('no-transition');
				$uiBar.addClass('stowed');
				setTimeout(function () {
					return $uiBarStory.removeClass('no-transition');
				}, Engine.minDomActionDelay);
			})();
		}

		// Setup the #ui-bar-toggle and #ui-bar-history widgets.
		jQuery('#ui-bar-toggle').ariaClick({
			label: strings.uiBar.toggle
		}, function () {
			return $uiBar.toggleClass('stowed');
		});

		if (Config.history.controls) {
			jQuery('#history-backward').prop('disabled', State.length < 2).ariaClick({
				label: strings.uiBar.backward.replace(/%identity%/g, strings.identity)
			}, function () {
				return Engine.backward();
			});

			if (Story.lookup('tags', 'bookmark').length > 0) {
				jQuery('#history-jumpto').ariaClick({
					label: strings.uiBar.jumpto.replace(/%identity%/g, strings.identity)
				}, function () {
					return UI.jumpto();
				});
			} else {
				jQuery('#history-jumpto').remove();
			}

			jQuery('#history-forward').prop('disabled', State.length === State.size).ariaClick({
				label: strings.uiBar.forward.replace(/%identity%/g, strings.identity)
			}, function () {
				return Engine.forward();
			});
		} else {
			jQuery('#ui-bar-history').remove();
		}

		// Setup the title.
		if (TWINE1) {
			// for Twine 1
			setPageElement('story-title', 'StoryTitle', Story.title);
		} else {
			// for Twine 2
			jQuery('#story-title').text(Story.title);
		}

		// Setup the dynamic page elements.
		if (!Story.has('StoryCaption')) {
			jQuery('#story-caption').remove();
		}

		if (!Story.has('StoryMenu')) {
			jQuery('#menu-story').remove();
		}

		if (!Config.ui.updateStoryElements) {
			/*
   	We only need to set the story elements here if `Config.ui.updateStoryElements`
   	is falsy, since otherwise they will be set by `Engine.play()`.
   */
			uiSetStoryElements();
		}

		// Setup the Saves menu item.
		Dialog.addClickHandler('#menu-item-saves a', null, uiBuildSaves).text(strings.saves.title);

		// Setup the Settings menu item.
		if (!Setting.isEmpty()) {
			Dialog.addClickHandler('#menu-item-settings a', null, uiBuildSettings).text(strings.settings.title);
		} else {
			jQuery('#menu-item-settings').remove();
		}

		// Setup the Restart menu item.
		Dialog.addClickHandler('#menu-item-restart a', null, uiBuildRestart).text(strings.restart.title);

		// Setup the Share menu item.
		if (Story.has('StoryShare')) {
			Dialog.addClickHandler('#menu-item-share a', null, uiBuildShare).text(strings.share.title);
		} else {
			jQuery('#menu-item-share').remove();
		}

		// Focus the document element initially.
		jQuery(document.documentElement).focus();
	}

	function uiSetStoryElements() {
		if (DEBUG) {
			console.log('[UI/uiSetStoryElements()]');
		}

		// Setup the (non-navigation) dynamic page elements.
		setPageElement('story-banner', 'StoryBanner');
		setPageElement('story-subtitle', 'StorySubtitle');
		setPageElement('story-author', 'StoryAuthor');
		setPageElement('story-caption', 'StoryCaption');

		// Setup the #menu-story items.
		var menuStory = document.getElementById('menu-story');

		if (menuStory !== null) {
			jQuery(menuStory).empty();

			if (Story.has('StoryMenu')) {
				uiAssembleLinkList('StoryMenu', menuStory);
			}
		}
	}

	function uiHideOutlines() {
		_outlinePatch.set('*:focus{outline:none}');
	}

	function uiShowOutlines() {
		_outlinePatch.clear();
	}

	function uiAssembleLinkList(passage, listEl) {
		var list = listEl;

		// Cache the value of `Config.debug` and then disable it during this method's run.
		var debugState = Config.debug;
		Config.debug = false;

		if (list == null) {
			// lazy equality for null
			list = document.createElement('ul');
		}

		var temp = document.createDocumentFragment();
		new Wikifier(temp, Story.get(passage).processText().trim());

		if (temp.hasChildNodes()) {
			var li = null;

			while (temp.hasChildNodes()) {
				var node = temp.firstChild;

				// Non-<a>-element nodes.
				if (node.nodeType !== Node.ELEMENT_NODE || node.nodeName.toUpperCase() !== 'A') {
					temp.removeChild(node);

					if (li !== null) {
						// Forget the current list item.
						li = null;
					}
				}

				// <a>-element nodes.
				else {
						if (li === null) {
							// Create a new list item.
							li = document.createElement('li');
							list.appendChild(li);
						}
						li.appendChild(node);
					}
			}
		}

		// Restore `Config.debug` to its original value.
		Config.debug = debugState;

		return list;
	}

	/*******************************************************************************************************************
  * UI Functions, Built-ins.
  ******************************************************************************************************************/
	function uiOpenAlert(message) {
		jQuery(Dialog.setup('Alert', 'alert')).append('<p>' + message + '</p><ul class="buttons">' + ('<li><button id="alert-ok" class="ui-close">' + (strings.alert.ok || strings.ok) + '</button></li>') + '</ul>');

		for (var _len3 = arguments.length, args = Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {
			args[_key3 - 1] = arguments[_key3];
		}

		Dialog.open.apply(Dialog, args);
	}

	function uiOpenJumpto() {
		uiBuildJumpto();
		Dialog.open.apply(Dialog, arguments);
	}

	function uiOpenRestart() {
		uiBuildRestart();
		Dialog.open.apply(Dialog, arguments);
	}

	function uiOpenSaves() {
		uiBuildSaves();
		Dialog.open.apply(Dialog, arguments);
	}

	function uiOpenSettings() {
		uiBuildSettings();
		Dialog.open.apply(Dialog, arguments);
	}

	function uiOpenShare() {
		uiBuildShare();
		Dialog.open.apply(Dialog, arguments);
	}

	function uiBuildAutoload() {
		if (DEBUG) {
			console.log('[UI/uiBuildAutoload()]');
		}

		jQuery(Dialog.setup(strings.autoload.title, 'autoload')).append(
		/* eslint-disable max-len */
		'<p>' + strings.autoload.prompt + '</p><ul class="buttons">' + ('<li><button id="autoload-ok" class="ui-close">' + (strings.autoload.ok || strings.ok) + '</button></li>') + ('<li><button id="autoload-cancel" class="ui-close">' + (strings.autoload.cancel || strings.cancel) + '</button></li>') + '</ul>'
		/* eslint-enable max-len */
		);

		// Add an additional delegated click handler for the `.ui-close` elements to handle autoloading.
		jQuery(document).one('click.autoload', '.ui-close', function (evt) {
			var isAutoloadOk = evt.target.id === 'autoload-ok';
			jQuery(document).one('tw:dialogclosed', function () {
				if (DEBUG) {
					console.log('\tattempting autoload: "' + Save.autosave.get().title + '"');
				}

				if (!isAutoloadOk || !Save.autosave.load()) {
					Engine.play(Config.passages.start);
				}
			});
		});

		return true;
	}

	function uiBuildJumpto() {
		if (DEBUG) {
			console.log('[UI/uiBuildJumpto()]');
		}

		var list = document.createElement('ul');

		jQuery(Dialog.setup(strings.jumpto.title, 'jumpto list')).append(list);

		var expired = State.expired.length;

		for (var i = State.size - 1; i >= 0; --i) {
			if (i === State.activeIndex) {
				continue;
			}

			var passage = Story.get(State.history[i].title);

			if (passage && passage.tags.includes('bookmark')) {
				jQuery(document.createElement('li')).append(jQuery(document.createElement('a')).ariaClick({ one: true }, function (idx) {
					return function () {
						return jQuery(document).one('tw:dialogclosed', function () {
							return Engine.goTo(idx);
						});
					};
				}(i)).addClass('ui-close').text(strings.jumpto.turn + ' ' + (expired + i + 1) + ': ' + passage.description())).appendTo(list);
			}
		}

		if (!list.hasChildNodes()) {
			jQuery(list).append('<li><a><em>' + strings.jumpto.unavailable + '</em></a></li>');
		}
	}

	function uiBuildRestart() {
		if (DEBUG) {
			console.log('[UI/uiBuildRestart()]');
		}

		jQuery(Dialog.setup(strings.restart.title, 'restart')).append(
		/* eslint-disable max-len */
		'<p>' + strings.restart.prompt + '</p><ul class="buttons">' + ('<li><button id="restart-ok">' + (strings.restart.ok || strings.ok) + '</button></li>') + ('<li><button id="restart-cancel" class="ui-close">' + (strings.restart.cancel || strings.cancel) + '</button></li>') + '</ul>'
		/* eslint-enable max-len */
		).find('#restart-ok')
		/*
  	Instead of adding '.ui-close' to '#restart-ok' (to receive the use of the default
  	delegated dialog close handler), we setup a special case close handler here.  We
  	do this to ensure that the invocation of `Engine.restart()` happens after the dialog
  	has fully closed.  If we did not, then a race condition could occur, causing display
  	shenanigans.
  */
		.ariaClick({ one: true }, function () {
			jQuery(document).one('tw:dialogclosed', function () {
				return Engine.restart();
			});
			Dialog.close();
		});

		return true;
	}

	function uiBuildSaves() {
		function createActionItem(bId, bClass, bText, bAction) {
			var $btn = jQuery(document.createElement('button')).attr('id', 'saves-' + bId).html(bText);

			if (bClass) {
				$btn.addClass(bClass);
			}

			if (bAction) {
				$btn.ariaClick(bAction);
			} else {
				$btn.prop('disabled', true);
			}

			return jQuery(document.createElement('li')).append($btn);
		}

		function createSaveList() {
			function createButton(bId, bClass, bText, bSlot, bAction) {
				var $btn = jQuery(document.createElement('button')).attr('id', 'saves-' + bId + '-' + bSlot).addClass(bId).html(bText);

				if (bClass) {
					$btn.addClass(bClass);
				}

				if (bAction) {
					if (bSlot === 'auto') {
						$btn.ariaClick({
							label: bText + ' ' + strings.saves.labelAuto
						}, function () {
							return bAction();
						});
					} else {
						$btn.ariaClick({
							label: bText + ' ' + strings.saves.labelSlot + ' ' + (bSlot + 1)
						}, function () {
							return bAction(bSlot);
						});
					}
				} else {
					$btn.prop('disabled', true);
				}

				return $btn;
			}

			var saves = Save.get(),
			    $tbody = jQuery(document.createElement('tbody'));

			if (Save.autosave.ok()) {
				var $tdSlot = jQuery(document.createElement('td')),
				    $tdLoad = jQuery(document.createElement('td')),
				    $tdDesc = jQuery(document.createElement('td')),
				    $tdDele = jQuery(document.createElement('td'));

				// Add the slot ID.
				jQuery(document.createElement('b')).attr({
					title: strings.saves.labelAuto,
					'aria-label': strings.saves.labelAuto
				}).text('A') // '\u25C6' Black Diamond
				.appendTo($tdSlot);

				if (saves.autosave) {
					// Add the load button.
					$tdLoad.append(createButton('load', 'ui-close', strings.saves.labelLoad, 'auto', function () {
						jQuery(document).one('tw:dialogclosed', function () {
							return Save.autosave.load();
						});
					}));

					// Add the description (title and datestamp).
					jQuery(document.createElement('div')).text(saves.autosave.title).appendTo($tdDesc);
					jQuery(document.createElement('div')).addClass('datestamp').html(saves.autosave.date ? strings.saves.savedOn + ' ' + new Date(saves.autosave.date).toLocaleString() : strings.saves.savedOn + ' <em>' + strings.saves.unknownDate + '</em>').appendTo($tdDesc);

					// Add the delete button.
					$tdDele.append(createButton('delete', null, strings.saves.labelDelete, 'auto', function () {
						Save.autosave.delete();
						uiBuildSaves();
						Dialog.resize();
					}));
				} else {
					// Add the load button.
					$tdLoad.append(createButton('load', null, strings.saves.labelLoad, 'auto'));

					// Add the description.
					jQuery(document.createElement('em')).text(strings.saves.emptySlot).appendTo($tdDesc);
					$tdDesc.addClass('empty');

					// Add the delete button.
					$tdDele.append(createButton('delete', null, strings.saves.labelDelete, 'auto'));
				}

				jQuery(document.createElement('tr')).append($tdSlot).append($tdLoad).append($tdDesc).append($tdDele).appendTo($tbody);
			}

			for (var i = 0, iend = saves.slots.length; i < iend; ++i) {
				var _$tdSlot = jQuery(document.createElement('td')),
				    _$tdLoad = jQuery(document.createElement('td')),
				    _$tdDesc = jQuery(document.createElement('td')),
				    _$tdDele = jQuery(document.createElement('td'));

				// Add the slot ID.
				_$tdSlot.append(document.createTextNode(i + 1));

				if (saves.slots[i]) {
					// Add the load button.
					_$tdLoad.append(createButton('load', 'ui-close', strings.saves.labelLoad, i, function (slot) {
						jQuery(document).one('tw:dialogclosed', function () {
							return Save.slots.load(slot);
						});
					}));

					// Add the description (title and datestamp).
					jQuery(document.createElement('div')).text(saves.slots[i].title).appendTo(_$tdDesc);
					jQuery(document.createElement('div')).addClass('datestamp').html(saves.slots[i].date ? strings.saves.savedOn + ' ' + new Date(saves.slots[i].date).toLocaleString() : strings.saves.savedOn + ' <em>' + strings.saves.unknownDate + '</em>').appendTo(_$tdDesc);

					// Add the delete button.
					_$tdDele.append(createButton('delete', null, strings.saves.labelDelete, i, function (slot) {
						Save.slots.delete(slot);
						uiBuildSaves();
						Dialog.resize();
					}));
				} else {
					// Add the load button.
					_$tdLoad.append(createButton('save', 'ui-close', strings.saves.labelSave, i, Save.slots.save));

					// Add the description.
					jQuery(document.createElement('em')).text(strings.saves.emptySlot).appendTo(_$tdDesc);
					_$tdDesc.addClass('empty');

					// Add the delete button.
					_$tdDele.append(createButton('delete', null, strings.saves.labelDelete, i));
				}

				jQuery(document.createElement('tr')).append(_$tdSlot).append(_$tdLoad).append(_$tdDesc).append(_$tdDele).appendTo($tbody);
			}

			return jQuery(document.createElement('table')).attr('id', 'saves-list').append($tbody);
		}

		if (DEBUG) {
			console.log('[UI/uiBuildSaves()]');
		}

		var $dialogBody = jQuery(Dialog.setup(strings.saves.title, 'saves')),
		    savesOk = Save.ok();

		// Add saves list.
		if (savesOk) {
			$dialogBody.append(createSaveList());
		}

		// Add button bar items (export, import, and clear).
		if (savesOk || Has.fileAPI) {
			var $btnBar = jQuery(document.createElement('ul')).addClass('buttons').appendTo($dialogBody);

			if (Has.fileAPI) {
				$btnBar.append(createActionItem('export', 'ui-close', strings.saves.labelExport, function () {
					return Save.export();
				}));
				$btnBar.append(createActionItem('import', null, strings.saves.labelImport, function () {
					return $dialogBody.find('#saves-import-file').trigger('click');
				}));

				// Add the hidden `input[type=file]` element which will be triggered by the `#saves-import` button.
				jQuery(document.createElement('input')).css({
					display: 'block',
					visibility: 'hidden',
					position: 'fixed',
					left: '-9999px',
					top: '-9999px',
					width: '1px',
					height: '1px'
				}).attr({
					type: 'file',
					id: 'saves-import-file',
					tabindex: -1,
					'aria-hidden': true
				}).on('change', function (evt) {
					jQuery(document).one('tw:dialogclosed', function () {
						return Save.import(evt);
					});
					Dialog.close();
				}).appendTo($dialogBody);
			}

			if (savesOk) {
				$btnBar.append(createActionItem('clear', null, strings.saves.labelClear, Save.autosave.has() || !Save.slots.isEmpty() ? function () {
					Save.clear();
					uiBuildSaves();
					Dialog.resize();
				} : null));
			}

			return true;
		} else {
			uiOpenAlert(strings.saves.incapable.replace(/%identity%/g, strings.identity));
			return false;
		}
	}

	function uiBuildSettings() {
		if (DEBUG) {
			console.log('[UI/uiBuildSettings()]');
		}

		var $dialogBody = jQuery(Dialog.setup(strings.settings.title, 'settings'));

		Setting.forEach(function (control) {
			if (control.type === Setting.Types.Header) {
				var _name = control.name,
				    _id = Util.slugify(_name),
				    $elHeader = jQuery(document.createElement('div')),
				    $elHeading = jQuery(document.createElement('h2')),
				    _$elLabel = jQuery(document.createElement('p'));

				$elHeader.attr('id', 'header-body-' + _id).append($elHeading).append(_$elLabel).appendTo($dialogBody);
				$elHeading.attr('id', 'header-heading-' + _id).wiki(_name);
				_$elLabel.attr('id', 'header-label-' + _id).wiki(control.label);

				return;
			}

			var name = control.name,
			    id = Util.slugify(name),
			    $elSetting = jQuery(document.createElement('div')),
			    $elLabel = jQuery(document.createElement('label')),
			    $elWrapper = jQuery(document.createElement('div'));
			var $elControl = void 0;

			$elSetting.attr('id', 'setting-body-' + id).append($elLabel).append($elWrapper).appendTo($dialogBody);

			// Setup the label.
			$elLabel.attr({
				id: 'setting-label-' + id,
				for: 'setting-control-' + id // must be in sync with $elControl's ID (see below)
			}).wiki(control.label);

			// Setup the control.
			if (settings[name] == null) {
				// lazy equality for null
				settings[name] = control.default;
			}

			switch (control.type) {
				case Setting.Types.Toggle:
					$elControl = jQuery(document.createElement('button'));

					if (settings[name]) {
						$elControl.addClass('enabled').text(strings.settings.on);
					} else {
						$elControl.text(strings.settings.off);
					}

					$elControl.ariaClick(function () {
						if (settings[name]) {
							jQuery(this).removeClass('enabled').text(strings.settings.off);
							settings[name] = false;
						} else {
							jQuery(this).addClass('enabled').text(strings.settings.on);
							settings[name] = true;
						}

						Setting.save();

						if (control.hasOwnProperty('onChange')) {
							control.onChange.call({
								name: name,
								value: settings[name],
								default: control.default
							});
						}
					});
					break;

				case Setting.Types.List:
					$elControl = jQuery(document.createElement('select'));

					for (var i = 0, iend = control.list.length; i < iend; ++i) {
						jQuery(document.createElement('option')).val(i).text(control.list[i]).appendTo($elControl);
					}

					$elControl.val(control.list.indexOf(settings[name])).attr('tabindex', 0).on('change', function () {
						settings[name] = control.list[Number(this.value)];
						Setting.save();

						if (control.hasOwnProperty('onChange')) {
							control.onChange.call({
								name: name,
								value: settings[name],
								default: control.default,
								list: control.list
							});
						}
					});
					break;
			}

			$elControl.attr('id', 'setting-control-' + id).appendTo($elWrapper);
		});

		// Add the button bar.
		$dialogBody.append('<ul class="buttons">' + ('<li><button id="settings-ok" class="ui-close">' + (strings.settings.ok || strings.ok) + '</button></li>') + ('<li><button id="settings-reset">' + strings.settings.reset + '</button></li>') + '</ul>').find('#settings-reset')
		/*
  	Instead of adding '.ui-close' to '#settings-reset' (to receive the use of the default
  	delegated dialog close handler), we setup a special case close handler here.  We
  	do this to ensure that the invocation of `window.location.reload()` happens after the
  	dialog has fully closed.  If we did not, then a race condition could occur, causing
  	display shenanigans.
  */
		.ariaClick({ one: true }, function () {
			jQuery(document).one('tw:dialogclosed', function () {
				Setting.reset();
				window.location.reload();
			});
			Dialog.close();
		});

		return true;
	}

	function uiBuildShare() {
		if (DEBUG) {
			console.log('[UI/uiBuildShare()]');
		}

		jQuery(Dialog.setup(strings.share.title, 'share list')).append(uiAssembleLinkList('StoryShare'));

		return true;
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		/*
  	UI Functions, Core.
  */
		init: { value: uiInit },
		start: { value: uiStart },
		setStoryElements: { value: uiSetStoryElements },
		hideOutlines: { value: uiHideOutlines },
		showOutlines: { value: uiShowOutlines },
		assembleLinkList: { value: uiAssembleLinkList },

		/*
  	UI Functions, Built-ins.
  */
		alert: { value: uiOpenAlert },
		jumpto: { value: uiOpenJumpto },
		restart: { value: uiOpenRestart },
		saves: { value: uiOpenSaves },
		settings: { value: uiOpenSettings },
		share: { value: uiOpenShare },
		buildAutoload: { value: uiBuildAutoload },
		buildJumpto: { value: uiBuildJumpto },
		buildRestart: { value: uiBuildRestart },
		buildSaves: { value: uiBuildSaves },
		buildSettings: { value: uiBuildSettings },
		buildShare: { value: uiBuildShare },

		/*
  	Legacy Aliases.
  */
		isOpen: { value: function value() {
				return Dialog.isOpen.apply(Dialog, arguments);
			} },
		body: { value: function value() {
				return Dialog.body();
			} },
		setup: { value: function value() {
				return Dialog.setup.apply(Dialog, arguments);
			} },
		addClickHandler: { value: function value() {
				return Dialog.addClickHandler.apply(Dialog, arguments);
			} },
		open: { value: function value() {
				return Dialog.open.apply(Dialog, arguments);
			} },
		close: { value: function value() {
				return Dialog.close.apply(Dialog, arguments);
			} },
		resize: { value: function value() {
				return Dialog.resize();
			} },
		// Deprecated method names.
		buildDialogAutoload: { value: uiBuildAutoload },
		buildDialogJumpto: { value: uiBuildJumpto },
		buildDialogRestart: { value: uiBuildRestart },
		buildDialogSaves: { value: uiBuildSaves },
		buildDialogSettings: { value: uiBuildSettings },
		buildDialogShare: { value: uiBuildShare },
		buildLinkListFromPassage: { value: uiAssembleLinkList }
	}));
}();

/***********************************************************************************************************************
 *
 * ar.js
 *
 * Copyright © 2016 Blair MacIntyre <blair@cc.gatech.edu>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/

var AR = function () {
	// eslint-disable-line no-unused-vars, no-var
	'use strict';

	var _arScene = null,
	    _$storyEntities = null,
	    _$passageEntities = null,
	    _$hud = null;

	/*******************************************************************************************************************
  * Core Functions.
  ******************************************************************************************************************/
	function arInit() {
		if (DEBUG) {
			console.log('[AR/arInit()]');
		}

		/*
  	Generate the dialog elements.
  */
		var $uiTree = jQuery(document.createDocumentFragment()).append(
		/* eslint-disable max-len */
		//					'<ar-scene id="argon-aframe">' 
		'  <a-entity id="story-entities">' + '  </a-entity>' + '  <a-entity id="passage-entities">' + '  </a-entity>'
		//				  + '</ar-scene>'
		/* eslint-enable max-len */
		);

		/*
  	Cache the dialog elements, since they're going to be used often.
  		n.b. We rewrap the elements themselves, rather than simply using the results of
  	     `find()`, so that we cache uncluttered jQuery-wrappers (i.e. `context` refers
  	     to the elements and there is no `prevObject`).
  */
		_arScene = $('#argon-aframe').get(0);
		_$storyEntities = jQuery($uiTree.find('#story-entities').get(0));
		_$passageEntities = jQuery($uiTree.find('#passage-entities').get(0));
		_$hud = jQuery(document.getElementById('hud'));

		_arScene.addEventListener('argon-initialized', function (evt) {
			console.log("argon initialized, moving hud");
			_arScene.hud.hudElements[0].appendChild(_$hud.get(0));
		});

		/*
  	Insert the dialog elements into the page before the store area.
  */
		$("#argon-aframe").append($uiTree);

		//$uiTree.insertBefore('#store-area');

		/*
  	Set up the scene for AR.  
  */
		_$hud.find("#passages").addClass("passages-ar");
		_$hud.find("#story").addClass("story-ar");
	}

	/*******************************************************************************************************************
  * Module Exports.
  ******************************************************************************************************************/
	return Object.freeze(Object.defineProperties({}, {
		init: { value: arInit }
	}));
}();

/***********************************************************************************************************************
 *
 * sugarcube.js
 *
 * Copyright © 2013–2016 Thomas Michael Edwards <tmedwards@motoslave.net>. All rights reserved.
 * Use of this source code is governed by a Simplified BSD License which can be found in the LICENSE file.
 *
 **********************************************************************************************************************/
/*
	global Alert, Browser, Config, Dialog, DebugView, Engine, Has, KeyValueStore, Macro, Passage, Save, Scripting,
	       Setting, State, Story, UI, Util, Wikifier, strings
*/
/* eslint-disable no-var */

/*
	Version object.
*/
var version = Object.freeze({
	title: 'OldFashioned',
	major: 2,
	minor: 7,
	patch: 2,
	prerelease: "",
	build: 78,
	date: new Date("2016-10-06T04:02:47.551Z"),
	/* legacy */
	extensions: {},
	/* /legacy */

	toString: function toString() {
		'use strict';

		var prerelease = this.prerelease ? '-' + this.prerelease : '';
		return this.major + '.' + this.minor + '.' + this.patch + prerelease + '+' + this.build;
	},
	short: function short() {
		'use strict';

		var prerelease = this.prerelease ? '-' + this.prerelease : '';
		return this.title + ' (v' + this.major + '.' + this.minor + '.' + this.patch + prerelease + ')';
	},
	long: function long() {
		'use strict';

		return this.title + ' v' + this.toString() + ' (' + this.date.toUTCString() + ')';
	}
});

/* eslint-disable no-unused-vars */
/*
	Internal variables.
*/
var
// Temporary state object.
TempState = {},


// Temporary _variables object.
TempVariables = {},


// Legacy macros object.
macros = {},


// Post-display task callbacks object.
postdisplay = {},


// Post-render task callbacks object.
postrender = {},


// Pre-display task callbacks object.
predisplay = {},


// Pre-history task callbacks object.
prehistory = {},


// Pre-render task callbacks object.
prerender = {},


// Session storage manager object.
session = null,


// Settings object.
settings = {},


// Setup object.
setup = {},


// Persistant storage manager object.
storage = null;

/*
	Legacy aliases.
*/
var browser = Browser,
    config = Config,
    has = Has,
    History = State,
    state = State,
    tale = Story;
/* eslint-enable no-unused-vars */

/*
	Global `SugarCube` object.  Allows scripts to detect if they're running in SugarCube by
	testing for the object (e.g. `"SugarCube" in window`) and contains exported identifiers
	for debugging purposes.
*/
window.SugarCube = {};

/*
	Handle the loading screen.

	The value of `document.readyState` may be: 'loading' -> 'interactive' -> 'complete'.
	Though, to reach this point, it must already be in, at least, the 'interactive' state.
*/
jQuery(document).on('readystatechange.SugarCube', function () {
	'use strict';

	if (DEBUG) {
		console.log('[SugarCube/readystatechange()] document.readyState: "' + document.readyState + '"');
	}

	var $html = jQuery(document.documentElement);

	if (document.readyState === 'complete') {
		if ($html.hasClass('init-loading')) {
			if (Config.loadDelay > 0) {
				setTimeout(function () {
					return $html.removeClass('init-loading');
				}, Math.max(Engine.minDomActionDelay, Config.loadDelay));
			} else {
				$html.removeClass('init-loading');
			}
		}
	} else {
		$html.addClass('init-loading');
	}
});

/*
	Main function, entry point for the story.
*/
jQuery(function () {
	'use strict';

	try {
		if (DEBUG) {
			console.log('[SugarCube/main()] Document loaded; beginning startup.');
		}

		/*
  	WARNING!
  		The ordering of the code in this function is important, so be careful when mucking around with it.
  */

		// Normalize the document.
		if (document.normalize) {
			document.normalize();
		}

		// Load the story data (must be done before most anything else).
		Story.load();

		// Instantiate the storage and session objects.
		// n.b. `KeyValueStore()` params: driverType, persist, storageId
		storage = new KeyValueStore('webStorage', true, Story.domId);
		session = new KeyValueStore('webStorage', false, Story.domId);

		// Alert players when their browser is degrading required capabilities.
		if (!session.has('rcWarn') && storage.name === 'cookie') {
			/* eslint-disable no-alert */
			session.set('rcWarn', 1);
			window.alert(strings.warnings.degraded.replace(/%identity%/g, strings.identity));
			/* eslint-enable no-alert */
		}

		// Initialize the user interface (must be done before story initialization, specifically before scripts).
		Dialog.init();
		UI.init();

		// Initialize the story (largely load the user styles, scripts, and widgets).
		Story.init();

		// Initialize the saves (must be done after story initialization, but before engine start).
		Save.init();

		// Initialize the settings.
		Setting.init();

		// Initialize the macros.
		Macro.init();

		// Add the AR components.
		AR.init();

		// Start the engine (should be done as late as possible, but before UI startup).
		Engine.start();

		// Start the user interface.
		UI.start();

		// Finally, export identifiers for debugging purposes.
		window.SugarCube = {
			AR: AR,
			Browser: Browser,
			Config: Config,
			Dialog: Dialog,
			DebugView: DebugView,
			Engine: Engine,
			Has: Has,
			Macro: Macro,
			Passage: Passage,
			Save: Save,
			Scripting: Scripting,
			Setting: Setting,
			State: State,
			Story: Story,
			TempVariables: TempVariables,
			UI: UI,
			Util: Util,
			Wikifier: Wikifier,
			macros: macros,
			session: session,
			settings: settings,
			setup: setup,
			storage: storage,
			version: version
		};

		if (DEBUG) {
			console.log('[SugarCube/main()] Startup complete; story ready.');
		}
	} catch (e) {
		jQuery(document).off('readystatechange.SugarCube');
		return Alert.fatal(null, e.message, e);
	}
});
})(window, window.document, jQuery);
}
	</script>
</body>
</html>
